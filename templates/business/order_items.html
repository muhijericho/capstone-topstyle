{% extends 'business/base.html' %}

{% block title %}Order Items - TopStyle Business{% endblock %}
{% block page_title %}Add Items to Order{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-shopping-cart me-2"></i>
                    Order: {{ order.order_id|truncatechars:12 }}
                </h5>
                <span class="badge bg-primary">{{ order.get_order_type_display }}</span>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Customer:</strong> {{ order.customer.name }}
                    </div>
                    <div class="col-md-6">
                        <strong>Status:</strong> 
                        <span class="status-badge status-{{ order.status }}">
                            {{ order.get_status_display }}
                        </span>
                    </div>
                </div>
                
                <!-- Add Items Form -->
                <div class="mb-4">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Select Product</label>
                            <button type="button" class="btn btn-primary w-100" onclick="openRentalBrochure()">
                                <i class="fas fa-tshirt me-2"></i>Browse Rental Items
                            </button>
                            <div id="selectedRentalItems" class="mt-2"></div>
                            <button type="button" class="btn btn-success w-100 mt-2" id="addSelectedItemsBtn" onclick="addSelectedItemsToOrder()" style="display: none;">
                                <i class="fas fa-plus me-2"></i>Add Selected Items to Order
                            </button>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Or Select from Dropdown</label>
                            <form method="post" id="quickAddForm">
                                {% csrf_token %}
                                <div class="input-group">
                                    <select name="product_id" id="product_id" class="form-select" required>
                                        <option value="">Choose a product...</option>
                                        {% for product in products %}
                                        <option value="{{ product.id }}" 
                                                data-price="{{ product.price }}"
                                                data-quantity="{{ product.quantity }}"
                                                data-type="{{ product.product_type }}">
                                            {{ product.name }} - â‚±{{ product.price }} 
                                            (Stock: {{ product.quantity }})
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <input type="number" name="quantity" id="quantity" class="form-control" value="1" min="1" style="max-width: 100px;" required>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-plus"></i> Add
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Selected Customize Product Display -->
                <div class="card mb-4" id="selectedCustomizeProductDisplay" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-image me-2"></i>Selected Product</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div id="selectedProductImageContainer">
                                    <img id="selectedProductImage" src="" alt="Selected Product" class="img-fluid" style="max-width: 100%; border-radius: 8px; border: 2px solid #dee2e6;">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div id="selectedProductMeasurementsContainer">
                                    <h6 class="mb-3">Measurements</h6>
                                    <div id="selectedProductMeasurements" class="row">
                                        <!-- Measurements will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Polo Customization Section (shown when Polo is selected) -->
                <div class="card mb-4" id="poloCustomizationSection" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-tshirt me-2"></i>Polo Customization</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Customization</label>
                                <select class="form-select" id="poloCustomization" name="polo_customization">
                                    <option value="">Select Customization</option>
                                    <option value="polo" selected>Polo</option>
                                    <option value="polo_shirt">Polo Shirt</option>
                                    <option value="blouse">Blouse</option>
                                    <option value="pants">Pants</option>
                                    <option value="shorts">Shorts</option>
                                    <option value="skirt_palda">Skirt/Palda</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Quantity</label>
                                <input type="number" class="form-control" id="poloQuantity" name="polo_quantity" min="1" value="1" placeholder="Enter quantity">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Type of Button</label>
                                <select class="form-select" id="poloButtonType" name="polo_button_type">
                                    <option value="">Select Button Type</option>
                                    <option value="metal">Metal</option>
                                    <option value="plastic">Plastic</option>
                                </select>
                                <small class="form-text text-muted">Only for Polo and Pants</small>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Button Quantity</label>
                                <input type="number" class="form-control" id="poloButtonQuantity" name="polo_button_quantity" min="0" value="0" placeholder="Enter button quantity">
                                <small class="form-text text-muted">Number of buttons needed per item</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Buttons qt per group</label>
                                <input type="number" class="form-control" id="poloButtonsPerGroup" name="polo_buttons_per_group" min="0" value="0" placeholder="Enter buttons per group">
                            </div>
                        </div>
                        
                        <!-- POLO MEASUREMENTS Section -->
                        <div class="border-top pt-3 mt-3" id="poloMeasurementsSection">
                            <h5 class="mb-3 fw-bold" style="color: #1e3a5f; font-size: 1.1rem;">POLO MEASUREMENTS</h5>
                            <div class="row">
                                <!-- Measurement Input Fields -->
                                <div class="col-12">
                                    <!-- Neckline Circumference -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Neckline Circumference:</label>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <div class="form-check-group" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white; max-height: 200px; overflow-y: auto;" id="poloNecklineCheckboxes">
                                                    <!-- Checkboxes will be generated by JavaScript -->
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">or input:</label>
                                                <input type="text" class="form-control" id="poloNecklineCustom" name="polo_neckline_custom" placeholder="Input here" style="border-radius: 6px;">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Bust -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Bust:</label>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <div class="form-check-group" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white; max-height: 200px; overflow-y: auto;" id="poloBustCheckboxes">
                                                    <!-- Checkboxes will be generated by JavaScript -->
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">or input:</label>
                                                <input type="text" class="form-control" id="poloBustCustom" name="polo_bust_custom" placeholder="Input here" style="border-radius: 6px;">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Armhole -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Armhole:</label>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <div class="form-check-group" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white; max-height: 200px; overflow-y: auto;" id="poloArmholeCheckboxes">
                                                    <!-- Checkboxes will be generated by JavaScript -->
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">or input:</label>
                                                <input type="text" class="form-control" id="poloArmholeCustom" name="polo_armhole_custom" placeholder="Input here" style="border-radius: 6px;">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Shoulders -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Shoulders:</label>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <div class="form-check-group" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white; max-height: 200px; overflow-y: auto;" id="poloShouldersCheckboxes">
                                                    <!-- Checkboxes will be generated by JavaScript -->
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">or input:</label>
                                                <input type="text" class="form-control" id="poloShouldersCustom" name="polo_shoulders_custom" placeholder="Input here" style="border-radius: 6px;">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Waist -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Waist:</label>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <div class="form-check-group" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white; max-height: 200px; overflow-y: auto;" id="poloWaistCheckboxes">
                                                    <!-- Checkboxes will be generated by JavaScript -->
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">or input:</label>
                                                <input type="text" class="form-control" id="poloWaistCustom" name="polo_waist_custom" placeholder="Input here" style="border-radius: 6px;">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Sleeve -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Sleeve:</label>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <div class="form-check-group" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white; max-height: 200px; overflow-y: auto;" id="poloSleeveCheckboxes">
                                                    <!-- Checkboxes will be generated by JavaScript -->
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">or input:</label>
                                                <input type="text" class="form-control" id="poloSleeveCustom" name="polo_sleeve_custom" placeholder="Input here" style="border-radius: 6px;">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Hips -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Hips:</label>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <div class="form-check-group" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white; max-height: 200px; overflow-y: auto;" id="poloHipsCheckboxes">
                                                    <!-- Checkboxes will be generated by JavaScript -->
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">or input:</label>
                                                <input type="text" class="form-control" id="poloHipsCustom" name="polo_hips_custom" placeholder="Input here" style="border-radius: 6px;">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Length -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Length:</label>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <div class="form-check-group" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white; max-height: 200px; overflow-y: auto;" id="poloLengthCheckboxes">
                                                    <!-- Checkboxes will be generated by JavaScript -->
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">or input:</label>
                                                <input type="text" class="form-control" id="poloLengthCustom" name="polo_length_custom" placeholder="Input here" style="border-radius: 6px;">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- POLO SHIRT MEASUREMENTS Section -->
                        <div class="border-top pt-3 mt-3" id="poloShirtMeasurementsSection" style="display: none;">
                            <h5 class="mb-3 fw-bold" style="color: #1e3a5f; font-size: 1.1rem;">POLO SHIRT MEASUREMENTS</h5>
                            <div class="row">
                                <!-- Measurement Input Fields -->
                                <div class="col-12">
                                    <!-- Neckline Circumference -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Neckline Circumference:</label>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <div class="form-check-group" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white; max-height: 200px; overflow-y: auto;" id="poloShirtNecklineCheckboxes"></div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">or input:</label>
                                                <input type="text" class="form-control" id="poloShirtNecklineCustom" name="polo_shirt_neckline_custom" placeholder="Input here" style="border-radius: 6px;">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Bust -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Bust:</label>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <div class="form-check-group" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white; max-height: 200px; overflow-y: auto;" id="poloShirtBustCheckboxes"></div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">or input:</label>
                                                <input type="text" class="form-control" id="poloShirtBustCustom" name="polo_shirt_bust_custom" placeholder="Input here" style="border-radius: 6px;">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Armhole -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Armhole:</label>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <div class="form-check-group" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white; max-height: 200px; overflow-y: auto;" id="poloShirtArmholeCheckboxes"></div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">or input:</label>
                                                <input type="text" class="form-control" id="poloShirtArmholeCustom" name="polo_shirt_armhole_custom" placeholder="Input here" style="border-radius: 6px;">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Shoulders -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Shoulders:</label>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <div class="form-check-group" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white; max-height: 200px; overflow-y: auto;" id="poloShirtShouldersCheckboxes"></div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">or input:</label>
                                                <input type="text" class="form-control" id="poloShirtShouldersCustom" name="polo_shirt_shoulders_custom" placeholder="Input here" style="border-radius: 6px;">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Waist -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Waist:</label>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <div class="form-check-group" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white; max-height: 200px; overflow-y: auto;" id="poloShirtWaistCheckboxes"></div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">or input:</label>
                                                <input type="text" class="form-control" id="poloShirtWaistCustom" name="polo_shirt_waist_custom" placeholder="Input here" style="border-radius: 6px;">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Sleeve -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Sleeve:</label>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <div class="form-check-group" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white; max-height: 200px; overflow-y: auto;" id="poloShirtSleeveCheckboxes"></div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">or input:</label>
                                                <input type="text" class="form-control" id="poloShirtSleeveCustom" name="polo_shirt_sleeve_custom" placeholder="Input here" style="border-radius: 6px;">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Hips -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Hips:</label>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <div class="form-check-group" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white; max-height: 200px; overflow-y: auto;" id="poloShirtHipsCheckboxes"></div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">or input:</label>
                                                <input type="text" class="form-control" id="poloShirtHipsCustom" name="polo_shirt_hips_custom" placeholder="Input here" style="border-radius: 6px;">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Length -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Length:</label>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <div class="form-check-group" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white; max-height: 200px; overflow-y: auto;" id="poloShirtLengthCheckboxes"></div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">or input:</label>
                                                <input type="text" class="form-control" id="poloShirtLengthCustom" name="polo_shirt_length_custom" placeholder="Input here" style="border-radius: 6px;">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- BLOUSE MEASUREMENTS Section -->
                        <div class="border-top pt-3 mt-3" id="blouseMeasurementsSection" style="display: none;">
                            <h5 class="mb-3 fw-bold" style="color: #1e3a5f; font-size: 1.1rem;">BLOUSE MEASUREMENTS</h5>
                            <div class="row">
                                <!-- Measurement Input Fields -->
                                <div class="col-12">
                                    <!-- Neckline Circumference -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Neckline Circumference:</label>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <div class="form-check-group" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white; max-height: 200px; overflow-y: auto;" id="blouseNecklineCheckboxes"></div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">or input:</label>
                                                <input type="text" class="form-control" id="blouseNecklineCustom" name="blouse_neckline_custom" placeholder="Input here" style="border-radius: 6px;">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Bust -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Bust:</label>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <div class="form-check-group" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white; max-height: 200px; overflow-y: auto;" id="blouseBustCheckboxes"></div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">or input:</label>
                                                <input type="text" class="form-control" id="blouseBustCustom" name="blouse_bust_custom" placeholder="Input here" style="border-radius: 6px;">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Armhole -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Armhole:</label>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <div class="form-check-group" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white; max-height: 200px; overflow-y: auto;" id="blouseArmholeCheckboxes"></div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">or input:</label>
                                                <input type="text" class="form-control" id="blouseArmholeCustom" name="blouse_armhole_custom" placeholder="Input here" style="border-radius: 6px;">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Shoulders -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Shoulders:</label>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <div class="form-check-group" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white; max-height: 200px; overflow-y: auto;" id="blouseShouldersCheckboxes"></div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">or input:</label>
                                                <input type="text" class="form-control" id="blouseShouldersCustom" name="blouse_shoulders_custom" placeholder="Input here" style="border-radius: 6px;">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Waist -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Waist:</label>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <div class="form-check-group" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white; max-height: 200px; overflow-y: auto;" id="blouseWaistCheckboxes"></div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">or input:</label>
                                                <input type="text" class="form-control" id="blouseWaistCustom" name="blouse_waist_custom" placeholder="Input here" style="border-radius: 6px;">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Sleeve -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Sleeve:</label>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <div class="form-check-group" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white; max-height: 200px; overflow-y: auto;" id="blouseSleeveCheckboxes"></div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">or input:</label>
                                                <input type="text" class="form-control" id="blouseSleeveCustom" name="blouse_sleeve_custom" placeholder="Input here" style="border-radius: 6px;">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Hips -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Hips:</label>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <div class="form-check-group" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white; max-height: 200px; overflow-y: auto;" id="blouseHipsCheckboxes"></div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">or input:</label>
                                                <input type="text" class="form-control" id="blouseHipsCustom" name="blouse_hips_custom" placeholder="Input here" style="border-radius: 6px;">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Length -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Length:</label>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <div class="form-check-group" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white; max-height: 200px; overflow-y: auto;" id="blouseLengthCheckboxes"></div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">or input:</label>
                                                <input type="text" class="form-control" id="blouseLengthCustom" name="blouse_length_custom" placeholder="Input here" style="border-radius: 6px;">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- PANTS MEASUREMENTS Section -->
                        <div class="border-top pt-3 mt-3" id="pantsMeasurementsSection" style="display: none;">
                            <h5 class="mb-3 fw-bold" style="color: #1e3a5f; font-size: 1.1rem;">PANTS MEASUREMENTS</h5>
                            <div class="row">
                                <!-- Measurement Input Fields -->
                                <div class="col-12">
                                    <!-- Length -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Length:</label>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <div class="form-check-group" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white; max-height: 200px; overflow-y: auto;" id="pantsLengthCheckboxes"></div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">or input:</label>
                                                <input type="text" class="form-control" id="pantsLengthCustom" name="pants_length_custom" placeholder="Input here" style="border-radius: 6px;">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Waist -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Waist:</label>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <div class="form-check-group" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white; max-height: 200px; overflow-y: auto;" id="pantsWaistCheckboxes"></div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">or input:</label>
                                                <input type="text" class="form-control" id="pantsWaistCustom" name="pants_waist_custom" placeholder="Input here" style="border-radius: 6px;">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Crotch -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Crotch:</label>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <div class="form-check-group" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white; max-height: 200px; overflow-y: auto;" id="pantsCrotchCheckboxes"></div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">or input:</label>
                                                <input type="text" class="form-control" id="pantsCrotchCustom" name="pants_crotch_custom" placeholder="Input here" style="border-radius: 6px;">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Hips -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Hips:</label>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <div class="form-check-group" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white; max-height: 200px; overflow-y: auto;" id="pantsHipsCheckboxes"></div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">or input:</label>
                                                <input type="text" class="form-control" id="pantsHipsCustom" name="pants_hips_custom" placeholder="Input here" style="border-radius: 6px;">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Thigh -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Thigh:</label>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <div class="form-check-group" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white; max-height: 200px; overflow-y: auto;" id="pantsThighCheckboxes"></div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">or input:</label>
                                                <input type="text" class="form-control" id="pantsThighCustom" name="pants_thigh_custom" placeholder="Input here" style="border-radius: 6px;">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Knee -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Knee:</label>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <div class="form-check-group" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white; max-height: 200px; overflow-y: auto;" id="pantsKneeCheckboxes"></div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">or input:</label>
                                                <input type="text" class="form-control" id="pantsKneeCustom" name="pants_knee_custom" placeholder="Input here" style="border-radius: 6px;">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Hips Circumference -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Hips Circumference:</label>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <div class="form-check-group" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white; max-height: 200px; overflow-y: auto;" id="pantsHipsCircumferenceCheckboxes"></div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">or input:</label>
                                                <input type="text" class="form-control" id="pantsHipsCircumferenceCustom" name="pants_hips_circumference_custom" placeholder="Input here" style="border-radius: 6px;">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Bottom -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Bottom:</label>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <div class="form-check-group" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white; max-height: 200px; overflow-y: auto;" id="pantsBottomCheckboxes"></div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">or input:</label>
                                                <input type="text" class="form-control" id="pantsBottomCustom" name="pants_bottom_custom" placeholder="Input here" style="border-radius: 6px;">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- SHORTS MEASUREMENTS Section -->
                        <div class="border-top pt-3 mt-3" id="shortsMeasurementsSection" style="display: none;">
                            <h5 class="mb-3 fw-bold" style="color: #1e3a5f; font-size: 1.1rem;">SHORTS MEASUREMENTS</h5>
                            <div class="row">
                                <!-- Measurement Input Fields -->
                                <div class="col-12">
                                    <!-- Length -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Length:</label>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <div class="form-check-group" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white; max-height: 200px; overflow-y: auto;" id="shortsLengthCheckboxes"></div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">or input:</label>
                                                <input type="text" class="form-control" id="shortsLengthCustom" name="shorts_length_custom" placeholder="Input here" style="border-radius: 6px;">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Waist -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Waist:</label>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <div class="form-check-group" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white; max-height: 200px; overflow-y: auto;" id="shortsWaistCheckboxes"></div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">or input:</label>
                                                <input type="text" class="form-control" id="shortsWaistCustom" name="shorts_waist_custom" placeholder="Input here" style="border-radius: 6px;">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Crotch -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Crotch:</label>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <div class="form-check-group" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white; max-height: 200px; overflow-y: auto;" id="shortsCrotchCheckboxes"></div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">or input:</label>
                                                <input type="text" class="form-control" id="shortsCrotchCustom" name="shorts_crotch_custom" placeholder="Input here" style="border-radius: 6px;">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Hips -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Hips:</label>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <div class="form-check-group" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white; max-height: 200px; overflow-y: auto;" id="shortsHipsCheckboxes"></div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">or input:</label>
                                                <input type="text" class="form-control" id="shortsHipsCustom" name="shorts_hips_custom" placeholder="Input here" style="border-radius: 6px;">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Bottom -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Bottom:</label>
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <div class="form-check-group" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white; max-height: 200px; overflow-y: auto;" id="shortsBottomCheckboxes"></div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">or input:</label>
                                                <input type="text" class="form-control" id="shortsBottomCustom" name="shorts_bottom_custom" placeholder="Input here" style="border-radius: 6px;">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Order Items List -->
                <h6>Order Items</h6>
                {% if order_items %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Type</th>
                                    <th>Quantity</th>
                                    <th>Unit Price</th>
                                    <th>Total</th>
                                    <th>Stock Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in order_items %}
                                <tr id="order-item-{{ item.id }}">
                                    <td>{{ item.product.name }}</td>
                                    <td>
                                        <span class="badge bg-info">{{ item.product.get_product_type_display }}</span>
                                    </td>
                                    <td>
                                        <span class="item-quantity-display">{{ item.quantity }}</span>
                                        <div class="item-quantity-edit" style="display: none;">
                                            <form method="post" action="{% url 'update_order_item' order.id item.id %}" class="d-inline">
                                                {% csrf_token %}
                                                <div class="input-group input-group-sm" style="width: 120px;">
                                                    <input type="number" name="quantity" value="{{ item.quantity }}" min="1" class="form-control" required>
                                                    <button type="submit" class="btn btn-success btn-sm">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-secondary btn-sm" onclick="cancelEditItem({{ item.id }})">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </td>
                                    <td>â‚±{{ item.unit_price|floatformat:2 }}</td>
                                    <td class="item-total">â‚±{{ item.total_price|floatformat:2 }}</td>
                                    <td>
                                        {% if item.product.is_available %}
                                            <span class="text-success">
                                                <i class="fas fa-check-circle"></i> Available
                                            </span>
                                        {% else %}
                                            <span class="text-danger">
                                                <i class="fas fa-times-circle"></i> Out of Stock
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-primary btn-sm" onclick="editItem({{ item.id }})" title="Edit Quantity">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button type="button" class="btn btn-danger btn-sm" onclick="deleteItem({{ item.id }}, {{ order.id }}, '{{ item.product.name|escapejs }}')" title="Delete Item">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div>
                            <h5>Total Amount: <span class="text-primary">â‚±{{ order.total_amount|floatformat:2 }}</span></h5>
                        </div>
                        <div>
                            <a href="{% url 'order_payment' order.id %}" class="btn btn-success">
                                <i class="fas fa-credit-card me-2"></i>Proceed to Payment
                            </a>
                        </div>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-box-open fa-3x mb-3"></i>
                        <p>No items added to this order yet.</p>
                        <p>Select a product above to get started.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Order Details</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>Order ID:</strong><br>
                    <code>{{ order.order_id }}</code>
                </div>
                <div class="mb-3">
                    <strong>Customer:</strong><br>
                    {{ order.customer.name }}<br>
                    <small class="text-muted">{{ order.customer.phone }}</small>
                </div>
                <div class="mb-3">
                    <strong>Order Type:</strong><br>
                    <span class="badge bg-primary">{{ order.get_order_type_display }}</span>
                </div>
                {% if order.due_date %}
                <div class="mb-3">
                    <strong>Due Date:</strong><br>
                    {{ order.due_date|date:"M d, Y H:i" }}
                </div>
                {% endif %}
                {% if order.notes %}
                <div class="mb-3">
                    <strong>Notes:</strong><br>
                    <small>{{ order.notes }}</small>
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-list-ol me-2"></i>Order Process</h5>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center mb-2">
                    <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 30px; height: 30px;">
                        <i class="fas fa-check small"></i>
                    </div>
                    <span class="small">Order Information</span>
                </div>
                <div class="d-flex align-items-center mb-2">
                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 30px; height: 30px;">
                        <span class="small">2</span>
                    </div>
                    <span class="small">Add Items</span>
                </div>
                <div class="d-flex align-items-center mb-2">
                    <div class="bg-light text-muted rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 30px; height: 30px;">
                        <span class="small">3</span>
                    </div>
                    <span class="small text-muted">Payment</span>
                </div>
                <div class="d-flex align-items-center">
                    <div class="bg-light text-muted rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 30px; height: 30px;">
                        <span class="small">4</span>
                    </div>
                    <span class="small text-muted">Receipt & QR Code</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Rental Brochure Modal -->
<div class="modal fade" id="rentalBrochureModal" tabindex="-1" aria-labelledby="rentalBrochureModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content" style="background: linear-gradient(135deg, #1e3a5f 0%, #2d4a6e 100%); border: none;">
            <div class="modal-header" style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                <h5 class="modal-title" id="rentalBrochureModalLabel" style="color: white;">
                    <i class="fas fa-tshirt me-2"></i>Browse Rental Items
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto; color: #ffffff;">
                <div id="rentalStatusSummary" class="alert alert-warning mb-3" style="display: none; background: rgba(255, 193, 7, 0.2); border: 1px solid rgba(255, 193, 7, 0.5); color: #ffffff;">
                    <i class="fas fa-exclamation-triangle me-2" style="color: #ffffff;"></i>
                    <strong style="color: #ffffff;">Note:</strong> <span id="rentedItemsCount" style="color: #ffffff;">0</span> <span style="color: #ffffff;">item(s) are currently rented and cannot be selected.</span>
                </div>
                <div class="mb-3">
                    <label for="rentalCategoryFilter" class="form-label" style="color: #ffffff;">Filter by Category:</label>
                    <select id="rentalCategoryFilter" class="form-select" style="background: rgba(255,255,255,0.1); color: #ffffff !important; border: 1px solid rgba(255,255,255,0.2);">
                        <option value="" style="color: #ffffff; background: rgba(30, 58, 95, 0.9);">All Categories</option>
                    </select>
                </div>
                <div class="rental-items-grid" id="rentalItemsGrid" style="color: #ffffff;">
                    <!-- Rental items will be populated by JavaScript -->
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid rgba(255,255,255,0.1); color: #ffffff;">
                <div id="selectedRentalItemsDisplay" class="me-auto" style="color: #ffffff;"></div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="color: #ffffff;">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmRentalSelection()" style="color: #ffffff;">
                    <i class="fas fa-check me-2"></i>Add Selected Items
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Image Preview Modal -->
<div class="modal fade" id="imagePreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: linear-gradient(135deg, #1e3a5f 0%, #2d4a6e 100%); border: none;">
            <div class="modal-header" style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                <h5 class="modal-title" style="color: white;" id="previewProductName"></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="previewImage" src="" alt="Product Image" class="img-fluid" style="max-height: 500px; border-radius: 8px;">
                <div class="mt-3">
                    <h5 style="color: white;" id="previewProductPrice"></h5>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
    .rental-items-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
        padding: 20px 0;
    }
    
    .rental-item-card {
        border: none;
        padding: 8px;
        background: transparent;
        color: #ffffff !important;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        height: 200px;
        display: flex;
        flex-direction: column;
    }
    
    .rental-item-card * {
        color: #ffffff !important;
    }
    
    .rental-item-card div {
        color: #ffffff !important;
    }
    
    .rental-item-card span {
        color: #ffffff !important;
    }
    
    .rental-item-card:hover {
        background: rgba(0, 123, 255, 0.1);
        transform: translateY(-2px);
    }
    
    .rental-item-card.selected {
        background: rgba(30, 58, 138, 0.3);
        box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
    }
    
    .rental-item-card.rented {
        background: rgba(255, 140, 0, 0.3) !important;
        border: 3px solid #ff8c00 !important;
        box-shadow: 0 0 15px rgba(255, 140, 0, 0.7) !important;
        position: relative;
    }
    
    .rental-item-card.rented::before {
        content: "RENTED";
        position: absolute;
        top: 3px;
        right: 3px;
        background: #ff8c00;
        color: white;
        padding: 1px 4px;
        border-radius: 3px;
        font-size: 7px;
        font-weight: bold;
        z-index: 10;
    }
    
    .rental-item-card.overdue {
        background: rgba(220, 53, 69, 0.1) !important;
        border: 3px solid rgba(220, 53, 69, 0.9) !important;
        box-shadow: 0 0 15px rgba(220, 53, 69, 0.9) !important;
        position: relative;
    }
    
    .rental-item-card.overdue::before {
        content: "OVERDUE";
        position: absolute;
        top: 3px;
        right: 3px;
        background: rgba(220, 53, 69, 0.9);
        color: white;
        padding: 1px 4px;
        border-radius: 3px;
        font-size: 7px;
        font-weight: bold;
        z-index: 10;
    }
    
    .rental-item-card.overdue:hover {
        box-shadow: 0 0 20px rgba(220, 53, 69, 0.9) !important;
        transform: translateY(-2px);
        background: rgba(220, 53, 69, 0.15) !important;
    }
    
    .rental-item-card.overdue .rental-item-name,
    .rental-item-card.overdue .rental-item-price,
    .rental-item-card.overdue .rental-item-category {
        color: #ffffff !important;
    }
    
    .rental-item-card.overdue .rental-item-stock {
        background: rgba(220, 53, 69, 0.9) !important;
        color: white !important;
    }
    
    .rental-item-image {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 6px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: transform 0.3s ease;
        flex-shrink: 0;
    }
    
    .rental-item-image:hover {
        transform: scale(1.05);
    }
    
    .rental-item-name {
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 4px;
        color: #ffffff !important;
        flex-grow: 1;
    }
    
    .rental-item-price {
        font-size: 11px;
        font-weight: 500;
        margin-bottom: 4px;
        color: #ffffff !important;
    }
    
    .rental-item-category {
        font-size: 10px;
        color: #ffffff !important;
        margin-bottom: 4px;
    }
    
    .rental-item-stock {
        font-size: 10px;
        color: #ffffff !important;
        font-weight: 500;
        margin-bottom: 4px;
    }
    
    /* Ensure all status classes have white text */
    .rental-item-stock.available,
    .rental-item-stock.rented,
    .rental-item-stock.maintenance,
    .rental-item-stock.out-of-stock,
    .rental-item-stock.overdue {
        color: #ffffff !important;
    }
    
    .quantity-selector {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
        margin-top: 5px;
    }
    
    .quantity-selector input {
        width: 40px;
        text-align: center;
        background-color: #2d2d2d;
        color: #ffffff !important;
        border: 1px solid #444;
        border-radius: 3px;
        padding: 3px;
        font-size: 10px;
    }
    
    .quantity-selector button {
        width: 20px;
        height: 20px;
        background-color: #2d2d2d;
        color: #ffffff !important;
        border: 1px solid #444;
        border-radius: 3px;
        font-size: 10px;
        cursor: pointer;
    }
    
    /* Ensure all text in rental brochure modal is white */
    #rentalBrochureModal .modal-body,
    #rentalBrochureModal .modal-body *,
    #rentalBrochureModal .modal-footer,
    #rentalBrochureModal .modal-footer * {
        color: #ffffff !important;
    }
    
    /* Force all text in rental items grid to be white */
    #rentalItemsGrid,
    #rentalItemsGrid *,
    #rentalItemsGrid div,
    #rentalItemsGrid span,
    .rental-items-grid,
    .rental-items-grid *,
    .rental-items-grid div,
    .rental-items-grid span {
        color: #ffffff !important;
    }
    
    /* Override any Bootstrap or other framework styles */
    #rentalBrochureModal .rental-item-card,
    #rentalBrochureModal .rental-item-card *,
    #rentalBrochureModal .rental-item-name,
    #rentalBrochureModal .rental-item-price,
    #rentalBrochureModal .rental-item-category,
    #rentalBrochureModal .rental-item-stock {
        color: #ffffff !important;
    }
    
    /* Style select dropdown options */
    #rentalCategoryFilter option {
        color: #ffffff !important;
        background: rgba(30, 58, 95, 0.9) !important;
    }
    
    #rentalCategoryFilter option:hover,
    #rentalCategoryFilter option:checked,
    #rentalCategoryFilter option:focus {
        color: #ffffff !important;
        background: rgba(30, 58, 95, 1) !important;
    }
    
    .selected-items-display {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 10px;
        margin-top: 10px;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .selected-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px;
        margin-bottom: 5px;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        color: #333;
    }
    
    .selected-item-info {
        flex: 1;
    }
    
    .selected-item-name {
        font-weight: 600;
        margin-bottom: 2px;
        color: #333;
    }
    
    .selected-item-details {
        font-size: 0.85rem;
        color: #6c757d;
    }
    
    .selected-item-price {
        font-weight: 600;
        margin: 0 10px;
        color: #28a745;
    }
    
    .remove-item-btn {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 18px;
        line-height: 1;
        padding: 0;
    }
    
    .remove-item-btn:hover {
        background: #c82333;
    }
</style>

<script>
    // Global variables for rental brochure
    let selectedRentalProducts = [];
    let allRentalProducts = [];
    let rentalBrochureModal = null;
    let imagePreviewModal = null;

    // Initialize modals
    document.addEventListener('DOMContentLoaded', function() {
        const modalElement = document.getElementById('rentalBrochureModal');
        const imageModalElement = document.getElementById('imagePreviewModal');
        
        if (modalElement) {
            rentalBrochureModal = new bootstrap.Modal(modalElement, {
                backdrop: false
            });
        } else {
            console.error('Rental brochure modal element not found');
        }
        
        if (imageModalElement) {
            imagePreviewModal = new bootstrap.Modal(imageModalElement, {
                backdrop: false
            });
        }
        
    });

    // Setup event listeners for rental brochure
    function setupEventListeners() {
        // Category filter
        const categoryFilter = document.getElementById('rentalCategoryFilter');
        if (categoryFilter) {
            categoryFilter.addEventListener('change', function() {
                displayRentalProducts();
            });
        }
    }

    // Make functions globally accessible
    window.openRentalBrochure = function() {
        console.log('Opening rental brochure...');
        try {
            if (!rentalBrochureModal) {
                const modalElement = document.getElementById('rentalBrochureModal');
                if (modalElement) {
                    rentalBrochureModal = new bootstrap.Modal(modalElement, {
                        backdrop: false
                    });
                } else {
                    alert('Rental brochure modal not found. Please refresh the page.');
                    return;
                }
            }
            
            rentalBrochureModal.show();
            setupEventListeners();
            loadRentalProducts();
        } catch (error) {
            console.error('Error opening rental brochure:', error);
            alert('Error opening rental brochure. Please check the console for details.');
        }
    };
    
    // Alias for backward compatibility
    function openRentalBrochure() {
        window.openRentalBrochure();
    }

    // Load rental products
    function loadRentalProducts() {
        console.log('Loading rental products...');
        fetch('/api/products/', { credentials: 'same-origin' })
            .then(response => {
                const ct = response.headers.get('content-type') || '';
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.status);
                }
                if (ct.includes('application/json')) {
                    return response.json();
                }
                throw new Error('Unexpected content-type: ' + ct);
            })
            .then(data => {
                console.log('Products loaded:', data);
                // Handle both response formats: {success: true, products: [...]} or {products: [...]}
                if (data.success && data.products) {
                    allRentalProducts = data.products;
                } else if (data.products) {
                    allRentalProducts = data.products;
                } else if (Array.isArray(data)) {
                    allRentalProducts = data;
                } else {
                    console.error('Unexpected API response format:', data);
                    allRentalProducts = [];
                }
                
                // Filter only rental products
                allRentalProducts = allRentalProducts.filter(p => p.product_type === 'rental');
                
                // Ensure is_rented flag is set based on rental_status (API now provides this, but ensure consistency)
                allRentalProducts.forEach(product => {
                    // FIX: For rental items, check if they're actually in active orders
                    // If rental_status is 'rented' but is_rented is false, it means the order was returned
                    if (product.rental_status === 'rented' && product.is_rented === false) {
                        // Product was marked as rented but is not actually rented - fix it
                        product.rental_status = 'available';
                        product.is_rented = false;
                    }
                    
                    if (product.is_rented === undefined) {
                        product.is_rented = product.rental_status === 'rented';
                    }
                    // Ensure rental_status matches is_rented
                    if (product.is_rented && product.rental_status !== 'rented' && product.rental_status !== 'maintenance') {
                        product.rental_status = 'rented';
                    }
                    // If not rented, ensure status is available (not maintenance)
                    if (!product.is_rented && product.rental_status !== 'maintenance') {
                        product.rental_status = 'available';
                    }
                    // For rental items, is_available should be based on rental_status, not quantity
                    if (product.product_type === 'rental') {
                        product.is_available = product.rental_status === 'available';
                    }
                    // Ensure is_overdue and is_almost_due flags are set (API provides these)
                    if (product.is_overdue === undefined) {
                        product.is_overdue = product.rental_status === 'overdue' || false;
                    }
                    if (product.is_almost_due === undefined) {
                        product.is_almost_due = false;
                    }
                });
                
                // Display products immediately with accurate status
                displayRentalProducts();
                
                // Load rental status after products are loaded (as a refresh/update mechanism)
                setTimeout(() => {
                    loadRentalStatus();
                }, 500);
            })
            .catch(error => {
                console.error('Error loading products:', error);
                allRentalProducts = [];
                displayRentalProducts();
            });
    }

    // Load rental status
    function loadRentalStatus() {
        fetch('/api/rental-status/', { credentials: 'same-origin' })
            .then(response => {
                const ct = response.headers.get('content-type') || '';
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.status);
                }
                if (ct.includes('application/json')) {
                    return response.json();
                }
                throw new Error('Unexpected content-type: ' + ct);
            })
            .then(data => {
                if (data.success) {
                    // Handle different API response formats
                    let rentedProductIds = [];
                    
                    if (data.rented_products && Array.isArray(data.rented_products)) {
                        // Format: {success: true, rented_products: [1, 2, 3]}
                        rentedProductIds = data.rented_products;
                    } else if (data.rental_status && typeof data.rental_status === 'object') {
                        // Format: {success: true, rental_status: {1: {is_rented: true}, 2: {is_rented: false}}}
                        rentedProductIds = Object.keys(data.rental_status)
                            .filter(id => data.rental_status[id].is_rented)
                            .map(id => parseInt(id));
                    }
                    
                    // Update product rental status
                    allRentalProducts.forEach(product => {
                        if (rentedProductIds.includes(product.id)) {
                            product.rental_status = 'rented';
                            product.is_rented = true;
                            
                            // Check for overdue/almost due status from API
                            const statusInfo = data.rental_status && data.rental_status[product.id];
                            if (statusInfo) {
                                product.is_overdue = statusInfo.is_overdue || false;
                                product.is_almost_due = statusInfo.is_almost_due || false;
                            }
                        } else if (product.rental_status !== 'maintenance') {
                            product.rental_status = 'available';
                            product.is_rented = false;
                            product.is_overdue = false;
                            product.is_almost_due = false;
                            // For rental items, is_available should be true when status is available
                            if (product.product_type === 'rental') {
                                product.is_available = true;
                            }
                        }
                    });
                    
                    // Refresh display to show rented status
                    displayRentalProducts();
                }
            })
            .catch(error => {
                console.error('Error loading rental status:', error);
                // Still refresh display even if status load fails
                displayRentalProducts();
            });
    }

    // Populate category filter (called from displayRentalProducts if needed)
    function populateCategoryFilter() {
        const filter = document.getElementById('rentalCategoryFilter');
        if (!filter) return;
        
        const categories = [...new Set(allRentalProducts.map(p => p.category).filter(Boolean))];
        
        // Only populate if not already populated
        if (filter.options.length <= 1) {
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                option.style.color = '#ffffff';
                option.style.background = 'rgba(30, 58, 95, 0.9)';
                filter.appendChild(option);
            });
        }
    }

    // Display rental products
    function displayRentalProducts() {
        const grid = document.getElementById('rentalItemsGrid');
        if (!grid) return;
        
        grid.innerHTML = '';
        
        const filteredProducts = filterRentalProducts();
        
        // Count rented items
        const rentedCount = filteredProducts.filter(p => p.is_rented === true || p.rental_status === 'rented').length;
        const availableCount = filteredProducts.length - rentedCount;
        
        // Update rental status summary
        const summaryDiv = document.getElementById('rentalStatusSummary');
        const rentedCountSpan = document.getElementById('rentedItemsCount');
        if (summaryDiv && rentedCountSpan) {
            if (rentedCount > 0) {
                rentedCountSpan.textContent = rentedCount;
                summaryDiv.style.display = 'block';
            } else {
                summaryDiv.style.display = 'none';
            }
        }
        
        filteredProducts.forEach(product => {
            const card = createRentalItemCard(product);
            grid.appendChild(card);
        });
        
        // Populate category filter if needed
        populateCategoryFilter();
        
        updateSelectedItemsDisplay();
    }

    // Filter rental products
    function filterRentalProducts() {
        const categoryFilter = document.getElementById('rentalCategoryFilter');
        const categoryValue = categoryFilter ? categoryFilter.value : '';
        
        let filtered = allRentalProducts;
        
        if (categoryValue) {
            filtered = allRentalProducts.filter(product => 
                product.category && product.category.toLowerCase() === categoryValue.toLowerCase()
            );
        }
        
        return filtered;
    }

    // Create rental item card
    function createRentalItemCard(product) {
        const card = document.createElement('div');
        card.className = 'rental-item-card';
        card.setAttribute('data-product-id', product.id);
        
        // Check if product is rented (handle both is_rented flag and rental_status)
        const isRented = product.is_rented === true || product.rental_status === 'rented';
        
        // Add rented or overdue class if product is rented
        if (isRented) {
            // Check if overdue or almost due
            const isOverdue = product.is_overdue === true || product.is_almost_due === true;
            if (isOverdue) {
                card.classList.add('overdue');
            } else {
                card.classList.add('rented');
            }
            product.rental_status = 'rented';
            product.is_rented = true;
        }
        
        const isSelected = selectedRentalProducts.some(p => p.id === product.id);
        if (isSelected) {
            card.classList.add('selected');
        }
        
        // Determine status display
        let statusDisplay = 'Available';
        let statusClass = 'available';
        
        if (isRented) {
            // Check if overdue or almost due
            const isOverdue = product.is_overdue === true || product.is_almost_due === true;
            if (isOverdue) {
                statusDisplay = 'OVERDUE';
                statusClass = 'overdue';
            } else {
                statusDisplay = 'RENTED';
                statusClass = 'rented';
            }
        } else if (product.rental_status === 'maintenance') {
            statusDisplay = 'Maintenance';
            statusClass = 'maintenance';
        } else if (!product.is_available && product.product_type !== 'rental') {
            // Only show "Out of Stock" for non-rental items
            // For rental items, if not available, it means it's rented
            statusDisplay = 'Out of Stock';
            statusClass = 'out-of-stock';
        } else if (product.product_type === 'rental' && !product.is_available && !isRented) {
            // For rental items, if not available and not rented, it should be available
            // This handles cases where is_available is incorrectly false
            statusDisplay = 'Available';
            statusClass = 'available';
            product.is_available = true;
            product.rental_status = 'available';
        }
        
        card.innerHTML = `
            <img src="${product.image || '/static/images/placeholder.png'}" 
                 alt="${product.name}" 
                 class="rental-item-image"
                 onclick="showImagePreview('${product.image || '/static/images/placeholder.png'}', '${product.name}', 'â‚±${product.price}')">
            <div class="rental-item-name" style="color: #ffffff !important;">${product.name}</div>
            <div class="rental-item-price" style="color: #ffffff !important;">â‚±${product.price}</div>
            <div class="rental-item-category" style="color: #ffffff !important;">${product.category}</div>
            <div class="rental-item-stock ${statusClass}" style="color: #ffffff !important;">${statusDisplay}</div>
            ${isSelected ? `
                <div class="quantity-selector">
                    <button type="button" onclick="updateQuantity(${product.id}, -1)" style="color: #ffffff !important;">-</button>
                    <input type="number" value="${getSelectedProductQuantity(product.id)}" min="1" max="${product.quantity}" 
                           onchange="updateQuantity(${product.id}, 0, this.value)" style="color: #ffffff !important;">
                    <button type="button" onclick="updateQuantity(${product.id}, 1)" style="color: #ffffff !important;">+</button>
                </div>
            ` : ''}
        `;
        
        card.addEventListener('click', function(e) {
            if (!e.target.classList.contains('rental-item-image') && 
                !e.target.classList.contains('quantity-selector') &&
                !e.target.closest('.quantity-selector')) {
                selectRentalProduct(product);
            }
        });
        
        return card;
    }

    // Select rental product
    function selectRentalProduct(product) {
        // Prevent selection of rented items (check both is_rented flag and rental_status)
        const isRented = product.is_rented === true || product.rental_status === 'rented';
        
        if (isRented) {
            alert(`Cannot select "${product.name}" - This item is currently rented out. Please select an available item.`);
            return;
        }
        
        // Prevent selection of items under maintenance
        if (product.rental_status === 'maintenance') {
            alert(`Cannot select "${product.name}" - This item is under maintenance. Please select an available item.`);
            return;
        }
        
        // Prevent selection of out of stock items
        if (!product.is_available) {
            alert(`Cannot select "${product.name}" - This item is out of stock. Please select an available item.`);
            return;
        }
        
        const existingIndex = selectedRentalProducts.findIndex(p => p.id === product.id);
        
        if (existingIndex >= 0) {
            // Remove from selection
            selectedRentalProducts.splice(existingIndex, 1);
        } else {
            // Add to selection
            selectedRentalProducts.push({
                ...product,
                quantity: 1
            });
        }
        
        updateSelectedItemsDisplay();
        displayRentalProducts(); // Refresh to update selection state
    }


    // Get selected product quantity
    function getSelectedProductQuantity(productId) {
        const product = selectedRentalProducts.find(p => p.id === productId);
        return product ? product.quantity : 1;
    }

    // Update selected items display
    function updateSelectedItemsDisplay() {
        const container = document.getElementById('selectedRentalItems');
        const modalContainer = document.getElementById('selectedRentalItemsDisplay');
        const addBtn = document.getElementById('addSelectedItemsBtn');
        
        if (selectedRentalProducts.length === 0) {
            if (container) {
                container.innerHTML = '<div class="text-muted text-center py-2">No items selected. Click "Browse Rental Items" to select products.</div>';
            }
            if (modalContainer) {
                modalContainer.innerHTML = '<span class="text-muted">No items selected</span>';
            }
            if (addBtn) {
                addBtn.style.display = 'none';
            }
            return;
        }
        
        const totalQuantity = selectedRentalProducts.reduce((sum, product) => sum + product.quantity, 0);
        const totalPrice = selectedRentalProducts.reduce((sum, product) => sum + (product.price * product.quantity), 0);
        
        // Update modal footer
        if (modalContainer) {
            modalContainer.innerHTML = `
                <strong>${selectedRentalProducts.length} item(s) selected (${totalQuantity} total) - â‚±${totalPrice.toFixed(2)}</strong>
            `;
        }
        
        // Update main display below button (matching create_order format)
        if (container) {
            container.innerHTML = `
                <div class="selected-items-display">
                    ${selectedRentalProducts.map(product => `
                        <div class="selected-item">
                            <div class="selected-item-info">
                                <div class="selected-item-name">${product.name}</div>
                                <div class="selected-item-details">${product.category} â€¢ Qty: ${product.quantity}</div>
                            </div>
                            <div class="selected-item-price">â‚±${product.price * product.quantity}</div>
                            <button type="button" class="remove-item-btn" onclick="removeRentalProduct(${product.id})">Ã—</button>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        // Show add button
        if (addBtn) {
            addBtn.style.display = 'block';
        }
    }
    
    // Confirm rental selection (just close modal and update display)
    window.confirmRentalSelection = function() {
        if (selectedRentalProducts.length === 0) {
            alert('Please select at least one rental item');
            return;
        }
        
        rentalBrochureModal.hide();
        updateSelectedItemsDisplay();
    };
    
    // Alias for backward compatibility
    function confirmRentalSelection() {
        window.confirmRentalSelection();
    }
    
    // Add selected items to order
    window.addSelectedItemsToOrder = async function() {
        if (selectedRentalProducts.length === 0) {
            alert('Please select at least one rental item');
            return;
        }
        
        // Disable button to prevent double submission
        const addBtn = document.getElementById('addSelectedItemsBtn');
        if (addBtn) {
            addBtn.disabled = true;
            addBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Adding...';
        }
        
        // Add each selected product to the order
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        let addedCount = 0;
        let errorCount = 0;
        
        // Process all products sequentially
        for (const product of selectedRentalProducts) {
            try {
                const formData = new FormData();
                formData.append('product_id', product.id);
                formData.append('quantity', product.quantity);
                formData.append('csrfmiddlewaretoken', csrfToken);
                
                const response = await fetch(window.location.pathname, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                if (response.ok) {
                    addedCount++;
                } else {
                    errorCount++;
                }
            } catch (error) {
                console.error('Error adding product:', error);
                errorCount++;
            }
        }
        
        // Clear selection
        selectedRentalProducts = [];
        updateSelectedItemsDisplay();
        
        // Show result and reload
        if (addedCount > 0) {
            if (errorCount > 0) {
                alert(`Added ${addedCount} item(s) successfully. ${errorCount} item(s) could not be added.`);
            } else {
                // Show success message briefly before reload
                if (addBtn) {
                    addBtn.innerHTML = '<i class="fas fa-check me-2"></i>Added Successfully!';
                    addBtn.classList.remove('btn-success');
                    addBtn.classList.add('btn-success');
                }
            }
            // Reload after a short delay
            setTimeout(() => {
                window.location.reload();
            }, 500);
        } else {
            alert('No items could be added. Please try again.');
            if (addBtn) {
                addBtn.disabled = false;
                addBtn.innerHTML = '<i class="fas fa-plus me-2"></i>Add Selected Items to Order';
            }
        }
    };
    
    // Alias for backward compatibility
    async function addSelectedItemsToOrder() {
        return window.addSelectedItemsToOrder();
    }
    
    // Remove rental product from selection
    window.removeRentalProduct = function(productId) {
        selectedRentalProducts = selectedRentalProducts.filter(p => p.id !== productId);
        updateSelectedItemsDisplay();
        // Refresh modal if open
        if (rentalBrochureModal && document.getElementById('rentalBrochureModal').classList.contains('show')) {
            displayRentalProducts();
        }
    };
    
    // Update quantity
    window.updateQuantity = function(productId, change, newValue = null) {
        const product = selectedRentalProducts.find(p => p.id === productId);
        if (product) {
            if (newValue !== null) {
                product.quantity = parseInt(newValue) || 1;
            } else {
                product.quantity = Math.max(1, product.quantity + change);
            }
            updateSelectedItemsDisplay();
            displayRentalProducts(); // Refresh to update quantity display
        }
    };
    
    // Show image preview
    window.showImagePreview = function(imageSrc, productName, productPrice) {
        document.getElementById('previewImage').src = imageSrc;
        document.getElementById('previewProductName').textContent = productName;
        document.getElementById('previewProductPrice').textContent = productPrice;
        imagePreviewModal.show();
    };

    // Quick add form handler
    const productSelect = document.getElementById('product_id');
    if (productSelect) {
        productSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const quantityInput = document.getElementById('quantity');
        
        if (selectedOption.value) {
            const maxQuantity = parseInt(selectedOption.dataset.quantity);
            quantityInput.max = maxQuantity;
            quantityInput.value = Math.min(1, maxQuantity);
                
                // Check if product type is customize
                const productType = selectedOption.dataset.type;
                const poloSection = document.getElementById('poloCustomizationSection');
                const selectedProductDisplay = document.getElementById('selectedCustomizeProductDisplay');
                
                if (productType === 'customize' || productType === 'service') {
                    if (poloSection) {
                        poloSection.style.display = 'block';
                    }
                    
                    // Fetch product details including measurements
                    fetch(`/api/product/${selectedOption.value}/detail/`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success && data.product) {
                                const product = data.product;
                                
                                // Display product image
                                const productImage = document.getElementById('selectedProductImage');
                                if (product.image_url) {
                                    productImage.src = product.image_url;
                                    productImage.style.display = 'block';
                                } else {
                                    productImage.style.display = 'none';
                                }
                                
                                // Display measurements
                                displayProductMeasurements(product);
                                
                                // Show the selected product display
                                if (selectedProductDisplay) {
                                    selectedProductDisplay.style.display = 'block';
                                }
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching product details:', error);
                        });
                } else {
                    if (poloSection) {
                        poloSection.style.display = 'none';
                    }
                    if (selectedProductDisplay) {
                        selectedProductDisplay.style.display = 'none';
                    }
                }
            } else {
                const poloSection = document.getElementById('poloCustomizationSection');
                const selectedProductDisplay = document.getElementById('selectedCustomizeProductDisplay');
                if (poloSection) {
                    poloSection.style.display = 'none';
                }
                if (selectedProductDisplay) {
                    selectedProductDisplay.style.display = 'none';
                }
            }
        });
    }
    
    // Function to display product measurements
    function displayProductMeasurements(product) {
        const measurementsContainer = document.getElementById('selectedProductMeasurements');
        if (!measurementsContainer) return;
        
        measurementsContainer.innerHTML = '';
        
        // Format measurement names (convert snake_case to Title Case)
        const formatMeasurementName = (name) => {
            return name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        };
        
        // Define expected measurements for each category/type
        const categoryMeasurements = {
            'polo': ['length', 'bust', 'waist', 'hips', 'shoulder', 'sleeve', 'armhole', 'neckline'],
            'polo_shirt': ['length', 'bust', 'waist', 'hips', 'shoulder', 'sleeve', 'armhole', 'neckline'],
            'blouse': ['length', 'bust', 'waist', 'hips', 'shoulder', 'sleeve', 'armhole', 'neckline'],
            'pe_tshirt': ['length', 'bust', 'waist', 'hips', 'shoulder', 'sleeve', 'armhole', 'neckline'],
            'tshirt': ['length', 'bust', 'waist', 'hips', 'shoulder', 'sleeve', 'armhole', 'neckline'],
            't-shirt': ['length', 'bust', 'waist', 'hips', 'shoulder', 'sleeve', 'armhole', 'neckline'],
            'pants': ['length', 'crotch', 'waist', 'hips', 'thigh', 'knee', 'bottom'],
            'pe_pants': ['length', 'crotch', 'waist', 'hips', 'thigh', 'knee', 'bottom'],
            'short': ['length', 'waist', 'crotch', 'hips', 'bottom'],
            'shorts': ['length', 'waist', 'crotch', 'hips', 'bottom'],
            'skirt/palda': ['waist', 'hips', 'length', 'hem_width'],
            'skirt': ['waist', 'hips', 'length', 'hem_width'],
            'palda': ['waist', 'hips', 'length', 'hem_width'],
            // Fullset measurements - will be determined by gender
            'fullset_male': ['length', 'bust', 'waist', 'hips', 'shoulder', 'sleeve', 'armhole', 'neckline', 'crotch', 'thigh', 'knee', 'bottom'],
            'fullset_female': ['length', 'bust', 'waist', 'hips', 'shoulder', 'sleeve', 'armhole', 'neckline', 'waist', 'hips', 'length', 'hem_width']
        };
        
        // Define top and bottom measurements separately for fullset
        const topMeasurements = ['length', 'bust', 'waist', 'hips', 'shoulder', 'sleeve', 'armhole', 'neckline'];
        const pantsMeasurements = ['length', 'crotch', 'waist', 'hips', 'thigh', 'knee', 'bottom'];
        const skirtMeasurements = ['waist', 'hips', 'length', 'hem_width'];
        
        // Get expected measurements for this product category
        // Normalize category name - handle various formats
        let category = product.category ? product.category.toLowerCase().trim() : '';
        // Handle category name variations
        category = category.replace(/\s+/g, '_'); // Replace spaces with underscores
        category = category.replace(/\//g, '_'); // Replace slashes with underscores
        
        // Check for gender in description for fullset products
        let gender = '';
        if (product.description) {
            const genderMatch = product.description.match(/Gender:\s*(\w+)/i);
            if (genderMatch) {
                gender = genderMatch[1].toLowerCase();
            }
        }
        
        // Try multiple category name formats
        let expectedMeasurements = categoryMeasurements[category] || [];
        
        // If not found, try without underscores (e.g., "poloshirt" vs "polo_shirt")
        if (expectedMeasurements.length === 0) {
            const categoryNoUnderscore = category.replace(/_/g, '');
            expectedMeasurements = categoryMeasurements[categoryNoUnderscore] || [];
        }
        
        // If still not found, try partial matches (e.g., if category is "Polo Shirt" but we have "polo")
        if (expectedMeasurements.length === 0) {
            for (const [catKey, measurements] of Object.entries(categoryMeasurements)) {
                if (category.includes(catKey) || catKey.includes(category)) {
                    expectedMeasurements = measurements;
                    break;
                }
            }
        }
        
        // Also check product name for type hints
        if (expectedMeasurements.length === 0 && product.name) {
            const productNameLower = product.name.toLowerCase();
            for (const [catKey, measurements] of Object.entries(categoryMeasurements)) {
                if (productNameLower.includes(catKey.replace(/_/g, ' ')) || productNameLower.includes(catKey)) {
                    expectedMeasurements = measurements;
                    break;
                }
            }
        }
        
        // Handle fullset with gender
        if (category === 'fullset' && gender) {
            let topToShow = [];
            let bottomToShow = [];
            
            if (gender === 'male') {
                // Male Fullset: Polo (top) + Pants (bottom)
                topToShow = topMeasurements;
                bottomToShow = pantsMeasurements;
            } else if (gender === 'female') {
                // Female Fullset: Blouse (top) + Skirt/Palda (bottom)
                topToShow = topMeasurements;
                bottomToShow = skirtMeasurements;
            }
            
            // Display top measurements
            if (topToShow.length > 0) {
                const topHeader = document.createElement('div');
                topHeader.className = 'col-12 mb-2';
                topHeader.innerHTML = `<h6 class="fw-bold">Top Measurements (${gender === 'male' ? 'Polo' : 'Blouse'})</h6>`;
                measurementsContainer.appendChild(topHeader);
                
                topToShow.forEach(key => {
                    let value = '-';
                    if (product.measurements && typeof product.measurements === 'object' && product.measurements.hasOwnProperty(key)) {
                        const rawValue = product.measurements[key];
                        if (rawValue !== null && rawValue !== undefined && String(rawValue).trim() !== '') {
                            value = String(rawValue).trim();
                        }
                    }
                    
                    const measurementCol = document.createElement('div');
                    measurementCol.className = 'col-md-6 mb-2';
                    measurementCol.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center p-2" style="background: #f8f9fa; border-radius: 4px;">
                            <strong>${formatMeasurementName(key)}:</strong>
                            <span>${value}</span>
                        </div>
                    `;
                    measurementsContainer.appendChild(measurementCol);
                });
            }
            
            // Display bottom measurements
            if (bottomToShow.length > 0) {
                const bottomHeader = document.createElement('div');
                bottomHeader.className = 'col-12 mb-2 mt-3';
                bottomHeader.innerHTML = `<h6 class="fw-bold">Bottom Measurements (${gender === 'male' ? 'Pants' : 'Skirt/Palda'})</h6>`;
                measurementsContainer.appendChild(bottomHeader);
                
                bottomToShow.forEach(key => {
                    let value = '-';
                    if (product.measurements && typeof product.measurements === 'object' && product.measurements.hasOwnProperty(key)) {
                        const rawValue = product.measurements[key];
                        if (rawValue !== null && rawValue !== undefined && String(rawValue).trim() !== '') {
                            value = String(rawValue).trim();
                        }
                    }
                    
                    const measurementCol = document.createElement('div');
                    measurementCol.className = 'col-md-6 mb-2';
                    measurementCol.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center p-2" style="background: #f8f9fa; border-radius: 4px;">
                            <strong>${formatMeasurementName(key)}:</strong>
                            <span>${value}</span>
                        </div>
                    `;
                    measurementsContainer.appendChild(measurementCol);
                });
            }
        } else {
            // For non-fullset or fullset without gender, use standard display
            const measurementsToShow = expectedMeasurements.length > 0 ? expectedMeasurements : [];
            
            // Display ONLY the expected measurements for this product type
            if (measurementsToShow.length > 0) {
                measurementsToShow.forEach(key => {
                    let value = '-';
                    
                    // Check if measurements exist and have this key
                    if (product.measurements && typeof product.measurements === 'object') {
                        if (product.measurements.hasOwnProperty(key)) {
                            const rawValue = product.measurements[key];
                            // Only show '-' if value is truly empty (null, undefined, empty string, or whitespace)
                            if (rawValue !== null && rawValue !== undefined && String(rawValue).trim() !== '') {
                                value = String(rawValue).trim();
                            }
                        }
                    }
                    
                    const measurementCol = document.createElement('div');
                    measurementCol.className = 'col-md-6 mb-2';
                    measurementCol.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center p-2" style="background: #f8f9fa; border-radius: 4px;">
                            <strong>${formatMeasurementName(key)}:</strong>
                            <span>${value}</span>
                        </div>
                    `;
                    measurementsContainer.appendChild(measurementCol);
                });
            } else {
                // If no expected measurements found, show a message
                const noMeasurementsMsg = document.createElement('div');
                noMeasurementsMsg.className = 'col-12';
                noMeasurementsMsg.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        No measurements available for this product type.
                    </div>
                `;
                measurementsContainer.appendChild(noMeasurementsMsg);
            }
        }
    }
    
    // Polo customization type handler - show/hide measurements section
    const poloCustomizationSelect = document.getElementById('poloCustomization');
    const poloMeasurementsSection = document.getElementById('poloMeasurementsSection');
    const poloShirtMeasurementsSection = document.getElementById('poloShirtMeasurementsSection');
    const blouseMeasurementsSection = document.getElementById('blouseMeasurementsSection');
    const pantsMeasurementsSection = document.getElementById('pantsMeasurementsSection');
    const shortsMeasurementsSection = document.getElementById('shortsMeasurementsSection');
    
    function toggleMeasurementsSections() {
        if (poloCustomizationSelect) {
            const selectedValue = poloCustomizationSelect.value;
            
            // Hide all sections first
            if (poloMeasurementsSection) poloMeasurementsSection.style.display = 'none';
            if (poloShirtMeasurementsSection) poloShirtMeasurementsSection.style.display = 'none';
            if (blouseMeasurementsSection) blouseMeasurementsSection.style.display = 'none';
            if (pantsMeasurementsSection) pantsMeasurementsSection.style.display = 'none';
            if (shortsMeasurementsSection) shortsMeasurementsSection.style.display = 'none';
            
            // Show appropriate section based on selection
            if (selectedValue === 'polo') {
                if (poloMeasurementsSection) poloMeasurementsSection.style.display = 'block';
            } else if (selectedValue === 'polo_shirt') {
                if (poloShirtMeasurementsSection) poloShirtMeasurementsSection.style.display = 'block';
            } else if (selectedValue === 'blouse') {
                if (blouseMeasurementsSection) blouseMeasurementsSection.style.display = 'block';
            } else if (selectedValue === 'pants') {
                if (pantsMeasurementsSection) pantsMeasurementsSection.style.display = 'block';
            } else if (selectedValue === 'shorts') {
                if (shortsMeasurementsSection) shortsMeasurementsSection.style.display = 'block';
            }
        }
    }
    
    if (poloCustomizationSelect) {
        poloCustomizationSelect.addEventListener('change', toggleMeasurementsSections);
        // Initialize on page load
        toggleMeasurementsSections();
    }
    
    // Helper function to generate checkboxes
    function generateCheckboxes(containerId, values, namePrefix) {
        const container = document.getElementById(containerId);
        if (!container) return;
        
        container.innerHTML = '';
        values.forEach(value => {
            const checkboxDiv = document.createElement('div');
            checkboxDiv.className = 'form-check';
            checkboxDiv.innerHTML = `
                <input class="form-check-input" type="checkbox" name="${namePrefix}" value="${value}" id="${namePrefix}_${value}">
                <label class="form-check-label" for="${namePrefix}_${value}">${value}</label>
            `;
            container.appendChild(checkboxDiv);
        });
    }
    
    // Generate checkboxes for all measurement types
    function generateAllCheckboxes() {
        // Polo measurements
        generateCheckboxes('poloNecklineCheckboxes', [10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30], 'polo_neckline_checkbox');
        generateCheckboxes('poloBustCheckboxes', [30,31,32,33,34,35,36,37,39,40,41,42,43,44,45,46,47,48,49,50], 'polo_bust_checkbox');
        generateCheckboxes('poloArmholeCheckboxes', [10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30], 'polo_armhole_checkbox');
        generateCheckboxes('poloShouldersCheckboxes', [10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30], 'polo_shoulders_checkbox');
        generateCheckboxes('poloWaistCheckboxes', [30,31,32,33,34,35,36,37,39,40,41,42,43,44,45,46,47,48,49,50], 'polo_waist_checkbox');
        generateCheckboxes('poloSleeveCheckboxes', [5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28], 'polo_sleeve_checkbox');
        generateCheckboxes('poloHipsCheckboxes', [30,31,32,33,34,35,36,37,39,40,41,42,43,44,45,46,47,48,49,50], 'polo_hips_checkbox');
        generateCheckboxes('poloLengthCheckboxes', [10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30], 'polo_length_checkbox');
        
        // Polo Shirt measurements (same as Polo)
        generateCheckboxes('poloShirtNecklineCheckboxes', [10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30], 'polo_shirt_neckline_checkbox');
        generateCheckboxes('poloShirtBustCheckboxes', [30,31,32,33,34,35,36,37,39,40,41,42,43,44,45,46,47,48,49,50], 'polo_shirt_bust_checkbox');
        generateCheckboxes('poloShirtArmholeCheckboxes', [10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30], 'polo_shirt_armhole_checkbox');
        generateCheckboxes('poloShirtShouldersCheckboxes', [10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30], 'polo_shirt_shoulders_checkbox');
        generateCheckboxes('poloShirtWaistCheckboxes', [30,31,32,33,34,35,36,37,39,40,41,42,43,44,45,46,47,48,49,50], 'polo_shirt_waist_checkbox');
        generateCheckboxes('poloShirtSleeveCheckboxes', [5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28], 'polo_shirt_sleeve_checkbox');
        generateCheckboxes('poloShirtHipsCheckboxes', [30,31,32,33,34,35,36,37,39,40,41,42,43,44,45,46,47,48,49,50], 'polo_shirt_hips_checkbox');
        generateCheckboxes('poloShirtLengthCheckboxes', [10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30], 'polo_shirt_length_checkbox');
        
        // Blouse measurements (same as Polo)
        generateCheckboxes('blouseNecklineCheckboxes', [10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30], 'blouse_neckline_checkbox');
        generateCheckboxes('blouseBustCheckboxes', [30,31,32,33,34,35,36,37,39,40,41,42,43,44,45,46,47,48,49,50], 'blouse_bust_checkbox');
        generateCheckboxes('blouseArmholeCheckboxes', [10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30], 'blouse_armhole_checkbox');
        generateCheckboxes('blouseShouldersCheckboxes', [10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30], 'blouse_shoulders_checkbox');
        generateCheckboxes('blouseWaistCheckboxes', [30,31,32,33,34,35,36,37,39,40,41,42,43,44,45,46,47,48,49,50], 'blouse_waist_checkbox');
        generateCheckboxes('blouseSleeveCheckboxes', [5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28], 'blouse_sleeve_checkbox');
        generateCheckboxes('blouseHipsCheckboxes', [30,31,32,33,34,35,36,37,39,40,41,42,43,44,45,46,47,48,49,50], 'blouse_hips_checkbox');
        generateCheckboxes('blouseLengthCheckboxes', [10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30], 'blouse_length_checkbox');
        
        // Pants measurements
        generateCheckboxes('pantsLengthCheckboxes', [30,31,32,33,34,35,36,37,39,40,41,42,43,44,45,46,47,48,49,50], 'pants_length_checkbox');
        generateCheckboxes('pantsWaistCheckboxes', [30,31,32,33,34,35,36,37,39,40,41,42,43,44,45,46,47,48,49,50], 'pants_waist_checkbox');
        generateCheckboxes('pantsCrotchCheckboxes', [21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,39,40], 'pants_crotch_checkbox');
        generateCheckboxes('pantsHipsCheckboxes', [30,31,32,33,34,35,36,37,39,40,41,42,43,44,45,46,47,48,49,50], 'pants_hips_checkbox');
        generateCheckboxes('pantsThighCheckboxes', [21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,39,40], 'pants_thigh_checkbox');
        generateCheckboxes('pantsKneeCheckboxes', [21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,39,40], 'pants_knee_checkbox');
        generateCheckboxes('pantsHipsCircumferenceCheckboxes', [30,31,32,33,34,35,36,37,39,40,41,42,43,44,45,46,47,48,49,50], 'pants_hips_circumference_checkbox');
        generateCheckboxes('pantsBottomCheckboxes', [30,31,32,33,34,35,36,37,39,40,41,42,43,44,45,46,47,48,49,50], 'pants_bottom_checkbox');
        
        // Shorts measurements
        generateCheckboxes('shortsLengthCheckboxes', [10,11,12,13,14,15,16,17,18,19,20], 'shorts_length_checkbox');
        generateCheckboxes('shortsWaistCheckboxes', [30,31,32,33,34,35,36,37,39,40,41,42,43,44,45,46,47,48,49,50], 'shorts_waist_checkbox');
        generateCheckboxes('shortsCrotchCheckboxes', [21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,39,40], 'shorts_crotch_checkbox');
        generateCheckboxes('shortsHipsCheckboxes', [30,31,32,33,34,35,36,37,39,40,41,42,43,44,45,46,47,48,49,50], 'shorts_hips_checkbox');
        generateCheckboxes('shortsBottomCheckboxes', [30,31,32,33,34,35,36,37,39,40,41,42,43,44,45,46,47,48,49,50], 'shorts_bottom_checkbox');
    }
    
    // Override toggleMeasurementsSections to include checkbox generation
    const originalToggleMeasurementsSections = toggleMeasurementsSections;
    toggleMeasurementsSections = function() {
        originalToggleMeasurementsSections();
        // Regenerate checkboxes when any section is shown
        setTimeout(generateAllCheckboxes, 100);
    };
    
    // Initialize checkboxes on page load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            generateAllCheckboxes();
        });
    } else {
        generateAllCheckboxes();
    }
    
    // Edit order item quantity
    window.editItem = function(itemId) {
        const row = document.getElementById('order-item-' + itemId);
        if (row) {
            const display = row.querySelector('.item-quantity-display');
            const edit = row.querySelector('.item-quantity-edit');
            
            if (display && edit) {
                display.style.display = 'none';
                edit.style.display = 'block';
                const input = edit.querySelector('input[type="number"]');
                if (input) {
                    input.focus();
                    input.select();
                }
            }
        }
    };
    
    // Cancel edit
    window.cancelEditItem = function(itemId) {
        const row = document.getElementById('order-item-' + itemId);
        if (row) {
            const display = row.querySelector('.item-quantity-display');
            const edit = row.querySelector('.item-quantity-edit');
            
            if (display && edit) {
                display.style.display = '';
                edit.style.display = 'none';
            }
        }
    };
    
    // Delete order item
    window.deleteItem = function(itemId, orderId, productName) {
        if (confirm(`Are you sure you want to remove "${productName}" from this order?`)) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/orders/${orderId}/items/${itemId}/delete/`;
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            if (csrfToken) {
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = csrfToken.value;
                form.appendChild(csrfInput);
            }
            
            document.body.appendChild(form);
            form.submit();
        }
    };
</script>
{% endblock %}
