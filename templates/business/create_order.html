{% extends 'business/base.html' %}

{% block title %}Create Order - TopStyle Business{% endblock %}
{% block page_title %}Create Order{% endblock %}

{% block extra_css %}
<style>
    .estimator-container {
        max-width: 1400px;
        margin: 0 auto 0 10px;
        padding: 10px;
    }
    
    .estimator-form-wrapper {
        width: 100%;
    }
    
    .form-section {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border: 1px solid #e9ecef;
    }
    
    .section-title {
        color: #1e3a8a;
        font-weight: bold;
        margin-bottom: 15px;
        padding-bottom: 5px;
        border-bottom: 2px solid #1e3a8a;
        font-size: 18px;
    }
    
    .section-subtitle {
        color: #495057;
        font-weight: 600;
        margin-bottom: 10px;
        font-size: 16px;
    }
    
    .form-group {
        margin-bottom: 12px;
    }
    
    .form-label {
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
        font-size: 13px;
    }
    
    .form-control, .form-select {
        border: 2px solid #e9ecef;
        border-radius: 6px;
        padding: 8px 12px;
        font-size: 13px;
        transition: all 0.3s ease;
        color: #333;
        background-color: white;
    }
    
    /* Service Type select - ensure visible text and options */
    #serviceType {
        color: #333 !important;
        background-color: #ffffff !important;
    }
    
    #serviceType:focus {
        color: #333 !important;
        background-color: #ffffff !important;
    }
    
    /* When dropdown is open, show options with visible dark text */
    #serviceType option {
        color: #333 !important;
        background-color: #ffffff !important;
        padding: 8px 12px;
        display: block;
    }
    
    #serviceType option:hover {
        background-color: #1e40af !important;
        color: #ffffff !important;
    }
    
    #serviceType option:checked,
    #serviceType option[selected] {
        background-color: #1e40af !important;
        color: #ffffff !important;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #1e3a8a;
        box-shadow: 0 0 0 0.2rem rgba(30, 58, 138, 0.25);
    }
    
    /* Style other select dropdown options - make text white on blue background */
    .form-select:not(#serviceType) option {
        color: #ffffff !important;
        background-color: #3b82f6;
        padding: 8px 12px;
    }
    
    .form-select:not(#serviceType) option:hover {
        background-color: #2563eb;
        color: #ffffff !important;
    }
    
    .form-select:not(#serviceType) option:checked {
        background-color: #1e40af;
        color: #ffffff !important;
    }
    
    textarea.form-control {
        min-height: 60px;
    }
    
    /* Size Selector Styling */
    .size-selector-container {
        border: 1px solid #dee2e6;
        border-radius: 6px;
        overflow: hidden;
        background: white;
    }
    
    .size-selector-header {
        background-color: #6c757d;
        color: white;
        padding: 10px 15px;
        font-weight: 600;
        font-size: 14px;
        text-align: center;
    }
    
    .size-selector-body {
        padding: 0;
        background: white;
    }
    
    .size-option {
        display: block;
        padding: 12px 15px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: background-color 0.2s ease;
        margin: 0;
    }
    
    .size-option:last-child {
        border-bottom: none;
    }
    
    .size-option:hover {
        background-color: #f8f9fa;
    }
    
    .size-option input[type="radio"]:checked ~ .size-label,
    .size-option input[type="radio"]:checked ~ .size-measurements {
        color: #007bff;
    }
    
    .size-option input[type="radio"]:checked {
        accent-color: #007bff;
    }
    
    /* Fallback for browsers that don't support :has() */
    .size-option.checked {
        background-color: #e3f2fd;
        border-left: 3px solid #007bff;
    }
    
    .size-checkbox {
        margin-right: 10px;
        cursor: pointer;
        width: 18px;
        height: 18px;
        accent-color: #007bff;
    }
    
    .size-label {
        font-weight: 600;
        color: #333;
        margin-right: 8px;
        font-size: 14px;
    }
    
    .size-measurements {
        color: #6c757d;
        font-size: 13px;
    }
    
    .cost-result-box {
        background: rgba(255, 255, 255, 0.95);
        color: #333;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        border: 5px solid #dc3545;
        position: sticky;
        top: 20px;
        z-index: 101;
    }
    
    .cost-result-title {
        font-size: 1.1rem;
        font-weight: bold;
        margin-bottom: 12px;
        text-align: center;
        color: #1e3a8a;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .cost-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 6px;
        padding: 4px 0;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        font-size: 0.85rem;
        color: #333;
    }
    
    .cost-item:last-child {
        border-bottom: none;
        font-weight: bold;
        font-size: 0.9rem;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 2px solid rgba(0, 0, 0, 0.2);
        color: #1e3a8a;
    }
    
    .cost-label {
        font-weight: 500;
        color: #555;
    }
    
    .cost-value {
        font-weight: 600;
        color: #333;
    }
    
    /* Hidden class - ensure it works with both display and visibility */
    .hidden {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
    }
    
    /* Ensure form sections are visible when not hidden */
    .form-section:not(.hidden) {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    /* Floating Image Card Holder for Customize Measurements */
    .measurement-image-card {
        position: sticky;
        top: 20px;
        width: 100%;
        max-width: 100%;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        padding: 20px;
        z-index: 100;
        border: 2px solid #1e3a8a;
        transition: all 0.3s ease;
        margin-top: 20px;
        margin-right: 15px;
        min-height: 850px;
    }
    
    /* Ensure image card stays below cost box when both are sticky */
    .col-md-4 {
        display: flex;
        flex-direction: column;
    }
    
    #costResultBox {
        order: 1;
    }
    
    #measurementImageCard {
        order: 2;
    }
    
    .measurement-image-card.hidden {
        display: none !important;
    }
    
    .measurement-image-card-header {
        font-weight: 600;
        color: #1e3a8a;
        margin-bottom: 15px;
        font-size: 16px;
        text-align: center;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
    }
    
    .measurement-image-card-body {
        position: relative;
        width: 100%;
        min-height: 750px;
        max-height: 850px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        display: flex;
        align-items: flex-start;
        justify-content: center;
        background: #f8f9fa;
        transition: all 0.3s ease;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 10px;
    }
    
    .measurement-image-card-body.pe-mode {
        min-height: 1100px;
        max-height: 1300px;
    }
    
    .measurement-image-card-body:hover {
        border-color: #1e3a8a;
        background: #f0f4ff;
    }
    
    .measurement-image-card-body.has-image {
        border: 2px solid #1e3a8a;
        padding: 5px;
    }
    
    .measurement-image-card-body img {
        width: 100%;
        height: auto;
        border-radius: 6px;
        object-fit: contain;
    }
    
    #singleImageContainer img {
        min-height: 700px;
    }
    
    #dualImageContainer img {
        min-height: 450px;
    }
    
    #dualImageContainer > div {
        width: 100%;
    }
    
    .measurement-image-card-upload-text {
        text-align: center;
        color: #6c757d;
        font-size: 14px;
        padding: 20px;
    }
    
    .measurement-image-card-upload-text i {
        font-size: 96px;
        color: #1e3a8a;
        margin-bottom: 20px;
        display: block;
    }
    
    .measurement-image-card-upload-text {
        font-size: 18px;
    }
    
    /* Container for side-by-side layout */
    .measurements-container {
        display: flex;
        gap: 20px;
        align-items: flex-start;
    }
    
    .measurements-content {
        flex: 1;
    }
    
    .measurement-image-card-wrapper {
        width: 450px;
        flex-shrink: 0;
    }
    
    @media (max-width: 1400px) {
        .measurement-image-card-wrapper {
            width: 400px;
        }
    }
    
    @media (max-width: 1200px) {
        .measurements-container {
            flex-direction: column;
        }
        
        .measurement-image-card-wrapper {
            width: 100%;
        }
    }
    
    .measurement-image-card-remove {
        position: absolute;
        top: -10px;
        right: -10px;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: #dc3545;
        color: white;
        border: 2px solid white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        transition: all 0.2s ease;
    }
    
    .measurement-image-card-remove:hover {
        background: #c82333;
        transform: scale(1.1);
    }
    
    .measurement-image-card input[type="file"] {
        display: none;
    }
    
    
    .btn-estimate {
        background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
        border: none;
        color: white;
        padding: 12px 25px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.3s ease;
    }
    
    .btn-estimate:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(30, 58, 138, 0.4);
        color: white;
    }
    
    .add-more-btn {
        background: #28a745;
        border: none;
        color: white;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 11px;
        margin-left: 8px;
    }
    
    .add-more-btn:hover {
        background: #218838;
        color: white;
    }
    
    .btn-success, .btn-primary, .btn-info {
        border: none;
        border-radius: 6px;
        padding: 10px 16px;
        font-weight: 600;
        transition: all 0.3s ease;
        font-size: 13px;
    }
    
    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4);
    }
    
    .btn-info:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(23, 162, 184, 0.4);
    }
    
    .row {
        margin-bottom: 8px;
    }
    
    .selected-items-display {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 6px;
        min-height: 50px;
        margin-top: 8px;
    }
    
    .selected-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 4px 0;
        font-size: 11px;
        border-bottom: 1px solid #e9ecef;
    }
    
    .selected-item:last-child {
        border-bottom: none;
    }
    
    .selected-item-info {
        flex: 1;
    }
    
    .selected-item-name {
        font-weight: 600;
        font-size: 12px;
        color: #333;
    }
    
    .selected-item-details {
        font-size: 10px;
        color: #666;
    }
    
    .selected-item-price {
        font-weight: 600;
        color: #1e3a8a;
    }
    
    .remove-item-btn {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        font-size: 9px;
        cursor: pointer;
        margin-left: 8px;
    }
    
    .remove-item-btn:hover {
        background: #c82333;
    }
    
    /* Rental Brochure Modal Styles */
    .modal-backdrop {
        display: none !important;
        opacity: 0 !important;
        visibility: hidden !important;
        z-index: -1 !important;
    }
    .modal-backdrop.show {
        display: none !important;
    }
    .modal {
        z-index: 1060 !important;
    }
    #zipperBrochureModal {
        z-index: 1060 !important;
    }
    #zipperBrochureModal .modal-dialog {
        z-index: 1060 !important;
    }
    #zipperBrochureModal .modal-content {
        z-index: 1060 !important;
    }
    #zipperInchesModal {
        z-index: 1070 !important;
    }
    #zipperInchesModal .modal-dialog {
        z-index: 1070 !important;
    }
    #zipperInchesModal .modal-content {
        z-index: 1070 !important;
    }
    .modal-dialog {
        margin: 1.75rem auto;
        max-width: 90%;
    }
    .modal-xl {
        max-width: 1200px;
    }
    body.modal-open {
        overflow: auto !important;
        padding-right: 0 !important;
    }
    
    /* Responsive modals for mobile devices */
    @media (max-width: 768px) {
        #zipperBrochureModal .modal-dialog,
        #zipperInchesModal .modal-dialog,
        #rentalBrochureModal .modal-dialog,
        #customizeBrochureModal .modal-dialog,
        .modal-dialog {
            max-width: calc(100% - 20px) !important;
            width: calc(100% - 20px) !important;
            margin: 10px !important;
        }
        
        #zipperBrochureModal .modal-content,
        #zipperInchesModal .modal-content,
        #rentalBrochureModal .modal-content,
        #customizeBrochureModal .modal-content,
        .modal-content {
            width: 100% !important;
            max-width: 100% !important;
            height: auto !important;
            max-height: calc(100vh - 40px) !important;
        }
        
        .modal-body {
            max-height: calc(100vh - 180px) !important;
            overflow-y: auto !important;
            -webkit-overflow-scrolling: touch !important;
            height: auto !important;
        }
        
        .modal-xl {
            max-width: calc(100% - 20px) !important;
        }
    }
    
    .rental-items-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 20px;
        padding: 20px 0;
    }
    
    /* Ensure all text in rental modal is white and visible */
    #rentalBrochureModal .modal-body,
    #rentalBrochureModal .modal-body *,
    #rentalBrochureModal .rental-items-grid,
    #rentalBrochureModal .rental-items-grid * {
        color: #ffffff !important;
    }
    
    #rentalBrochureModal .form-label {
        color: #ffffff !important;
        font-weight: 600;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    }
    
    .rental-item-card {
        border: 2px solid rgba(255, 255, 255, 0.2);
        padding: 10px;
        background: rgba(45, 45, 45, 0.6);
        color: #ffffff !important;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        min-height: 250px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    .rental-item-card:hover {
        background: rgba(0, 123, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.4);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
    }
    
    .rental-item-card.selected {
        background: rgba(30, 58, 138, 0.5);
        border-color: #28a745;
        box-shadow: 0 0 15px rgba(40, 167, 69, 0.7);
    }
    
    .rental-item-card.rented {
        background: rgba(255, 140, 0, 0.2) !important;
        border: 3px solid #ff8c00 !important;
        box-shadow: 0 0 15px rgba(255, 140, 0, 0.7) !important;
        position: relative;
        opacity: 0.8;
    }
    
    .rental-item-card.rented::before {
        content: "RENTED";
        position: absolute;
        top: 3px;
        right: 3px;
        background: #ff8c00;
        color: #ffffff;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 9px;
        font-weight: bold;
        z-index: 10;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    }
    
    .rental-item-card.rented:hover {
        background: rgba(255, 140, 0, 0.3) !important;
        transform: translateY(-2px);
    }
    
    .rental-item-card.rented .rental-item-name,
    .rental-item-card.rented .rental-item-price,
    .rental-item-card.rented .rental-item-category {
        color: #ffffff !important;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.9) !important;
    }
    
    .rental-item-card.rented .rental-item-stock {
        color: #ffd700 !important;
        font-weight: bold !important;
        font-size: 13px !important;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.9) !important;
    }
    
    .rental-item-stock.maintenance {
        color: #87ceeb !important;
        font-weight: bold !important;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.9) !important;
    }
    
    .rental-item-stock.out-of-stock {
        color: #ff6b6b !important;
        font-weight: bold !important;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.9) !important;
    }
    
    .rental-item-stock.available {
        color: #90ee90 !important;
        font-weight: bold !important;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.9) !important;
    }
    
    .rental-item-image {
        width: 100%;
        height: 140px;
        object-fit: cover;
        border-radius: 6px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: transform 0.3s ease;
        flex-shrink: 0;
        border: 2px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
    }
    
    .rental-item-image:hover {
        transform: scale(1.05);
        border-color: rgba(255, 255, 255, 0.6);
    }
    
    .rental-item-name {
        font-size: 14px;
        font-weight: 700;
        margin-bottom: 6px;
        color: #ffffff !important;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        flex-grow: 1;
        line-height: 1.3;
        min-height: 20px;
    }
    
    .rental-item-price {
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 6px;
        color: #ffffff !important;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        min-height: 18px;
    }
    
    .rental-item-category {
        font-size: 12px;
        color: #ffffff !important;
        margin-bottom: 6px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        font-weight: 500;
        min-height: 16px;
    }
    
    .rental-item-stock {
        font-size: 12px;
        color: #ffffff !important;
        font-weight: 600;
        margin-bottom: 4px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        min-height: 16px;
    }
    
    .quantity-selector {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
        margin-top: 5px;
    }
    
    .quantity-selector input {
        width: 50px;
        text-align: center;
        background-color: rgba(45, 45, 45, 0.9);
        color: #ffffff !important;
        border: 2px solid rgba(255, 255, 255, 0.4);
        border-radius: 4px;
        padding: 5px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .quantity-selector button {
        width: 28px;
        height: 28px;
        background-color: rgba(45, 45, 45, 0.9);
        color: #ffffff !important;
        border: 2px solid rgba(255, 255, 255, 0.4);
        border-radius: 4px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .quantity-selector button:hover {
        background-color: rgba(0, 123, 255, 0.5);
        border-color: rgba(255, 255, 255, 0.6);
    }
    
    .selected-items-display {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 8px;
        min-height: 60px;
        margin-top: 10px;
    }
    
    .selected-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px 0;
        font-size: 12px;
        border-bottom: 1px solid #e9ecef;
    }
    
    .selected-item:last-child {
        border-bottom: none;
    }
    
    .selected-item-info {
        flex: 1;
    }
    
    .selected-item-name {
        font-weight: 600;
        font-size: 13px;
        color: #333;
    }
    
    .selected-item-details {
        font-size: 11px;
        color: #666;
    }
    
    .selected-item-price {
        font-weight: 600;
        color: #1e3a8a;
    }
    
    .remove-item-btn {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 10px;
        cursor: pointer;
        margin-left: 10px;
    }
    
    .remove-item-btn:hover {
        background: #c82333;
    }
</style>
{% endblock %}

{% block content %}
<div class="estimator-container">
    <div class="estimator-form-wrapper">
        <form id="estimatorForm">
            {% csrf_token %}
            
            <div class="row">
            <div class="col-md-8">
                <!-- Basic Information -->
                <div class="form-section">
                    <h4 class="section-title">Basic Information</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Customer</label>
                                <select class="form-select" id="customerSelect" name="customer_id">
                                    <option value="">Select Existing Customer</option>
                                    <!-- Customers will be populated by JavaScript -->
                                </select>
                                <small class="form-text text-muted">Or enter new customer details below</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">New Customer Name</label>
                                <input type="text" class="form-control" id="customerName" name="customer_name" placeholder="Enter new customer name">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="customerPhone" name="customer_phone" placeholder="Enter phone number">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Email (Optional)</label>
                                <input type="email" class="form-control" id="customerEmail" name="customer_email" placeholder="Enter email address">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div class="form-group">
                                <label class="form-label">Address (Optional)</label>
                                <textarea class="form-control" id="customerAddress" name="customer_address" rows="2" placeholder="Enter customer address"></textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Service Type</label>
                                <select class="form-select" id="serviceType" name="service_type" required>
                                    <option value="">Select Service Type</option>
                                    <option value="rent">Rent</option>
                                    <option value="repair">Repair</option>
                                    <option value="customize">Customize</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Rent Section -->
                <div class="form-section hidden" id="rentSection">
                    <h4 class="section-title">RENT</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Select Rental Items</label>
                                <button type="button" class="btn btn-primary w-100" onclick="openRentalBrochure()">
                                    <i class="fas fa-tshirt me-2"></i>Browse Rental Items
                                </button>
                                <div id="selectedRentalItems" class="mt-2"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Total Rental Items</label>
                                <input type="number" class="form-control" id="totalRentalItems" name="total_rental_items" min="1" value="1" readonly>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Date Rent</label>
                                <input type="date" class="form-control" id="dateRent" name="date_rent" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Return Date</label>
                                <input type="date" class="form-control" id="returnDate" name="return_date" readonly>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Repair Section -->
                <div class="form-section hidden" id="repairSection">
                    <h4 class="section-title">REPAIR</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Repair Type</label>
                                <select class="form-select" id="repairType" name="repair_type">
                                    <option value="">Select Repair Type</option>
                                    <option value="putol">Putol</option>
                                    <option value="baston">Baston</option>
                                    <option value="suklot">Suklot</option>
                                    <option value="baston_suklot">Baston Suklot</option>
                                    <option value="baston_putol">Baston Putol</option>
                                    <option value="ambel">Ambel</option>
                                    <option value="pasada">Pasada</option>
                                    <option value="zipper_replacement">Zipper Replacement</option>
                                    <option value="bewang">Bewang</option>
                                    <option value="buttons">Buttons</option>
                                    <option value="elastic">Elastic</option>
                                    <option value="patches">Patches</option>
                                    <option value="general_tshirt_repair">General t-shirt repair</option>
                                    <option value="general_repair">General Repair</option>
                                    <option value="lock_repair">Lock repair</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Urgency</label>
                                <select class="form-select" id="repairUrgency" name="repair_urgency">
                                    <option value="not_urgent">Not Urgent</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Sewing Style</label>
                                <select class="form-select" id="sewingStyle" name="sewing_style">
                                    <option value="">Select Sewing Style</option>
                                    <option value="straight_stitch">Straight Stitch</option>
                                    <option value="zigzag_stitch">Zigzag Stitch</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Zipper Sub-section -->
                    <div class="hidden" id="zipperSection">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label" id="browseZippersLabel">Browse Zippers</label>
                                    <button type="button" class="btn btn-primary w-100" onclick="openZipperBrochure()" id="browseZippersBtn">
                                        <i class="fas fa-search me-2"></i>Browse Zippers
                                    </button>
                                    <div id="selectedZipperInfo" class="mt-2" style="display: none;">
                                        <div class="alert alert-info">
                                            <strong>Selected Zipper:</strong> <span id="selectedZipperName"></span><br>
                                            <strong>Size:</strong> <span id="selectedZipperSize"></span><br>
                                            <strong>Available:</strong> <span id="selectedZipperAvailable"></span> inches<br>
                                            <strong>Price:</strong> ₱<span id="selectedZipperPrice"></span> per inch<br>
                                            <strong>Inches Needed:</strong> <span id="selectedZipperInches"></span> inches<br>
                                            <strong>Thread Color:</strong> <span id="selectedThreadColorDisplay"></span>
                                        </div>
                                    </div>
                                    <input type="hidden" id="selectedZipperId" name="selected_zipper_id" value="">
                                    <input type="hidden" id="selectedZipperInchesUsed" name="selected_zipper_inches_used" value="">
                                    <input type="hidden" id="selectedThreadColor" name="selected_thread_color" value="">
                                    <input type="hidden" id="selectedThreadColorOther" name="selected_thread_color_other" value="">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Zipper Provided</label>
                                    <select class="form-select" id="zipperProvided" name="zipper_provided">
                                        <option value="no">No</option>
                                        <option value="yes">Yes</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Patch Sub-section -->
                    <div class="hidden" id="patchSection">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Browse Patches</label>
                                    <button type="button" class="btn btn-primary w-100" onclick="openPatchesBrochure()" id="browsePatchesBtn">
                                        <i class="fas fa-search me-2"></i>Browse Patches
                                    </button>
                                    <div id="selectedPatchInfo" class="mt-2" style="display: none;">
                                        <div class="alert alert-info">
                                            <strong>Selected Patch:</strong> <span id="selectedPatchName"></span><br>
                                            <strong>Type:</strong> <span id="selectedPatchType"></span><br>
                                            <strong>Available:</strong> <span id="selectedPatchAvailable"></span> <span id="selectedPatchUnit"></span><br>
                                            <strong>Price:</strong> ₱<span id="selectedPatchPrice"></span> <span id="selectedPatchPriceUnit"></span><br>
                                            <strong>Quantity Needed:</strong> <span id="selectedPatchQuantity"></span> <span id="selectedPatchQuantityUnit"></span>
                                        </div>
                                    </div>
                                    <input type="hidden" id="selectedPatchId" name="selected_patch_id" value="">
                                    <input type="hidden" id="selectedPatchQuantityUsed" name="selected_patch_quantity_used" value="">
                                    <input type="hidden" id="selectedThreadColorPatches" name="selected_thread_color_patches" value="">
                                    <input type="hidden" id="selectedThreadColorOtherPatches" name="selected_thread_color_other_patches" value="">
                                    <input type="hidden" id="selectedPatchThreadLength" name="selected_patch_thread_length" value="">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Patch Provided</label>
                                    <select class="form-select" id="patchProvided" name="patch_provided">
                                        <option value="no">No</option>
                                        <option value="yes">Yes</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Buttons Sub-section -->
                    <div class="hidden" id="buttonsSection">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Browse Buttons</label>
                                    <button type="button" class="btn btn-primary w-100" onclick="openButtonsBrochure()" id="browseButtonsBtn">
                                        <i class="fas fa-search me-2"></i>Browse Buttons
                                    </button>
                                    <div id="selectedButtonInfo" class="mt-2" style="display: none;">
                                        <div class="alert alert-info">
                                            <strong>Selected Button:</strong> <span id="selectedButtonName"></span><br>
                                            <strong>Type:</strong> <span id="selectedButtonType"></span><br>
                                            <strong>Available:</strong> <span id="selectedButtonAvailable"></span> <span id="selectedButtonUnit"></span><br>
                                            <strong>Price:</strong> ₱<span id="selectedButtonPrice"></span> <span id="selectedButtonPriceUnit"></span><br>
                                            <strong>Quantity Needed:</strong> <span id="selectedButtonQuantity"></span> <span id="selectedButtonQuantityUnit"></span>
                                </div>
                            </div>
                                    <input type="hidden" id="selectedButtonId" name="selected_button_id" value="">
                                    <input type="hidden" id="selectedButtonQuantityUsed" name="selected_button_quantity_used" value="">
                                    <input type="hidden" id="selectedThreadColorButtons" name="selected_thread_color_buttons" value="">
                                    <input type="hidden" id="selectedThreadColorOtherButtons" name="selected_thread_color_other_buttons" value="">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Buttons Provided</label>
                                    <select class="form-select" id="buttonsProvided" name="buttons_provided">
                                        <option value="no">No</option>
                                        <option value="yes">Yes</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lock Repair Sub-section -->
                    <div class="hidden" id="lockRepairSection">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Browse Locks/Kawit</label>
                                    <button type="button" class="btn btn-primary w-100" onclick="openLocksBrochure()" id="browseLocksBtn">
                                        <i class="fas fa-search me-2"></i>Browse Locks/Kawit
                                    </button>
                                    <div id="selectedLockInfo" class="mt-2" style="display: none;">
                                        <div class="alert alert-info">
                                            <strong>Selected Lock/Kawit:</strong> <span id="selectedLockName"></span><br>
                                            <strong>Type:</strong> <span id="selectedLockType"></span><br>
                                            <strong>Available:</strong> <span id="selectedLockAvailable"></span> groups<br>
                                            <strong>Price:</strong> ₱<span id="selectedLockPrice"></span> per group<br>
                                            <strong>Groups Needed:</strong> <span id="selectedLockGroups"></span> groups
                                        </div>
                                    </div>
                                    <input type="hidden" id="selectedLockId" name="selected_lock_id" value="">
                                    <input type="hidden" id="selectedLockGroupsUsed" name="selected_lock_groups_used" value="">
                                    <input type="hidden" id="selectedThreadColorLocks" name="selected_thread_color_locks" value="">
                                    <input type="hidden" id="selectedThreadColorOtherLocks" name="selected_thread_color_other_locks" value="">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bewang Sub-section -->
                    <div class="hidden" id="bewangSection">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Browse Garter</label>
                                    <button type="button" class="btn btn-primary w-100" onclick="openGarterBrochure()" id="browseGarterBtn">
                                        <i class="fas fa-search me-2"></i>Browse Garter
                                    </button>
                                    <div id="selectedGarterInfo" class="mt-2" style="display: none;">
                                        <div class="alert alert-info">
                                            <strong>Selected Garter:</strong> <span id="selectedGarterName"></span><br>
                                            <strong>Available:</strong> <span id="selectedGarterAvailable"></span> inches<br>
                                            <strong>Price:</strong> ₱<span id="selectedGarterPrice"></span><br>
                                            <strong>Inches Needed:</strong> <span id="selectedGarterInches"></span> inches
                                        </div>
                                    </div>
                                    <input type="hidden" id="selectedGarterId" name="selected_garter_id" value="">
                                    <input type="hidden" id="selectedGarterInchesUsed" name="selected_garter_inches_used" value="">
                                    <input type="hidden" id="selectedThreadColorBewang" name="selected_thread_color_bewang" value="">
                                    <input type="hidden" id="selectedThreadColorOtherBewang" name="selected_thread_color_other_bewang" value="">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Elastic Sub-section -->
                    <div class="hidden" id="elasticSection">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Browse Garter</label>
                                    <button type="button" class="btn btn-primary w-100" onclick="openGarterBrochure()" id="browseGarterBtnElastic">
                                        <i class="fas fa-search me-2"></i>Browse Garter
                                    </button>
                                    <div id="selectedGarterInfoElastic" class="mt-2" style="display: none;">
                                        <div class="alert alert-info">
                                            <strong>Selected Garter:</strong> <span id="selectedGarterNameElastic"></span><br>
                                            <strong>Available:</strong> <span id="selectedGarterAvailableElastic"></span> inches<br>
                                            <strong>Price:</strong> ₱<span id="selectedGarterPriceElastic"></span><br>
                                            <strong>Inches Needed:</strong> <span id="selectedGarterInchesElastic"></span> inches
                                        </div>
                                    </div>
                                    <input type="hidden" id="selectedGarterIdElastic" name="selected_garter_id_elastic" value="">
                                    <input type="hidden" id="selectedGarterInchesUsedElastic" name="selected_garter_inches_used_elastic" value="">
                                    <input type="hidden" id="selectedThreadColorElastic" name="selected_thread_color_elastic" value="">
                                    <input type="hidden" id="selectedThreadColorOtherElastic" name="selected_thread_color_other_elastic" value="">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Thread Details Sub-section (for specific repair types) -->
                    <div class="hidden" id="threadDetailsSection">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="form-label">Thread Color *</label>
                                    <select class="form-select" id="threadColor" name="thread_color" required>
                                        <option value="">Select Thread Color</option>
                                        <option value="black">Black</option>
                                        <option value="white">White</option>
                                        <option value="red">Red</option>
                                        <option value="blue">Blue</option>
                                        <option value="green">Green</option>
                                        <option value="yellow">Yellow</option>
                                        <option value="brown">Brown</option>
                                        <option value="gray">Gray</option>
                                        <option value="beige">Beige</option>
                                        <option value="navy">Navy</option>
                                        <option value="maroon">Maroon</option>
                                        <option value="orange">Orange</option>
                                        <option value="pink">Pink</option>
                                        <option value="purple">Purple</option>
                                        <option value="tan">Tan</option>
                                        <option value="cream">Cream</option>
                                        <option value="ivory">Ivory</option>
                                        <option value="khaki">Khaki</option>
                                        <option value="assorted">Assorted</option>
                                        <option value="other">Other / Add New Color</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Thread Meters *</label>
                                    <input type="number" class="form-control" id="threadMeters" name="thread_meters" placeholder="Enter thread in meters" min="0" step="0.1" required>
                                    <small class="form-text text-muted">Enter the length in meters</small>
                                </div>
                            </div>
                        </div>
                        <div class="row" id="threadColorOtherField" style="display: none;">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Custom Color Name *</label>
                                    <input type="text" class="form-control" id="threadColorOther" name="thread_color_other" placeholder="Enter custom color name">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Customize Section -->
                <div class="form-section hidden" id="customizeSection">
                    <h4 class="section-title">CUSTOMIZE</h4>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Type of Customize</label>
                                <select class="form-select" id="typeOfCustomize" name="type_of_customize">
                                    <option value="">Select Type</option>
                                    <option value="polo">Polo</option>
                                    <option value="polo_shirt">Polo Shirt</option>
                                    <option value="blouse">Blouse</option>
                                    <option value="pants">Pants</option>
                                    <option value="shorts">Shorts</option>
                                    <option value="skirt_palda">Skirt/Palda</option>
                                    <option value="pe">PE</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Quantity</label>
                                <input type="number" class="form-control" id="customizeQuantity" name="customize_quantity" min="1" value="1" placeholder="Enter quantity">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Type of Button</label>
                                <select class="form-select" id="uniformButtonType" name="uniform_button_type">
                                    <option value="">Select Button Type</option>
                                    <option value="metal">Metal</option>
                                    <option value="plastic">Plastic</option>
                                </select>
                                <small class="form-text text-muted">Only for Polo and Pants</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="form-label">Urgent</label>
                                <select class="form-select" id="customizeUrgency" name="customize_urgency">
                                    <option value="no">No</option>
                                    <option value="yes">Yes</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="form-group">
                                <label class="form-label">Guide Picture</label>
                                <select class="form-select" id="customizeCategory" name="customize_category" required>
                                    <option value="">Select</option>
                                    <option value="choose_photo">Browse from Customize Product Brochure</option>
                                    <option value="upload_new">Upload New</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <!-- Choose Photo Section (shown when "Choose Photo" is selected) -->
                    <div class="row hidden" id="choosePhotoSection">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label class="form-label">Browse Customize Product</label>
                                <button type="button" class="btn btn-primary w-100" onclick="openCustomizeBrochure()" id="browseCustomizeBtn">
                                    <i class="fas fa-images me-2"></i>Browse Customize Product
                                </button>
                                <small class="form-text text-muted">Choose an existing design from the customize product table</small>
                                <div id="selectedCustomizeProductInfo" class="mt-3" style="display: none;">
                                    <div class="alert alert-info">
                                        <strong>Selected Product:</strong> <span id="selectedCustomizeProductName"></span><br>
                                        <img id="selectedCustomizeProductImage" src="" alt="Selected Product" style="max-width: 300px; max-height: 300px; border-radius: 8px; border: 2px solid #3b82f6; margin-top: 10px;">
                                    </div>
                                </div>
                                <input type="hidden" id="selectedCustomizeProductId" name="customize_product_id" value="">
                            </div>
                        </div>
                    </div>
                    <!-- Upload New Section (shown when "Upload New" is selected) -->
                    <div class="row hidden" id="uploadNewSection">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label class="form-label">Upload Customize Product Image</label>
                                <input type="file" class="form-control" id="customizeProductImage" name="customize_product_image" accept="image/*">
                                <small class="form-text text-muted">Upload a new image of the uniform or PE design. If not existing in customize product table, it will be automatically added.</small>
                                <div id="uploadedImagePreview" class="mt-3" style="display: none;">
                                    <img id="uploadedImage" src="" alt="Uploaded Image" style="max-width: 300px; max-height: 300px; border-radius: 8px; border: 2px solid #3b82f6;">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-5">
                            <div class="form-group">
                                <label class="form-label">Fabric Type</label>
                                <select class="form-select" id="customizeFabric" name="customize_fabric">
                                    <option value="">Select Fabric</option>
                                    <option value="linen">Linen</option>
                                    <option value="cotton">Cotton</option>
                                    <option value="silk">Silk</option>
                                    <option value="wool">Wool</option>
                                    <option value="cashmere">Cashmere</option>
                                    <option value="hemp">Hemp</option>
                                    <option value="jute">Jute</option>
                                    <option value="polyester">Polyester</option>
                                    <option value="nylon">Nylon</option>
                                    <option value="acrylic">Acrylic</option>
                                    <option value="rayon">Rayon</option>
                                    <option value="spandex">Spandex</option>
                                    <option value="acetate">Acetate</option>
                                    <option value="denim">Denim</option>
                                    <option value="corduroy">Corduroy</option>
                                    <option value="cotton_polyester">Cotton-Polyester</option>
                                    <option value="wool_nylon">Wool-Nylon</option>
                                    <option value="rayon_spandex">Rayon-Spandex</option>
                                    <option value="knitted_fabrics">Knitted Fabrics</option>
                                    <option value="add_another">Add Another Fabric</option>
                                </select>
                            </div>
                            <!-- Custom Fabric Input (shown when "Add Another Fabric" is selected) -->
                            <div class="form-group hidden" id="customFabricInput">
                                <label class="form-label">Custom Fabric Name</label>
                                <input type="text" class="form-control" id="customFabricName" name="custom_fabric_name" placeholder="Enter fabric name">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="form-label">Size</label>
                                <select class="form-select" id="uniformSize" name="uniform_size">
                                    <option value="">Select Size</option>
                                    <option value="small">Small</option>
                                    <option value="medium">Medium</option>
                                    <option value="large">Large</option>
                                    <option value="xl">XL</option>
                                </select>
                                <small class="form-text text-muted">Used to auto-compute yards and thread meters</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Materials Provided?</label>
                                <select class="form-select" id="providedMaterialsSelect">
                                    <option value="no">No</option>
                                    <option value="yes">Yes</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Thread Color</label>
                                <select class="form-select" id="customizeThreadColor" name="customize_thread_color">
                                    <option value="">Select Thread Color</option>
                                    <option value="black">Black</option>
                                    <option value="white">White</option>
                                    <option value="red">Red</option>
                                    <option value="blue">Blue</option>
                                    <option value="green">Green</option>
                                    <option value="yellow">Yellow</option>
                                    <option value="orange">Orange</option>
                                    <option value="brown">Brown</option>
                                    <option value="gray">Gray</option>
                                    <option value="beige">Beige</option>
                                    <option value="navy">Navy</option>
                                    <option value="maroon">Maroon</option>
                                    <option value="pink">Pink</option>
                                    <option value="purple">Purple</option>
                                    <option value="tan">Tan</option>
                                    <option value="cream">Cream</option>
                                    <option value="ivory">Ivory</option>
                                    <option value="khaki">Khaki</option>
                                    <option value="assorted">Assorted</option>
                                    <option value="other">Add Other Color</option>
                                </select>
                            </div>
                            <div class="form-group hidden" id="customizeThreadColorOtherInput">
                                <label class="form-label">Custom Thread Color</label>
                                <input type="text" class="form-control" id="customizeThreadColorOther" name="customize_thread_color_other" placeholder="Enter custom thread color">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Thread Meters Needed</label>
                                <input type="number" class="form-control" id="customizeThreadMeters" name="customize_thread_meters" placeholder="Enter thread in meters" min="0" step="0.1">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Fabric Yards Needed</label>
                                <input type="number" class="form-control" id="customizeFabricYards" name="customize_fabric_yards" placeholder="Enter fabric in yards" min="0" step="0.1">
                            </div>
                        </div>
                    </div>

                    <!-- Pants Type Section (shown when Pants is selected) -->
                    <div class="row hidden" id="pantsTypeSection">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Pants Type</label>
                                <select class="form-select" id="pantsType" name="pants_type">
                                    <option value="">Select Pants Type</option>
                                    <option value="slacks">Slacks</option>
                                    <option value="maong">Maong</option>
                                    <option value="corduroy">Corduroy</option>
                                    <option value="tropical">Tropical</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row hidden" id="uniformButtonsSection">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Button Quantity</label>
                                <input type="number" class="form-control" id="uniformButtonsNeeded" name="uniform_buttons_needed" placeholder="Enter button quantity" min="0" value="0">
                                <small class="form-text text-muted">Number of buttons needed per item</small>
                            </div>
                        </div>
                    </div>

                    <!-- PE Section (shown when PE is selected) -->
                    <div class="row hidden" id="peSection">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">PE Type</label>
                                <select class="form-select" id="peType" name="pe_type">
                                    <option value="">Select PE Type</option>
                                    <option value="short">Short</option>
                                    <option value="pants">Pants</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Quantity</label>
                                <input type="number" class="form-control" id="peQuantity" name="pe_quantity" min="1" value="1" placeholder="Enter quantity">
                            </div>
                        </div>
                    </div>
                    <div class="row hidden" id="peGarterSection">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Garter CM</label>
                                <input type="number" class="form-control" id="peGarterCm" name="pe_garter_cm" placeholder="Enter garter in cm" min="0" step="0.1">
                                <small class="form-text text-muted">For PE Shorts and Pants waist</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Gender</label>
                                <select class="form-select" id="peGender" name="pe_gender">
                                    <option value="">Select Gender</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- PE SHORTS Section -->
                    <div class="row hidden" id="peShortsSection">
                        <div class="col-12">
                            <h5 class="section-subtitle mb-3">PE SHORTS</h5>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Shorts Size</label>
                                <select class="form-select" id="peShortsSize" name="pe_shorts_size">
                                    <option value="">Select Size</option>
                                    <option value="xs">XS</option>
                                    <option value="s">S</option>
                                    <option value="m">M</option>
                                    <option value="l">L</option>
                                    <option value="xl">XL</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Waist (Gar garter)</label>
                                <input type="text" class="form-control" id="peShortsWaist" name="pe_shorts_waist" placeholder="Enter waist size">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Hips</label>
                                <input type="text" class="form-control" id="peShortsHips" name="pe_shorts_hips" placeholder="Enter hips size">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Shorts Length</label>
                                <input type="text" class="form-control" id="peShortsLength" name="pe_shorts_length" placeholder="Enter shorts length">
                            </div>
                        </div>
                    </div>

                    <!-- PE PANTS Section -->
                    <div class="row hidden" id="pePantsSection">
                        <div class="col-12">
                            <h5 class="section-subtitle mb-3">PE PANTS</h5>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Pants Size</label>
                                <select class="form-select" id="pePantsSize" name="pe_pants_size">
                                    <option value="">Select Size</option>
                                    <option value="xs">XS</option>
                                    <option value="s">S</option>
                                    <option value="m">M</option>
                                    <option value="l">L</option>
                                    <option value="xl">XL</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Waist (Gar garter)</label>
                                <input type="text" class="form-control" id="pePantsWaist" name="pe_pants_waist" placeholder="Enter waist size">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Hips</label>
                                <input type="text" class="form-control" id="pePantsHips" name="pe_pants_hips" placeholder="Enter hips size">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Pants Length</label>
                                <input type="text" class="form-control" id="pePantsLength" name="pe_pants_length" placeholder="Enter pants length">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Leg Opening / Hem</label>
                                <input type="text" class="form-control" id="pePantsLegOpening" name="pe_pants_leg_opening" placeholder="Enter leg opening">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Inseam (Inner leg length)</label>
                                <input type="text" class="form-control" id="pePantsInseam" name="pe_pants_inseam" placeholder="Enter inseam">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Outseam / Full Length</label>
                                <input type="text" class="form-control" id="pePantsOutseam" name="pe_pants_outseam" placeholder="Enter outseam">
                            </div>
                        </div>
                    </div>

                    <!-- PE T-SHIRT Section (always shown when PE is selected) -->
                    <div class="row hidden" id="peTshirtSection">
                        <div class="col-12">
                            <h5 class="section-subtitle mb-3">PE T-SHIRT</h5>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">T-shirt Size</label>
                                <select class="form-select" id="peTshirtSize" name="pe_tshirt_size">
                                    <option value="">Select Size</option>
                                    <option value="xs">XS</option>
                                    <option value="s">S</option>
                                    <option value="m">M</option>
                                    <option value="l">L</option>
                                    <option value="xl">XL</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Chest Circumference</label>
                                <input type="text" class="form-control" id="peChestCircumference" name="pe_chest_circumference" placeholder="Enter chest circumference">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Shirt Length</label>
                                <input type="text" class="form-control" id="peShirtLength" name="pe_shirt_length" placeholder="Enter shirt length">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Neck Circumference</label>
                                <input type="text" class="form-control" id="peNeckCircumference" name="pe_neck_circumference" placeholder="Enter neck circumference">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Bust</label>
                                <input type="text" class="form-control" id="peBust" name="pe_bust" placeholder="Enter bust size">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Armhole</label>
                                <input type="text" class="form-control" id="peArmhole" name="pe_armhole" placeholder="Enter armhole size">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Shoulder</label>
                                <input type="text" class="form-control" id="peShoulder" name="pe_shoulder" placeholder="Enter shoulder size">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Waist</label>
                                <input type="text" class="form-control" id="peTshirtWaist" name="pe_tshirt_waist" placeholder="Enter waist size">
                            </div>
                        </div>
                    </div>

                    <!-- Uniform Pants Measurements -->
                    <div class="row hidden" id="pantsSizeSection">
                        <div class="col-12">
                            <h5 class="section-subtitle mb-3">PANTS MEASUREMENTS</h5>
                        </div>
                        
                        <!-- Length -->
                        <div class="col-12 mb-4">
                            <label class="form-label fw-bold">Length:</label>
                            <div class="row mb-2">
                                <div class="col-12">
                                    <div class="form-check-group" style="padding: 10px;" id="pantsLengthCheckboxes">
                                        <!-- Dropdown will be generated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Or Input:</label>
                                    <input type="text" class="form-control" id="uniformPantsLengthCustom" name="uniform_pants_length_custom" placeholder="Enter custom length measurement">
                                </div>
                            </div>
                        </div>

                        <!-- Waist -->
                        <div class="col-12 mb-4">
                            <label class="form-label fw-bold">Waist:</label>
                            <div class="row mb-2">
                                <div class="col-12">
                                    <div class="form-check-group" style="padding: 10px;" id="pantsWaistCheckboxes">
                                        <!-- Dropdown will be generated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Or Input:</label>
                                    <input type="text" class="form-control" id="uniformPantsWaistCustom" name="uniform_pants_waist_custom" placeholder="Enter custom waist measurement">
                                </div>
                            </div>
                        </div>

                        <!-- Crotch -->
                        <div class="col-12 mb-4">
                            <label class="form-label fw-bold">Crotch:</label>
                            <div class="row mb-2">
                                <div class="col-12">
                                    <div class="form-check-group" style="padding: 10px;" id="pantsCrotchCheckboxes">
                                        <!-- Dropdown will be generated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Or Input:</label>
                                    <input type="text" class="form-control" id="uniformPantsCrotchCustom" name="uniform_pants_crotch_custom" placeholder="Enter custom crotch measurement">
                                </div>
                            </div>
                        </div>

                        <!-- Hips -->
                        <div class="col-12 mb-4">
                            <label class="form-label fw-bold">Hips:</label>
                            <div class="row mb-2">
                                <div class="col-12">
                                    <div class="form-check-group" style="padding: 10px;" id="pantsHipsCheckboxes">
                                        <!-- Dropdown will be generated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Or Input:</label>
                                    <input type="text" class="form-control" id="uniformPantsHipsCustom" name="uniform_pants_hips_custom" placeholder="Enter custom hips measurement">
                                </div>
                            </div>
                        </div>

                        <!-- Thigh -->
                        <div class="col-12 mb-4">
                            <label class="form-label fw-bold">Thigh:</label>
                            <div class="row mb-2">
                                <div class="col-12">
                                    <div class="form-check-group" style="padding: 10px;" id="pantsThighCheckboxes">
                                        <!-- Dropdown will be generated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Or Input:</label>
                                    <input type="text" class="form-control" id="uniformPantsThighCustom" name="uniform_pants_thigh_custom" placeholder="Enter custom thigh measurement">
                                </div>
                            </div>
                        </div>

                        <!-- Knee -->
                        <div class="col-12 mb-4">
                            <label class="form-label fw-bold">Knee:</label>
                            <div class="row mb-2">
                                <div class="col-12">
                                    <div class="form-check-group" style="padding: 10px;" id="pantsKneeCheckboxes">
                                        <!-- Dropdown will be generated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Or Input:</label>
                                    <input type="text" class="form-control" id="uniformPantsKneeCustom" name="uniform_pants_knee_custom" placeholder="Enter custom knee measurement">
                                </div>
                            </div>
                        </div>

                        <!-- Bottom -->
                        <div class="col-12 mb-4">
                            <label class="form-label fw-bold">Bottom:</label>
                            <div class="row mb-2">
                                <div class="col-12">
                                    <div class="form-check-group" style="padding: 10px;" id="pantsBottomCheckboxes">
                                        <!-- Dropdown will be generated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Or Input:</label>
                                    <input type="text" class="form-control" id="uniformPantsBottomCustom" name="uniform_pants_bottom_custom" placeholder="Enter custom bottom measurement">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Uniform Shorts Measurements -->
                    <div class="row hidden" id="shortsSizeSection">
                        <div class="col-12">
                            <h5 class="section-subtitle mb-3">SHORTS MEASUREMENTS</h5>
                        </div>
                        
                        <!-- Length -->
                        <div class="col-12 mb-4">
                            <label class="form-label fw-bold">Length:</label>
                            <div class="row mb-2">
                                <div class="col-12">
                                    <div class="form-check-group" style="padding: 10px;" id="shortsLengthCheckboxes">
                                        <!-- Dropdown will be generated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Or Input:</label>
                                    <input type="text" class="form-control" id="uniformShortsLengthCustom" name="uniform_shorts_length_custom" placeholder="Enter custom length measurement">
                                </div>
                            </div>
                        </div>

                        <!-- Waist -->
                        <div class="col-12 mb-4">
                            <label class="form-label fw-bold">Waist:</label>
                            <div class="row mb-2">
                                <div class="col-12">
                                    <div class="form-check-group" style="padding: 10px;" id="shortsWaistCheckboxes">
                                        <!-- Dropdown will be generated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Or Input:</label>
                                    <input type="text" class="form-control" id="uniformShortsWaistCustom" name="uniform_shorts_waist_custom" placeholder="Enter custom waist measurement">
                                </div>
                            </div>
                        </div>

                        <!-- Crotch -->
                        <div class="col-12 mb-4">
                            <label class="form-label fw-bold">Crotch:</label>
                            <div class="row mb-2">
                                <div class="col-12">
                                    <div class="form-check-group" style="padding: 10px;" id="shortsCrotchCheckboxes">
                                        <!-- Dropdown will be generated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Or Input:</label>
                                    <input type="text" class="form-control" id="uniformShortsCrotchCustom" name="uniform_shorts_crotch_custom" placeholder="Enter custom crotch measurement">
                                </div>
                            </div>
                        </div>

                        <!-- Hips -->
                        <div class="col-12 mb-4">
                            <label class="form-label fw-bold">Hips:</label>
                            <div class="row mb-2">
                                <div class="col-12">
                                    <div class="form-check-group" style="padding: 10px;" id="shortsHipsCheckboxes">
                                        <!-- Dropdown will be generated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Or Input:</label>
                                    <input type="text" class="form-control" id="uniformShortsHipsCustom" name="uniform_shorts_hips_custom" placeholder="Enter custom hips measurement">
                                </div>
                            </div>
                        </div>

                        <!-- Bottom -->
                        <div class="col-12 mb-4">
                            <label class="form-label fw-bold">Bottom:</label>
                            <div class="row mb-2">
                                <div class="col-12">
                                    <div class="form-check-group" style="padding: 10px;" id="shortsBottomCheckboxes">
                                        <!-- Dropdown will be generated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Or Input:</label>
                                    <input type="text" class="form-control" id="uniformShortsBottomCustom" name="uniform_shorts_bottom_custom" placeholder="Enter custom bottom measurement">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Uniform Polo Measurements -->
                    <div class="measurements-container hidden" id="poloSizeSectionContainer">
                        <div class="measurements-content">
                            <div class="row hidden" id="poloSizeSection">
                        <div class="col-12">
                            <h5 class="section-subtitle mb-3">POLO MEASUREMENTS</h5>
                        </div>
                        
                        <!-- Neckline Circumference -->
                        <div class="col-12 mb-4">
                            <label class="form-label fw-bold">Neckline Circumference:</label>
                            <div class="row mb-2">
                                <div class="col-12">
                                    <div class="form-check-group" style="padding: 10px;" id="poloNecklineCheckboxes">
                                        <!-- Dropdown will be generated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Or Input:</label>
                                    <input type="text" class="form-control" id="uniformPoloNecklineCustom" name="uniform_polo_neckline_custom" placeholder="Enter custom neckline circumference">
                                </div>
                            </div>
                        </div>

                        <!-- Bust -->
                        <div class="col-12 mb-4">
                            <label class="form-label fw-bold">Bust:</label>
                            <div class="row mb-2">
                                <div class="col-12">
                                    <div class="form-check-group" style="padding: 10px;" id="poloBustCheckboxes">
                                        <!-- Dropdown will be generated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Or Input:</label>
                                    <input type="text" class="form-control" id="uniformPoloBustCustom" name="uniform_polo_bust_custom" placeholder="Enter custom bust measurement">
                                </div>
                            </div>
                        </div>

                        <!-- Armhole -->
                        <div class="col-12 mb-4">
                            <label class="form-label fw-bold">Armhole:</label>
                            <div class="row mb-2">
                                <div class="col-12">
                                    <div class="form-check-group" style="padding: 10px;" id="poloArmholeCheckboxes">
                                        <!-- Dropdown will be generated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Or Input:</label>
                                    <input type="text" class="form-control" id="uniformPoloArmholeCustom" name="uniform_polo_armhole_custom" placeholder="Enter custom armhole measurement">
                                </div>
                            </div>
                        </div>

                        <!-- Shoulders -->
                        <div class="col-12 mb-4">
                            <label class="form-label fw-bold">Shoulders:</label>
                            <div class="row mb-2">
                                <div class="col-12">
                                    <div class="form-check-group" style="padding: 10px;" id="poloShouldersCheckboxes">
                                        <!-- Dropdown will be generated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Or Input:</label>
                                    <input type="text" class="form-control" id="uniformPoloShouldersCustom" name="uniform_polo_shoulders_custom" placeholder="Enter custom shoulders measurement">
                                </div>
                            </div>
                        </div>

                        <!-- Waist -->
                        <div class="col-12 mb-4">
                            <label class="form-label fw-bold">Waist:</label>
                            <div class="row mb-2">
                                <div class="col-12">
                                    <div class="form-check-group" style="padding: 10px;" id="poloWaistCheckboxes">
                                        <!-- Dropdown will be generated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Or Input:</label>
                                    <input type="text" class="form-control" id="uniformPoloWaistCustom" name="uniform_polo_waist_custom" placeholder="Enter custom waist measurement">
                                </div>
                            </div>
                        </div>

                        <!-- Sleeve -->
                        <div class="col-12 mb-4">
                            <label class="form-label fw-bold">Sleeve:</label>
                            <div class="row mb-2">
                                <div class="col-12">
                                    <div class="form-check-group" style="padding: 10px;" id="poloSleeveCheckboxes">
                                        <!-- Dropdown will be generated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Or Input:</label>
                                    <input type="text" class="form-control" id="uniformPoloSleeveCustom" name="uniform_polo_sleeve_custom" placeholder="Enter custom sleeve measurement">
                                </div>
                            </div>
                        </div>

                        <!-- Hips -->
                        <div class="col-12 mb-4">
                            <label class="form-label fw-bold">Hips:</label>
                            <div class="row mb-2">
                                <div class="col-12">
                                    <div class="form-check-group" style="padding: 10px;" id="poloHipsCheckboxes">
                                        <!-- Dropdown will be generated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Or Input:</label>
                                    <input type="text" class="form-control" id="uniformPoloHipsCustom" name="uniform_polo_hips_custom" placeholder="Enter custom hips measurement">
                                </div>
                            </div>
                        </div>

                        <!-- Length -->
                        <div class="col-12 mb-4">
                            <label class="form-label fw-bold">Length:</label>
                            <div class="row mb-2">
                                <div class="col-12">
                                    <div class="form-check-group" style="padding: 10px;" id="poloLengthCheckboxes">
                                        <!-- Dropdown will be generated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Or Input:</label>
                                    <input type="text" class="form-control" id="uniformPoloLengthCustom" name="uniform_polo_length_custom" placeholder="Enter custom length measurement">
                                </div>
                            </div>
                        </div>
                            </div>
                        </div>
                    </div>

                    <!-- Uniform Blouse Measurements -->
                    <div class="measurements-container hidden" id="blouseSizeSectionContainer">
                        <div class="measurements-content">
                            <div class="row hidden" id="blouseSizeSection">
                        <div class="col-12">
                            <h5 class="section-subtitle mb-3">BLOUSE MEASUREMENTS</h5>
                        </div>
                        
                        <!-- Neckline Circumference -->
                        <div class="col-12 mb-4">
                            <label class="form-label fw-bold">Neckline Circumference:</label>
                            <div class="row mb-2">
                                <div class="col-12">
                                    <div class="form-check-group" style="padding: 10px;" id="blouseNecklineCheckboxes">
                                        <!-- Dropdown will be generated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Or Input:</label>
                                    <input type="text" class="form-control" id="uniformBlouseNecklineCustom" name="uniform_blouse_neckline_custom" placeholder="Enter custom neckline circumference">
                                </div>
                            </div>
                        </div>

                        <!-- Bust -->
                        <div class="col-12 mb-4">
                            <label class="form-label fw-bold">Bust:</label>
                            <div class="row mb-2">
                                <div class="col-12">
                                    <div class="form-check-group" style="padding: 10px;" id="blouseBustCheckboxes">
                                        <!-- Dropdown will be generated by JavaScript -->
                            </div>
                        </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Or Input:</label>
                                    <input type="text" class="form-control" id="uniformBlouseBustCustom" name="uniform_blouse_bust_custom" placeholder="Enter custom bust measurement">
                        </div>
                            </div>
                        </div>

                        <!-- Armhole -->
                        <div class="col-12 mb-4">
                            <label class="form-label fw-bold">Armhole:</label>
                            <div class="row mb-2">
                                <div class="col-12">
                                    <div class="form-check-group" style="padding: 10px;" id="blouseArmholeCheckboxes">
                                        <!-- Dropdown will be generated by JavaScript -->
                            </div>
                        </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Or Input:</label>
                                    <input type="text" class="form-control" id="uniformBlouseArmholeCustom" name="uniform_blouse_armhole_custom" placeholder="Enter custom armhole measurement">
                        </div>
                            </div>
                        </div>

                        <!-- Shoulders -->
                        <div class="col-12 mb-4">
                            <label class="form-label fw-bold">Shoulders:</label>
                            <div class="row mb-2">
                                <div class="col-12">
                                    <div class="form-check-group" style="padding: 10px;" id="blouseShouldersCheckboxes">
                                        <!-- Dropdown will be generated by JavaScript -->
                            </div>
                        </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Or Input:</label>
                                    <input type="text" class="form-control" id="uniformBlouseShouldersCustom" name="uniform_blouse_shoulders_custom" placeholder="Enter custom shoulders measurement">
                        </div>
                            </div>
                        </div>

                        <!-- Waist -->
                        <div class="col-12 mb-4">
                            <label class="form-label fw-bold">Waist:</label>
                            <div class="row mb-2">
                                <div class="col-12">
                                    <div class="form-check-group" style="padding: 10px;" id="blouseWaistCheckboxes">
                                        <!-- Dropdown will be generated by JavaScript -->
                            </div>
                        </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Or Input:</label>
                                    <input type="text" class="form-control" id="uniformBlouseWaistCustom" name="uniform_blouse_waist_custom" placeholder="Enter custom waist measurement">
                                </div>
                            </div>
                        </div>

                        <!-- Sleeve -->
                        <div class="col-12 mb-4">
                            <label class="form-label fw-bold">Sleeve:</label>
                            <div class="row mb-2">
                                <div class="col-12">
                                    <div class="form-check-group" style="padding: 10px;" id="blouseSleeveCheckboxes">
                                        <!-- Dropdown will be generated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Or Input:</label>
                                    <input type="text" class="form-control" id="uniformBlouseSleeveCustom" name="uniform_blouse_sleeve_custom" placeholder="Enter custom sleeve measurement">
                                </div>
                            </div>
                        </div>

                        <!-- Hips -->
                        <div class="col-12 mb-4">
                            <label class="form-label fw-bold">Hips:</label>
                            <div class="row mb-2">
                                <div class="col-12">
                                    <div class="form-check-group" style="padding: 10px;" id="blouseHipsCheckboxes">
                                        <!-- Dropdown will be generated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Or Input:</label>
                                    <input type="text" class="form-control" id="uniformBlouseHipsCustom" name="uniform_blouse_hips_custom" placeholder="Enter custom hips measurement">
                                </div>
                            </div>
                        </div>

                        <!-- Length -->
                        <div class="col-12 mb-4">
                            <label class="form-label fw-bold">Length:</label>
                            <div class="row mb-2">
                                <div class="col-12">
                                    <div class="form-check-group" style="padding: 10px;" id="blouseLengthCheckboxes">
                                        <!-- Dropdown will be generated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Or Input:</label>
                                    <input type="text" class="form-control" id="uniformBlouseLengthCustom" name="uniform_blouse_length_custom" placeholder="Enter custom length measurement">
                                </div>
                            </div>
                        </div>
                            </div>
                        </div>
                    </div>

                    <!-- Uniform Skirt/Palda Measurements -->
                    <div class="row hidden" id="skirtPaldaSection">
                        <div class="col-12">
                            <h5 class="section-subtitle mb-3">SKIRT/PALDA MEASUREMENTS</h5>
                        </div>
                        
                        <!-- Length -->
                        <div class="col-12 mb-4">
                            <label class="form-label fw-bold">Length:</label>
                            <div class="row mb-2">
                                <div class="col-12">
                                    <div class="form-check-group" style="padding: 10px;" id="skirtLengthCheckboxes">
                                        <!-- Dropdown will be generated by JavaScript -->
                            </div>
                        </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Or Input:</label>
                                    <input type="text" class="form-control" id="uniformSkirtLengthCustom" name="uniform_skirt_length_custom" placeholder="Enter custom length measurement">
                        </div>
                            </div>
                        </div>

                        <!-- Waist -->
                        <div class="col-12 mb-4">
                            <label class="form-label fw-bold">Waist:</label>
                            <div class="row mb-2">
                                <div class="col-12">
                                    <div class="form-check-group" style="padding: 10px;" id="skirtWaistCheckboxes">
                                        <!-- Dropdown will be generated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Or Input:</label>
                                    <input type="text" class="form-control" id="uniformSkirtWaistCustom" name="uniform_skirt_waist_custom" placeholder="Enter custom waist measurement">
                                </div>
                            </div>
                        </div>

                        <!-- Hips -->
                        <div class="col-12 mb-4">
                            <label class="form-label fw-bold">Hips:</label>
                            <div class="row mb-2">
                                <div class="col-12">
                                    <div class="form-check-group" style="padding: 10px;" id="skirtHipsCheckboxes">
                                        <!-- Dropdown will be generated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Or Input:</label>
                                    <input type="text" class="form-control" id="uniformSkirtHipsCustom" name="uniform_skirt_hips_custom" placeholder="Enter custom hips measurement">
                                </div>
                            </div>
                        </div>

                        <!-- Hem Width -->
                        <div class="col-12 mb-4">
                            <label class="form-label fw-bold">Hem Width:</label>
                            <div class="row mb-2">
                                <div class="col-12">
                                    <div class="form-check-group" style="padding: 10px;" id="skirtHemWidthCheckboxes">
                                        <!-- Dropdown will be generated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Or Input:</label>
                                    <input type="text" class="form-control" id="uniformSkirtHemWidthCustom" name="uniform_skirt_hem_width_custom" placeholder="Enter custom hem width measurement">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Whole (Set) -->
                    <div class="row hidden" id="wholeSection">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Gender</label>
                                <select class="form-select" id="wholeGender" name="whole_gender">
                                    <option value="">Select Gender</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4" id="wholeTopMale" class="hidden"></div>
                        <div class="col-md-4" id="wholeTopFemale" class="hidden"></div>
                    </div>

                    <!-- Whole: Top and Pants selectors dynamically rendered -->
                    <div class="row hidden" id="wholeMaleSizes">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Top Size (Male)</label>
                                <select class="form-select" id="maleTopSize" name="male_top_size">
                                    <option value="">Select Size</option>
                                    <option value="S">Small — Chest 36–38 / Shoulder 17 / Length 26</option>
                                    <option value="M">Medium — Chest 39–41 / Shoulder 18 / Length 27</option>
                                    <option value="L">Large — Chest 42–44 / Shoulder 19 / Length 28</option>
                                    <option value="XL">XL — Chest 45–47 / Shoulder 20 / Length 29</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Pants Size</label>
                                <div class="size-selector-container">
                                    <div class="size-selector-header">Select Size</div>
                                    <div class="size-selector-body">
                                        <label class="size-option">
                                            <input type="radio" name="male_pants_size" value="S" id="malePantsSizeS" class="size-checkbox">
                                            <span class="size-label">Small</span>
                                            <span class="size-measurements">— Waist 28-30 / Hips 36-38 / Inseam 30</span>
                                        </label>
                                        <label class="size-option">
                                            <input type="radio" name="male_pants_size" value="M" id="malePantsSizeM" class="size-checkbox">
                                            <span class="size-label">Medium</span>
                                            <span class="size-measurements">— Waist 31-33 / Hips 39-41 / Inseam 31</span>
                                        </label>
                                        <label class="size-option">
                                            <input type="radio" name="male_pants_size" value="L" id="malePantsSizeL" class="size-checkbox">
                                            <span class="size-label">Large</span>
                                            <span class="size-measurements">— Waist 34-36 / Hips 42-44 / Inseam 32</span>
                                        </label>
                                        <label class="size-option">
                                            <input type="radio" name="male_pants_size" value="XL" id="malePantsSizeXL" class="size-checkbox">
                                            <span class="size-label">XL</span>
                                            <span class="size-measurements">— Waist 37-40 / Hips 45-47 / Inseam 32-33</span>
                                        </label>
                                    </div>
                                    <!-- Hidden input to maintain compatibility with existing JavaScript -->
                                    <input type="hidden" id="malePantsSize" name="male_pants_size_hidden">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row hidden" id="wholeFemaleSizes">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Blouse Size (Female)</label>
                                <select class="form-select" id="femaleBlouseSize" name="female_blouse_size">
                                    <option value="">Select Size</option>
                                    <option value="S">Small — Bust 33–34 / Waist 26–27 / Hips 36–37 / Length 22</option>
                                    <option value="M">Medium — Bust 35–36 / Waist 28–29 / Hips 38–39 / Length 23</option>
                                    <option value="L">Large — Bust 37–39 / Waist 30–32 / Hips 40–42 / Length 24</option>
                                    <option value="XL">XL — Bust 40–42 / Waist 33–35 / Hips 43–45 / Length 25</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Pants Size</label>
                                <div class="size-selector-container">
                                    <div class="size-selector-header">Select Size</div>
                                    <div class="size-selector-body">
                                        <label class="size-option">
                                            <input type="radio" name="female_pants_size" value="S" id="femalePantsSizeS" class="size-checkbox">
                                            <span class="size-label">Small</span>
                                            <span class="size-measurements">— Waist 28-30 / Hips 36-38 / Inseam 30</span>
                                        </label>
                                        <label class="size-option">
                                            <input type="radio" name="female_pants_size" value="M" id="femalePantsSizeM" class="size-checkbox">
                                            <span class="size-label">Medium</span>
                                            <span class="size-measurements">— Waist 31-33 / Hips 39-41 / Inseam 31</span>
                                        </label>
                                        <label class="size-option">
                                            <input type="radio" name="female_pants_size" value="L" id="femalePantsSizeL" class="size-checkbox">
                                            <span class="size-label">Large</span>
                                            <span class="size-measurements">— Waist 34-36 / Hips 42-44 / Inseam 32</span>
                                        </label>
                                        <label class="size-option">
                                            <input type="radio" name="female_pants_size" value="XL" id="femalePantsSizeXL" class="size-checkbox">
                                            <span class="size-label">XL</span>
                                            <span class="size-measurements">— Waist 37-40 / Hips 45-47 / Inseam 32-33</span>
                                        </label>
                                    </div>
                                    <!-- Hidden input to maintain compatibility with existing JavaScript -->
                                    <input type="hidden" id="femalePantsSize" name="female_pants_size_hidden">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="text-center mt-4">
                    <button type="button" class="btn btn-estimate" onclick="calculateCost()">
                        <i class="fas fa-calculator me-2"></i>Calculate Cost
                    </button>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="cost-result-box hidden" id="costResultBox">
                    <div class="cost-result-title">ORDER COST</div>
                    <div id="costDetails"></div>
                    
                    <!-- Action Buttons -->
                    <div class="text-center mt-3" id="actionButtons" style="display: none;">
                        <button type="button" class="btn btn-danger btn-sm w-100 mb-2" onclick="cancelOrder()">
                            <i class="fas fa-times me-2"></i>Cancel Order
                        </button>
                        <button type="button" class="btn btn-primary btn-sm w-100 mb-2" onclick="createOrder()">
                            <i class="fas fa-shopping-cart me-2"></i>Create Order
                        </button>
                        <button type="button" class="btn btn-info btn-sm w-100" onclick="printEstimate()">
                            <i class="fas fa-print me-2"></i>Print Estimate
                        </button>
                    </div>
                </div>
                
                <!-- Measurement Guide Card for Customize Measurements -->
                <div class="measurement-image-card hidden" id="measurementImageCard">
                    <div class="measurement-image-card-header">
                        <i class="fas fa-ruler-combined me-2"></i><span id="measurementGuideTitle">Measurement Guide</span>
                    </div>
                    <div class="measurement-image-card-body" id="measurementImageCardBody">
                        <!-- Single Image Container -->
                        <div id="singleImageContainer" style="display: none; width: 100%;">
                            <img id="measurementReferenceImage" src="" alt="Measurement guide diagram" style="width: 100%; height: auto; min-height: 700px; border-radius: 6px; display: block;">
                        </div>
                        
                        <!-- Dual Image Container for PE -->
                        <div id="dualImageContainer" style="display: none; width: 100%;">
                            <div style="margin-bottom: 20px;">
                                <h6 style="text-align: center; color: #1e3a8a; font-weight: 600; margin-bottom: 15px; font-size: 1.1rem;">Top (Shirt/Polo)</h6>
                                <img id="measurementReferenceImageTop" src="" alt="Top measurement guide" style="width: 100%; height: auto; min-height: 500px; border-radius: 6px; display: block;">
                            </div>
                            <div>
                                <h6 style="text-align: center; color: #1e3a8a; font-weight: 600; margin-bottom: 15px; font-size: 1.1rem;" id="bottomLabel">Bottom</h6>
                                <img id="measurementReferenceImageBottom" src="" alt="Bottom measurement guide" style="width: 100%; height: auto; min-height: 500px; border-radius: 6px; display: block;">
                            </div>
                        </div>
                        
                        <div id="measurementImagePlaceholder" style="text-align: center; padding: 40px; color: #999;">
                            <i class="fas fa-ruler-combined" style="font-size: 64px; margin-bottom: 15px; display: block; color: #1e3a8a;"></i>
                            <div>Loading measurement diagram...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </form>
    </div>
</div>

<!-- Rental Items Brochure Modal -->
<div class="modal fade" id="rentalBrochureModal" tabindex="-1" aria-labelledby="rentalBrochureModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="max-width: 80vw; width: 80vw; max-height: 90vh;">
        <div class="modal-content" style="height: 90vh; background-color: #1a1a1a; color: #ffffff;">
            <div class="modal-header" style="background-color: #2d2d2d; border-bottom: 1px solid #444;">
                <h5 class="modal-title" id="rentalBrochureModalLabel" style="color: #ffffff;">
                    <i class="fas fa-tshirt me-2"></i>Select Rental Items
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="height: calc(90vh - 140px); overflow-y: auto; background-color: #1a1a1a;">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label" style="color: #ffffff;">Filter by Category</label>
                        <select class="form-select" id="rentalCategoryFilter" style="background-color: #2d2d2d; color: #ffffff; border: 1px solid #444;">
                            <option value="">All Categories</option>
                            <option value="Coat">Coat</option>
                            <option value="Barong">Barong</option>
                            <option value="Pants">Pants</option>
                        </select>
                    </div>
                </div>
                
                <div class="rental-items-grid" id="rentalItemsGrid">
                    <!-- Rental items will be populated by JavaScript -->
                </div>
            </div>
            <div class="modal-footer" style="background-color: #2d2d2d; border-top: 1px solid #444;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" onclick="confirmRentalSelection()">
                    <i class="fas fa-check me-2"></i>Confirm Selection
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Zipper Brochure Modal -->
<div class="modal fade" id="zipperBrochureModal" tabindex="-1" aria-labelledby="zipperBrochureModalLabel" aria-hidden="true" data-bs-backdrop="false" style="z-index: 1060;">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 800px; width: 800px; max-height: 800px; margin: auto; z-index: 1060;">
        <div class="modal-content" style="width: 800px; height: 800px; background-color: #1a1a1a; color: #ffffff; position: relative; z-index: 1060; border-radius: 8px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);">
            <div class="modal-header" style="background-color: #2d2d2d; border-bottom: 1px solid #444; border-radius: 8px 8px 0 0;">
                <h5 class="modal-title" id="zipperBrochureModalLabel" style="color: #ffffff;">
                    <i class="fas fa-zipper me-2"></i>Browse Available Zippers
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="height: calc(800px - 140px); overflow-y: auto; background-color: #1a1a1a; position: relative; z-index: 1; pointer-events: auto;">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label" style="color: #ffffff;">Filter by Size</label>
                        <select class="form-select" id="zipperSizeFilter" style="background-color: #2d2d2d; color: #ffffff; border: 1px solid #444; pointer-events: auto;">
                            <option value="">All Sizes</option>
                        </select>
                    </div>
                </div>
                
                <div class="zipper-items-grid" id="zipperItemsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; position: relative; z-index: 1; pointer-events: auto;">
                    <!-- Zipper items will be populated by JavaScript -->
                </div>
            </div>
            <div class="modal-footer" style="background-color: #2d2d2d; border-top: 1px solid #444; border-radius: 0 0 8px 8px;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Customize Product Brochure Modal -->
<div class="modal fade" id="customizeBrochureModal" tabindex="-1" aria-labelledby="customizeBrochureModalLabel" aria-hidden="true" data-bs-backdrop="false" style="z-index: 1060;">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 900px; width: 900px; max-height: 800px; margin: auto; z-index: 1060;">
        <div class="modal-content" style="width: 900px; height: 800px; background-color: #1a1a1a; color: #ffffff; position: relative; z-index: 1060; border-radius: 8px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);">
            <div class="modal-header" style="background-color: #2d2d2d; border-bottom: 1px solid #444; border-radius: 8px 8px 0 0;">
                <h5 class="modal-title" id="customizeBrochureModalLabel" style="color: #ffffff;">
                    <i class="fas fa-images me-2"></i>Browse Customize Products
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="height: calc(800px - 140px); overflow-y: auto; background-color: #1a1a1a; position: relative; z-index: 1; pointer-events: auto;">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label" style="color: #ffffff;">Filter by Type</label>
                        <select class="form-select" id="customizeTypeFilter" style="background-color: #2d2d2d; color: #ffffff; border: 1px solid #444; pointer-events: auto;">
                            <option value="">All Types</option>
                            <option value="uniform">Uniform</option>
                            <option value="pe">PE</option>
                        </select>
                    </div>
                </div>
                
                <div class="customize-products-grid" id="customizeProductsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; position: relative; z-index: 1; pointer-events: auto;">
                    <!-- Customize products will be populated by JavaScript -->
                </div>
            </div>
            <div class="modal-footer" style="background-color: #2d2d2d; border-top: 1px solid #444; border-radius: 0 0 8px 8px;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Zipper Inches Input Modal -->
<div class="modal fade" id="zipperInchesModal" tabindex="-1" aria-labelledby="zipperInchesModalLabel" aria-hidden="true" style="z-index: 1070;">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 900px; width: 900px; max-height: 600px; margin: auto; z-index: 1070;">
        <div class="modal-content" style="width: 900px; height: 600px; position: relative; z-index: 1070; border-radius: 8px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);">
            <div class="modal-header" style="border-bottom: 1px solid #dee2e6; border-radius: 8px 8px 0 0;">
                <h5 class="modal-title" id="zipperInchesModalLabel">Enter Inches Needed</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="height: calc(600px - 140px); overflow-y: auto; padding: 20px;">
                <div class="row h-100">
                    <!-- Left Side - Input Form -->
                    <div class="col-md-5" style="border-right: 2px solid #dee2e6; padding-right: 20px;">
                        <div class="d-flex flex-column justify-content-center h-100">
                            <div class="mb-4">
                                <label class="form-label fw-bold">Selected Zipper:</label>
                                <div class="alert alert-info mb-0">
                                    <strong id="modalZipperName"></strong>
                                </div>
                            </div>
                            <div class="mb-4">
                                <label class="form-label fw-bold">Available:</label>
                                <div class="alert alert-success mb-0">
                                    <span id="modalZipperAvailable"></span> inches
                                </div>
                            </div>
                            <div class="mb-4">
                                <label for="inchesNeeded" class="form-label fw-bold">Inches Needed *</label>
                                <input type="number" class="form-control form-control-lg" id="inchesNeeded" min="0.1" step="0.1" placeholder="Enter inches needed" style="font-size: 1.1rem; padding: 12px;">
                                <small class="form-text text-muted">Enter the length in inches needed for this repair</small>
                            </div>
                            <div class="mb-4">
                                <label for="zipperThreadColor" class="form-label fw-bold">Thread Color *</label>
                                <select class="form-control form-control-lg" id="zipperThreadColor" name="zipper_thread_color" required style="font-size: 1.1rem; padding: 12px;">
                                    <option value="">Select Thread Color</option>
                                    <option value="black">Black</option>
                                    <option value="white">White</option>
                                    <option value="red">Red</option>
                                    <option value="blue">Blue</option>
                                    <option value="green">Green</option>
                                    <option value="yellow">Yellow</option>
                                    <option value="brown">Brown</option>
                                    <option value="gray">Gray</option>
                                    <option value="beige">Beige</option>
                                    <option value="navy">Navy</option>
                                    <option value="maroon">Maroon</option>
                                    <option value="orange">Orange</option>
                                    <option value="pink">Pink</option>
                                    <option value="purple">Purple</option>
                                    <option value="tan">Tan</option>
                                    <option value="cream">Cream</option>
                                    <option value="ivory">Ivory</option>
                                    <option value="khaki">Khaki</option>
                                    <option value="assorted">Assorted</option>
                                    <option value="other">Other / Add New Color</option>
                                </select>
                                <small class="form-text text-muted">Select the thread color for this repair</small>
                            </div>
                            <div id="zipperThreadColorOtherField" class="mb-4" style="display: none;">
                                <label for="zipperThreadColorOther" class="form-label fw-bold">Custom Color Name *</label>
                                <input type="text" class="form-control form-control-lg" id="zipperThreadColorOther" name="zipper_thread_color_other" placeholder="Enter custom color name" style="font-size: 1.1rem; padding: 12px;">
                                <small class="form-text text-muted">Enter a custom thread color name</small>
                            </div>
                            <div class="mb-4">
                                <label for="zipperThreadMetersNeeded" class="form-label fw-bold">Thread Meters Needed</label>
                                <input type="number" class="form-control form-control-lg" id="zipperThreadMetersNeeded" name="zipper_thread_meters_needed" placeholder="Auto-calculated" readonly style="font-size: 1.1rem; padding: 12px; background-color: #f8f9fa;">
                                <small class="form-text text-muted">Automatically calculated based on repair type, sewing style, and quantity</small>
                            </div>
                            <div id="inchesError" class="alert alert-danger" style="display: none;"></div>
                        </div>
                    </div>
                    
                    <!-- Right Side - Zipper Length Guide -->
                    <div class="col-md-7" style="padding-left: 20px;">
                        <h6 class="fw-bold mb-3" style="color: #495057;">
                            <i class="fas fa-info-circle me-2"></i>Zipper Length Guide
                        </h6>
                        <div style="max-height: calc(600px - 200px); overflow-y: auto;">
                            <table class="table table-sm table-bordered table-hover" style="font-size: 0.9rem;">
                                <thead class="table-light" style="position: sticky; top: 0; z-index: 10;">
                                    <tr>
                                        <th style="width: 25%;">Category</th>
                                        <th style="width: 45%;">Item Type</th>
                                        <th style="width: 30%;">Typical Zipper Length</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Pants -->
                                    <tr>
                                        <td rowspan="3" class="align-middle fw-bold" style="background-color: #f8f9fa;">Pants</td>
                                        <td>Men's pants</td>
                                        <td class="fw-bold text-primary">7–9 inches</td>
                                    </tr>
                                    <tr>
                                        <td>Women's pants</td>
                                        <td class="fw-bold text-primary">6–8 inches</td>
                                    </tr>
                                    <tr>
                                        <td>Jeans (men/women)</td>
                                        <td class="fw-bold text-primary">5–7 inches</td>
                                    </tr>
                                    
                                    <!-- Bags -->
                                    <tr>
                                        <td rowspan="6" class="align-middle fw-bold" style="background-color: #f8f9fa;">Bags</td>
                                        <td>Small pouch / coin purse</td>
                                        <td class="fw-bold text-primary">4–6 inches</td>
                                    </tr>
                                    <tr>
                                        <td>Makeup pouch</td>
                                        <td class="fw-bold text-primary">7–10 inches</td>
                                    </tr>
                                    <tr>
                                        <td>Small shoulder bag</td>
                                        <td class="fw-bold text-primary">12–14 inches</td>
                                    </tr>
                                    <tr>
                                        <td>Medium handbag</td>
                                        <td class="fw-bold text-primary">12–16 inches</td>
                                    </tr>
                                    <tr>
                                        <td>Backpack main compartment</td>
                                        <td class="fw-bold text-primary">18–24 inches</td>
                                    </tr>
                                    <tr>
                                        <td>Travel bag / duffel bag</td>
                                        <td class="fw-bold text-primary">20–30 inches</td>
                                    </tr>
                                    
                                    <!-- Jackets -->
                                    <tr>
                                        <td rowspan="4" class="align-middle fw-bold" style="background-color: #f8f9fa;">Jackets</td>
                                        <td>Kids' jacket</td>
                                        <td class="fw-bold text-primary">14–18 inches</td>
                                    </tr>
                                    <tr>
                                        <td>Women's jacket</td>
                                        <td class="fw-bold text-primary">18–22 inches</td>
                                    </tr>
                                    <tr>
                                        <td>Men's jacket</td>
                                        <td class="fw-bold text-primary">22–26 inches</td>
                                    </tr>
                                    <tr>
                                        <td>Long coat</td>
                                        <td class="fw-bold text-primary">26–36 inches</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <small class="text-muted d-block mt-2">
                            <i class="fas fa-lightbulb me-1"></i>Use this guide to determine the appropriate zipper length for your repair
                        </small>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid #dee2e6; border-radius: 0 0 8px 8px; padding: 15px;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmZipperSelection()">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Buttons Brochure Modal -->
<div class="modal fade" id="buttonsBrochureModal" tabindex="-1" aria-labelledby="buttonsBrochureModalLabel" aria-hidden="true" data-bs-backdrop="false" style="z-index: 1060;">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 800px; width: 800px; max-height: 800px; margin: auto; z-index: 1060;">
        <div class="modal-content" style="width: 800px; height: 800px; background-color: #1a1a1a; color: #ffffff; position: relative; z-index: 1060; border-radius: 8px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);">
            <div class="modal-header" style="background-color: #2d2d2d; border-bottom: 1px solid #444; border-radius: 8px 8px 0 0;">
                <h5 class="modal-title" id="buttonsBrochureModalLabel" style="color: #ffffff;">
                    <i class="fas fa-circle me-2"></i>Browse Available Buttons
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="height: calc(800px - 140px); overflow-y: auto; background-color: #1a1a1a; position: relative; z-index: 1; pointer-events: auto;">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label" style="color: #ffffff;">Filter by Type</label>
                        <select class="form-select" id="buttonTypeFilter" style="background-color: #2d2d2d; color: #ffffff; border: 1px solid #444; pointer-events: auto;">
                            <option value="">All Types</option>
                        </select>
                    </div>
                </div>
                
                <div class="button-items-grid" id="buttonItemsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; position: relative; z-index: 1; pointer-events: auto;">
                    <!-- Button items will be populated by JavaScript -->
                </div>
            </div>
            <div class="modal-footer" style="background-color: #2d2d2d; border-top: 1px solid #444; border-radius: 0 0 8px 8px;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Buttons Quantity Input Modal -->
<div class="modal fade" id="buttonQuantityModal" tabindex="-1" aria-labelledby="buttonQuantityModalLabel" aria-hidden="true" style="z-index: 1070;">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 500px; width: 500px; max-height: 600px; margin: auto; z-index: 1070;">
        <div class="modal-content" style="width: 500px; max-height: 600px; position: relative; z-index: 1070; border-radius: 8px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);">
            <div class="modal-header" style="border-bottom: 1px solid #dee2e6; border-radius: 8px 8px 0 0;">
                <h5 class="modal-title" id="buttonQuantityModalLabel">Enter Quantity Needed</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="max-height: calc(600px - 140px); overflow-y: auto; padding: 30px;">
                <div class="mb-4">
                    <label class="form-label fw-bold">Selected Button:</label>
                    <div class="alert alert-info mb-0">
                        <strong id="modalButtonName"></strong>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="form-label fw-bold">Available:</label>
                    <div class="alert alert-success mb-0">
                        <span id="modalButtonAvailable"></span> <span id="modalButtonUnit"></span>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="buttonQuantityNeeded" class="form-label fw-bold">Quantity Needed *</label>
                    <input type="number" class="form-control form-control-lg" id="buttonQuantityNeeded" min="1" step="1" placeholder="Enter quantity needed" style="font-size: 1.1rem; padding: 12px;">
                    <small class="form-text text-muted">Enter the number of buttons needed for this repair</small>
                </div>
                <div class="mb-4">
                    <label for="buttonThreadColor" class="form-label fw-bold">Thread Color *</label>
                    <select class="form-select form-select-lg" id="buttonThreadColor" name="button_thread_color" required style="font-size: 1.1rem; padding: 12px;">
                        <option value="">Select Thread Color</option>
                        <option value="black">Black</option>
                        <option value="white">White</option>
                        <option value="red">Red</option>
                        <option value="blue">Blue</option>
                        <option value="green">Green</option>
                        <option value="yellow">Yellow</option>
                        <option value="brown">Brown</option>
                        <option value="gray">Gray</option>
                        <option value="beige">Beige</option>
                        <option value="navy">Navy</option>
                        <option value="maroon">Maroon</option>
                        <option value="orange">Orange</option>
                        <option value="pink">Pink</option>
                        <option value="purple">Purple</option>
                        <option value="tan">Tan</option>
                        <option value="cream">Cream</option>
                        <option value="ivory">Ivory</option>
                        <option value="khaki">Khaki</option>
                        <option value="assorted">Assorted</option>
                        <option value="other">Other / Add New Color</option>
                    </select>
                    <small class="form-text text-muted">Select the thread color for this repair</small>
                </div>
                <div id="buttonThreadColorOtherField" class="mb-4" style="display: none;">
                    <label for="buttonThreadColorOther" class="form-label fw-bold">Custom Color Name *</label>
                    <input type="text" class="form-control form-control-lg" id="buttonThreadColorOther" name="button_thread_color_other" placeholder="Enter custom color name" style="font-size: 1.1rem; padding: 12px;">
                    <small class="form-text text-muted">Enter a custom thread color name</small>
                </div>
                <div class="mb-4">
                    <label for="buttonThreadMetersNeeded" class="form-label fw-bold">Thread Meters Needed</label>
                    <input type="number" class="form-control form-control-lg" id="buttonThreadMetersNeeded" name="button_thread_meters_needed" placeholder="Auto-calculated" readonly style="font-size: 1.1rem; padding: 12px; background-color: #f8f9fa;">
                    <small class="form-text text-muted">Automatically calculated based on repair type, sewing style, and quantity</small>
                </div>
                <div id="buttonQuantityError" class="alert alert-danger" style="display: none;"></div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid #dee2e6; border-radius: 0 0 8px 8px; padding: 15px;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmButtonSelection()">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Locks/Kawit Brochure Modal -->
<div class="modal fade" id="locksBrochureModal" tabindex="-1" aria-labelledby="locksBrochureModalLabel" aria-hidden="true" data-bs-backdrop="false" style="z-index: 1060;">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 800px; width: 800px; max-height: 800px; margin: auto; z-index: 1060;">
        <div class="modal-content" style="width: 800px; height: 800px; background-color: #1a1a1a; color: #ffffff; position: relative; z-index: 1060; border-radius: 8px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);">
            <div class="modal-header" style="background-color: #2d2d2d; border-bottom: 1px solid #444; border-radius: 8px 8px 0 0;">
                <h5 class="modal-title" id="locksBrochureModalLabel" style="color: #ffffff;">
                    <i class="fas fa-lock me-2"></i>Browse Available Locks/Kawit
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="height: calc(800px - 140px); overflow-y: auto; background-color: #1a1a1a; position: relative; z-index: 1; pointer-events: auto;">
                <div class="locks-items-grid" id="locksItemsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; position: relative; z-index: 1; pointer-events: auto;">
                    <!-- Lock items will be populated by JavaScript -->
                </div>
            </div>
            <div class="modal-footer" style="background-color: #2d2d2d; border-top: 1px solid #444; border-radius: 0 0 8px 8px;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Locks/Kawit Quantity Input Modal -->
<div class="modal fade" id="locksQuantityModal" tabindex="-1" aria-labelledby="locksQuantityModalLabel" aria-hidden="true" style="z-index: 1070;">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 500px; width: 500px; max-height: 600px; margin: auto; z-index: 1070;">
        <div class="modal-content" style="width: 500px; max-height: 600px; position: relative; z-index: 1070; border-radius: 8px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);">
            <div class="modal-header" style="border-bottom: 1px solid #dee2e6; border-radius: 8px 8px 0 0;">
                <h5 class="modal-title" id="locksQuantityModalLabel">Enter Groups Needed</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="max-height: calc(600px - 140px); overflow-y: auto; padding: 30px;">
                <div class="mb-4">
                    <label class="form-label fw-bold">Selected Lock/Kawit:</label>
                    <div class="alert alert-info mb-0">
                        <strong id="modalLockName"></strong>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="form-label fw-bold">Available:</label>
                    <div class="alert alert-success mb-0">
                        <span id="modalLockAvailable"></span> groups (4 pieces per group)
                    </div>
                </div>
                <div class="mb-4">
                    <label for="locksQuantityNeeded" class="form-label fw-bold">Groups Needed *</label>
                    <input type="number" class="form-control form-control-lg" id="locksQuantityNeeded" min="1" step="1" placeholder="Enter groups needed" style="font-size: 1.1rem; padding: 12px;">
                    <small class="form-text text-muted">Enter the number of groups needed (1 group = 4 pieces)</small>
                </div>
                <div class="mb-4">
                    <label for="locksThreadColor" class="form-label fw-bold">Thread Color *</label>
                    <select class="form-select form-select-lg" id="locksThreadColor" name="locks_thread_color" required style="font-size: 1.1rem; padding: 12px;">
                        <option value="">Select Thread Color</option>
                        <option value="black">Black</option>
                        <option value="white">White</option>
                        <option value="red">Red</option>
                        <option value="blue">Blue</option>
                        <option value="green">Green</option>
                        <option value="yellow">Yellow</option>
                        <option value="brown">Brown</option>
                        <option value="gray">Gray</option>
                        <option value="beige">Beige</option>
                        <option value="navy">Navy</option>
                        <option value="maroon">Maroon</option>
                        <option value="orange">Orange</option>
                        <option value="pink">Pink</option>
                        <option value="purple">Purple</option>
                        <option value="tan">Tan</option>
                        <option value="cream">Cream</option>
                        <option value="ivory">Ivory</option>
                        <option value="khaki">Khaki</option>
                        <option value="assorted">Assorted</option>
                        <option value="other">Other / Add New Color</option>
                    </select>
                    <small class="form-text text-muted">Select the thread color for this repair</small>
                </div>
                <div id="locksThreadColorOtherField" class="mb-4" style="display: none;">
                    <label for="locksThreadColorOther" class="form-label fw-bold">Custom Color Name *</label>
                    <input type="text" class="form-control form-control-lg" id="locksThreadColorOther" name="locks_thread_color_other" placeholder="Enter custom color name" style="font-size: 1.1rem; padding: 12px;">
                    <small class="form-text text-muted">Enter a custom thread color name</small>
                </div>
                <div class="mb-4">
                    <label for="locksThreadMetersNeeded" class="form-label fw-bold">Thread Meters Needed</label>
                    <input type="number" class="form-control form-control-lg" id="locksThreadMetersNeeded" name="locks_thread_meters_needed" placeholder="Auto-calculated" readonly style="font-size: 1.1rem; padding: 12px; background-color: #f8f9fa;">
                    <small class="form-text text-muted">Automatically calculated based on repair type, sewing style, and quantity</small>
                </div>
                <div id="locksQuantityError" class="alert alert-danger" style="display: none;"></div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid #dee2e6; border-radius: 0 0 8px 8px; padding: 15px;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmLockSelection()">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Garter Brochure Modal -->
<div class="modal fade" id="garterBrochureModal" tabindex="-1" aria-labelledby="garterBrochureModalLabel" aria-hidden="true" data-bs-backdrop="false" style="z-index: 1060;">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 800px; width: 800px; max-height: 800px; margin: auto; z-index: 1060;">
        <div class="modal-content" style="width: 800px; height: 800px; background-color: #1a1a1a; color: #ffffff; position: relative; z-index: 1060; border-radius: 8px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);">
            <div class="modal-header" style="background-color: #2d2d2d; border-bottom: 1px solid #444; border-radius: 8px 8px 0 0;">
                <h5 class="modal-title" id="garterBrochureModalLabel" style="color: #ffffff;">
                    <i class="fas fa-ruler me-2"></i>Browse Available Garter
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="height: calc(800px - 140px); overflow-y: auto; background-color: #1a1a1a; position: relative; z-index: 1; pointer-events: auto;">
                <div class="garter-items-grid" id="garterItemsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; position: relative; z-index: 1; pointer-events: auto;">
                    <!-- Garter items will be populated by JavaScript -->
                </div>
            </div>
            <div class="modal-footer" style="background-color: #2d2d2d; border-top: 1px solid #444; border-radius: 0 0 8px 8px;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Garter Inches Input Modal -->
<div class="modal fade" id="garterInchesModal" tabindex="-1" aria-labelledby="garterInchesModalLabel" aria-hidden="true" style="z-index: 1070;">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 500px; width: 500px; max-height: 600px; margin: auto; z-index: 1070;">
        <div class="modal-content" style="width: 500px; max-height: 600px; position: relative; z-index: 1070; border-radius: 8px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);">
            <div class="modal-header" style="border-bottom: 1px solid #dee2e6; border-radius: 8px 8px 0 0;">
                <h5 class="modal-title" id="garterInchesModalLabel">Enter Inches Needed</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="max-height: calc(600px - 140px); overflow-y: auto; padding: 30px;">
                <div class="mb-4">
                    <label class="form-label fw-bold">Selected Garter:</label>
                    <div class="alert alert-info mb-0">
                        <strong id="modalGarterName"></strong>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="form-label fw-bold">Available:</label>
                    <div class="alert alert-success mb-0">
                        <span id="modalGarterAvailable"></span> inches
                    </div>
                </div>
                <div class="mb-4">
                    <label for="garterInchesNeeded" class="form-label fw-bold">Inches Needed *</label>
                    <input type="number" class="form-control form-control-lg" id="garterInchesNeeded" min="0.1" step="0.1" placeholder="Enter inches needed" style="font-size: 1.1rem; padding: 12px;">
                    <small class="form-text text-muted">Enter the length in inches needed for this repair</small>
                </div>
                <div class="mb-4">
                    <label for="garterThreadColor" class="form-label fw-bold">Thread Color *</label>
                    <select class="form-select form-select-lg" id="garterThreadColor" name="garter_thread_color" required style="font-size: 1.1rem; padding: 12px;">
                        <option value="">Select Thread Color</option>
                        <option value="black">Black</option>
                        <option value="white">White</option>
                        <option value="red">Red</option>
                        <option value="blue">Blue</option>
                        <option value="green">Green</option>
                        <option value="yellow">Yellow</option>
                        <option value="brown">Brown</option>
                        <option value="gray">Gray</option>
                        <option value="beige">Beige</option>
                        <option value="navy">Navy</option>
                        <option value="maroon">Maroon</option>
                        <option value="orange">Orange</option>
                        <option value="pink">Pink</option>
                        <option value="purple">Purple</option>
                        <option value="tan">Tan</option>
                        <option value="cream">Cream</option>
                        <option value="ivory">Ivory</option>
                        <option value="khaki">Khaki</option>
                        <option value="assorted">Assorted</option>
                        <option value="other">Other / Add New Color</option>
                    </select>
                    <small class="form-text text-muted">Select the thread color for this repair</small>
                </div>
                <div id="garterThreadColorOtherField" class="mb-4" style="display: none;">
                    <label for="garterThreadColorOther" class="form-label fw-bold">Custom Color Name *</label>
                    <input type="text" class="form-control form-control-lg" id="garterThreadColorOther" name="garter_thread_color_other" placeholder="Enter custom color name" style="font-size: 1.1rem; padding: 12px;">
                    <small class="form-text text-muted">Enter a custom thread color name</small>
                </div>
                <div class="mb-4">
                    <label for="garterThreadMetersNeeded" class="form-label fw-bold">Thread Meters Needed</label>
                    <input type="number" class="form-control form-control-lg" id="garterThreadMetersNeeded" name="garter_thread_meters_needed" placeholder="Auto-calculated" readonly style="font-size: 1.1rem; padding: 12px; background-color: #f8f9fa;">
                    <small class="form-text text-muted">Automatically calculated based on repair type, sewing style, and quantity</small>
                </div>
                <div id="garterInchesError" class="alert alert-danger" style="display: none;"></div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid #dee2e6; border-radius: 0 0 8px 8px; padding: 15px;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmGarterSelection()">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Patches Brochure Modal -->
<div class="modal fade" id="patchesBrochureModal" tabindex="-1" aria-labelledby="patchesBrochureModalLabel" aria-hidden="true" data-bs-backdrop="false" style="z-index: 1060;">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 800px; width: 800px; max-height: 800px; margin: auto; z-index: 1060;">
        <div class="modal-content" style="width: 800px; height: 800px; background-color: #1a1a1a; color: #ffffff; position: relative; z-index: 1060; border-radius: 8px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);">
            <div class="modal-header" style="background-color: #2d2d2d; border-bottom: 1px solid #444; border-radius: 8px 8px 0 0;">
                <h5 class="modal-title" id="patchesBrochureModalLabel" style="color: #ffffff;">
                    <i class="fas fa-stamp me-2"></i>Browse Available Patches
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="height: calc(800px - 140px); overflow-y: auto; background-color: #1a1a1a; position: relative; z-index: 1; pointer-events: auto;">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label" style="color: #ffffff;">Filter by Type</label>
                        <select class="form-select" id="patchTypeFilter" style="background-color: #2d2d2d; color: #ffffff; border: 1px solid #444; pointer-events: auto;">
                            <option value="">All Types</option>
                        </select>
                    </div>
                </div>
                
                <div class="patch-items-grid" id="patchItemsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; position: relative; z-index: 1; pointer-events: auto;">
                    <!-- Patch items will be populated by JavaScript -->
                </div>
            </div>
            <div class="modal-footer" style="background-color: #2d2d2d; border-top: 1px solid #444; border-radius: 0 0 8px 8px;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Patches Quantity Input Modal -->
<div class="modal fade" id="patchQuantityModal" tabindex="-1" aria-labelledby="patchQuantityModalLabel" aria-hidden="true" style="z-index: 1070;">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 500px; width: 500px; max-height: 600px; margin: auto; z-index: 1070;">
        <div class="modal-content" style="width: 500px; max-height: 600px; position: relative; z-index: 1070; border-radius: 8px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);">
            <div class="modal-header" style="border-bottom: 1px solid #dee2e6; border-radius: 8px 8px 0 0;">
                <h5 class="modal-title" id="patchQuantityModalLabel">Enter Quantity Needed</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="max-height: calc(600px - 140px); overflow-y: auto; padding: 30px;">
                <div class="mb-4">
                    <label class="form-label fw-bold">Selected Patch:</label>
                    <div class="alert alert-info mb-0">
                        <strong id="modalPatchName"></strong>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="form-label fw-bold">Available:</label>
                    <div class="alert alert-success mb-0">
                        <span id="modalPatchAvailable"></span> <span id="modalPatchUnit"></span>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="patchQuantityNeeded" class="form-label fw-bold">Quantity Needed *</label>
                    <input type="number" class="form-control form-control-lg" id="patchQuantityNeeded" min="1" step="1" placeholder="Enter quantity needed" style="font-size: 1.1rem; padding: 12px;">
                    <small class="form-text text-muted">Enter the number of patches needed for this repair</small>
                </div>
                <div class="mb-4">
                    <label for="patchThreadColor" class="form-label fw-bold">Thread Color *</label>
                    <select class="form-select form-select-lg" id="patchThreadColor" name="patch_thread_color" required style="font-size: 1.1rem; padding: 12px;">
                        <option value="">Select Thread Color</option>
                        <option value="black">Black</option>
                        <option value="white">White</option>
                        <option value="red">Red</option>
                        <option value="blue">Blue</option>
                        <option value="green">Green</option>
                        <option value="yellow">Yellow</option>
                        <option value="brown">Brown</option>
                        <option value="gray">Gray</option>
                        <option value="beige">Beige</option>
                        <option value="navy">Navy</option>
                        <option value="maroon">Maroon</option>
                        <option value="orange">Orange</option>
                        <option value="pink">Pink</option>
                        <option value="purple">Purple</option>
                        <option value="tan">Tan</option>
                        <option value="cream">Cream</option>
                        <option value="ivory">Ivory</option>
                        <option value="khaki">Khaki</option>
                        <option value="assorted">Assorted</option>
                        <option value="other">Other / Add New Color</option>
                    </select>
                    <small class="form-text text-muted">Select the thread color for this repair</small>
                </div>
                <div id="patchThreadColorOtherField" class="mb-4" style="display: none;">
                    <label for="patchThreadColorOther" class="form-label fw-bold">Custom Color Name *</label>
                    <input type="text" class="form-control form-control-lg" id="patchThreadColorOther" name="patch_thread_color_other" placeholder="Enter custom color name" style="font-size: 1.1rem; padding: 12px;">
                    <small class="form-text text-muted">Enter a custom thread color name</small>
                </div>
                <div class="mb-4">
                    <label for="patchThreadLength" class="form-label fw-bold">Thread Meters Needed</label>
                    <input type="number" class="form-control form-control-lg" id="patchThreadLength" name="patch_thread_length" placeholder="Auto-calculated" readonly style="font-size: 1.1rem; padding: 12px; background-color: #f8f9fa;">
                    <small class="form-text text-muted">Automatically calculated based on repair type, sewing style, and quantity</small>
                </div>
                <div id="patchQuantityError" class="alert alert-danger" style="display: none;"></div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid #dee2e6; border-radius: 0 0 8px 8px; padding: 15px;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmPatchSelection()">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Image Preview Modal -->
<div class="modal fade" id="imagePreviewModal" tabindex="-1" aria-labelledby="imagePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="max-width: 480px;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imagePreviewModalLabel">Product Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body py-4">
                <div class="text-center">
                    <img id="previewImage" src="" alt="Product Image" class="img-fluid" style="max-height: 70vh; border-radius: 8px;">
                    <div id="previewProductInfo" class="mt-4">
                        <h6 id="previewProductName" class="mb-2"></h6>
                        <p id="previewProductPrice" class="text-muted mb-0"></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ============================================
    // UTILITY FUNCTIONS - DEFINED FIRST
    // ============================================
    
    // Get cookie function - needed for CSRF tokens (defined first to prevent errors)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Show alert function - needed for notifications (defined first to prevent errors)
    function showAlert(message, type = 'info') {
        const existingAlerts = document.querySelectorAll('.alert-custom');
        existingAlerts.forEach(alert => alert.remove());
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show alert-custom`;
        alertDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
        document.body.appendChild(alertDiv);
        setTimeout(() => { if (alertDiv.parentNode) alertDiv.remove(); }, 5000);
    }
    
    // Make utility functions globally available
    window.getCookie = getCookie;
    window.showAlert = showAlert;
    
    // Check thread availability by color
    async function checkThreadAvailability(threadColor) {
        if (!threadColor || threadColor.trim() === '') {
            return { available: false, found: false, error: 'Thread color is required' };
        }
        
        try {
            const response = await fetch(`/api/thread-availability/?color=${encodeURIComponent(threadColor)}`);
            const data = await response.json();
            
            if (data.success) {
                return {
                    available: data.available,
                    quantity: data.quantity,
                    found: data.found,
                    unit: data.unit,
                    color: data.color
                };
            } else {
                return { available: false, found: false, error: data.error || 'Failed to check thread availability' };
            }
        } catch (error) {
            console.error('Error checking thread availability:', error);
            // If offline or error, assume available (will be checked on backend)
            return { available: true, found: true, error: null };
        }
    }
    
    window.checkThreadAvailability = checkThreadAvailability;
    
    // ============================================
    // SERVICE TYPE HANDLER - SINGLE RELIABLE VERSION
    // ============================================
    
    // Function to handle service type changes - SIMPLE and RELIABLE
    function handleServiceTypeChange() {
        const select = document.getElementById('serviceType');
        if (!select) {
            console.error('[ServiceType] Select not found');
            return;
        }
        
        const value = (select.value || '').trim().toLowerCase();
        const rentSection = document.getElementById('rentSection');
        const repairSection = document.getElementById('repairSection');
        const customizeSection = document.getElementById('customizeSection');
        
        // Hide all sections
        [rentSection, repairSection, customizeSection].forEach(function(section) {
            if (section) {
                section.classList.add('hidden');
                section.style.display = 'none';
                section.style.visibility = 'hidden';
                section.style.opacity = '0';
            }
        });
        
        // Show selected section
        let sectionToShow = null;
        if (value === 'rent' || value === 'rental') {
            sectionToShow = rentSection;
        } else if (value === 'repair') {
            sectionToShow = repairSection;
        } else if (value === 'customize' || value === 'custom') {
            sectionToShow = customizeSection;
        }
        
        if (sectionToShow) {
            sectionToShow.classList.remove('hidden');
            sectionToShow.style.display = 'block';
            sectionToShow.style.visibility = 'visible';
            sectionToShow.style.opacity = '1';
            sectionToShow.style.height = 'auto';
            console.log('[ServiceType] ✓ Section shown:', value);
        }
        
        // Update measurement image card visibility
        updateMeasurementImageCard();
    }
    
    // Setup on DOM ready - immediate response on selection
    document.addEventListener('DOMContentLoaded', function() {
        const select = document.getElementById('serviceType');
        if (!select) return;
        const newSelect = select.cloneNode(true);
        select.parentNode.replaceChild(newSelect, select);
        const attach = (el) => {
            el.addEventListener('change', handleServiceTypeChange, { passive: true });
            el.addEventListener('input', handleServiceTypeChange, { passive: true });
            el.addEventListener('keyup', handleServiceTypeChange, { passive: true });
        };
        attach(newSelect);
        if (newSelect.value) handleServiceTypeChange();

        const providedSelect = document.getElementById('providedMaterialsSelect');
        const fabricYardsInput = document.getElementById('customizeFabricYards');
        const threadMetersInput = document.getElementById('customizeThreadMeters');
        const sizeSelect = document.getElementById('uniformSize');
        const customizeTypeSelect = document.getElementById('typeOfCustomize');
        const threadColorSelect = document.getElementById('customizeThreadColor');
        const threadColorOtherDiv = document.getElementById('customizeThreadColorOtherInput');
        const threadColorOtherInput = document.getElementById('customizeThreadColorOther');

        const sizeYardMap = { small: 1.10, medium: 1.40, large: 1.65, xl: 1.95 };
        const sizeThreadMap = { small: 500, medium: 600, large: 700, xl: 1000 };

        function updateMaterialsFromSize() {
            const size = (sizeSelect?.value || '').toLowerCase();
            const provided = (providedSelect?.value || 'no') === 'yes';
            if (!size || provided) return;
            const yards = sizeYardMap[size] || 0;
            const meters = sizeThreadMap[size] || 0;
            if (fabricYardsInput) fabricYardsInput.value = yards ? yards.toFixed(2) : '';
            if (threadMetersInput) threadMetersInput.value = meters ? meters.toFixed(0) : '';
        }

        function toggleThreadOther() {
            const val = (threadColorSelect?.value || '');
            if (val === 'other') {
                threadColorOtherDiv?.classList.remove('hidden');
            } else {
                threadColorOtherDiv?.classList.add('hidden');
                if (threadColorOtherInput) threadColorOtherInput.value = '';
            }
        }

        function toggleMaterialFields() {
            const provided = (providedSelect?.value || 'no') === 'yes';
            const fabricBlock = document.getElementById('customizeFabric').closest('.form-group');
            const yardsBlock = fabricYardsInput?.closest('.form-group');
            const threadMetersBlock = threadMetersInput?.closest('.form-group');
            const threadColorBlock = threadColorSelect?.closest('.form-group');
            if (provided) {
                fabricBlock?.classList.add('hidden');
                yardsBlock?.classList.add('hidden');
                threadMetersBlock?.classList.add('hidden');
                threadColorBlock?.classList.add('hidden');
            } else {
                fabricBlock?.classList.remove('hidden');
                yardsBlock?.classList.remove('hidden');
                threadMetersBlock?.classList.remove('hidden');
                threadColorBlock?.classList.remove('hidden');
            }
        }

        providedSelect?.addEventListener('change', updateMaterialsFromSize);
        providedSelect?.addEventListener('change', toggleMaterialFields);
        sizeSelect?.addEventListener('change', updateMaterialsFromSize);
        customizeTypeSelect?.addEventListener('change', updateMaterialsFromSize);
        threadColorSelect?.addEventListener('change', toggleThreadOther);
        toggleThreadOther();
        toggleMaterialFields();
    });
    
    // Make globally available
    window.handleServiceTypeChange = handleServiceTypeChange;
    
    // Global variables for rental brochure
    let selectedRentalProducts = [];
    let allRentalProducts = [];
    let rentalBrochureModal = null;
    let imagePreviewModal = null;
    
    // Global variables for zipper brochure
    let allZippers = [];
    let selectedZipper = null;
    let zipperBrochureModal = null;
    let zipperInchesModal = null;
    
    // Global variables for buttons brochure
    let allButtons = [];
    let selectedButton = null;
    
    // Global variables for customize brochure
    let customizeBrochureModal = null;
    let selectedCustomizeProduct = null;
    let buttonsBrochureModal = null;
    let buttonQuantityModal = null;
    
    // Global variables for locks brochure
    let allLocks = [];
    let selectedLock = null;
    let locksBrochureModal = null;
    let locksQuantityModal = null;
    
    // Global variables for garter brochure
    let allGarters = [];
    let selectedGarter = null;
    let garterBrochureModal = null;
    let garterInchesModal = null;
    
    // Global variables for patches brochure
    let allPatches = [];
    let selectedPatch = null;
    let patchesBrochureModal = null;
    let patchQuantityModal = null;

    // Generate dropdowns dynamically (replaced checkboxes)
    function generateDropdown(containerId, values, namePrefix, selectId) {
        const container = document.getElementById(containerId);
        if (!container) return;
        
        container.innerHTML = '';
        const select = document.createElement('select');
        select.className = 'form-select';
        select.id = selectId;
        select.name = namePrefix;
        select.innerHTML = '<option value="">Select measurement</option>';
        
        values.forEach(value => {
            const option = document.createElement('option');
            option.value = value;
            option.textContent = value;
            select.appendChild(option);
        });
        
        container.appendChild(select);
    }

    // Load customers on page load
    // NOTE: handleServiceTypeChange is now defined at the top of the script

    document.addEventListener('DOMContentLoaded', function() {
        loadCustomers();
        initializeModals();
        
        // Initialize measurement image card visibility
        updateMeasurementImageCard();
        
        // Generate checkboxes for uniform measurements
        // Helper function to generate range excluding 38
        function generateRangeWithExclusion(start, end, exclude = []) {
            const values = [];
            for (let i = start; i <= end; i++) {
                if (!exclude.includes(i)) {
                    values.push(i.toString());
                }
            }
            return values;
        }
        
        // POLO, BLOUSE, POLO SHIRT measurements (same for all)
        // Neckline Circumference: 10-30
        const necklineValues = generateRangeWithExclusion(10, 30);
        generateDropdown('poloNecklineCheckboxes', necklineValues, 'uniform_polo_neckline_checkbox', 'uniformPoloNecklineSelect');
        generateDropdown('blouseNecklineCheckboxes', necklineValues, 'uniform_blouse_neckline_checkbox', 'uniformBlouseNecklineSelect');
        
        // Bust: 30-50 (excluding 38)
        const bustValues = generateRangeWithExclusion(30, 50, [38]);
        generateDropdown('poloBustCheckboxes', bustValues, 'uniform_polo_bust_checkbox', 'uniformPoloBustSelect');
        generateDropdown('blouseBustCheckboxes', bustValues, 'uniform_blouse_bust_checkbox', 'uniformBlouseBustSelect');
        
        // Armhole: 10-30
        const armholeValues = generateRangeWithExclusion(10, 30);
        generateDropdown('poloArmholeCheckboxes', armholeValues, 'uniform_polo_armhole_checkbox', 'uniformPoloArmholeSelect');
        generateDropdown('blouseArmholeCheckboxes', armholeValues, 'uniform_blouse_armhole_checkbox', 'uniformBlouseArmholeSelect');
        
        // Shoulders: 10-30
        const shouldersValues = generateRangeWithExclusion(10, 30);
        generateDropdown('poloShouldersCheckboxes', shouldersValues, 'uniform_polo_shoulders_checkbox', 'uniformPoloShouldersSelect');
        generateDropdown('blouseShouldersCheckboxes', shouldersValues, 'uniform_blouse_shoulders_checkbox', 'uniformBlouseShouldersSelect');
        
        // Waist: 30-50 (excluding 38)
        const waistValues = generateRangeWithExclusion(30, 50, [38]);
        generateDropdown('poloWaistCheckboxes', waistValues, 'uniform_polo_waist_checkbox', 'uniformPoloWaistSelect');
        generateDropdown('blouseWaistCheckboxes', waistValues, 'uniform_blouse_waist_checkbox', 'uniformBlouseWaistSelect');
        
        // Sleeve: 5-28
        const sleeveValues = generateRangeWithExclusion(5, 28);
        generateDropdown('poloSleeveCheckboxes', sleeveValues, 'uniform_polo_sleeve_checkbox', 'uniformPoloSleeveSelect');
        generateDropdown('blouseSleeveCheckboxes', sleeveValues, 'uniform_blouse_sleeve_checkbox', 'uniformBlouseSleeveSelect');
        
        // Hips: 30-50 (excluding 38)
        const hipsValues = generateRangeWithExclusion(30, 50, [38]);
        generateDropdown('poloHipsCheckboxes', hipsValues, 'uniform_polo_hips_checkbox', 'uniformPoloHipsSelect');
        generateDropdown('blouseHipsCheckboxes', hipsValues, 'uniform_blouse_hips_checkbox', 'uniformBlouseHipsSelect');
        
        // Length: 10-30
        const lengthValues = generateRangeWithExclusion(10, 30);
        generateDropdown('poloLengthCheckboxes', lengthValues, 'uniform_polo_length_checkbox', 'uniformPoloLengthSelect');
        generateDropdown('blouseLengthCheckboxes', lengthValues, 'uniform_blouse_length_checkbox', 'uniformBlouseLengthSelect');
        
        // PANTS measurements
        // Length: 30-50 (excluding 38)
        generateDropdown('pantsLengthCheckboxes', generateRangeWithExclusion(30, 50, [38]), 'uniform_pants_length_checkbox', 'uniformPantsLengthSelect');
        // Waist: 30-50 (excluding 38)
        generateDropdown('pantsWaistCheckboxes', waistValues, 'uniform_pants_waist_checkbox', 'uniformPantsWaistSelect');
        // Crotch: 21-40 (excluding 38)
        generateDropdown('pantsCrotchCheckboxes', generateRangeWithExclusion(21, 40, [38]), 'uniform_pants_crotch_checkbox', 'uniformPantsCrotchSelect');
        // Hips: 30-50 (excluding 38)
        generateDropdown('pantsHipsCheckboxes', hipsValues, 'uniform_pants_hips_checkbox', 'uniformPantsHipsSelect');
        // Thigh: 21-40 (excluding 38)
        generateDropdown('pantsThighCheckboxes', generateRangeWithExclusion(21, 40, [38]), 'uniform_pants_thigh_checkbox', 'uniformPantsThighSelect');
        // Knee: 21-40 (excluding 38)
        generateDropdown('pantsKneeCheckboxes', generateRangeWithExclusion(21, 40, [38]), 'uniform_pants_knee_checkbox', 'uniformPantsKneeSelect');
        // Bottom: 30-50 (excluding 38)
        generateDropdown('pantsBottomCheckboxes', generateRangeWithExclusion(30, 50, [38]), 'uniform_pants_bottom_checkbox', 'uniformPantsBottomSelect');
        
        // SHORTS measurements
        // Length: 10-20
        generateDropdown('shortsLengthCheckboxes', generateRangeWithExclusion(10, 20), 'uniform_shorts_length_checkbox', 'uniformShortsLengthSelect');
        // Waist: 30-50 (excluding 38)
        generateDropdown('shortsWaistCheckboxes', waistValues, 'uniform_shorts_waist_checkbox', 'uniformShortsWaistSelect');
        // Crotch: 21-40 (excluding 38)
        generateDropdown('shortsCrotchCheckboxes', generateRangeWithExclusion(21, 40, [38]), 'uniform_shorts_crotch_checkbox', 'uniformShortsCrotchSelect');
        // Hips: 30-50 (excluding 38)
        generateDropdown('shortsHipsCheckboxes', hipsValues, 'uniform_shorts_hips_checkbox', 'uniformShortsHipsSelect');
        // Bottom: 30-50 (excluding 38)
        generateDropdown('shortsBottomCheckboxes', generateRangeWithExclusion(30, 50, [38]), 'uniform_shorts_bottom_checkbox', 'uniformShortsBottomSelect');
        
        // SKIRT/PALDA measurements
        // Length: 10-20
        generateDropdown('skirtLengthCheckboxes', generateRangeWithExclusion(10, 20), 'uniform_skirt_length_checkbox', 'uniformSkirtLengthSelect');
        // Waist: 30-50 (excluding 38)
        generateDropdown('skirtWaistCheckboxes', waistValues, 'uniform_skirt_waist_checkbox', 'uniformSkirtWaistSelect');
        // Hips: 30-50 (excluding 38)
        generateDropdown('skirtHipsCheckboxes', hipsValues, 'uniform_skirt_hips_checkbox', 'uniformSkirtHipsSelect');
        // Hem Width: 20-50 (excluding 38)
        generateDropdown('skirtHemWidthCheckboxes', generateRangeWithExclusion(20, 50, [38]), 'uniform_skirt_hem_width_checkbox', 'uniformSkirtHemWidthSelect');
        
        // Service type handler is already set up above
        
        // Setup PE auto-fill event listeners
        setupPEAutoFillListeners();
        
        // Setup PE type change handler
        setupPETypeHandler();
    });

    // Initialize Bootstrap modals
    function initializeModals() {
        rentalBrochureModal = new bootstrap.Modal(document.getElementById('rentalBrochureModal'), {
            backdrop: false
        });
        imagePreviewModal = new bootstrap.Modal(document.getElementById('imagePreviewModal'), {
            backdrop: false
        });
        
        // Initialize zipper modals
        initializeZipperModals();
        setupZipperFilter();
        
        // Initialize buttons modals
        initializeButtonsModals();
        setupButtonFilter();
        
        // Initialize locks modals
        initializeLocksModals();
        
        // Initialize garter modals
        initializeGarterModals();
        
        // Initialize customize modals
        initializeCustomizeModals();
        
        // Setup customize type filter
        setupCustomizeTypeFilter();
    }
    
    // Setup button filter event listener
    function setupButtonFilter() {
        const filter = document.getElementById('buttonTypeFilter');
        if (filter) {
            filter.addEventListener('change', displayButtons);
        }
    }

    // Load customers from API (works offline with cached data)
    function loadCustomers() {
        // Try to get from cache first if offline
        if (!navigator.onLine && window.offlineDB) {
            window.offlineDB.getAllCustomers().then(customers => {
                if (customers && customers.length > 0) {
                    console.log('[LoadCustomers] Loading from offline cache:', customers.length);
                    const select = document.getElementById('customerSelect');
                    if (select) {
                        customers.forEach(customer => {
                            const option = document.createElement('option');
                            option.value = customer.id || customer.localId;
                            option.textContent = `${customer.name} (${customer.phone || 'No phone'})`;
                            select.appendChild(option);
                        });
                    }
                    return;
                }
            });
        }
        
        // Try network request (will use cache if offline)
        fetch('/api/customers/', { credentials: 'same-origin' })
            .then(response => {
                const ct = response.headers.get('content-type') || '';
                if (!response.ok) throw new Error('Network response was not ok: ' + response.status);
                if (ct.includes('application/json')) return response.json();
                throw new Error('Unexpected content-type: ' + ct);
            })
            .then(data => {
                const select = document.getElementById('customerSelect');
                if (!select) return;
                
                // Clear existing options except first one
                while (select.options.length > 1) {
                    select.remove(1);
                }
                
                if (data.customers && Array.isArray(data.customers)) {
                    data.customers.forEach(customer => {
                        const option = document.createElement('option');
                        option.value = customer.id;
                        option.textContent = `${customer.name} (${customer.phone || 'No phone'})`;
                        select.appendChild(option);
                    });
                    
                    // Cache customers for offline use
                    if (window.offlineDB && navigator.onLine) {
                        data.customers.forEach(customer => {
                            window.offlineDB.saveCustomer({
                                id: customer.id,
                                name: customer.name,
                                phone: customer.phone || '',
                                email: customer.email || '',
                                address: customer.address || '',
                                sync_status: 'synced'
                            }).catch(err => console.warn('[LoadCustomers] Failed to cache customer:', err));
                        });
                    }
                }
            })
            .catch(error => {
                console.error('[LoadCustomers] Error loading customers:', error);
                // If offline and no cache, show message
                if (!navigator.onLine) {
                    console.log('[LoadCustomers] Offline - no cached customers available');
                }
            });
    }

    // Sync size radio buttons with hidden inputs using event delegation
    function handleSizeSelection(event) {
        const radio = event.target;
        if (radio.type === 'radio' && radio.classList.contains('size-checkbox')) {
            const name = radio.name;
            let hiddenInput = null;
            
            // Find corresponding hidden input
            if (name === 'pants_size') {
                hiddenInput = document.getElementById('pantsSize');
            } else if (name === 'male_pants_size') {
                hiddenInput = document.getElementById('malePantsSize');
            } else if (name === 'female_pants_size') {
                hiddenInput = document.getElementById('femalePantsSize');
            }
            
            if (hiddenInput && radio.checked) {
                hiddenInput.value = radio.value;
                
                // Update visual state - remove checked class from all options in this group
                document.querySelectorAll(`input[name="${name}"]`).forEach(r => {
                    const option = r.closest('.size-option');
                    if (option) {
                        option.classList.remove('checked');
                    }
                });
                
                // Add checked class to selected option
                const selectedOption = radio.closest('.size-option');
                if (selectedOption) {
                    selectedOption.classList.add('checked');
                }
            }
        }
    }
    
    // Use event delegation on document body for dynamic elements
    document.addEventListener('change', handleSizeSelection);
    
    // Also handle clicks on the label/option area
    document.addEventListener('click', function(event) {
        const sizeOption = event.target.closest('.size-option');
        if (sizeOption && !event.target.type) {
            const radio = sizeOption.querySelector('input[type="radio"]');
            if (radio) {
                radio.checked = true;
                radio.dispatchEvent(new Event('change', { bubbles: true }));
            }
        }
    });

    // Handle customer selection (works offline with cached data)
    const customerSelect = document.getElementById('customerSelect');
    if (customerSelect) {
        customerSelect.addEventListener('change', function() {
            const selectedCustomerId = this.value;
            if (selectedCustomerId) {
                // Try cache first if offline
                if (!navigator.onLine && window.offlineDB) {
                    window.offlineDB.getCustomer(selectedCustomerId).then(customer => {
                        if (customer) {
                            console.log('[CustomerSelect] Loading from cache');
                            document.getElementById('customerName').value = customer.name || '';
                            document.getElementById('customerPhone').value = customer.phone || '';
                            document.getElementById('customerEmail').value = customer.email || '';
                            document.getElementById('customerAddress').value = customer.address || '';
                            return;
                        }
                    });
                }
                
                // Try network request (will use cache if offline)
                fetch(`/api/customers/${selectedCustomerId}/`)
                    .then(response => response.json())
                    .then(customer => {
                        if (customer) {
                            document.getElementById('customerName').value = customer.name || '';
                            document.getElementById('customerPhone').value = customer.phone || '';
                            document.getElementById('customerEmail').value = customer.email || '';
                            document.getElementById('customerAddress').value = customer.address || '';
                            
                            // Cache customer for offline use
                            if (window.offlineDB && navigator.onLine) {
                                window.offlineDB.saveCustomer({
                                    id: customer.id,
                                    ...customer,
                                    sync_status: 'synced'
                                }).catch(err => console.warn('[CustomerSelect] Failed to cache:', err));
                            }
                        }
                    })
                    .catch(error => {
                        console.error('[CustomerSelect] Error loading customer details:', error);
                        if (!navigator.onLine) {
                            console.log('[CustomerSelect] Offline - customer details not cached');
                        }
                    });
            } else {
                // Clear form fields
                document.getElementById('customerName').value = '';
                document.getElementById('customerPhone').value = '';
                document.getElementById('customerEmail').value = '';
                document.getElementById('customerAddress').value = '';
            }
        });
    }

    // Material Pricing Configuration
    const materialPricing = {
        zippers: {
            magic: {
                basePrice: 15,      // 15 pesos per 5 inches (base)
                perInch: 3,         // 3 pesos per additional inch
                baseInches: 5,      // Base measurement
                colors: ['white', 'red', 'maroon', 'pink']
            },
            plastic: {
                basePrice: 10,      // 10 pesos per 5 inches (base)
                perInch: 2,         // 2 pesos per additional inch
                baseInches: 5,      // Base measurement
                colors: ['orange', 'blue', 'pink']
            },
            tanso: {
                basePrice: 20,      // 20 pesos per 5 inches (base)
                perInch: 4,         // 4 pesos per additional inch
                baseInches: 5,      // Base measurement
                colors: ['black']
            }
        },
        thread: {
            spun_polyester: {
                basePrice: 15,      // 15 pesos per 500 meters
                per100m: 3,         // 3 pesos per 100 meters
                baseMeters: 500,    // Base measurement
                colors: ['black', 'white']
            },
            apple_rugged: {
                basePrice: 15,      // 15 pesos per 500 meters
                per100m: 3,         // 3 pesos per 100 meters
                baseMeters: 500,    // Base measurement
                colors: ['red', 'yellow', 'blue']
            },
            trident_polyester: {
                basePrice: 10,      // 10 pesos per 500 meters
                per100m: 3,         // 3 pesos per 100 meters
                baseMeters: 500,    // Base measurement
                colors: ['pink']
            },
            apple: {
                basePrice: 8,       // 8 pesos per 500 meters
                per100m: 3,         // 3 pesos per 100 meters
                baseMeters: 500,    // Base measurement
                colors: ['yellow', 'indigo']
            }
        },
        buttons: {
            four_holes: {
                plastic: {
                    basePrice: 20,  // 20 pesos per group (8 pieces)
                    perPiece: 3,    // 3 pesos per additional piece
                    groupSize: 8    // Standard group size
                },
                metal: {
                    basePrice: 25,  // 25 pesos per group (8 pieces)
                    perPiece: 3,    // 3 pesos per additional piece
                    groupSize: 8    // Standard group size
                }
            },
            two_holes: {
                plastic: {
                    basePrice: 10,  // 10 pesos per group (8 pieces)
                    perPiece: 2,    // 2 pesos per additional piece
                    groupSize: 8    // Standard group size
                },
                metal: {
                    basePrice: 20,  // 20 pesos per group (8 pieces)
                    perPiece: 2,    // 2 pesos per additional piece
                    groupSize: 8    // Standard group size
                }
            },
            special: {
                basePrice: 30,      // 30 pesos per group (8 pieces)
                perPiece: 5,        // 5 pesos per additional piece
                groupSize: 8,       // Standard group size
                brands: ['levis', 'wrangler', 'lee']
            }
        },
        locks: {
            basePrice: 14,          // 14 pesos per group
            groupSize: 4            // 4 pieces per group
        },
        garter: {
            perInch: 20             // 20 pesos per inch
        },
        fabric: {
            cotton: {
                costPrice: 80,      // Cost price per yard
                sellingPrice: 100    // Selling price per yard
            },
            cotton_spandex: {
                costPrice: 90,
                sellingPrice: 110
            },
            linen: {
                costPrice: 100,
                sellingPrice: 120
            },
            denim: {
                costPrice: 199,
                sellingPrice: 220
            },
            corduroy: {
                costPrice: 320,
                sellingPrice: 350
            },
            wool: {
                costPrice: 159,
                sellingPrice: 170
            }
        }
    };

    // Pricing configuration
    const pricing = {
        rent: {
            base_price: 500,
            penalty_per_day: 10,
            rent_days: 3
        },
        repair: {
            // Standard Labor Prices (as per user specification)
            baston: 50,
            putol: 50,
            baston_putol: 120,
            suklot: 100,
            baston_suklot: 150,
            ambel: 150,
            pasada: 50,
            zipper_replacement: 90,
            zipper_replacement_provided: 90,
            bewang: 250,
            general_repair: 450,
            general_tshirt_repair: 150,
            buttons: 90,
            buttons_provided: 90,
            lock_repair: 90,
            lock_repair_provided: 90,
            patches: 90,
            patches_provided: 90,
            elastic: 150,
            // Legacy button structure (kept for compatibility)
            buttons_legacy: {
                pants: {
                    plastic: { labor: 10, price: 90 },
                    metal: { labor: 50, price: 90 }
                },
                polo: {
                    plastic: { labor: 10, price: 90 },
                    metal: { labor: 50, price: 90 }
                },
                discount_if_provided: 10
            }
        },
        customize: {
            // PE Pricing
            pe_labor_only: 300,  // Default PE labor (pants) fallback
            pe_pants_labor: 300,
            pe_shorts_labor: 250,
            
            // Uniform Pricing - Materials Provided
            polo_materials_provided: 250,
            blouse_materials_provided: 250,
            pants_materials_provided: 250,  // Base for labor only
            shorts_materials_provided: 200,
            palda_materials_provided: 200,
            
            // Uniform Pricing - Top Style Tela & Labor
            polo_tela_labor: 250,
            blouse_tela_labor: 250,
            shorts_tela_labor: 200,
            palda_tela_labor: 200,
            
            // Pants Pricing - Labor Only
            pants_labor_only: {
                slacks: 250,
                maong: 250,
                corduroy: 250,
                tropical: 250
            },
            
            // Pants Pricing - Top Style Tela and Pants Labor
            pants_tela_labor: {
                slacks: 250,
                maong: 250,
                corduroy: 250,
                tropical: 250  // Assuming same as labor only if not specified
            },
            
            urgent_surcharge: 50
        }
    };

    // Service type change handler is now defined above in DOMContentLoaded

    // Type of Customize show/hide logic
    const typeOfCustomize = document.getElementById('typeOfCustomize');
    if (typeOfCustomize) {
        typeOfCustomize.addEventListener('change', function() {
            const type = this.value;
            const peSection = document.getElementById('peSection');
            const peTshirtSection = document.getElementById('peTshirtSection');
            const uniformButtonsSection = document.getElementById('uniformButtonsSection');
            const peGarterSection = document.getElementById('peGarterSection');
            const uniformTypes = ['polo', 'polo_shirt', 'blouse', 'pants', 'shorts', 'skirt_palda'];

            // Reset PE subsections
            document.getElementById('peShortsSection')?.classList.add('hidden');
            document.getElementById('pePantsSection')?.classList.add('hidden');
            peTshirtSection?.classList.add('hidden');
            peGarterSection?.classList.add('hidden');

            if (type === 'pe') {
                peSection?.classList.remove('hidden');
                peTshirtSection?.classList.remove('hidden');
                peGarterSection?.classList.remove('hidden');
                uniformButtonsSection?.classList.add('hidden');
            } else if (uniformTypes.includes(type)) {
                peSection?.classList.add('hidden');
                // Show buttons section only for polo/pants/shorts
                if (uniformButtonsSection) {
                    if (type === 'polo' || type === 'polo_shirt' || type === 'pants' || type === 'shorts') {
                        uniformButtonsSection.classList.remove('hidden');
                    } else {
                        uniformButtonsSection.classList.add('hidden');
                    }
                }
            } else {
                // Default hide
                peSection?.classList.add('hidden');
                uniformButtonsSection?.classList.add('hidden');
            }
            
            // Update measurement image card visibility
            updateMeasurementImageCard();
        });
    }
    
    // Function to setup PE Type change handler
    function setupPETypeHandler() {
        const peType = document.getElementById('peType');
        if (peType) {
            peType.addEventListener('change', function() {
                const type = this.value;
                const peShortsSection = document.getElementById('peShortsSection');
                const pePantsSection = document.getElementById('pePantsSection');
                const peGarterSection = document.getElementById('peGarterSection');
                
                if (type === 'short') {
                    peShortsSection.classList.remove('hidden');
                    pePantsSection.classList.add('hidden');
                    // Show garter section for shorts
                    if (peGarterSection) peGarterSection.classList.remove('hidden');
                    // Auto-fill shorts measurements if gender and size are selected
                    setTimeout(() => autoFillPEShortsMeasurements(), 100);
                } else if (type === 'pants') {
                    peShortsSection.classList.add('hidden');
                    pePantsSection.classList.remove('hidden');
                    // Show garter section for pants
                    if (peGarterSection) peGarterSection.classList.remove('hidden');
                    // Auto-fill pants measurements if gender and size are selected
                    setTimeout(() => autoFillPEPantsMeasurements(), 100);
                } else {
                    peShortsSection.classList.add('hidden');
                    pePantsSection.classList.add('hidden');
                    // Hide garter section if no type selected
                    if (peGarterSection) peGarterSection.classList.add('hidden');
                    document.getElementById('peGarterCm').value = '';
                }
                
                // Update measurement image card when PE type changes
                updateMeasurementImageCard();
            });
        }
    }

    // PE Size Auto-Fill System - Complete measurements for T-shirt, Shorts, Pants, and Garter
    const peSizingChart = {
        male: {
            xs: { 
                chest: 35, waist: 29, shoulder: 17, shirtLength: 27, armhole: 17, neck: 15, sleeve: 8,
                garter: 60,
                shorts: { waist: 30, hips: 37, length: 18, legOpening: 22, inseam: 6, outseam: 18 },
                pants: { waist: 30, hips: 37, length: 40, legOpening: 16, inseam: 30, outseam: 40 }
            },
            s: { 
                chest: 35, waist: 29, shoulder: 17, shirtLength: 27, armhole: 17, neck: 15, sleeve: 8,
                garter: 60,
                shorts: { waist: 30, hips: 37, length: 18, legOpening: 22, inseam: 6, outseam: 18 },
                pants: { waist: 30, hips: 37, length: 40, legOpening: 16, inseam: 30, outseam: 40 }
            },
            m: { 
                chest: 40, waist: 34, shoulder: 18, shirtLength: 28, armhole: 19, neck: 16, sleeve: 9,
                garter: 65,
                shorts: { waist: 33, hips: 40, length: 19, legOpening: 23, inseam: 7, outseam: 19 },
                pants: { waist: 33, hips: 40, length: 41, legOpening: 17, inseam: 31, outseam: 41 }
            },
            l: { 
                chest: 44, waist: 38, shoulder: 19, shirtLength: 29, armhole: 20, neck: 17, sleeve: 10,
                garter: 70,
                shorts: { waist: 36, hips: 43, length: 20, legOpening: 24, inseam: 8, outseam: 20 },
                pants: { waist: 36, hips: 43, length: 42, legOpening: 18, inseam: 32, outseam: 42 }
            },
            xl: { 
                chest: 48, waist: 42, shoulder: 20, shirtLength: 30, armhole: 21, neck: 18, sleeve: 11,
                garter: 75,
                shorts: { waist: 40, hips: 46, length: 21, legOpening: 25, inseam: 9, outseam: 21 },
                pants: { waist: 40, hips: 46, length: 43, legOpening: 19, inseam: 33, outseam: 43 }
            }
        },
        female: {
            xs: { 
                chest: 34, waist: 28, shoulder: 16, shirtLength: 25, armhole: 15, neck: 14, sleeve: 7,
                garter: 55,
                shorts: { waist: 28, hips: 35, length: 16, legOpening: 20, inseam: 5, outseam: 16 },
                pants: { waist: 28, hips: 35, length: 38, legOpening: 14, inseam: 29, outseam: 38 }
            },
            s: { 
                chest: 34, waist: 28, shoulder: 16, shirtLength: 25, armhole: 15, neck: 14, sleeve: 7,
                garter: 55,
                shorts: { waist: 28, hips: 35, length: 16, legOpening: 20, inseam: 5, outseam: 16 },
                pants: { waist: 28, hips: 35, length: 38, legOpening: 14, inseam: 29, outseam: 38 }
            },
            m: { 
                chest: 38, waist: 32, shoulder: 17, shirtLength: 27, armhole: 18, neck: 15, sleeve: 8,
                garter: 60,
                shorts: { waist: 31, hips: 38, length: 17, legOpening: 21, inseam: 6, outseam: 17 },
                pants: { waist: 31, hips: 38, length: 40, legOpening: 15, inseam: 30, outseam: 40 }
            },
            l: { 
                chest: 42, waist: 36, shoulder: 18, shirtLength: 28, armhole: 19, neck: 16, sleeve: 9,
                garter: 65,
                shorts: { waist: 34, hips: 41, length: 18, legOpening: 22, inseam: 7, outseam: 18 },
                pants: { waist: 34, hips: 41, length: 41, legOpening: 16, inseam: 31, outseam: 41 }
            },
            xl: { 
                chest: 46, waist: 40, shoulder: 19, shirtLength: 29, armhole: 20, neck: 17, sleeve: 10,
                garter: 70,
                shorts: { waist: 38, hips: 44, length: 19, legOpening: 23, inseam: 8, outseam: 19 },
                pants: { waist: 38, hips: 44, length: 42, legOpening: 17, inseam: 32, outseam: 42 }
            }
        }
    };

    // Function to auto-fill PE T-shirt measurements based on gender and t-shirt size
    function autoFillPETshirtMeasurements() {
        const gender = document.getElementById('peGender')?.value;
        const size = document.getElementById('peTshirtSize')?.value;
        
        if (!gender || !size) return;
        
        const measurements = peSizingChart[gender]?.[size];
        if (!measurements) return;
        
        const fields = [];
        const chestField = document.getElementById('peChestCircumference');
        const waistField = document.getElementById('peTshirtWaist');
        const shoulderField = document.getElementById('peShoulder');
        const lengthField = document.getElementById('peShirtLength');
        const armholeField = document.getElementById('peArmhole');
        const neckField = document.getElementById('peNeckCircumference');
        const bustField = document.getElementById('peBust');
        
        if (chestField) { chestField.value = measurements.chest; fields.push(chestField); }
        if (waistField) { waistField.value = measurements.waist; fields.push(waistField); }
        if (shoulderField) { shoulderField.value = measurements.shoulder; fields.push(shoulderField); }
        if (lengthField) { lengthField.value = measurements.shirtLength; fields.push(lengthField); }
        if (armholeField) { armholeField.value = measurements.armhole; fields.push(armholeField); }
        if (neckField) { neckField.value = measurements.neck; fields.push(neckField); }
        if (bustField) { bustField.value = measurements.chest; fields.push(bustField); }
        
        applyVisualFeedback(fields);
        showAlert(`✓ T-Shirt measurements auto-filled for ${gender.charAt(0).toUpperCase() + gender.slice(1)} size ${size.toUpperCase()}`, 'success');
    }
    
    // Function to auto-fill PE Shorts measurements based on gender and shorts size
    function autoFillPEShortsMeasurements() {
        const gender = document.getElementById('peGender')?.value;
        const size = document.getElementById('peShortsSize')?.value;
        
        if (!gender || !size) return;
        
        const measurements = peSizingChart[gender]?.[size];
        if (!measurements || !measurements.shorts) return;
        
        const fields = [];
        const shortsWaist = document.getElementById('peShortsWaist');
        const shortsHips = document.getElementById('peShortsHips');
        const shortsLength = document.getElementById('peShortsLength');
        const garterField = document.getElementById('peGarterCm');
        
        if (shortsWaist) { shortsWaist.value = measurements.shorts.waist; fields.push(shortsWaist); }
        if (shortsHips) { shortsHips.value = measurements.shorts.hips; fields.push(shortsHips); }
        if (shortsLength) { shortsLength.value = measurements.shorts.length; fields.push(shortsLength); }
        if (garterField) { garterField.value = measurements.garter; fields.push(garterField); }
        
        applyVisualFeedback(fields);
        showAlert(`✓ Shorts measurements auto-filled for ${gender.charAt(0).toUpperCase() + gender.slice(1)} size ${size.toUpperCase()}`, 'success');
    }
    
    // Function to auto-fill PE Pants measurements based on gender and pants size
    function autoFillPEPantsMeasurements() {
        const gender = document.getElementById('peGender')?.value;
        const size = document.getElementById('pePantsSize')?.value;
        
        if (!gender || !size) return;
        
        const measurements = peSizingChart[gender]?.[size];
        if (!measurements || !measurements.pants) return;
        
        const fields = [];
        const pantsWaist = document.getElementById('pePantsWaist');
        const pantsHips = document.getElementById('pePantsHips');
        const pantsLength = document.getElementById('pePantsLength');
        const legOpening = document.getElementById('pePantsLegOpening');
        const inseam = document.getElementById('pePantsInseam');
        const outseam = document.getElementById('pePantsOutseam');
        const garterField = document.getElementById('peGarterCm');
        
        if (pantsWaist) { pantsWaist.value = measurements.pants.waist; fields.push(pantsWaist); }
        if (pantsHips) { pantsHips.value = measurements.pants.hips; fields.push(pantsHips); }
        if (pantsLength) { pantsLength.value = measurements.pants.length; fields.push(pantsLength); }
        if (legOpening) { legOpening.value = measurements.pants.legOpening; fields.push(legOpening); }
        if (inseam) { inseam.value = measurements.pants.inseam; fields.push(inseam); }
        if (outseam) { outseam.value = measurements.pants.outseam; fields.push(outseam); }
        if (garterField) { garterField.value = measurements.garter; fields.push(garterField); }
        
        applyVisualFeedback(fields);
        showAlert(`✓ Pants measurements auto-filled for ${gender.charAt(0).toUpperCase() + gender.slice(1)} size ${size.toUpperCase()}`, 'success');
    }
    
    // Helper function to apply visual feedback
    function applyVisualFeedback(fields) {
        fields.forEach(field => {
            if (field && field.value) {
                field.style.backgroundColor = '#e8f5e9';
                field.style.transition = 'background-color 0.3s ease';
                setTimeout(() => {
                    field.style.backgroundColor = '';
                }, 1500);
            }
        });
    }

    // Function to setup PE auto-fill event listeners
    function setupPEAutoFillListeners() {
        // Event listeners for Gender and all Size selectors
        const peGenderSelect = document.getElementById('peGender');
        const peTshirtSizeSelect = document.getElementById('peTshirtSize');
        const peShortsSizeSelect = document.getElementById('peShortsSize');
        const pePantsSizeSelect = document.getElementById('pePantsSize');
        
        if (peGenderSelect) {
            peGenderSelect.addEventListener('change', function() {
                // Auto-fill T-shirt measurements
                autoFillPETshirtMeasurements();
                
                // Auto-fill Shorts or Pants based on what's visible
                const peType = document.getElementById('peType')?.value;
                if (peType === 'short' || peType === 'shorts') {
                    autoFillPEShortsMeasurements();
                } else if (peType === 'pants') {
                    autoFillPEPantsMeasurements();
                }
            });
        }
        
        if (peTshirtSizeSelect) {
            peTshirtSizeSelect.addEventListener('change', function() {
                autoFillPETshirtMeasurements();
            });
        }
        
        if (peShortsSizeSelect) {
            peShortsSizeSelect.addEventListener('change', function() {
                autoFillPEShortsMeasurements();
            });
        }
        
        if (pePantsSizeSelect) {
            pePantsSizeSelect.addEventListener('change', function() {
                autoFillPEPantsMeasurements();
            });
        }
    }

    // Custom Fabric Input show/hide logic
    const customizeFabric = document.getElementById('customizeFabric');
    if (customizeFabric) {
        customizeFabric.addEventListener('change', function() {
            const fabricValue = this.value;
            const customFabricInput = document.getElementById('customFabricInput');
            
            if (fabricValue === 'add_another') {
                customFabricInput.classList.remove('hidden');
            } else {
                customFabricInput.classList.add('hidden');
                document.getElementById('customFabricName').value = '';
            }
        });
    }
    
    // Customize Category show/hide logic
    const customizeCategory = document.getElementById('customizeCategory');
    const choosePhotoSection = document.getElementById('choosePhotoSection');
    const uploadNewSection = document.getElementById('uploadNewSection');
    const customizeProductImage = document.getElementById('customizeProductImage');
    
    // Initialize customize brochure modal
    function initializeCustomizeModals() {
        const customizeModalElement = document.getElementById('customizeBrochureModal');
        
        if (customizeModalElement) {
            customizeBrochureModal = new bootstrap.Modal(customizeModalElement, {
                backdrop: false,
                keyboard: true
            });
            
            // Remove any backdrop that might be created
            customizeModalElement.addEventListener('shown.bs.modal', function() {
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach(backdrop => backdrop.remove());
                document.body.style.overflow = 'auto';
                document.body.classList.remove('modal-open');
            });
        }
    }
    
    // Open customize brochure
    function openCustomizeBrochure() {
        if (!customizeBrochureModal) {
            initializeCustomizeModals();
        }
        loadCustomizeProducts();
        customizeBrochureModal.show();
    }
    
    // Load customize products from API
    function loadCustomizeProducts() {
        fetch('/api/customize-products/', { credentials: 'same-origin' })
            .then(response => {
                const ct = response.headers.get('content-type') || '';
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.status);
                }
                if (ct.includes('application/json')) {
                    return response.json();
                }
                throw new Error('Unexpected content-type: ' + ct);
            })
            .then(data => {
                if (data && data.success && data.products) {
                    displayCustomizeProducts(data.products);
                } else if (data && data.products) {
                    displayCustomizeProducts(data.products);
                } else {
                    console.error('Error loading customize products:', data && data.error);
                    const grid = document.getElementById('customizeProductsGrid');
                    if (grid) {
                        grid.innerHTML = '<div class="text-center text-muted" style="grid-column: 1 / -1; padding: 20px;">No customize products available.</div>';
                    }
                }
            })
            .catch(error => {
                console.error('Error loading customize products:', error);
                const grid = document.getElementById('customizeProductsGrid');
                if (grid) {
                    grid.innerHTML = '<div class="text-center text-danger" style="grid-column: 1 / -1; padding: 20px;">Error loading products. Please try again.</div>';
                }
            });
    }
    
    // Display customize products in grid
    function displayCustomizeProducts(products) {
        const grid = document.getElementById('customizeProductsGrid');
        if (!grid) return;
        
        grid.innerHTML = '';
        
        if (!products || products.length === 0) {
            grid.innerHTML = '<div class="text-center text-muted" style="grid-column: 1 / -1; padding: 20px;">No customize products available.</div>';
            return;
        }
        
        // Get filter value
        const typeFilter = document.getElementById('customizeTypeFilter')?.value || '';
        const typeOfCustomize = document.getElementById('typeOfCustomize')?.value || '';
        
        // Filter products
        let filteredProducts = products;
        
        // Only filter if a specific filter is selected (not "All Types" which is empty string)
        if (typeFilter && typeFilter !== '') {
            filteredProducts = products.filter(p => {
                const nameLower = (p.name || '').toLowerCase();
                const descLower = (p.description || '').toLowerCase();
                if (typeFilter === 'uniform') {
                    return nameLower.includes('uniform') || descLower.includes('uniform');
                } else if (typeFilter === 'pe') {
                    return nameLower.includes('pe') || descLower.includes('pe') || nameLower.includes('physical education');
                }
                return true;
            });
        } else if (typeFilter === '' && typeOfCustomize) {
            // Only auto-filter if filter is explicitly set to "All Types" (empty) AND typeOfCustomize is set
            // But show all products when "All Types" is selected
            // Commented out auto-filtering to show all products when "All Types" is selected
            // filteredProducts = products.filter(p => {
            //     const nameLower = (p.name || '').toLowerCase();
            //     const descLower = (p.description || '').toLowerCase();
            //     if (typeOfCustomize === 'uniform') {
            //         return nameLower.includes('uniform') || descLower.includes('uniform');
            //     } else if (typeOfCustomize === 'pe') {
            //         return nameLower.includes('pe') || descLower.includes('pe') || nameLower.includes('physical education');
            //     }
            //     return true;
            // });
            filteredProducts = products; // Show all products when "All Types" is selected
        }
        
        if (filteredProducts.length === 0) {
            grid.innerHTML = '<div class="text-center text-muted" style="grid-column: 1 / -1; padding: 20px;">No products found matching the filter.</div>';
            return;
        }
        
        filteredProducts.forEach(product => {
            const card = createCustomizeProductCard(product);
            grid.appendChild(card);
        });
    }
    
    // Create customize product card
    function createCustomizeProductCard(product) {
        const card = document.createElement('div');
        card.className = 'customize-product-card';
        card.style.cssText = 'background-color: #2d2d2d; border: 2px solid #444; border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.3s; text-align: center;';
        
        card.addEventListener('mouseenter', function() {
            this.style.borderColor = '#3b82f6';
            this.style.transform = 'scale(1.05)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.borderColor = '#444';
            this.style.transform = 'scale(1)';
        });
        
        const imageUrl = product.image_url || '';
        const productName = product.name || 'Unnamed Product';
        const productDesc = product.description || '';
        
        card.innerHTML = `
            <div style="text-align: center; margin-bottom: 10px;">
                ${imageUrl ? 
                    `<img src="${imageUrl}" alt="${productName}" style="width: 100%; height: 200px; object-fit: cover; border-radius: 5px;">` :
                    `<div style="width: 100%; height: 200px; background: #444; border-radius: 5px; display: flex; align-items: center; justify-content: center; color: #888;">
                        <i class="fas fa-image" style="font-size: 48px;"></i>
                    </div>`
                }
            </div>
            <div style="color: #ffffff; font-weight: bold; margin-bottom: 5px;">${productName}</div>
            ${productDesc ? `<div style="color: #aaa; font-size: 0.9em; margin-bottom: 5px;">${productDesc.substring(0, 50)}${productDesc.length > 50 ? '...' : ''}</div>` : ''}
            ${product.category ? `<div style="color: #3b82f6; font-size: 0.85em; margin-top: 5px;">Category: ${product.category}</div>` : ''}
        `;
        
        card.addEventListener('click', function(e) {
            e.stopPropagation();
            e.preventDefault();
            selectCustomizeProduct(product);
        });
        
        card.setAttribute('data-product-id', product.id);
        card.style.pointerEvents = 'auto';
        card.style.userSelect = 'none';
        
        return card;
    }
    
    // Select customize product
    function selectCustomizeProduct(product) {
        selectedCustomizeProduct = product;
        
        // Store selected product info
        document.getElementById('selectedCustomizeProductId').value = product.id;
        document.getElementById('selectedCustomizeProductName').textContent = product.name || 'Selected Product';
        
        const productImage = document.getElementById('selectedCustomizeProductImage');
        if (product.image_url) {
            productImage.src = product.image_url;
            productImage.style.display = 'block';
        } else {
            productImage.style.display = 'none';
        }
        
        document.getElementById('selectedCustomizeProductInfo').style.display = 'block';
        
        customizeBrochureModal.hide();
    }
    
    if (customizeCategory) {
        customizeCategory.addEventListener('change', function() {
            const categoryValue = this.value;
            
            if (categoryValue === 'choose_photo') {
                choosePhotoSection.classList.remove('hidden');
                uploadNewSection.classList.add('hidden');
            } else if (categoryValue === 'upload_new') {
                choosePhotoSection.classList.add('hidden');
                uploadNewSection.classList.remove('hidden');
            } else {
                choosePhotoSection.classList.add('hidden');
                uploadNewSection.classList.add('hidden');
            }
        });
    }
    
    // Setup customize type filter
    function setupCustomizeTypeFilter() {
        const filter = document.getElementById('customizeTypeFilter');
        if (filter) {
            filter.addEventListener('change', function() {
                loadCustomizeProducts();
            });
        }
        
        // Also listen to typeOfCustomize changes to auto-filter
        const typeOfCustomize = document.getElementById('typeOfCustomize');
        if (typeOfCustomize) {
            typeOfCustomize.addEventListener('change', function() {
                if (customizeBrochureModal && customizeBrochureModal._isShown) {
                    loadCustomizeProducts();
                }
                // Update measurement image card visibility
                updateMeasurementImageCard();
            });
        }
    }
    
    // Make openCustomizeBrochure globally available
    window.openCustomizeBrochure = openCustomizeBrochure;
    
    // Show preview and upload image immediately when file is selected
    if (customizeProductImage) {
        customizeProductImage.addEventListener('change', function(e) {
            const file = e.target.files[0];
            const previewDiv = document.getElementById('uploadedImagePreview');
            const previewImg = document.getElementById('uploadedImage');
            
            if (file) {
                // Show preview immediately
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    previewDiv.style.display = 'block';
                };
                reader.readAsDataURL(file);
                
                // Upload image immediately to create product in customize product table
                const formData = new FormData();
                formData.append('image', file);
                
                // Get customize type information for category
                const typeOfCustomize = document.getElementById('typeOfCustomize').value || 'customize';
                const customizeType = document.getElementById('typeOfCustomize') ? document.getElementById('typeOfCustomize').value : '';
                
                formData.append('type_of_customize', typeOfCustomize);
                formData.append('customize_type', customizeType);
                
                // Show loading indicator
                const loadingMsg = document.createElement('div');
                loadingMsg.className = 'alert alert-info mt-2';
                loadingMsg.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Uploading image and adding to customize products...';
                previewDiv.parentNode.insertBefore(loadingMsg, previewDiv.nextSibling);
                
                // Upload to server
                fetch('/api/upload-customize-image/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    loadingMsg.remove();
                    
                    if (data.success) {
                        // Image uploaded successfully, product created
                        const successMsg = document.createElement('div');
                        successMsg.className = 'alert alert-success mt-2';
                        successMsg.innerHTML = `<i class="fas fa-check-circle me-2"></i>${data.message || 'Image uploaded and added to customize products!'}`;
                        previewDiv.parentNode.insertBefore(successMsg, previewDiv.nextSibling);
                        
                        // Store the product ID for later use in order creation
                        customizeProductImage.dataset.productId = data.product_id;
                        
                        // Update the category to "choose_photo" so the product can be selected
                        // This ensures the uploaded product is linked to the order
                        if (data.product_id && customizeCategory) {
                            // Switch to "choose_photo" mode and select the uploaded product
                            customizeCategory.value = 'choose_photo';
                            customizeCategory.dispatchEvent(new Event('change'));
                            
                            // Wait a bit for the dropdown to load, then select the product
                            setTimeout(() => {
                                if (customizeProductSelect) {
                                    // Reload products to include the new one
                                    loadCustomizeProducts().then(() => {
                                        // Select the uploaded product
                                        customizeProductSelect.value = data.product_id;
                                        customizeProductSelect.dispatchEvent(new Event('change'));
                                    });
                                }
                            }, 500);
                        }
                        
                        // Remove success message after 3 seconds
                        setTimeout(() => {
                            successMsg.remove();
                        }, 3000);
                    } else {
                        // Show error
                        const errorMsg = document.createElement('div');
                        errorMsg.className = 'alert alert-danger mt-2';
                        errorMsg.innerHTML = `<i class="fas fa-exclamation-circle me-2"></i>Error: ${data.error || 'Failed to upload image'}`;
                        previewDiv.parentNode.insertBefore(errorMsg, previewDiv.nextSibling);
                        
                        setTimeout(() => {
                            errorMsg.remove();
                        }, 5000);
                    }
                })
                .catch(error => {
                    loadingMsg.remove();
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'alert alert-danger mt-2';
                    errorMsg.innerHTML = `<i class="fas fa-exclamation-circle me-2"></i>Error uploading image: ${error.message}`;
                    previewDiv.parentNode.insertBefore(errorMsg, previewDiv.nextSibling);
                    
                    setTimeout(() => {
                        errorMsg.remove();
                    }, 5000);
                });
            } else {
                previewDiv.style.display = 'none';
            }
        });
    }
    
    // Load products when customize section is shown
    document.getElementById('serviceType').addEventListener('change', function() {
        if (this.value === 'customize') {
            // Load products if "Choose Photo" is already selected
            if (customizeCategory && customizeCategory.value === 'choose_photo') {
                loadCustomizeProducts();
            }
        }
        // Update measurement image card visibility
        updateMeasurementImageCard();
    });


    // Function to update measurement image card visibility
    function updateMeasurementImageCard() {
        const serviceType = document.getElementById('serviceType')?.value || '';
        const typeOfCustomize = document.getElementById('typeOfCustomize')?.value || '';
        const peType = document.getElementById('peType')?.value || '';
        
        const imageCard = document.getElementById('measurementImageCard');
        const cardBody = document.getElementById('measurementImageCardBody');
        const singleImageContainer = document.getElementById('singleImageContainer');
        const dualImageContainer = document.getElementById('dualImageContainer');
        const referenceImage = document.getElementById('measurementReferenceImage');
        const referenceImageTop = document.getElementById('measurementReferenceImageTop');
        const referenceImageBottom = document.getElementById('measurementReferenceImageBottom');
        const placeholder = document.getElementById('measurementImagePlaceholder');
        const bottomLabel = document.getElementById('bottomLabel');
        
        // Show image card when service type is customize and type is polo, polo_shirt, blouse, pants, shorts, skirt_palda, or pe
        const shouldShow = serviceType === 'customize' && 
                          (typeOfCustomize === 'polo' || typeOfCustomize === 'polo_shirt' || 
                           typeOfCustomize === 'blouse' || typeOfCustomize === 'pants' || 
                           typeOfCustomize === 'shorts' || typeOfCustomize === 'skirt_palda' || 
                           typeOfCustomize === 'pe');
        
        if (imageCard) {
            if (shouldShow) {
                imageCard.classList.remove('hidden');
                
                // Handle PE type - show two images
                if (typeOfCustomize === 'pe' && peType) {
                    // Add PE mode class for larger container
                    if (cardBody) cardBody.classList.add('pe-mode');
                    
                    // Hide single image, show dual images
                    if (singleImageContainer) singleImageContainer.style.display = 'none';
                    if (dualImageContainer) dualImageContainer.style.display = 'block';
                    if (placeholder) placeholder.style.display = 'none';
                    
                    // Top image is always polo
                    const topImagePath = '/static/images/polo_measurement_reference.png';
                    
                    // Bottom image depends on PE type
                    let bottomImagePath = '';
                    if (peType === 'short' || peType === 'shorts') {
                        bottomImagePath = '/static/images/shorts_measurement_reference.png';
                        if (bottomLabel) bottomLabel.textContent = 'Bottom (Shorts)';
                    } else if (peType === 'pants') {
                        bottomImagePath = '/static/images/pants_measurement_reference.png';
                        if (bottomLabel) bottomLabel.textContent = 'Bottom (Pants)';
                    }
                    
                    // Load top image
                    if (referenceImageTop) {
                        const imgTop = new Image();
                        imgTop.onload = function() {
                            referenceImageTop.src = topImagePath;
                        };
                        imgTop.src = topImagePath;
                    }
                    
                    // Load bottom image
                    if (bottomImagePath && referenceImageBottom) {
                        const imgBottom = new Image();
                        imgBottom.onload = function() {
                            referenceImageBottom.src = bottomImagePath;
                        };
                        imgBottom.src = bottomImagePath;
                    }
                } else {
                    // Remove PE mode class for single image
                    if (cardBody) cardBody.classList.remove('pe-mode');
                    
                    // Single image mode for other types
                    if (singleImageContainer) singleImageContainer.style.display = 'block';
                    if (dualImageContainer) dualImageContainer.style.display = 'none';
                    
                    // Set the appropriate measurement reference image based on type
                    let imagePath = '';
                    if (typeOfCustomize === 'pants') {
                        imagePath = '/static/images/pants_measurement_reference.png';
                    } else if (typeOfCustomize === 'shorts') {
                        imagePath = '/static/images/shorts_measurement_reference.png';
                    } else if (typeOfCustomize === 'skirt_palda') {
                        imagePath = '/static/images/skirt_measurement_reference.png';
                    } else if (typeOfCustomize === 'pe') {
                        // PE without type selected - show placeholder
                        if (singleImageContainer) singleImageContainer.style.display = 'none';
                        if (placeholder) placeholder.style.display = 'block';
                        return;
                    } else {
                        // Use polo measurement reference for polo, polo_shirt, and blouse
                        imagePath = '/static/images/polo_measurement_reference.png';
                    }
                    
                    if (imagePath && referenceImage) {
                        // Try to load the image
                        const img = new Image();
                        img.onload = function() {
                            referenceImage.src = imagePath;
                            if (placeholder) placeholder.style.display = 'none';
                        };
                        img.onerror = function() {
                            // If image doesn't exist, show placeholder
                            if (singleImageContainer) singleImageContainer.style.display = 'none';
                            if (placeholder) placeholder.style.display = 'block';
                        };
                        img.src = imagePath;
                    } else {
                        if (singleImageContainer) singleImageContainer.style.display = 'none';
                        if (placeholder) placeholder.style.display = 'block';
                    }
                }
            } else {
                imageCard.classList.add('hidden');
            }
        }
    }
    
    // Function to handle measurement image upload
    function handleMeasurementImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        // Validate file type
        if (!file.type.startsWith('image/')) {
            alert('Please select an image file.');
            return;
        }
        
        // Validate file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('Image size should be less than 5MB.');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('measurementImagePreview');
            const uploadText = document.getElementById('measurementImageUploadText');
            const cardBody = document.getElementById('measurementImageCardBody');
            const removeBtn = document.getElementById('measurementImageRemove');
            
            if (preview) {
                preview.src = e.target.result;
                preview.style.display = 'block';
            }
            if (uploadText) {
                uploadText.style.display = 'none';
            }
            if (cardBody) {
                cardBody.classList.add('has-image');
            }
            if (removeBtn) {
                removeBtn.classList.remove('hidden');
            }
        };
        reader.readAsDataURL(file);
    }
    
    // Function to handle measurement image upload for Blouse
    function handleMeasurementImageUploadBlouse(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        // Validate file type
        if (!file.type.startsWith('image/')) {
            alert('Please select an image file.');
            return;
        }
        
        // Validate file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('Image size should be less than 5MB.');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('measurementImagePreviewBlouse');
            const uploadText = document.getElementById('measurementImageUploadTextBlouse');
            const cardBody = document.getElementById('measurementImageCardBodyBlouse');
            const removeBtn = document.getElementById('measurementImageRemoveBlouse');
            
            if (preview) {
                preview.src = e.target.result;
                preview.style.display = 'block';
            }
            if (uploadText) {
                uploadText.style.display = 'none';
            }
            if (cardBody) {
                cardBody.classList.add('has-image');
            }
            if (removeBtn) {
                removeBtn.classList.remove('hidden');
            }
        };
        reader.readAsDataURL(file);
    }
    
    // Function to remove measurement image
    function removeMeasurementImage(event) {
        event.stopPropagation();
        
        const preview = document.getElementById('measurementImagePreview');
        const uploadText = document.getElementById('measurementImageUploadText');
        const cardBody = document.getElementById('measurementImageCardBody');
        const removeBtn = document.getElementById('measurementImageRemove');
        const input = document.getElementById('measurementImageInput');
        
        if (preview) {
            preview.src = '';
            preview.style.display = 'none';
        }
        if (uploadText) {
            uploadText.style.display = 'block';
        }
        if (cardBody) {
            cardBody.classList.remove('has-image');
        }
        if (removeBtn) {
            removeBtn.classList.add('hidden');
        }
        if (input) {
            input.value = '';
        }
    }
    
    // Function to remove measurement image for Blouse
    function removeMeasurementImageBlouse(event) {
        event.stopPropagation();
        
        const preview = document.getElementById('measurementImagePreviewBlouse');
        const uploadText = document.getElementById('measurementImageUploadTextBlouse');
        const cardBody = document.getElementById('measurementImageCardBodyBlouse');
        const removeBtn = document.getElementById('measurementImageRemoveBlouse');
        const input = document.getElementById('measurementImageInputBlouse');
        
        if (preview) {
            preview.src = '';
            preview.style.display = 'none';
        }
        if (uploadText) {
            uploadText.style.display = 'block';
        }
        if (cardBody) {
            cardBody.classList.remove('has-image');
        }
        if (removeBtn) {
            removeBtn.classList.add('hidden');
        }
        if (input) {
            input.value = '';
        }
    }
    
    // Make functions globally available
    window.handleMeasurementImageUpload = handleMeasurementImageUpload;
    window.handleMeasurementImageUploadBlouse = handleMeasurementImageUploadBlouse;
    window.removeMeasurementImage = removeMeasurementImage;
    window.removeMeasurementImageBlouse = removeMeasurementImageBlouse;

    // Customize show/hide logic (for Uniform customization types)
    const customizeType = document.getElementById('typeOfCustomize');
    if (customizeType) {
        customizeType.addEventListener('change', function() {
            const type = this.value;
            // Hide all customize subsections
            document.getElementById('pantsSizeSection').classList.add('hidden');
            document.getElementById('shortsSizeSection').classList.add('hidden');
            const poloContainer = document.getElementById('poloSizeSectionContainer');
            const blouseContainer = document.getElementById('blouseSizeSectionContainer');
            if (poloContainer) poloContainer.classList.add('hidden');
            if (blouseContainer) blouseContainer.classList.add('hidden');
            document.getElementById('poloSizeSection').classList.add('hidden');
            document.getElementById('blouseSizeSection').classList.add('hidden');
            document.getElementById('skirtPaldaSection').classList.add('hidden');
            document.getElementById('wholeSection').classList.add('hidden');
            document.getElementById('wholeMaleSizes').classList.add('hidden');
            document.getElementById('wholeFemaleSizes').classList.add('hidden');
            const pantsTypeSection = document.getElementById('pantsTypeSection');
            if (pantsTypeSection) {
                if (type === 'pants') {
                    pantsTypeSection.classList.remove('hidden');
                } else {
                    pantsTypeSection.classList.add('hidden');
                    document.getElementById('pantsType').value = '';
                }
            }
            const wholeGender = document.getElementById('wholeGender');
            if (wholeGender) {
                wholeGender.value = '';
            }

            const uniformButtonsSection = document.getElementById('uniformButtonsSection');
            
            if (type === 'pants') {
                document.getElementById('pantsSizeSection').classList.remove('hidden');
                // Show buttons section for pants
                if (uniformButtonsSection) uniformButtonsSection.classList.remove('hidden');
            } else if (type === 'shorts') {
                document.getElementById('shortsSizeSection').classList.remove('hidden');
                // Show buttons section for shorts
                if (uniformButtonsSection) uniformButtonsSection.classList.remove('hidden');
            } else if (type === 'polo' || type === 'polo_shirt') {
                const poloContainer = document.getElementById('poloSizeSectionContainer');
                if (poloContainer) {
                    poloContainer.classList.remove('hidden');
                    document.getElementById('poloSizeSection').classList.remove('hidden');
                }
                // Show buttons section for polo
                if (uniformButtonsSection) uniformButtonsSection.classList.remove('hidden');
                // Update image card visibility
                updateMeasurementImageCard();
            } else if (type === 'blouse') {
                const blouseContainer = document.getElementById('blouseSizeSectionContainer');
                if (blouseContainer) {
                    blouseContainer.classList.remove('hidden');
                    document.getElementById('blouseSizeSection').classList.remove('hidden');
                }
                // Hide buttons section for blouse
                if (uniformButtonsSection) uniformButtonsSection.classList.add('hidden');
                document.getElementById('uniformButtonType').value = '';
                document.getElementById('uniformButtonsNeeded').value = '0';
                // Update image card visibility
                updateMeasurementImageCard();
            } else if (type === 'skirt_palda') {
                document.getElementById('skirtPaldaSection').classList.remove('hidden');
                // Hide buttons section for skirt
                if (uniformButtonsSection) uniformButtonsSection.classList.add('hidden');
                document.getElementById('uniformButtonType').value = '';
                document.getElementById('uniformButtonsNeeded').value = '0';
            } else if (type === 'whole') {
                document.getElementById('wholeSection').classList.remove('hidden');
                // Hide buttons section for whole
                if (uniformButtonsSection) uniformButtonsSection.classList.add('hidden');
                document.getElementById('uniformButtonType').value = '';
                document.getElementById('uniformButtonsNeeded').value = '0';
            } else {
                // Hide buttons section if no type selected
                if (uniformButtonsSection) uniformButtonsSection.classList.add('hidden');
                document.getElementById('uniformButtonType').value = '';
                document.getElementById('uniformButtonsNeeded').value = '0';
            }
        });
    }

    // Blouse Sleeve show/hide logic
    const uniformBlouseSleeve = document.getElementById('uniformBlouseSleeve');
    if (uniformBlouseSleeve) {
        uniformBlouseSleeve.addEventListener('change', function() {
            const sleeveType = this.value;
            document.getElementById('blouseSleeveShort').classList.add('hidden');
            document.getElementById('blouseSleeve34').classList.add('hidden');
            document.getElementById('blouseSleeveLong').classList.add('hidden');
            
            if (sleeveType === 'short') {
                document.getElementById('blouseSleeveShort').classList.remove('hidden');
            } else if (sleeveType === '3/4') {
                document.getElementById('blouseSleeve34').classList.remove('hidden');
            } else if (sleeveType === 'long') {
                document.getElementById('blouseSleeveLong').classList.remove('hidden');
            }
        });
    }

    document.getElementById('wholeGender').addEventListener('change', function() {
        const gender = this.value;
        document.getElementById('wholeMaleSizes').classList.add('hidden');
        document.getElementById('wholeFemaleSizes').classList.add('hidden');
        if (gender === 'male') {
            document.getElementById('wholeMaleSizes').classList.remove('hidden');
        } else if (gender === 'female') {
            document.getElementById('wholeFemaleSizes').classList.remove('hidden');
        }
    });

    // Helper function to calculate thread meters for material modals
    function calculateMaterialThreadMeters(repairType, sewingStyle, quantity, materialType) {
        // Base thread lengths by repair type and sewing style
        const baseThreadLengths = {
            'putol': { 'straight_stitch': 50, 'zigzag_stitch': 70 },
            'pasada': { 'straight_stitch': 100, 'zigzag_stitch': 120 },
            'suklot': { 'straight_stitch': 100, 'zigzag_stitch': 120 },
            'baston': { 'straight_stitch': 100, 'zigzag_stitch': 120 },
            'baston_suklot': { 'straight_stitch': 150, 'zigzag_stitch': 170 },
            'baston_putol': { 'straight_stitch': 150, 'zigzag_stitch': 170 },
            'ambel': { 'straight_stitch': 100, 'zigzag_stitch': 120 },
            'general_tshirt_repair': { 'straight_stitch': 500, 'zigzag_stitch': 600 },
            'general_repair': { 'straight_stitch': 500, 'zigzag_stitch': 600 },
            'patches': { 'straight_stitch': 100, 'zigzag_stitch': 120 },
            'buttons': { 'straight_stitch': 50, 'zigzag_stitch': 70 },
            'lock_repair': { 'straight_stitch': 50, 'zigzag_stitch': 70 },
            'zipper_replacement': { 'straight_stitch': 100, 'zigzag_stitch': 120 },
            'elastic': { 'straight_stitch': 200, 'zigzag_stitch': 220 },
            'bewang': { 'straight_stitch': 200, 'zigzag_stitch': 220 }
        };
        
        // Get base thread length
        const stitchType = sewingStyle || 'straight_stitch';
        let baseLength = 0;
        
        if (baseThreadLengths[repairType] && baseThreadLengths[repairType][stitchType]) {
            baseLength = baseThreadLengths[repairType][stitchType];
        }
        
        // Calculate additional thread for materials
        let additionalThread = 0;
        quantity = parseFloat(quantity) || 0;
        
        if (materialType === 'buttons') {
            const baseButtons = 8; // 8 pieces = 1 group
            if (quantity > baseButtons) {
                additionalThread = (quantity - baseButtons) * 1;
            }
        } else if (materialType === 'patches') {
            const basePatches = 1;
            if (quantity > basePatches) {
                additionalThread = (quantity - basePatches) * 1;
            }
        } else if (materialType === 'zipper') {
            const baseZipperInches = 8;
            if (quantity > baseZipperInches) {
                additionalThread = (quantity - baseZipperInches) * 1;
            }
        } else if (materialType === 'lock') {
            const lockPiecesUsed = quantity * 4; // quantity is groups, 1 group = 4 pieces
            const baseLockPieces = 8;
            if (lockPiecesUsed > baseLockPieces) {
                additionalThread = (lockPiecesUsed - baseLockPieces) * 1;
            }
        } else if (materialType === 'elastic' || materialType === 'bewang') {
            const baseInches = 20;
            if (quantity > baseInches) {
                additionalThread = (quantity - baseInches) * 1;
            }
        }
        
        return baseLength + additionalThread;
    }
    
    // Function to update thread meters in material modals
    function updateMaterialThreadMeters(materialType) {
        const repairType = document.getElementById('repairType')?.value || '';
        const sewingStyle = document.getElementById('sewingStyle')?.value || '';
        
        let quantity = 0;
        let fieldId = '';
        
        if (materialType === 'buttons') {
            quantity = parseFloat(document.getElementById('buttonQuantityNeeded')?.value || 0) || 0;
            fieldId = 'buttonThreadMetersNeeded';
        } else if (materialType === 'lock') {
            const groups = parseFloat(document.getElementById('locksQuantityNeeded')?.value || 0) || 0;
            quantity = groups; // Will be converted to pieces in calculation
            fieldId = 'locksThreadMetersNeeded';
        } else if (materialType === 'zipper') {
            quantity = parseFloat(document.getElementById('inchesNeeded')?.value || 0) || 0;
            fieldId = 'zipperThreadMetersNeeded';
        } else if (materialType === 'elastic' || materialType === 'bewang') {
            quantity = parseFloat(document.getElementById('garterInchesNeeded')?.value || 0) || 0;
            fieldId = 'garterThreadMetersNeeded';
        } else if (materialType === 'patches') {
            quantity = parseFloat(document.getElementById('patchQuantityNeeded')?.value || 0) || 0;
            fieldId = 'patchThreadLength';
        }
        
        if (fieldId) {
            const threadMeters = calculateMaterialThreadMeters(repairType, sewingStyle, quantity, materialType);
            const field = document.getElementById(fieldId);
            if (field) {
                field.value = threadMeters > 0 ? threadMeters.toFixed(1) : '';
            }
        }
    }
    
    // Function to automatically calculate thread length based on repair type, sewing style, and materials
    function calculateThreadLength() {
        const repairType = document.getElementById('repairType')?.value || '';
        const sewingStyle = document.getElementById('sewingStyle')?.value || '';
        const threadMetersField = document.getElementById('threadMeters');
        
        if (!repairType || !threadMetersField) {
            return;
        }
        
        // Base thread lengths by repair type and sewing style
        const baseThreadLengths = {
            'putol': { 'straight_stitch': 50, 'zigzag_stitch': 70 },
            'pasada': { 'straight_stitch': 100, 'zigzag_stitch': 120 },
            'suklot': { 'straight_stitch': 100, 'zigzag_stitch': 120 },
            'baston': { 'straight_stitch': 100, 'zigzag_stitch': 120 },
            'baston_suklot': { 'straight_stitch': 150, 'zigzag_stitch': 170 },
            'baston_putol': { 'straight_stitch': 150, 'zigzag_stitch': 170 },
            'ambel': { 'straight_stitch': 100, 'zigzag_stitch': 120 },
            'general_tshirt_repair': { 'straight_stitch': 500, 'zigzag_stitch': 600 },
            'general_repair': { 'straight_stitch': 500, 'zigzag_stitch': 600 },
            'patches': { 'straight_stitch': 100, 'zigzag_stitch': 120 },
            'buttons': { 'straight_stitch': 50, 'zigzag_stitch': 70 },
            'lock_repair': { 'straight_stitch': 50, 'zigzag_stitch': 70 },
            'zipper_replacement': { 'straight_stitch': 100, 'zigzag_stitch': 120 },
            'elastic': { 'straight_stitch': 200, 'zigzag_stitch': 220 },
            'bewang': { 'straight_stitch': 200, 'zigzag_stitch': 220 }
        };
        
        // Get base thread length (default to straight stitch if sewing style not selected)
        const stitchType = sewingStyle || 'straight_stitch';
        let baseLength = 0;
        
        if (baseThreadLengths[repairType] && baseThreadLengths[repairType][stitchType]) {
            baseLength = baseThreadLengths[repairType][stitchType];
        }
        
        // Calculate additional thread for materials
        let additionalThread = 0;
        
        // Buttons: Base is 8 pieces (1 group), add 1 meter per additional piece
        if (repairType === 'buttons') {
            const buttonQuantityUsed = parseFloat(document.getElementById('selectedButtonQuantityUsed')?.value || 0) || 0;
            const baseButtons = 8; // 8 pieces = 1 group
            if (buttonQuantityUsed > baseButtons) {
                additionalThread = (buttonQuantityUsed - baseButtons) * 1;
            }
        }
        
        // Patches: Base is 1 piece, add 1 meter per additional piece
        if (repairType === 'patches') {
            const patchQuantityUsed = parseFloat(document.getElementById('selectedPatchQuantityUsed')?.value || 0) || 0;
            const basePatches = 1;
            if (patchQuantityUsed > basePatches) {
                additionalThread = (patchQuantityUsed - basePatches) * 1;
            }
        }
        
        // Zipper: Base is 8 inches, add 1 meter per additional inch
        if (repairType === 'zipper_replacement') {
            const zipperInchesUsed = parseFloat(document.getElementById('selectedZipperInchesUsed')?.value || 0) || 0;
            const baseZipperInches = 8;
            if (zipperInchesUsed > baseZipperInches) {
                additionalThread = (zipperInchesUsed - baseZipperInches) * 1;
            }
        }
        
        // Lock Repair: Base is 8 pieces (1 group), add 1 meter per additional piece
        if (repairType === 'lock_repair') {
            const lockGroupsUsed = parseFloat(document.getElementById('selectedLockGroupsUsed')?.value || 0) || 0;
            const lockPiecesUsed = lockGroupsUsed * 4; // 1 group = 4 pieces
            const baseLockPieces = 8;
            if (lockPiecesUsed > baseLockPieces) {
                additionalThread = (lockPiecesUsed - baseLockPieces) * 1;
            }
        }
        
        // Elastic: Base is 20 inches, add 1 meter per additional inch
        if (repairType === 'elastic') {
            const elasticInchesUsed = parseFloat(document.getElementById('selectedGarterInchesUsedElastic')?.value || 0) || 0;
            const baseElasticInches = 20;
            if (elasticInchesUsed > baseElasticInches) {
                additionalThread = (elasticInchesUsed - baseElasticInches) * 1;
            }
        }
        
        // Bewang: Base is 20 inches, add 1 meter per additional inch
        if (repairType === 'bewang') {
            const bewangInchesUsed = parseFloat(document.getElementById('selectedGarterInchesUsed')?.value || 0) || 0;
            const baseBewangInches = 20;
            if (bewangInchesUsed > baseBewangInches) {
                additionalThread = (bewangInchesUsed - baseBewangInches) * 1;
            }
        }
        
        // Calculate total thread length
        const totalThreadLength = baseLength + additionalThread;
        
        // Set the thread meters field
        if (totalThreadLength > 0) {
            threadMetersField.value = totalThreadLength.toFixed(1);
        } else {
            threadMetersField.value = '';
        }
    }
    
    // Show/hide repair sub-sections
    document.getElementById('repairType').addEventListener('change', function() {
        const repairType = this.value;
        
        // Hide all sub-sections
        document.getElementById('zipperSection').classList.add('hidden');
        document.getElementById('patchSection').classList.add('hidden');
        document.getElementById('buttonsSection').classList.add('hidden');
        document.getElementById('lockRepairSection').classList.add('hidden');
        document.getElementById('bewangSection').classList.add('hidden');
        document.getElementById('elasticSection').classList.add('hidden');
        document.getElementById('threadDetailsSection').classList.add('hidden');
        
        // Reset thread details fields
        document.getElementById('threadColor').value = '';
        document.getElementById('threadMeters').value = '';
        document.getElementById('threadColorOther').value = '';
        document.getElementById('threadColorOtherField').style.display = 'none';
        
        // Reset sewing style (optional field, so we don't require it to be cleared)
        const sewingStyleField = document.getElementById('sewingStyle');
        if (sewingStyleField) {
            sewingStyleField.value = '';
        }
        
        // Recalculate thread length after reset
        calculateThreadLength();
        
        // Reset patch fields
        document.getElementById('patchProvided').value = 'no';
        document.getElementById('selectedPatchId').value = '';
        document.getElementById('selectedPatchQuantityUsed').value = '';
        document.getElementById('selectedThreadColorPatches').value = '';
        document.getElementById('selectedThreadColorOtherPatches').value = '';
        document.getElementById('selectedPatchThreadLength').value = '';
        const selectedPatchInfo = document.getElementById('selectedPatchInfo');
        if (selectedPatchInfo) selectedPatchInfo.style.display = 'none';
        
        // Reset garter fields for bewang
        document.getElementById('selectedGarterId').value = '';
        document.getElementById('selectedGarterInchesUsed').value = '';
        const selectedGarterInfo = document.getElementById('selectedGarterInfo');
        if (selectedGarterInfo) selectedGarterInfo.style.display = 'none';
        
        // Reset garter fields for elastic
        document.getElementById('selectedGarterIdElastic').value = '';
        document.getElementById('selectedGarterInchesUsedElastic').value = '';
        const selectedGarterInfoElastic = document.getElementById('selectedGarterInfoElastic');
        if (selectedGarterInfoElastic) selectedGarterInfoElastic.style.display = 'none';
        
        // Repair types that require thread details - defined globally to avoid duplicate declarations
        if (typeof window.threadRequiredTypes === 'undefined') {
            window.threadRequiredTypes = [
                'ambel',
                'baston',
                'baston_suklot',
                'baston_putol',
                'putol',
                'suklot',
                'pasada',
                'bewang',
                'elastic',
                'general_repair',
                'general_tshirt_repair'
            ];
        }
        // Use global directly - don't redeclare const
        const threadRequiredTypesArray = window.threadRequiredTypes;
        
        // Show zipper section only for zipper_replacement
        if (repairType === 'zipper_replacement') {
            document.getElementById('zipperSection').classList.remove('hidden');
            // Check zipper provided status and show/hide browse button accordingly
            toggleZipperBrowseSection();
        }
        
        // Show buttons section for buttons repair type
        if (repairType === 'buttons') {
            document.getElementById('buttonsSection').classList.remove('hidden');
        }
        
        // Show patch section for patches repair type
        if (repairType === 'patches') {
            document.getElementById('patchSection').classList.remove('hidden');
        }
        
        // Show lock repair section for lock_repair
        if (repairType === 'lock_repair') {
            document.getElementById('lockRepairSection').classList.remove('hidden');
        }
        
        // Show bewang section for bewang
        if (repairType === 'bewang') {
            document.getElementById('bewangSection').classList.remove('hidden');
        }
        
        // Show elastic section for elastic
        if (repairType === 'elastic') {
            document.getElementById('elasticSection').classList.remove('hidden');
        }
        
        // Calculate and set thread length automatically
        calculateThreadLength();
        
        // Show thread details section for specific repair types
        if (threadRequiredTypesArray && threadRequiredTypesArray.includes(repairType)) {
            document.getElementById('threadDetailsSection').classList.remove('hidden');
        }
    });
    
    // Add event listener for sewing style changes to recalculate thread length
    const sewingStyleSelect = document.getElementById('sewingStyle');
    if (sewingStyleSelect) {
        sewingStyleSelect.addEventListener('change', function() {
            calculateThreadLength();
        });
    }
    
    // Toggle thread color other field for repair thread details
    const repairThreadColorSelect = document.getElementById('threadColor');
    if (repairThreadColorSelect) {
        repairThreadColorSelect.addEventListener('change', function() {
            const threadColorOtherField = document.getElementById('threadColorOtherField');
            const threadColorOtherInput = document.getElementById('threadColorOther');
            
            if (this.value === 'other') {
                if (threadColorOtherField) threadColorOtherField.style.display = 'block';
                if (threadColorOtherInput) {
                    threadColorOtherInput.required = true;
                    threadColorOtherInput.focus();
                }
            } else {
                if (threadColorOtherField) threadColorOtherField.style.display = 'none';
                if (threadColorOtherInput) {
                    threadColorOtherInput.required = false;
                    threadColorOtherInput.value = '';
                }
            }
        });
    }
    
    // Toggle Browse Zippers section based on Zipper Provided selection
    function toggleZipperBrowseSection() {
        const zipperProvided = document.getElementById('zipperProvided');
        const browseZippersBtn = document.getElementById('browseZippersBtn');
        const browseZippersLabel = document.getElementById('browseZippersLabel');
        const selectedZipperInfo = document.getElementById('selectedZipperInfo');
        
        if (zipperProvided && browseZippersBtn) {
            if (zipperProvided.value === 'yes') {
                // Hide Browse Zippers button and label
                if (browseZippersLabel) {
                    browseZippersLabel.style.display = 'none';
                }
                browseZippersBtn.style.display = 'none';
                if (selectedZipperInfo) {
                    selectedZipperInfo.style.display = 'none';
                }
                
                // Clear selected zipper data
                document.getElementById('selectedZipperId').value = '';
                document.getElementById('selectedZipperInchesUsed').value = '';
                document.getElementById('selectedThreadColor').value = '';
                document.getElementById('selectedThreadColorOther').value = '';
                if (selectedZipperInfo) {
                    document.getElementById('selectedZipperName').textContent = '';
                    document.getElementById('selectedZipperSize').textContent = '';
                    document.getElementById('selectedZipperAvailable').textContent = '';
                    document.getElementById('selectedZipperPrice').textContent = '';
                    document.getElementById('selectedZipperInches').textContent = '';
                }
            } else {
                // Show Browse Zippers button and label
                if (browseZippersLabel) {
                    browseZippersLabel.style.display = 'block';
                }
                browseZippersBtn.style.display = 'block';
            }
        }
    }
    
    // Add event listener for Zipper Provided dropdown
    const zipperProvidedSelect = document.getElementById('zipperProvided');
    if (zipperProvidedSelect) {
        zipperProvidedSelect.addEventListener('change', function() {
            toggleZipperBrowseSection();
        });
    }

    // Auto-calculate return date for rent
    document.getElementById('dateRent').addEventListener('change', function() {
        const rentDate = new Date(this.value);
        if (rentDate) {
            const returnDate = new Date(rentDate);
            returnDate.setDate(returnDate.getDate() + pricing.rent.rent_days);
            document.getElementById('returnDate').value = returnDate.toISOString().split('T')[0];
        }
    });

    // Setup event listeners for rental brochure
    function setupEventListeners() {
        // Category filter
        document.getElementById('rentalCategoryFilter').addEventListener('change', function() {
            displayRentalProducts();
        });
    }

    // Rental Brochure Functions
    function openRentalBrochure() {
        console.log('Opening rental brochure...');
        loadRentalProducts();
        setupEventListeners();
        rentalBrochureModal.show();
    }

    function loadRentalProducts() {
        console.log('Loading rental products...');
        fetch('/api/products/', { credentials: 'same-origin' })
            .then(response => {
                const ct = response.headers.get('content-type') || '';
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.status);
                }
                if (ct.includes('application/json')) {
                    return response.json();
                }
                throw new Error('Unexpected content-type: ' + ct);
            })
            .then(data => {
                console.log('Products loaded:', data);
                if (data.success) {
                    allRentalProducts = data.products;
                    displayRentalProducts();
                    // Load rental status after products are loaded
                    setTimeout(() => {
                        loadRentalStatus();
                    }, 500);
                } else {
                    console.error('Failed to load products:', data.error);
                }
            })
            .catch(error => {
                console.error('Error loading products:', error);
            });
    }

    function displayRentalProducts() {
        const grid = document.getElementById('rentalItemsGrid');
        grid.innerHTML = '';
        
        const filteredProducts = filterRentalProducts();
        
        filteredProducts.forEach(product => {
            const card = createRentalItemCard(product);
            grid.appendChild(card);
        });
        
        // After displaying, ensure rental status is properly applied
        updateRentalStatusDisplay();
    }
    
    function updateRentalStatusDisplay() {
        // Update rental status for all displayed cards
        allRentalProducts.forEach(product => {
            const card = document.querySelector(`[data-product-id="${product.id}"]`);
            if (card) {
                const rentalStatus = product.rental_status || 'available';
                if (rentalStatus === 'rented') {
                    card.classList.add('rented');
                    const stockElement = card.querySelector('.rental-item-stock');
                    if (stockElement) {
                        stockElement.textContent = 'RENTED';
                        stockElement.className = 'rental-item-stock rented';
                    }
                } else {
                    card.classList.remove('rented');
                }
            }
        });
    }

    function filterRentalProducts() {
        const categoryFilter = document.getElementById('rentalCategoryFilter').value;
        
        let filtered = allRentalProducts;
        
        if (categoryFilter) {
            filtered = allRentalProducts.filter(product => 
                product.category.toLowerCase() === categoryFilter.toLowerCase()
            );
        }
        
        return filtered;
    }

    function createRentalItemCard(product) {
        const card = document.createElement('div');
        card.className = 'rental-item-card';
        card.setAttribute('data-product-id', product.id);
        
        // Add rented class if product is rented
        if (product.rental_status === 'rented') {
            card.classList.add('rented');
        }
        
        const isSelected = selectedRentalProducts.some(p => p.id === product.id);
        if (isSelected) {
            card.classList.add('selected');
        }
        
        // Determine status display
        let statusDisplay = 'Available';
        let statusClass = 'available';
        
        const rentalStatus = product.rental_status || 'available';
        
        if (rentalStatus === 'rented') {
            statusDisplay = 'RENTED';
            statusClass = 'rented';
        } else if (rentalStatus === 'maintenance') {
            statusDisplay = 'Maintenance';
            statusClass = 'maintenance';
        } else if (!product.is_available || product.quantity <= 0) {
            statusDisplay = 'Out of Stock';
            statusClass = 'out-of-stock';
        } else if (rentalStatus === 'available') {
            statusDisplay = 'Available';
            statusClass = 'available';
        }
        
        const imageUrl = product.image || product.image_url || '/static/images/placeholder.png';
        const categoryName = product.category || 'Uncategorized';
        
        card.innerHTML = `
            <img src="${imageUrl}" 
                 alt="${product.name}" 
                 class="rental-item-image"
                 onclick="showImagePreview('${imageUrl}', '${product.name}', '₱${product.price}')">
            <div class="rental-item-name" style="color: #ffffff !important; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);">${product.name}</div>
            <div class="rental-item-price" style="color: #ffffff !important; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);">₱${product.price}</div>
            <div class="rental-item-category" style="color: #ffffff !important; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);">${categoryName}</div>
            <div class="rental-item-stock ${statusClass}" style="text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);">${statusDisplay}</div>
            ${isSelected ? `` : ''}
        `;
        
        card.addEventListener('click', function(e) {
            if (!e.target.classList.contains('rental-item-image') && 
                !e.target.classList.contains('quantity-selector') &&
                !e.target.closest('.quantity-selector')) {
                selectRentalProduct(product);
            }
        });
        
        return card;
    }

    function selectRentalProduct(product) {
        const rentalStatus = product.rental_status || 'available';
        
        // Prevent selection of rented items
        if (rentalStatus === 'rented') {
            alert(`Cannot select "${product.name}" - This item is currently rented out. Please select an available item.`);
            return;
        }
        
        // Prevent selection of items under maintenance
        if (rentalStatus === 'maintenance') {
            alert(`Cannot select "${product.name}" - This item is under maintenance. Please select an available item.`);
            return;
        }
        
        // Prevent selection of out of stock items
        if (!product.is_available || product.quantity <= 0) {
            alert(`Cannot select "${product.name}" - This item is out of stock. Please select an available item.`);
            return;
        }
        
        const existingIndex = selectedRentalProducts.findIndex(p => p.id === product.id);
        
        if (existingIndex >= 0) {
            // Remove from selection
            selectedRentalProducts.splice(existingIndex, 1);
        } else {
            // Add to selection
            selectedRentalProducts.push({
                ...product,
                quantity: 1  // fixed to 1 for rentals
            });
        }
        
        updateSelectedItemsDisplay();
        displayRentalProducts(); // Refresh to update selection state
    }

    function updateQuantity(productId, change, newValue = null) {
        const product = selectedRentalProducts.find(p => p.id === productId);
        if (product) {
            if (newValue !== null) {
                product.quantity = parseInt(newValue) || 1;
            } else {
                product.quantity = Math.max(1, product.quantity + change);
            }
            updateSelectedItemsDisplay();
            displayRentalProducts(); // Refresh to update quantity display
        }
    }

    function getSelectedProductQuantity(productId) {
        const product = selectedRentalProducts.find(p => p.id === productId);
        return product ? product.quantity : 1;
    }

    function updateSelectedItemsDisplay() {
        const container = document.getElementById('selectedRentalItems');
        const totalItemsInput = document.getElementById('totalRentalItems');
        
        if (selectedRentalProducts.length === 0) {
            container.innerHTML = '<div class="text-muted">No items selected</div>';
            totalItemsInput.value = 1;
            return;
        }
        
        const totalQuantity = selectedRentalProducts.length;
        totalItemsInput.value = totalQuantity;
        
        container.innerHTML = `
            <div class="selected-items-display">
                ${selectedRentalProducts.map(product => `
                    <div class="selected-item">
                        <div class="selected-item-info">
                            <div class="selected-item-name">${product.name}</div>
                            <div class="selected-item-details">${product.category}</div>
                        </div>
                        <div class="selected-item-price">₱${product.price}</div>
                        <button type="button" class="remove-item-btn" onclick="removeRentalProduct(${product.id})">×</button>
                    </div>
                `).join('')}
            </div>
        `;
    }

    function removeRentalProduct(productId) {
        selectedRentalProducts = selectedRentalProducts.filter(p => p.id !== productId);
        updateSelectedItemsDisplay();
        displayRentalProducts(); // Refresh to update selection state
    }

    function confirmRentalSelection() {
        if (selectedRentalProducts.length === 0) {
            alert('Please select at least one rental item');
            return;
        }
        
        rentalBrochureModal.hide();
        updateSelectedItemsDisplay();
    }

    // Image Preview Functions
    function showImagePreview(imageSrc, productName, productPrice) {
        document.getElementById('previewImage').src = imageSrc;
        document.getElementById('previewProductName').textContent = productName;
        document.getElementById('previewProductPrice').textContent = productPrice;
        imagePreviewModal.show();
    }

    // Rental Status Functions
    function loadRentalStatus() {
        return fetch('/api/rental-status/', { credentials: 'same-origin' })
            .then(response => {
                const ct = response.headers.get('content-type') || '';
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.status);
                }
                if (ct.includes('application/json')) {
                    return response.json();
                }
                throw new Error('Unexpected content-type: ' + ct);
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update rental status in allRentalProducts array
                    Object.keys(data.rental_status).forEach(productId => {
                        const status = data.rental_status[productId];
                        const product = allRentalProducts.find(p => p.id == productId);
                        if (product) {
                            product.rental_status = status.rental_status || 'available';
                            product.is_rented = status.is_rented || false;
                        }
                    });
                    
                    // Apply rented styling to cards (if they exist)
                    Object.keys(data.rental_status).forEach(productId => {
                        const status = data.rental_status[productId];
                        const card = document.querySelector(`[data-product-id="${productId}"]`);
                        if (card) {
                            if (status.is_rented || status.rental_status === 'rented') {
                                card.classList.add('rented');
                                const stockElement = card.querySelector('.rental-item-stock');
                                if (stockElement) {
                                    stockElement.textContent = 'RENTED';
                                    stockElement.className = 'rental-item-stock rented';
                                }
                            } else {
                                card.classList.remove('rented');
                                const stockElement = card.querySelector('.rental-item-stock');
                                if (stockElement && status.rental_status === 'available') {
                                    stockElement.textContent = 'Available';
                                    stockElement.className = 'rental-item-stock available';
                                }
                            }
                        }
                    });
                }
                return data;
            })
            .catch(error => {
                console.error('Error loading rental status:', error);
                return { success: false };
            });
    }

    function refreshRentalStatus() {
        if (typeof loadRentalStatus === 'function') {
            loadRentalStatus();
        }
    }

    // ========== ZIPPER BROCHURE FUNCTIONS ==========
    
    // Initialize zipper modals
    function initializeZipperModals() {
        const zipperModalElement = document.getElementById('zipperBrochureModal');
        const inchesModalElement = document.getElementById('zipperInchesModal');
        
        if (zipperModalElement) {
            zipperBrochureModal = new bootstrap.Modal(zipperModalElement, {
                backdrop: false,
                keyboard: true
            });
            
            // Remove any backdrop that might be created
            zipperModalElement.addEventListener('shown.bs.modal', function() {
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach(backdrop => backdrop.remove());
                document.body.style.overflow = 'auto';
                document.body.classList.remove('modal-open');
            });
        }
        if (inchesModalElement) {
            zipperInchesModal = new bootstrap.Modal(inchesModalElement, {
                backdrop: true
            });
            
            // Add event listener for thread color "other" option in zipper modal
            const zipperThreadColorSelect = document.getElementById('zipperThreadColor');
            if (zipperThreadColorSelect) {
                zipperThreadColorSelect.addEventListener('change', function() {
                    const threadColorOtherField = document.getElementById('zipperThreadColorOtherField');
                    const threadColorOtherInput = document.getElementById('zipperThreadColorOther');
                    const errorDiv = document.getElementById('inchesError');
                    
                    // Clear error message when a valid color is selected
                    if (this.value && this.value !== '' && this.value !== 'other') {
                        if (errorDiv) errorDiv.style.display = 'none';
                    }
                    
                    if (this.value === 'other') {
                        if (threadColorOtherField) threadColorOtherField.style.display = 'block';
                        if (threadColorOtherInput) {
                            threadColorOtherInput.required = true;
                            threadColorOtherInput.focus();
                        }
                    } else {
                        if (threadColorOtherField) threadColorOtherField.style.display = 'none';
                        if (threadColorOtherInput) {
                            threadColorOtherInput.required = false;
                            threadColorOtherInput.value = '';
                        }
                    }
                });
            }
        }
    }
    
    // Open zipper brochure
    function openZipperBrochure() {
        if (!zipperBrochureModal) {
            initializeZipperModals();
        }
        loadZippers();
        zipperBrochureModal.show();
    }
    
    // Load zippers from API
    function loadZippers() {
        fetch('/api/zippers/', { credentials: 'same-origin' })
            .then(response => {
                const ct = response.headers.get('content-type') || '';
                if (!response.ok) throw new Error('Network response was not ok: ' + response.status);
                if (ct.includes('application/json')) return response.json();
                throw new Error('Unexpected content-type: ' + ct);
            })
            .then(data => {
                if (data.success) {
                    allZippers = data.zippers;
                    displayZippers();
                    populateSizeFilter();
                } else {
                    console.error('Failed to load zippers:', data.error);
                    alert('Failed to load zippers. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error loading zippers:', error);
                alert('Error loading zippers. Please check the console for details.');
            });
    }
    
    // Display zippers in grid
    function displayZippers() {
        const grid = document.getElementById('zipperItemsGrid');
        if (!grid) return;
        
        const sizeFilter = document.getElementById('zipperSizeFilter')?.value || '';
        let filteredZippers = allZippers;
        
        if (sizeFilter) {
            filteredZippers = allZippers.filter(z => {
                const zipperSize = extractZipperSize(z.name, z.description);
                return zipperSize && zipperSize.toLowerCase().includes(sizeFilter.toLowerCase());
            });
        }
        
        grid.innerHTML = '';
        
        if (filteredZippers.length === 0) {
            grid.innerHTML = '<div class="col-12 text-center text-white">No zippers available</div>';
            return;
        }
        
        filteredZippers.forEach(zipper => {
            const card = createZipperCard(zipper);
            grid.appendChild(card);
        });
    }
    
    // Extract zipper size from name or description
    function extractZipperSize(name, description) {
        const text = (name + ' ' + (description || '')).toLowerCase();
        // Look for common size patterns
        const sizePatterns = [
            /size[:\s]+(\w+)/i,
            /(\d+[a-z]*)/i,
            /(small|medium|large|xl|xxl)/i,
            /(pants|bag|jacket)/i
        ];
        
        for (const pattern of sizePatterns) {
            const match = text.match(pattern);
            if (match) return match[1] || match[0];
        }
        
        return 'Standard';
    }
    
    // Create zipper card
    function createZipperCard(zipper) {
        const card = document.createElement('div');
        card.className = 'zipper-card';
        card.style.cssText = 'background: #2d2d2d; border-radius: 8px; padding: 15px; cursor: pointer; transition: transform 0.2s; border: 2px solid #444; position: relative; z-index: 1; pointer-events: auto;';
        card.onmouseover = function() { 
            this.style.transform = 'scale(1.02)'; 
            this.style.borderColor = '#3b82f6'; 
            this.style.boxShadow = '0 4px 8px rgba(59, 130, 246, 0.3)';
        };
        card.onmouseout = function() { 
            this.style.transform = 'scale(1)'; 
            this.style.borderColor = '#444'; 
            this.style.boxShadow = 'none';
        };
        
        const availableInches = zipper.quantity || 0;
        const pricePerInch = parseFloat(zipper.price) || 0;
        const size = extractZipperSize(zipper.name, zipper.description);
        const isAvailable = availableInches > 0;
        const statusClass = isAvailable ? 'text-success' : 'text-danger';
        const statusText = isAvailable ? 'Available' : 'Out of Stock';
        
        card.innerHTML = `
            <div style="text-align: center; margin-bottom: 10px;">
                ${zipper.image ? 
                    `<img src="${zipper.image}" alt="${zipper.name}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 5px;">` :
                    `<div style="width: 100%; height: 150px; background: #444; border-radius: 5px; display: flex; align-items: center; justify-content: center; color: #888;">
                        <i class="fas fa-zipper" style="font-size: 48px;"></i>
                    </div>`
                }
            </div>
            <div style="color: #ffffff; font-weight: bold; margin-bottom: 5px;">${zipper.name}</div>
            <div style="color: #aaa; font-size: 0.9em; margin-bottom: 5px;">Size: ${size}</div>
            <div style="color: #aaa; font-size: 0.9em; margin-bottom: 5px;">Available: <span class="${statusClass}">${availableInches} inches</span></div>
            <div style="color: #3b82f6; font-weight: bold; margin-bottom: 5px;">₱${pricePerInch.toFixed(2)} per inch</div>
            <div style="color: #aaa; font-size: 0.85em; margin-top: 10px; padding-top: 10px; border-top: 1px solid #444;">
                Status: <span class="${statusClass}">${statusText}</span>
            </div>
        `;
        
        card.addEventListener('click', function(e) {
            e.stopPropagation();
            e.preventDefault();
            if (isAvailable) {
                selectZipper(zipper);
            } else {
                alert('This zipper is out of stock. Please select another zipper.');
            }
        });
        
        // Ensure card is clickable
        card.setAttribute('data-zipper-id', zipper.id);
        card.style.pointerEvents = 'auto';
        card.style.userSelect = 'none';
        
        return card;
    }
    
    // Toggle thread color other field
    function toggleThreadColorOtherField() {
        const threadColorSelect = document.getElementById('threadColor');
        const threadColorOtherField = document.getElementById('threadColorOtherField');
        const threadColorOtherInput = document.getElementById('threadColorOther');
        
        if (threadColorSelect && threadColorOtherField) {
            if (threadColorSelect.value === 'other') {
                threadColorOtherField.style.display = 'block';
                if (threadColorOtherInput) {
                    threadColorOtherInput.required = true;
                    threadColorOtherInput.focus();
                }
            } else {
                threadColorOtherField.style.display = 'none';
                if (threadColorOtherInput) {
                    threadColorOtherInput.required = false;
                    threadColorOtherInput.value = '';
                }
            }
        }
    }
    
    // Select zipper and show inches input modal
    function selectZipper(zipper) {
        selectedZipper = zipper;
        document.getElementById('modalZipperName').textContent = zipper.name;
        document.getElementById('modalZipperAvailable').textContent = zipper.quantity || 0;
        document.getElementById('inchesNeeded').value = '';
        const zipperThreadColor = document.getElementById('zipperThreadColor');
        const zipperThreadColorOther = document.getElementById('zipperThreadColorOther');
        const zipperThreadColorOtherField = document.getElementById('zipperThreadColorOtherField');
        if (zipperThreadColor) zipperThreadColor.value = '';
        if (zipperThreadColorOther) zipperThreadColorOther.value = '';
        if (zipperThreadColorOtherField) zipperThreadColorOtherField.style.display = 'none';
        document.getElementById('inchesError').style.display = 'none';
        
        zipperBrochureModal.hide();
        if (!zipperInchesModal) {
            initializeZipperModals();
        }
        // Calculate and set thread meters
        updateMaterialThreadMeters('zipper');
        
        // Add event listener to recalculate when quantity changes
        const zipperInchesInput = document.getElementById('inchesNeeded');
        if (zipperInchesInput) {
            zipperInchesInput.addEventListener('input', function() {
                updateMaterialThreadMeters('zipper');
            });
        }
        
        zipperInchesModal.show();
    }
    
    // Confirm zipper selection with inches
    async function confirmZipperSelection() {
        const inchesNeeded = parseFloat(document.getElementById('inchesNeeded').value);
        const threadColorSelect = document.getElementById('zipperThreadColor');
        const threadColor = threadColorSelect ? threadColorSelect.value : '';
        const threadColorOtherInput = document.getElementById('zipperThreadColorOther');
        const threadColorOther = threadColorOtherInput ? threadColorOtherInput.value : '';
        const errorDiv = document.getElementById('inchesError');
        
        if (!inchesNeeded || inchesNeeded <= 0) {
            errorDiv.textContent = 'Please enter a valid number of inches (greater than 0)';
            errorDiv.style.display = 'block';
            return;
        }
        
        if (!selectedZipper) {
            errorDiv.textContent = 'No zipper selected. Please try again.';
            errorDiv.style.display = 'block';
            return;
        }
        
        if (!threadColor || threadColor.trim() === '') {
            errorDiv.textContent = 'Please select a thread color';
            errorDiv.style.display = 'block';
            return;
        }
        
        if (threadColor === 'other' && !threadColorOther.trim()) {
            errorDiv.textContent = 'Please enter a custom thread color name';
            errorDiv.style.display = 'block';
            return;
        }
        
        // Check thread availability
        const finalThreadColor = threadColor === 'other' ? threadColorOther.trim() : threadColor;
        const threadAvailability = await checkThreadAvailability(finalThreadColor);
        
        if (!threadAvailability.found) {
            errorDiv.textContent = `Thread color "${finalThreadColor}" not found in materials. Out of stock, please choose other color.`;
            errorDiv.style.display = 'block';
            return;
        }
        
        if (!threadAvailability.available || threadAvailability.quantity <= 0) {
            errorDiv.textContent = `Thread color "${finalThreadColor}" is out of stock. Please choose other color.`;
            errorDiv.style.display = 'block';
            return;
        }
        
        const availableInches = parseFloat(selectedZipper.quantity) || 0;
        if (inchesNeeded > availableInches) {
            errorDiv.textContent = `Only ${availableInches} inches available. Please enter a smaller amount.`;
            errorDiv.style.display = 'block';
            return;
        }
        
        // Store selected zipper info
        document.getElementById('selectedZipperId').value = selectedZipper.id;
        document.getElementById('selectedZipperInchesUsed').value = inchesNeeded;
        
        // Recalculate thread length
        calculateThreadLength();
        document.getElementById('selectedThreadColor').value = threadColor;
        document.getElementById('selectedThreadColorOther').value = threadColor === 'other' ? threadColorOther.trim() : '';
        
        // Get thread color display name
        const threadColorDisplay = threadColor === 'other' ? threadColorOther.trim() : (threadColorSelect.options[threadColorSelect.selectedIndex]?.text || threadColor);
        
        // Update display
        document.getElementById('selectedZipperName').textContent = selectedZipper.name;
        document.getElementById('selectedZipperSize').textContent = extractZipperSize(selectedZipper.name, selectedZipper.description);
        document.getElementById('selectedZipperAvailable').textContent = availableInches;
        document.getElementById('selectedZipperPrice').textContent = parseFloat(selectedZipper.price || 0).toFixed(2);
        document.getElementById('selectedZipperInches').textContent = inchesNeeded;
        document.getElementById('selectedThreadColorDisplay').textContent = threadColorDisplay;
        document.getElementById('selectedZipperInfo').style.display = 'block';
        
        zipperInchesModal.hide();
    }
    
    // Populate size filter dropdown
    function populateSizeFilter() {
        const filter = document.getElementById('zipperSizeFilter');
        if (!filter) return;
        
        const sizes = new Set();
        allZippers.forEach(zipper => {
            const size = extractZipperSize(zipper.name, zipper.description);
            if (size) sizes.add(size);
        });
        
        // Clear existing options except "All Sizes"
        filter.innerHTML = '<option value="">All Sizes</option>';
        
        Array.from(sizes).sort().forEach(size => {
            const option = document.createElement('option');
            option.value = size;
            option.textContent = size;
            filter.appendChild(option);
        });
    }
    
    // Setup zipper filter event listener
    function setupZipperFilter() {
        const filter = document.getElementById('zipperSizeFilter');
        if (filter) {
            filter.addEventListener('change', displayZippers);
        }
    }

    // ========== BUTTONS BROCHURE FUNCTIONS ==========
    
    // Initialize buttons modals
    function initializeButtonsModals() {
        const buttonsModalElement = document.getElementById('buttonsBrochureModal');
        const quantityModalElement = document.getElementById('buttonQuantityModal');
        
        if (buttonsModalElement) {
            buttonsBrochureModal = new bootstrap.Modal(buttonsModalElement, {
                backdrop: false,
                keyboard: true
            });
            
            buttonsModalElement.addEventListener('shown.bs.modal', function() {
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach(backdrop => backdrop.remove());
                document.body.style.overflow = 'auto';
                document.body.classList.remove('modal-open');
            });
        }
        if (quantityModalElement) {
            buttonQuantityModal = new bootstrap.Modal(quantityModalElement, {
                backdrop: true
            });
            
            // Add event listener for thread color "other" option in button modal
            const buttonThreadColorSelect = document.getElementById('buttonThreadColor');
            if (buttonThreadColorSelect) {
                buttonThreadColorSelect.addEventListener('change', function() {
                    const threadColorOtherField = document.getElementById('buttonThreadColorOtherField');
                    const threadColorOtherInput = document.getElementById('buttonThreadColorOther');
                    
                    if (this.value === 'other') {
                        if (threadColorOtherField) threadColorOtherField.style.display = 'block';
                        if (threadColorOtherInput) {
                            threadColorOtherInput.required = true;
                            threadColorOtherInput.focus();
                        }
                    } else {
                        if (threadColorOtherField) threadColorOtherField.style.display = 'none';
                        if (threadColorOtherInput) {
                            threadColorOtherInput.required = false;
                            threadColorOtherInput.value = '';
                        }
                    }
                });
            }
        }
    }
    
    // Open buttons brochure
    function openButtonsBrochure() {
        if (!buttonsBrochureModal) {
            initializeButtonsModals();
        }
        loadButtons();
        buttonsBrochureModal.show();
    }
    
    // Load buttons from API
    function loadButtons() {
        fetch('/api/buttons/', { credentials: 'same-origin' })
            .then(response => {
                const ct = response.headers.get('content-type') || '';
                if (!response.ok) throw new Error('Network response was not ok: ' + response.status);
                if (ct.includes('application/json')) return response.json();
                throw new Error('Unexpected content-type: ' + ct);
            })
            .then(data => {
                if (data.success) {
                    allButtons = data.buttons;
                    displayButtons();
                    populateButtonTypeFilter();
                } else {
                    console.error('Failed to load buttons:', data.error);
                    alert('Failed to load buttons. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error loading buttons:', error);
                alert('Error loading buttons. Please check the console for details.');
            });
    }
    
    // Display buttons in grid
    function displayButtons() {
        const grid = document.getElementById('buttonItemsGrid');
        if (!grid) return;
        
        const typeFilter = document.getElementById('buttonTypeFilter')?.value || '';
        let filteredButtons = allButtons;
        
        if (typeFilter) {
            filteredButtons = allButtons.filter(b => {
                const buttonType = extractButtonType(b.name, b.description);
                return buttonType && buttonType.toLowerCase().includes(typeFilter.toLowerCase());
            });
        }
        
        grid.innerHTML = '';
        
        if (filteredButtons.length === 0) {
            grid.innerHTML = '<div class="col-12 text-center text-white">No buttons available</div>';
            return;
        }
        
        filteredButtons.forEach(button => {
            const card = createButtonCard(button);
            grid.appendChild(card);
        });
    }
    
    // Extract button type from name or description
    function extractButtonType(name, description) {
        const text = (name + ' ' + (description || '')).toLowerCase();
        if (text.includes('pants')) return 'Pants';
        if (text.includes('polo')) return 'Polo';
        if (text.includes('plastic')) return 'Plastic';
        if (text.includes('metal')) return 'Metal';
        return 'Standard';
    }
    
    // Create button card
    function createButtonCard(button) {
        const card = document.createElement('div');
        card.className = 'button-card';
        card.style.cssText = 'background: #2d2d2d; border-radius: 8px; padding: 15px; cursor: pointer; transition: transform 0.2s; border: 2px solid #444; position: relative; z-index: 1; pointer-events: auto;';
        card.onmouseover = function() { 
            this.style.transform = 'scale(1.02)'; 
            this.style.borderColor = '#3b82f6'; 
            this.style.boxShadow = '0 4px 8px rgba(59, 130, 246, 0.3)';
        };
        card.onmouseout = function() { 
            this.style.transform = 'scale(1)'; 
            this.style.borderColor = '#444'; 
            this.style.boxShadow = 'none';
        };
        
        const availableQty = button.quantity || 0;
        const pricePerUnit = parseFloat(button.price) || 0;
        const type = extractButtonType(button.name, button.description);
        const unit = button.unit_of_measurement || 'pieces';
        const isAvailable = availableQty > 0;
        const statusClass = isAvailable ? 'text-success' : 'text-danger';
        const statusText = isAvailable ? 'Available' : 'Out of Stock';
        
        card.innerHTML = `
            <div style="text-align: center; margin-bottom: 10px;">
                ${button.image ? 
                    `<img src="${button.image}" alt="${button.name}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 5px;">` :
                    `<div style="width: 100%; height: 150px; background: #444; border-radius: 5px; display: flex; align-items: center; justify-content: center; color: #888;">
                        <i class="fas fa-circle" style="font-size: 48px;"></i>
                    </div>`
                }
            </div>
            <div style="color: #ffffff; font-weight: bold; margin-bottom: 5px;">${button.name}</div>
            <div style="color: #aaa; font-size: 0.9em; margin-bottom: 5px;">Type: ${type}</div>
            <div style="color: #aaa; font-size: 0.9em; margin-bottom: 5px;">Available: <span class="${statusClass}">${availableQty} ${unit}</span></div>
            <div style="color: #3b82f6; font-weight: bold; margin-bottom: 5px;">₱${pricePerUnit.toFixed(2)} per ${unit}</div>
            <div style="color: #aaa; font-size: 0.85em; margin-top: 10px; padding-top: 10px; border-top: 1px solid #444;">
                Status: <span class="${statusClass}">${statusText}</span>
            </div>
        `;
        
        card.addEventListener('click', function(e) {
            e.stopPropagation();
            e.preventDefault();
            if (isAvailable) {
                selectButton(button);
            } else {
                alert('This button is out of stock. Please select another button.');
            }
        });
        
        card.setAttribute('data-button-id', button.id);
        card.style.pointerEvents = 'auto';
        card.style.userSelect = 'none';
        
        return card;
    }
    
    // Select button and show quantity input modal
    function selectButton(button) {
        selectedButton = button;
        document.getElementById('modalButtonName').textContent = button.name;
        document.getElementById('modalButtonAvailable').textContent = button.quantity || 0;
        document.getElementById('modalButtonUnit').textContent = button.unit_of_measurement || 'pieces';
        document.getElementById('buttonQuantityNeeded').value = '';
        document.getElementById('buttonThreadColor').value = '';
        document.getElementById('buttonThreadColorOther').value = '';
        document.getElementById('buttonThreadColorOtherField').style.display = 'none';
        document.getElementById('buttonQuantityError').style.display = 'none';
        
        buttonsBrochureModal.hide();
        if (!buttonQuantityModal) {
            initializeButtonsModals();
        }
        // Calculate and set thread meters
        updateMaterialThreadMeters('buttons');
        
        // Add event listener to recalculate when quantity changes
        const buttonQuantityInput = document.getElementById('buttonQuantityNeeded');
        if (buttonQuantityInput) {
            buttonQuantityInput.addEventListener('input', function() {
                updateMaterialThreadMeters('buttons');
            });
        }
        
        buttonQuantityModal.show();
    }
    
    // Confirm button selection with quantity
    async function confirmButtonSelection() {
        const quantityNeeded = parseInt(document.getElementById('buttonQuantityNeeded').value);
        const threadColor = document.getElementById('buttonThreadColor').value;
        const threadColorOther = document.getElementById('buttonThreadColorOther').value;
        const errorDiv = document.getElementById('buttonQuantityError');
        
        if (!quantityNeeded || quantityNeeded <= 0) {
            errorDiv.textContent = 'Please enter a valid quantity (greater than 0)';
            errorDiv.style.display = 'block';
            return;
        }
        
        if (!selectedButton) {
            errorDiv.textContent = 'No button selected. Please try again.';
            errorDiv.style.display = 'block';
            return;
        }
        
        if (!threadColor) {
            errorDiv.textContent = 'Please select a thread color';
            errorDiv.style.display = 'block';
            return;
        }
        
        if (threadColor === 'other' && !threadColorOther.trim()) {
            errorDiv.textContent = 'Please enter a custom thread color name';
            errorDiv.style.display = 'block';
            return;
        }
        
        // Check thread availability
        const finalThreadColor = threadColor === 'other' ? threadColorOther.trim() : threadColor;
        const threadAvailability = await checkThreadAvailability(finalThreadColor);
        
        if (!threadAvailability.found) {
            errorDiv.textContent = `Thread color "${finalThreadColor}" not found in materials. Out of stock, please choose other color.`;
            errorDiv.style.display = 'block';
            return;
        }
        
        if (!threadAvailability.available || threadAvailability.quantity <= 0) {
            errorDiv.textContent = `Thread color "${finalThreadColor}" is out of stock. Please choose other color.`;
            errorDiv.style.display = 'block';
            return;
        }
        
        const availableQty = parseInt(selectedButton.quantity) || 0;
        if (quantityNeeded > availableQty) {
            errorDiv.textContent = `Only ${availableQty} ${selectedButton.unit_of_measurement || 'pieces'} available. Please enter a smaller amount.`;
            errorDiv.style.display = 'block';
            return;
        }
        
        // Store selected button info
        document.getElementById('selectedButtonId').value = selectedButton.id;
        document.getElementById('selectedButtonQuantityUsed').value = quantityNeeded;
        
        // Recalculate thread length
        calculateThreadLength();
        
        // Store thread color for buttons
        const threadColorField = document.getElementById('selectedThreadColorButtons');
        const threadColorOtherField = document.getElementById('selectedThreadColorOtherButtons');
        if (threadColorField) threadColorField.value = threadColor;
        if (threadColorOtherField) threadColorOtherField.value = threadColor === 'other' ? threadColorOther.trim() : '';
        
        // Calculate price based on new pricing logic
        const calculatedButtonPrice = calculateButtonPrice(selectedButton.name, quantityNeeded);
        
        // Update display
        document.getElementById('selectedButtonName').textContent = selectedButton.name;
        document.getElementById('selectedButtonType').textContent = extractButtonType(selectedButton.name, selectedButton.description);
        document.getElementById('selectedButtonAvailable').textContent = availableQty;
        document.getElementById('selectedButtonUnit').textContent = selectedButton.unit_of_measurement || 'pieces';
        document.getElementById('selectedButtonPrice').textContent = calculatedButtonPrice.toFixed(2);
        document.getElementById('selectedButtonPriceUnit').textContent = 'total';
        document.getElementById('selectedButtonQuantity').textContent = quantityNeeded;
        document.getElementById('selectedButtonQuantityUnit').textContent = selectedButton.unit_of_measurement || 'pieces';
        document.getElementById('selectedButtonInfo').style.display = 'block';
        
        buttonQuantityModal.hide();
    }
    
    // Populate button type filter dropdown
    function populateButtonTypeFilter() {
        const filter = document.getElementById('buttonTypeFilter');
        if (!filter) return;
        
        const types = new Set();
        allButtons.forEach(button => {
            const type = extractButtonType(button.name, button.description);
            if (type) types.add(type);
        });
        
        filter.innerHTML = '<option value="">All Types</option>';
        
        Array.from(types).sort().forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = type;
            filter.appendChild(option);
        });
    }

    // ========== LOCKS/KAWIT BROCHURE FUNCTIONS ==========
    
    // Initialize locks modals
    function initializeLocksModals() {
        const locksModalElement = document.getElementById('locksBrochureModal');
        const quantityModalElement = document.getElementById('locksQuantityModal');
        
        if (locksModalElement) {
            locksBrochureModal = new bootstrap.Modal(locksModalElement, {
                backdrop: false,
                keyboard: true
            });
            
            locksModalElement.addEventListener('shown.bs.modal', function() {
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach(backdrop => backdrop.remove());
                document.body.style.overflow = 'auto';
                document.body.classList.remove('modal-open');
            });
        }
        if (quantityModalElement) {
            locksQuantityModal = new bootstrap.Modal(quantityModalElement, {
                backdrop: true
            });
            
            // Add event listener for thread color "other" option in lock modal
            const locksThreadColorSelect = document.getElementById('locksThreadColor');
            if (locksThreadColorSelect) {
                locksThreadColorSelect.addEventListener('change', function() {
                    const threadColorOtherField = document.getElementById('locksThreadColorOtherField');
                    const threadColorOtherInput = document.getElementById('locksThreadColorOther');
                    
                    if (this.value === 'other') {
                        if (threadColorOtherField) threadColorOtherField.style.display = 'block';
                        if (threadColorOtherInput) {
                            threadColorOtherInput.required = true;
                            threadColorOtherInput.focus();
                        }
                    } else {
                        if (threadColorOtherField) threadColorOtherField.style.display = 'none';
                        if (threadColorOtherInput) {
                            threadColorOtherInput.required = false;
                            threadColorOtherInput.value = '';
                        }
                    }
                });
            }
        }
    }
    
    // Open locks brochure
    function openLocksBrochure() {
        if (!locksBrochureModal) {
            initializeLocksModals();
        }
        loadLocks();
        locksBrochureModal.show();
    }
    
    // Load locks from API
    function loadLocks() {
        fetch('/api/locks/', { credentials: 'same-origin' })
            .then(response => {
                const ct = response.headers.get('content-type') || '';
                if (!response.ok) throw new Error('Network response was not ok: ' + response.status);
                if (ct.includes('application/json')) return response.json();
                throw new Error('Unexpected content-type: ' + ct);
            })
            .then(data => {
                if (data.success) {
                    allLocks = data.locks;
                    displayLocks();
                } else {
                    console.error('Failed to load locks:', data.error);
                    alert('Failed to load locks. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error loading locks:', error);
                alert('Error loading locks. Please check the console for details.');
            });
    }
    
    // Display locks in grid
    function displayLocks() {
        const grid = document.getElementById('locksItemsGrid');
        if (!grid) return;
        
        grid.innerHTML = '';
        
        if (allLocks.length === 0) {
            grid.innerHTML = '<div class="col-12 text-center text-white">No locks/kawit available</div>';
            return;
        }
        
        allLocks.forEach(lock => {
            const card = createLockCard(lock);
            grid.appendChild(card);
        });
    }
    
    // Create lock card
    function createLockCard(lock) {
        const card = document.createElement('div');
        card.className = 'lock-card';
        card.style.cssText = 'background: #2d2d2d; border-radius: 8px; padding: 15px; cursor: pointer; transition: transform 0.2s; border: 2px solid #444; position: relative; z-index: 1; pointer-events: auto;';
        card.onmouseover = function() { 
            this.style.transform = 'scale(1.02)'; 
            this.style.borderColor = '#3b82f6'; 
            this.style.boxShadow = '0 4px 8px rgba(59, 130, 246, 0.3)';
        };
        card.onmouseout = function() { 
            this.style.transform = 'scale(1)'; 
            this.style.borderColor = '#444'; 
            this.style.boxShadow = 'none';
        };
        
        const availableGroups = lock.quantity || 0;
        const pricePerGroup = parseFloat(lock.price) || 0;
        const lockType = extractLockType(lock.name, lock.description);
        const isAvailable = availableGroups > 0;
        const statusClass = isAvailable ? 'text-success' : 'text-danger';
        const statusText = isAvailable ? 'Available' : 'Out of Stock';
        
        card.innerHTML = `
            <div style="text-align: center; margin-bottom: 10px;">
                ${lock.image ? 
                    `<img src="${lock.image}" alt="${lock.name}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 5px;">` :
                    `<div style="width: 100%; height: 150px; background: #444; border-radius: 5px; display: flex; align-items: center; justify-content: center; color: #888;">
                        <i class="fas fa-lock" style="font-size: 48px;"></i>
                    </div>`
                }
            </div>
            <div style="color: #ffffff; font-weight: bold; margin-bottom: 5px;">${lock.name}</div>
            <div style="color: #aaa; font-size: 0.9em; margin-bottom: 5px;">Type: ${lockType}</div>
            <div style="color: #aaa; font-size: 0.9em; margin-bottom: 5px;">Available: <span class="${statusClass}">${availableGroups} groups</span></div>
            <div style="color: #aaa; font-size: 0.85em; margin-bottom: 5px;">(4 pieces per group)</div>
            <div style="color: #3b82f6; font-weight: bold; margin-bottom: 5px;">₱${pricePerGroup.toFixed(2)} per group</div>
            <div style="color: #aaa; font-size: 0.85em; margin-top: 10px; padding-top: 10px; border-top: 1px solid #444;">
                Status: <span class="${statusClass}">${statusText}</span>
            </div>
        `;
        
        card.addEventListener('click', function(e) {
            e.stopPropagation();
            e.preventDefault();
            if (isAvailable) {
                selectLock(lock);
            } else {
                alert('This lock/kawit is out of stock. Please select another.');
            }
        });
        
        card.setAttribute('data-lock-id', lock.id);
        card.style.pointerEvents = 'auto';
        card.style.userSelect = 'none';
        
        return card;
    }
    
    // Extract lock type from name or description
    function extractLockType(name, description) {
        const text = (name + ' ' + (description || '')).toLowerCase();
        if (text.includes('normal')) return 'Normal';
        if (text.includes('special')) return 'Special';
        return 'Standard';
    }
    
    // Select lock and show quantity input modal
    function selectLock(lock) {
        selectedLock = lock;
        document.getElementById('modalLockName').textContent = lock.name;
        document.getElementById('modalLockAvailable').textContent = lock.quantity || 0;
        document.getElementById('locksQuantityNeeded').value = '';
        document.getElementById('locksThreadColor').value = '';
        document.getElementById('locksThreadColorOther').value = '';
        document.getElementById('locksThreadColorOtherField').style.display = 'none';
        document.getElementById('locksQuantityError').style.display = 'none';
        
        locksBrochureModal.hide();
        if (!locksQuantityModal) {
            initializeLocksModals();
        }
        // Calculate and set thread meters
        updateMaterialThreadMeters('lock');
        
        // Add event listener to recalculate when quantity changes
        const locksQuantityInput = document.getElementById('locksQuantityNeeded');
        if (locksQuantityInput) {
            locksQuantityInput.addEventListener('input', function() {
                updateMaterialThreadMeters('lock');
            });
        }
        
        locksQuantityModal.show();
    }
    
    // Confirm lock selection with groups
    async function confirmLockSelection() {
        const groupsNeeded = parseInt(document.getElementById('locksQuantityNeeded').value);
        const threadColor = document.getElementById('locksThreadColor').value;
        const threadColorOther = document.getElementById('locksThreadColorOther').value;
        const errorDiv = document.getElementById('locksQuantityError');
        
        if (!groupsNeeded || groupsNeeded <= 0) {
            errorDiv.textContent = 'Please enter a valid number of groups (greater than 0)';
            errorDiv.style.display = 'block';
            return;
        }
        
        if (!selectedLock) {
            errorDiv.textContent = 'No lock/kawit selected. Please try again.';
            errorDiv.style.display = 'block';
            return;
        }
        
        if (!threadColor) {
            errorDiv.textContent = 'Please select a thread color';
            errorDiv.style.display = 'block';
            return;
        }
        
        if (threadColor === 'other' && !threadColorOther.trim()) {
            errorDiv.textContent = 'Please enter a custom thread color name';
            errorDiv.style.display = 'block';
            return;
        }
        
        // Check thread availability
        const finalThreadColor = threadColor === 'other' ? threadColorOther.trim() : threadColor;
        const threadAvailability = await checkThreadAvailability(finalThreadColor);
        
        if (!threadAvailability.found) {
            errorDiv.textContent = `Thread color "${finalThreadColor}" not found in materials. Out of stock, please choose other color.`;
            errorDiv.style.display = 'block';
            return;
        }
        
        if (!threadAvailability.available || threadAvailability.quantity <= 0) {
            errorDiv.textContent = `Thread color "${finalThreadColor}" is out of stock. Please choose other color.`;
            errorDiv.style.display = 'block';
            return;
        }
        
        const availableGroups = parseInt(selectedLock.quantity) || 0;
        if (groupsNeeded > availableGroups) {
            errorDiv.textContent = `Only ${availableGroups} groups available. Please enter a smaller amount.`;
            errorDiv.style.display = 'block';
            return;
        }
        
        // Calculate price based on new pricing logic
        const calculatedLockPrice = calculateLockPrice(groupsNeeded);
        
        // Store selected lock info
        document.getElementById('selectedLockId').value = selectedLock.id;
        document.getElementById('selectedLockGroupsUsed').value = groupsNeeded;
        
        // Recalculate thread length
        calculateThreadLength();
        
        // Store thread color for locks/kawit
        const threadColorField = document.getElementById('selectedThreadColorLocks');
        const threadColorOtherField = document.getElementById('selectedThreadColorOtherLocks');
        if (threadColorField) threadColorField.value = threadColor;
        if (threadColorOtherField) threadColorOtherField.value = threadColor === 'other' ? threadColorOther.trim() : '';
        
        // Update display
        document.getElementById('selectedLockName').textContent = selectedLock.name;
        document.getElementById('selectedLockType').textContent = extractLockType(selectedLock.name, selectedLock.description);
        document.getElementById('selectedLockAvailable').textContent = availableGroups;
        document.getElementById('selectedLockPrice').textContent = calculatedLockPrice.toFixed(2);
        document.getElementById('selectedLockGroups').textContent = groupsNeeded;
        document.getElementById('selectedLockInfo').style.display = 'block';
        
        locksQuantityModal.hide();
    }

    // ========== GARTER BROCHURE FUNCTIONS ==========
    
    // Initialize garter modals
    function initializeGarterModals() {
        const garterModalElement = document.getElementById('garterBrochureModal');
        const inchesModalElement = document.getElementById('garterInchesModal');
        
        if (garterModalElement) {
            garterBrochureModal = new bootstrap.Modal(garterModalElement, {
                backdrop: false,
                keyboard: true
            });
            
            garterModalElement.addEventListener('shown.bs.modal', function() {
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach(backdrop => backdrop.remove());
                document.body.style.overflow = 'auto';
                document.body.classList.remove('modal-open');
            });
        }
        if (inchesModalElement) {
            garterInchesModal = new bootstrap.Modal(inchesModalElement, {
                backdrop: true
            });
            
            // Add event listener for thread color "other" option in garter modal
            const garterThreadColorSelect = document.getElementById('garterThreadColor');
            if (garterThreadColorSelect) {
                garterThreadColorSelect.addEventListener('change', function() {
                    const threadColorOtherField = document.getElementById('garterThreadColorOtherField');
                    const threadColorOtherInput = document.getElementById('garterThreadColorOther');
                    
                    if (this.value === 'other') {
                        if (threadColorOtherField) threadColorOtherField.style.display = 'block';
                        if (threadColorOtherInput) {
                            threadColorOtherInput.required = true;
                            threadColorOtherInput.focus();
                        }
                    } else {
                        if (threadColorOtherField) threadColorOtherField.style.display = 'none';
                        if (threadColorOtherInput) {
                            threadColorOtherInput.required = false;
                            threadColorOtherInput.value = '';
                        }
                    }
                });
            }
        }
    }
    
    // Open garter brochure
    function openGarterBrochure() {
        if (!garterBrochureModal) {
            initializeGarterModals();
        }
        loadGarters();
        garterBrochureModal.show();
    }
    
    // Load garters from API
    function loadGarters() {
        fetch('/api/garters/', { credentials: 'same-origin' })
            .then(response => {
                const ct = response.headers.get('content-type') || '';
                if (!response.ok) throw new Error('Network response was not ok: ' + response.status);
                if (ct.includes('application/json')) return response.json();
                throw new Error('Unexpected content-type: ' + ct);
            })
            .then(data => {
                if (data.success) {
                    allGarters = data.garters;
                    displayGarters();
                } else {
                    console.error('Failed to load garters:', data.error);
                    alert('Failed to load garters. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error loading garters:', error);
                alert('Error loading garters. Please check the console for details.');
            });
    }
    
    // Display garters in grid
    function displayGarters() {
        const grid = document.getElementById('garterItemsGrid');
        if (!grid) return;
        
        grid.innerHTML = '';
        
        if (allGarters.length === 0) {
            grid.innerHTML = '<div class="col-12 text-center text-white">No garters available</div>';
            return;
        }
        
        allGarters.forEach(garter => {
            const card = createGarterCard(garter);
            grid.appendChild(card);
        });
    }
    
    // Create garter card
    function createGarterCard(garter) {
        const card = document.createElement('div');
        card.className = 'garter-card';
        card.style.cssText = 'background: #2d2d2d; border-radius: 8px; padding: 15px; cursor: pointer; transition: transform 0.2s; border: 2px solid #444; position: relative; z-index: 1; pointer-events: auto;';
        card.onmouseover = function() { 
            this.style.transform = 'scale(1.02)'; 
            this.style.borderColor = '#3b82f6'; 
            this.style.boxShadow = '0 4px 8px rgba(59, 130, 246, 0.3)';
        };
        card.onmouseout = function() { 
            this.style.transform = 'scale(1)'; 
            this.style.borderColor = '#444'; 
            this.style.boxShadow = 'none';
        };
        
        const availableInches = garter.quantity || 0;
        const pricePerInch = parseFloat(garter.price) || 0;
        const isAvailable = availableInches > 0;
        const statusClass = isAvailable ? 'text-success' : 'text-danger';
        const statusText = isAvailable ? 'Available' : 'Out of Stock';
        
        card.innerHTML = `
            <div style="text-align: center; margin-bottom: 10px;">
                ${garter.image ? 
                    `<img src="${garter.image}" alt="${garter.name}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 5px;">` :
                    `<div style="width: 100%; height: 150px; background: #444; border-radius: 5px; display: flex; align-items: center; justify-content: center; color: #888;">
                        <i class="fas fa-ruler" style="font-size: 48px;"></i>
                    </div>`
                }
            </div>
            <div style="color: #ffffff; font-weight: bold; margin-bottom: 5px;">${garter.name}</div>
            <div style="color: #aaa; font-size: 0.9em; margin-bottom: 5px;">Available: <span class="${statusClass}">${availableInches} inches</span></div>
            <div style="color: #3b82f6; font-weight: bold; margin-bottom: 5px;">₱${pricePerInch.toFixed(2)} per inch</div>
            <div style="color: #aaa; font-size: 0.85em; margin-top: 10px; padding-top: 10px; border-top: 1px solid #444;">
                Status: <span class="${statusClass}">${statusText}</span>
            </div>
        `;
        
        card.addEventListener('click', function(e) {
            e.stopPropagation();
            e.preventDefault();
            if (isAvailable) {
                selectGarter(garter);
            } else {
                alert('This garter is out of stock. Please select another garter.');
            }
        });
        
        card.setAttribute('data-garter-id', garter.id);
        card.style.pointerEvents = 'auto';
        card.style.userSelect = 'none';
        
        return card;
    }
    
    // Select garter and show inches input modal
    function selectGarter(garter) {
        selectedGarter = garter;
        document.getElementById('modalGarterName').textContent = garter.name;
        document.getElementById('modalGarterAvailable').textContent = garter.quantity || 0;
        document.getElementById('garterInchesNeeded').value = '';
        document.getElementById('garterThreadColor').value = '';
        document.getElementById('garterThreadColorOther').value = '';
        document.getElementById('garterThreadColorOtherField').style.display = 'none';
        document.getElementById('garterInchesError').style.display = 'none';
        
        garterBrochureModal.hide();
        if (!garterInchesModal) {
            initializeGarterModals();
        }
        // Calculate and set thread meters
        const repairType = document.getElementById('repairType')?.value || '';
        const materialType = repairType === 'elastic' ? 'elastic' : 'bewang';
        updateMaterialThreadMeters(materialType);
        
        // Add event listener to recalculate when quantity changes
        const garterInchesInput = document.getElementById('garterInchesNeeded');
        if (garterInchesInput) {
            garterInchesInput.addEventListener('input', function() {
                updateMaterialThreadMeters(materialType);
            });
        }
        
        garterInchesModal.show();
    }
    
    // Confirm garter selection with inches
    async function confirmGarterSelection() {
        const inchesNeeded = parseFloat(document.getElementById('garterInchesNeeded').value);
        const threadColor = document.getElementById('garterThreadColor').value;
        const threadColorOther = document.getElementById('garterThreadColorOther').value;
        const errorDiv = document.getElementById('garterInchesError');
        
        if (!inchesNeeded || inchesNeeded <= 0) {
            errorDiv.textContent = 'Please enter a valid number of inches (greater than 0)';
            errorDiv.style.display = 'block';
            return;
        }
        
        if (!selectedGarter) {
            errorDiv.textContent = 'No garter selected. Please try again.';
            errorDiv.style.display = 'block';
            return;
        }
        
        if (!threadColor) {
            errorDiv.textContent = 'Please select a thread color';
            errorDiv.style.display = 'block';
            return;
        }
        
        if (threadColor === 'other' && !threadColorOther.trim()) {
            errorDiv.textContent = 'Please enter a custom thread color name';
            errorDiv.style.display = 'block';
            return;
        }
        
        // Check thread availability
        const finalThreadColor = threadColor === 'other' ? threadColorOther.trim() : threadColor;
        const threadAvailability = await checkThreadAvailability(finalThreadColor);
        
        if (!threadAvailability.found) {
            errorDiv.textContent = `Thread color "${finalThreadColor}" not found in materials. Out of stock, please choose other color.`;
            errorDiv.style.display = 'block';
            return;
        }
        
        if (!threadAvailability.available || threadAvailability.quantity <= 0) {
            errorDiv.textContent = `Thread color "${finalThreadColor}" is out of stock. Please choose other color.`;
            errorDiv.style.display = 'block';
            return;
        }
        
        const availableInches = parseFloat(selectedGarter.quantity) || 0;
        if (inchesNeeded > availableInches) {
            errorDiv.textContent = `Only ${availableInches} inches available. Please enter a smaller amount.`;
            errorDiv.style.display = 'block';
            return;
        }
        
        // Calculate price based on new pricing logic
        const calculatedGarterPrice = calculateGarterPrice(inchesNeeded);
        
        // Check which repair type is active (bewang or elastic)
        const repairType = document.getElementById('repairType') ? document.getElementById('repairType').value : '';
        const isElastic = repairType === 'elastic';
        
        // Get thread color display name
        const threadColorSelect = document.getElementById('garterThreadColor');
        const threadColorDisplay = threadColor === 'other' ? threadColorOther.trim() : (threadColorSelect.options[threadColorSelect.selectedIndex]?.text || threadColor);
        
        if (isElastic) {
            // Store selected garter info for elastic
            document.getElementById('selectedGarterIdElastic').value = selectedGarter.id;
            document.getElementById('selectedGarterInchesUsedElastic').value = inchesNeeded;
            
            // Recalculate thread length
            calculateThreadLength();
            
            // Store thread color for elastic
            document.getElementById('selectedThreadColorElastic').value = threadColor;
            document.getElementById('selectedThreadColorOtherElastic').value = threadColor === 'other' ? threadColorOther.trim() : '';
            
            // Update display for elastic
            document.getElementById('selectedGarterNameElastic').textContent = selectedGarter.name;
            document.getElementById('selectedGarterAvailableElastic').textContent = availableInches;
            document.getElementById('selectedGarterPriceElastic').textContent = calculatedGarterPrice.toFixed(2);
            document.getElementById('selectedGarterInchesElastic').textContent = inchesNeeded;
            document.getElementById('selectedGarterInfoElastic').style.display = 'block';
        } else {
            // Store selected garter info for bewang
            document.getElementById('selectedGarterId').value = selectedGarter.id;
            document.getElementById('selectedGarterInchesUsed').value = inchesNeeded;
            
            // Recalculate thread length
            calculateThreadLength();
            
            // Store thread color for bewang
            document.getElementById('selectedThreadColorBewang').value = threadColor;
            document.getElementById('selectedThreadColorOtherBewang').value = threadColor === 'other' ? threadColorOther.trim() : '';
            
            // Also update main thread color fields if they exist (for thread details section)
            const threadColorField = document.getElementById('threadColor');
            const threadColorOtherField = document.getElementById('threadColorOther');
            if (threadColorField) threadColorField.value = threadColor;
            if (threadColorOtherField) threadColorOtherField.value = threadColor === 'other' ? threadColorOther.trim() : '';
            
            // Update display for bewang
            document.getElementById('selectedGarterName').textContent = selectedGarter.name;
            document.getElementById('selectedGarterAvailable').textContent = availableInches;
            document.getElementById('selectedGarterPrice').textContent = calculatedGarterPrice.toFixed(2);
            document.getElementById('selectedGarterInches').textContent = inchesNeeded;
            document.getElementById('selectedGarterInfo').style.display = 'block';
        }
        
        garterInchesModal.hide();
    }

    // ========== PATCHES BROCHURE FUNCTIONS ==========
    
    // Initialize patches modals
    function initializePatchesModals() {
        const patchesModalElement = document.getElementById('patchesBrochureModal');
        const quantityModalElement = document.getElementById('patchQuantityModal');
        
        if (patchesModalElement) {
            patchesBrochureModal = new bootstrap.Modal(patchesModalElement, {
                backdrop: false,
                keyboard: true
            });
            
            patchesModalElement.addEventListener('shown.bs.modal', function() {
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach(backdrop => backdrop.remove());
                document.body.style.overflow = 'auto';
                document.body.classList.remove('modal-open');
            });
        }
        if (quantityModalElement) {
            patchQuantityModal = new bootstrap.Modal(quantityModalElement, {
                backdrop: true
            });
            
            // Add event listener for thread color "other" option in patch modal
            const patchThreadColorSelect = document.getElementById('patchThreadColor');
            if (patchThreadColorSelect) {
                patchThreadColorSelect.addEventListener('change', function() {
                    const threadColorOtherField = document.getElementById('patchThreadColorOtherField');
                    const threadColorOtherInput = document.getElementById('patchThreadColorOther');
                    
                    if (this.value === 'other') {
                        if (threadColorOtherField) threadColorOtherField.style.display = 'block';
                        if (threadColorOtherInput) {
                            threadColorOtherInput.required = true;
                            threadColorOtherInput.focus();
                        }
                    } else {
                        if (threadColorOtherField) threadColorOtherField.style.display = 'none';
                        if (threadColorOtherInput) {
                            threadColorOtherInput.required = false;
                            threadColorOtherInput.value = '';
                        }
                    }
                });
            }
        }
    }
    
    // Open patches brochure
    function openPatchesBrochure() {
        if (!patchesBrochureModal) {
            initializePatchesModals();
        }
        loadPatches();
        patchesBrochureModal.show();
    }
    
    // Load patches from API
    function loadPatches() {
        fetch('/api/patches/', { credentials: 'same-origin' })
            .then(response => {
                const ct = response.headers.get('content-type') || '';
                if (!response.ok) throw new Error('Network response was not ok: ' + response.status);
                if (ct.includes('application/json')) return response.json();
                throw new Error('Unexpected content-type: ' + ct);
            })
            .then(data => {
                if (data.success) {
                    allPatches = data.patches;
                    displayPatches();
                    populatePatchTypeFilter();
                } else {
                    console.error('Failed to load patches:', data.error);
                    alert('Failed to load patches. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error loading patches:', error);
                alert('Error loading patches. Please check the console for details.');
            });
    }
    
    // Display patches in grid
    function displayPatches() {
        const grid = document.getElementById('patchItemsGrid');
        if (!grid) return;
        
        const typeFilter = document.getElementById('patchTypeFilter')?.value || '';
        let filteredPatches = allPatches;
        
        if (typeFilter) {
            filteredPatches = allPatches.filter(p => {
                const patchType = extractPatchType(p.name, p.description);
                return patchType && patchType.toLowerCase().includes(typeFilter.toLowerCase());
            });
        }
        
        grid.innerHTML = '';
        
        if (filteredPatches.length === 0) {
            grid.innerHTML = '<div class="col-12 text-center text-white">No patches available</div>';
            return;
        }
        
        filteredPatches.forEach(patch => {
            const card = createPatchCard(patch);
            grid.appendChild(card);
        });
    }
    
    // Add event listener for patch type filter
    document.addEventListener('DOMContentLoaded', function() {
        const patchTypeFilter = document.getElementById('patchTypeFilter');
        if (patchTypeFilter) {
            patchTypeFilter.addEventListener('change', function() {
                displayPatches();
            });
        }
    });
    
    // Extract patch type from name or description
    function extractPatchType(name, description) {
        const text = (name + ' ' + (description || '')).toLowerCase();
        if (text.includes('normal')) return 'Normal';
        if (text.includes('logo')) return 'Logo';
        if (text.includes('big') || text.includes('large')) return 'Big Size';
        return 'Standard';
    }
    
    // Create patch card
    function createPatchCard(patch) {
        const card = document.createElement('div');
        card.className = 'patch-card';
        card.style.cssText = 'background: #2d2d2d; border-radius: 8px; padding: 15px; cursor: pointer; transition: transform 0.2s; border: 2px solid #444; position: relative; z-index: 1; pointer-events: auto;';
        card.onmouseover = function() { 
            this.style.transform = 'scale(1.02)'; 
            this.style.borderColor = '#3b82f6'; 
            this.style.boxShadow = '0 4px 8px rgba(59, 130, 246, 0.3)';
        };
        card.onmouseout = function() { 
            this.style.transform = 'scale(1)'; 
            this.style.borderColor = '#444'; 
            this.style.boxShadow = 'none';
        };
        
        const availableQty = patch.quantity || 0;
        const pricePerUnit = parseFloat(patch.price) || 0;
        const type = extractPatchType(patch.name, patch.description);
        const unit = patch.unit_of_measurement || 'pieces';
        const isAvailable = availableQty > 0;
        const statusClass = isAvailable ? 'text-success' : 'text-danger';
        const statusText = isAvailable ? 'Available' : 'Out of Stock';
        
        card.innerHTML = `
            <div style="text-align: center; margin-bottom: 10px;">
                ${patch.image ? 
                    `<img src="${patch.image}" alt="${patch.name}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 5px;">` :
                    `<div style="width: 100%; height: 150px; background: #444; border-radius: 5px; display: flex; align-items: center; justify-content: center; color: #888;">
                        <i class="fas fa-stamp" style="font-size: 48px;"></i>
                    </div>`
                }
            </div>
            <div style="color: #ffffff; font-weight: bold; margin-bottom: 5px;">${patch.name}</div>
            <div style="color: #aaa; font-size: 0.9em; margin-bottom: 5px;">Type: ${type}</div>
            <div style="color: #aaa; font-size: 0.9em; margin-bottom: 5px;">Available: <span class="${statusClass}">${availableQty} ${unit}</span></div>
            <div style="color: #3b82f6; font-weight: bold; margin-bottom: 5px;">₱${pricePerUnit.toFixed(2)} per ${unit}</div>
            <div style="color: #aaa; font-size: 0.85em; margin-top: 10px; padding-top: 10px; border-top: 1px solid #444;">
                Status: <span class="${statusClass}">${statusText}</span>
            </div>
        `;
        
        card.addEventListener('click', function(e) {
            e.stopPropagation();
            e.preventDefault();
            if (isAvailable) {
                selectPatch(patch);
            } else {
                alert('This patch is out of stock. Please select another patch.');
            }
        });
        
        card.setAttribute('data-patch-id', patch.id);
        card.style.pointerEvents = 'auto';
        card.style.userSelect = 'none';
        
        return card;
    }
    
    // Select patch and show quantity input modal
    function selectPatch(patch) {
        selectedPatch = patch;
        document.getElementById('modalPatchName').textContent = patch.name;
        document.getElementById('modalPatchAvailable').textContent = patch.quantity || 0;
        document.getElementById('modalPatchUnit').textContent = patch.unit_of_measurement || 'pieces';
        document.getElementById('patchQuantityNeeded').value = '';
        document.getElementById('patchThreadColor').value = '';
        document.getElementById('patchThreadColorOther').value = '';
        document.getElementById('patchThreadColorOtherField').style.display = 'none';
        document.getElementById('patchThreadLength').value = '';
        document.getElementById('patchQuantityError').style.display = 'none';
        
        patchesBrochureModal.hide();
        if (!patchQuantityModal) {
            initializePatchesModals();
        }
        // Calculate and set thread meters
        updateMaterialThreadMeters('patches');
        
        // Add event listener to recalculate when quantity changes
        const patchQuantityInput = document.getElementById('patchQuantityNeeded');
        if (patchQuantityInput) {
            patchQuantityInput.addEventListener('input', function() {
                updateMaterialThreadMeters('patches');
            });
        }
        
        patchQuantityModal.show();
    }
    
    // Confirm patch selection with quantity
    async function confirmPatchSelection() {
        const quantityNeeded = parseInt(document.getElementById('patchQuantityNeeded').value);
        const threadColor = document.getElementById('patchThreadColor').value;
        const threadColorOther = document.getElementById('patchThreadColorOther').value;
        const threadLength = parseFloat(document.getElementById('patchThreadLength').value) || 0;
        const errorDiv = document.getElementById('patchQuantityError');
        
        if (!quantityNeeded || quantityNeeded <= 0) {
            errorDiv.textContent = 'Please enter a valid quantity (greater than 0)';
            errorDiv.style.display = 'block';
            return;
        }
        
        if (!selectedPatch) {
            errorDiv.textContent = 'No patch selected. Please try again.';
            errorDiv.style.display = 'block';
            return;
        }
        
        if (!threadColor) {
            errorDiv.textContent = 'Please select a thread color';
            errorDiv.style.display = 'block';
            return;
        }
        
        if (threadColor === 'other' && !threadColorOther.trim()) {
            errorDiv.textContent = 'Please enter a custom thread color name';
            errorDiv.style.display = 'block';
            return;
        }
        
        if (!threadLength || threadLength <= 0) {
            errorDiv.textContent = 'Please enter a valid thread length (greater than 0)';
            errorDiv.style.display = 'block';
            return;
        }
        
        // Check thread availability
        const finalThreadColor = threadColor === 'other' ? threadColorOther.trim() : threadColor;
        const threadAvailability = await checkThreadAvailability(finalThreadColor);
        
        if (!threadAvailability.found) {
            errorDiv.textContent = `Thread color "${finalThreadColor}" not found in materials. Out of stock, please choose other color.`;
            errorDiv.style.display = 'block';
            return;
        }
        
        if (!threadAvailability.available || threadAvailability.quantity <= 0) {
            errorDiv.textContent = `Thread color "${finalThreadColor}" is out of stock. Please choose other color.`;
            errorDiv.style.display = 'block';
            return;
        }
        
        const availableQty = parseInt(selectedPatch.quantity) || 0;
        if (quantityNeeded > availableQty) {
            errorDiv.textContent = `Only ${availableQty} ${selectedPatch.unit_of_measurement || 'pieces'} available. Please enter a smaller amount.`;
            errorDiv.style.display = 'block';
            return;
        }
        
        // Store selected patch info
        document.getElementById('selectedPatchId').value = selectedPatch.id;
        document.getElementById('selectedPatchQuantityUsed').value = quantityNeeded;
        
        // Recalculate thread length
        calculateThreadLength();
        
        // Store thread color and length for patches
        const threadColorField = document.getElementById('selectedThreadColorPatches');
        const threadColorOtherField = document.getElementById('selectedThreadColorOtherPatches');
        const threadLengthField = document.getElementById('selectedPatchThreadLength');
        if (threadColorField) threadColorField.value = threadColor;
        if (threadColorOtherField) threadColorOtherField.value = threadColor === 'other' ? threadColorOther.trim() : '';
        if (threadLengthField) threadLengthField.value = threadLength;
        
        // Calculate price - patches are typically priced per piece
        const calculatedPatchPrice = parseFloat(selectedPatch.price) * quantityNeeded;
        
        // Update display
        document.getElementById('selectedPatchName').textContent = selectedPatch.name;
        document.getElementById('selectedPatchType').textContent = extractPatchType(selectedPatch.name, selectedPatch.description);
        document.getElementById('selectedPatchAvailable').textContent = availableQty;
        document.getElementById('selectedPatchUnit').textContent = selectedPatch.unit_of_measurement || 'pieces';
        document.getElementById('selectedPatchPrice').textContent = calculatedPatchPrice.toFixed(2);
        document.getElementById('selectedPatchPriceUnit').textContent = 'total';
        document.getElementById('selectedPatchQuantity').textContent = quantityNeeded;
        document.getElementById('selectedPatchQuantityUnit').textContent = selectedPatch.unit_of_measurement || 'pieces';
        document.getElementById('selectedPatchInfo').style.display = 'block';
        
        patchQuantityModal.hide();
    }
    
    // Populate patch type filter dropdown
    function populatePatchTypeFilter() {
        const filter = document.getElementById('patchTypeFilter');
        if (!filter) return;
        
        const types = new Set();
        allPatches.forEach(patch => {
            const type = extractPatchType(patch.name, patch.description);
            if (type) types.add(type);
        });
        
        filter.innerHTML = '<option value="">All Types</option>';
        
        Array.from(types).sort().forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = type;
            filter.appendChild(option);
        });
    }

    // Calculate cost
    function calculateCost() {
        try {
            const serviceType = document.getElementById('serviceType').value;
            const customerName = document.getElementById('customerName').value;
            const customerPhone = document.getElementById('customerPhone').value;
            
            // Enhanced validation
            if (!serviceType) {
                showAlert('Please select a service type', 'warning');
                return;
            }
            
            if (!customerName || customerName.trim() === '') {
                showAlert('Please enter customer name', 'warning');
                return;
            }
            
            if (!customerPhone || customerPhone.trim() === '') {
                showAlert('Please enter customer phone number', 'warning');
                return;
            }
            
            // Validate phone number format (basic validation)
            const phoneRegex = /^[0-9+\-\s()]+$/;
            if (!phoneRegex.test(customerPhone)) {
                showAlert('Please enter a valid phone number', 'warning');
                return;
            }

            let totalCost = 0;
            let details = [];

            if (serviceType === 'rent') {
                if (selectedRentalProducts.length === 0) {
                    showAlert('Please select rental items', 'warning');
                    return;
                }

                // Calculate cost based on selected products
                selectedRentalProducts.forEach(product => {
                    totalCost += product.price * product.quantity;
                });
                
                details.push(
                    { label: 'Customer Name', value: customerName },
                    { label: 'Service Type', value: 'Rent' },
                    { label: 'Items Selected', value: selectedRentalProducts.length },
                    { label: 'Total Quantity', value: selectedRentalProducts.reduce((sum, p) => sum + p.quantity, 0) },
                    { label: 'Total Cost', value: `₱${totalCost}` }
                );

            } else if (serviceType === 'repair') {
                const repairType = document.getElementById('repairType').value;
                const urgency = document.getElementById('repairUrgency').value;
                const sewingStyle = document.getElementById('sewingStyle').value;

                if (!repairType) {
                    alert('Please select repair type');
                    return;
                }

                // Initialize cost breakdown
                let laborCost = 0;
                let materialsCost = 0;
                let urgentFee = 0;

                // Calculate LABOR COST based on repair type (standard pricing)
                if (repairType === 'putol') {
                    laborCost = pricing.repair.putol || 50;
                } else if (repairType === 'baston') {
                    laborCost = pricing.repair.baston || 50;
                } else if (repairType === 'suklot') {
                    laborCost = pricing.repair.suklot || 100;
                } else if (repairType === 'baston_suklot') {
                    laborCost = pricing.repair.baston_suklot || 150;
                } else if (repairType === 'baston_putol') {
                    laborCost = pricing.repair.baston_putol || 120;
                } else if (repairType === 'ambel') {
                    laborCost = pricing.repair.ambel || 150;
                } else if (repairType === 'pasada') {
                    laborCost = pricing.repair.pasada || 50;
                } else if (repairType === 'zipper_replacement') {
                    const zipperProvided = document.getElementById('zipperProvided') ? document.getElementById('zipperProvided').value : 'no';
                    // Labor cost is same whether zipper is provided or not
                    laborCost = pricing.repair.zipper_replacement || 90;
                    
                    // If zipper is NOT provided, add zipper material cost
                    if (zipperProvided === 'no') {
                        const zipperId = document.getElementById('selectedZipperId') ? document.getElementById('selectedZipperId').value : null;
                        const zipperInches = parseFloat(document.getElementById('selectedZipperInchesUsed') ? document.getElementById('selectedZipperInchesUsed').value : 0) || 0;
                        
                        if (zipperId && zipperInches > 0 && allZippers && allZippers.length > 0) {
                            const selectedZipper = allZippers.find(z => z.id == zipperId);
                            if (selectedZipper) {
                                materialsCost += calculateZipperPrice(selectedZipper.name, zipperInches);
                            }
                        }
                    }
                } else if (repairType === 'bewang') {
                    laborCost = pricing.repair.bewang || 250;
                    // Add garter material cost if garter is selected
                    const garterId = document.getElementById('selectedGarterId') ? document.getElementById('selectedGarterId').value : null;
                    const garterInches = parseFloat(document.getElementById('selectedGarterInchesUsed') ? document.getElementById('selectedGarterInchesUsed').value : 0) || 0;
                    
                    if (garterId && garterInches > 0) {
                        materialsCost += calculateGarterPrice(garterInches);
                    }
                } else if (repairType === 'buttons') {
                    const buttonsProvidedElement = document.getElementById('buttonsProvided');
                    const provided = buttonsProvidedElement ? buttonsProvidedElement.value : 'no';
                    
                    // Labor cost is same whether buttons are provided or not
                    laborCost = pricing.repair.buttons || 90;
                    
                    // If buttons are NOT provided, add button material cost
                    if (provided === 'no') {
                        const buttonId = document.getElementById('selectedButtonId') ? document.getElementById('selectedButtonId').value : null;
                        const buttonQuantity = parseInt(document.getElementById('selectedButtonQuantityUsed') ? document.getElementById('selectedButtonQuantityUsed').value : 0) || 0;
                        
                        if (buttonId && buttonQuantity > 0 && allButtons && allButtons.length > 0) {
                            const selectedButton = allButtons.find(b => b.id == buttonId);
                            if (selectedButton) {
                                materialsCost += calculateButtonPrice(selectedButton.name, buttonQuantity);
                            }
                        }
                    }
                } else if (repairType === 'elastic') {
                    laborCost = pricing.repair.elastic || 150;
                    // Add garter material cost if garter is selected
                    const garterId = document.getElementById('selectedGarterIdElastic') ? document.getElementById('selectedGarterIdElastic').value : null;
                    const garterInches = parseFloat(document.getElementById('selectedGarterInchesUsedElastic') ? document.getElementById('selectedGarterInchesUsedElastic').value : 0) || 0;
                    
                    if (garterId && garterInches > 0) {
                        materialsCost += calculateGarterPrice(garterInches);
                    }
                } else if (repairType === 'patches') {
                    const patchProvidedElement = document.getElementById('patchProvided');
                    const provided = patchProvidedElement ? patchProvidedElement.value : 'no';
                    
                    // Labor cost is same whether patch is provided or not
                    laborCost = pricing.repair.patches || 90;
                    
                    // If patch is NOT provided, add patch material cost
                    if (provided === 'no') {
                        const patchId = document.getElementById('selectedPatchId') ? document.getElementById('selectedPatchId').value : null;
                        const patchQuantity = parseInt(document.getElementById('selectedPatchQuantityUsed') ? document.getElementById('selectedPatchQuantityUsed').value : 0) || 0;
                        
                        if (patchId && patchQuantity > 0 && allPatches && allPatches.length > 0) {
                            const selectedPatch = allPatches.find(p => p.id == patchId);
                            if (selectedPatch) {
                                materialsCost += parseFloat(selectedPatch.price) * patchQuantity;
                            }
                        }
                    }
                    
                    // Add thread cost if thread length is provided
                    const patchThreadLength = parseFloat(document.getElementById('selectedPatchThreadLength') ? document.getElementById('selectedPatchThreadLength').value : 0) || 0;
                    if (patchThreadLength > 0) {
                        const patchThreadColor = document.getElementById('selectedThreadColorPatches') ? document.getElementById('selectedThreadColorPatches').value : '';
                        const patchThreadColorOther = document.getElementById('selectedThreadColorOtherPatches') ? document.getElementById('selectedThreadColorOtherPatches').value : '';
                        const finalThreadColor = patchThreadColor === 'other' ? patchThreadColorOther : patchThreadColor;
                        const threadName = finalThreadColor ? `Thread ${finalThreadColor}` : 'Spun Polyester Thread';
                        materialsCost += calculateThreadPrice(threadName, patchThreadLength);
                    }
                } else if (repairType === 'general_tshirt_repair') {
                    laborCost = pricing.repair.general_tshirt_repair || 150;
                } else if (repairType === 'general_repair') {
                    laborCost = pricing.repair.general_repair || 450;
                } else if (repairType === 'lock_repair') {
                    laborCost = pricing.repair.lock_repair || 90;
                    // Add lock material cost if lock is selected
                    const lockId = document.getElementById('selectedLockId') ? document.getElementById('selectedLockId').value : null;
                    const lockGroups = parseInt(document.getElementById('selectedLockGroupsUsed') ? document.getElementById('selectedLockGroupsUsed').value : 0) || 0;
                    
                    if (lockId && lockGroups > 0) {
                        materialsCost += calculateLockPrice(lockGroups);
                    }
                } else {
                    // Default to general repair pricing if repair type not found
                    laborCost = pricing.repair.general_repair || 450;
                }
                
                // Add thread cost if thread is used (for thread-requiring repairs) - use global directly
                if (window.threadRequiredTypes && window.threadRequiredTypes.includes(repairType)) {
                    const threadMeters = parseFloat(document.getElementById('threadMeters') ? document.getElementById('threadMeters').value : 0) || 0;
                    if (threadMeters > 0) {
                        const threadColor = document.getElementById('threadColor') ? document.getElementById('threadColor').value : '';
                        // Use thread color or default thread type
                        const threadName = threadColor ? `Thread ${threadColor}` : 'Spun Polyester Thread';
                        materialsCost += calculateThreadPrice(threadName, threadMeters);
                    }
                }

                // Add urgent fee if urgent
                if (urgency === 'urgent') {
                    urgentFee = 20;
                }
                
                // Calculate total cost
                totalCost = laborCost + materialsCost + urgentFee;

                details.push(
                    { label: 'Customer Name', value: customerName },
                    { label: 'Service Type', value: 'Repair' },
                    { label: 'Repair Type', value: repairType.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) },
                    { label: 'Urgent', value: urgency === 'urgent' ? 'Yes' : 'No' }
                );
                
                // Add sewing style if selected
                if (sewingStyle) {
                    const sewingStyleDisplay = sewingStyle === 'straight_stitch' ? 'Straight Stitch' : 'Zigzag Stitch';
                    details.push({ label: 'Sewing Style', value: sewingStyleDisplay });
                }
                
                // Add button details if applicable
                if (repairType === 'buttons') {
                    const buttonTypeElement = document.getElementById('buttonType');
                    const buttonClassElement = document.getElementById('buttonClass');
                    const buttonsProvidedElement = document.getElementById('buttonsProvided');
                    
                    const buttonType = buttonTypeElement ? buttonTypeElement.value : '';
                    const buttonClass = buttonClassElement ? buttonClassElement.value : '';
                    const buttonsProvided = buttonsProvidedElement ? buttonsProvidedElement.value : 'no';
                    
                    if (buttonType) {
                        details.push({ label: 'Button Type', value: buttonType.charAt(0).toUpperCase() + buttonType.slice(1) });
                    }
                    if (buttonClass) {
                        details.push({ label: 'Button Class', value: buttonClass.charAt(0).toUpperCase() + buttonClass.slice(1) });
                    }
                    if (buttonsProvided) {
                        details.push({ label: 'Buttons Provided', value: buttonsProvided === 'yes' ? 'Yes' : 'No' });
                    }
                }
                
                // Add patch details if applicable
                if (repairType === 'patches') {
                    const patchProvidedElement = document.getElementById('patchProvided');
                    const patchId = document.getElementById('selectedPatchId') ? document.getElementById('selectedPatchId').value : null;
                    const patchQuantity = parseInt(document.getElementById('selectedPatchQuantityUsed') ? document.getElementById('selectedPatchQuantityUsed').value : 0) || 0;
                    const patchThreadColor = document.getElementById('selectedThreadColorPatches') ? document.getElementById('selectedThreadColorPatches').value : '';
                    const patchThreadColorOther = document.getElementById('selectedThreadColorOtherPatches') ? document.getElementById('selectedThreadColorOtherPatches').value : '';
                    const patchThreadLength = parseFloat(document.getElementById('selectedPatchThreadLength') ? document.getElementById('selectedPatchThreadLength').value : 0) || 0;
                    
                    const patchProvided = patchProvidedElement ? patchProvidedElement.value : 'no';
                    
                    if (patchId && allPatches && allPatches.length > 0) {
                        const selectedPatch = allPatches.find(p => p.id == patchId);
                        if (selectedPatch) {
                            const patchType = extractPatchType(selectedPatch.name, selectedPatch.description);
                            details.push({ label: 'Selected Patch', value: selectedPatch.name });
                            if (patchType) {
                                details.push({ label: 'Patch Type', value: patchType });
                            }
                        }
                    }
                    if (patchQuantity > 0) {
                        details.push({ label: 'Patch Quantity', value: `${patchQuantity} pieces` });
                    }
                    if (patchProvided) {
                        details.push({ label: 'Patch Provided', value: patchProvided === 'yes' ? 'Yes' : 'No' });
                    }
                    if (patchThreadColor) {
                        const finalThreadColor = patchThreadColor === 'other' ? patchThreadColorOther : patchThreadColor;
                        if (finalThreadColor) {
                            details.push({ label: 'Thread Color', value: finalThreadColor.charAt(0).toUpperCase() + finalThreadColor.slice(1) });
                        }
                    }
                    if (patchThreadLength > 0) {
                        details.push({ label: 'Thread Length', value: `${patchThreadLength} meters` });
                    }
                }
                
                // Add thread details if applicable - use global directly
                if (window.threadRequiredTypes && window.threadRequiredTypes.includes(repairType)) {
                    const threadColor = document.getElementById('threadColor').value || 'N/A';
                    const threadMeters = document.getElementById('threadMeters').value || 'N/A';
                    
                    if (threadColor && threadColor !== 'N/A') {
                        details.push({ label: 'Thread Color', value: threadColor.charAt(0).toUpperCase() + threadColor.slice(1) });
                    }
                    
                    if (threadMeters && threadMeters !== 'N/A') {
                        details.push({ label: 'Thread Meters Needed', value: `${threadMeters} meters` });
                    }
                }
                
                // Add detailed cost breakdown
                details.push(
                    { label: 'Labor Cost', value: `₱${laborCost.toFixed(2)}` }
                );
                
                if (materialsCost > 0) {
                    details.push({ label: 'Materials Cost', value: `₱${materialsCost.toFixed(2)}` });
                }
                
                if (urgentFee > 0) {
                    details.push({ label: 'Urgent Fee', value: `₱${urgentFee.toFixed(2)}` });
                }
                
                details.push({ label: 'Total Cost', value: `₱${totalCost.toFixed(2)}` });

            } else if (serviceType === 'customize') {
                const typeOfCustomize = document.getElementById('typeOfCustomize').value;
                const uniformTypes = ['polo', 'polo_shirt', 'blouse', 'pants', 'shorts', 'skirt_palda'];
                const urgencyYN = document.getElementById('customizeUrgency').value;
                const providedMaterials = document.getElementById('providedMaterialsSelect')?.value === 'yes';
                let fabric = document.getElementById('customizeFabric').value || 'N/A';
                
                // Get custom fabric name if "Add Another Fabric" is selected
                if (fabric === 'add_another') {
                    const customFabricName = document.getElementById('customFabricName').value;
                    fabric = customFabricName || 'N/A';
                }

                if (!typeOfCustomize) {
                    alert('Please select type of customize');
                    return;
                }

                // Get quantity
                let quantity = 1;
                if (typeOfCustomize === 'uniform') {
                    const qtyInput = document.getElementById('customizeQuantity');
                    quantity = qtyInput ? parseInt(qtyInput.value) || 1 : 1;
                } else if (typeOfCustomize === 'pe') {
                    const qtyInput = document.getElementById('peQuantity');
                    quantity = qtyInput ? parseInt(qtyInput.value) || 1 : 1;
                }

                // Calculate base cost (labor) based on type
                let baseCost = 0;
                let customizeType = '';
                let fabricCost = 0;
                let threadCost = 0;
                
                if (uniformTypes.includes(typeOfCustomize)) {
                    customizeType = typeOfCustomize;
                    
                    // Check if materials are provided
                    if (providedMaterials) {
                        // Materials provided pricing (labor only)
                        if (customizeType === 'polo') {
                            baseCost = pricing.customize.polo_materials_provided;
                        } else if (customizeType === 'polo_shirt') {
                            baseCost = pricing.customize.polo_materials_provided;
                        } else if (customizeType === 'blouse') {
                            baseCost = pricing.customize.blouse_materials_provided;
                        } else if (customizeType === 'shorts') {
                            baseCost = pricing.customize.shorts_materials_provided;
                        } else if (customizeType === 'pants') {
                            // For pants, need to check pants type
                            const pantsType = document.getElementById('pantsType').value;
                            if (!pantsType) {
                                alert('Please select pants type');
                                return;
                            }
                            baseCost = pricing.customize.pants_labor_only[pantsType] || pricing.customize.pants_materials_provided;
                        } else if (customizeType === 'skirt_palda') {
                            baseCost = pricing.customize.palda_materials_provided;
                        }
                    } else {
                        // Top Style Tela & Labor pricing (includes labor)
                        if (customizeType === 'polo') {
                            baseCost = pricing.customize.polo_tela_labor;
                        } else if (customizeType === 'polo_shirt') {
                            baseCost = pricing.customize.polo_tela_labor;
                        } else if (customizeType === 'blouse') {
                            baseCost = pricing.customize.blouse_tela_labor;
                        } else if (customizeType === 'shorts') {
                            baseCost = pricing.customize.shorts_tela_labor;
                        } else if (customizeType === 'pants') {
                            // For pants, need to check pants type
                            const pantsType = document.getElementById('pantsType').value;
                            if (!pantsType) {
                                alert('Please select pants type');
                                return;
                            }
                            baseCost = pricing.customize.pants_tela_labor[pantsType] || pricing.customize.pants_materials_provided;
                        } else if (customizeType === 'skirt_palda') {
                            baseCost = pricing.customize.palda_tela_labor;
                        }
                        
                        // Add fabric cost and thread cost if Top Style provides materials
                        let fabric = document.getElementById('customizeFabric') ? document.getElementById('customizeFabric').value : '';
                        
                        // Get custom fabric name if "Add Another Fabric" is selected
                        if (fabric === 'add_another') {
                            const customFabricName = document.getElementById('customFabricName') ? document.getElementById('customFabricName').value : '';
                            fabric = customFabricName || '';
                        }
                        
                        const fabricYards = parseFloat(document.getElementById('customizeFabricYards') ? document.getElementById('customizeFabricYards').value : 0) || 0;
                        
                        if (fabric && fabric !== 'N/A' && fabric !== '' && fabricYards > 0) {
                            // Use selling price when Top Style provides the fabric
                            fabricCost = calculateFabricPrice(fabric, fabricYards, true);
                            
                            // Add fabric details to display
                            details.push(
                                { label: 'Fabric Type', value: fabric.charAt(0).toUpperCase() + fabric.slice(1).replace(/_/g, ' ') },
                                { label: 'Fabric Yards', value: fabricYards },
                                { label: 'Fabric Cost', value: `₱${(fabricCost * quantity).toFixed(2)}` }
                            );
                        }

                        const threadMetersProvided = parseFloat(document.getElementById('customizeThreadMeters') ? document.getElementById('customizeThreadMeters').value : 0) || 0;
                        if (threadMetersProvided > 0) {
                            const threadColorSel = document.getElementById('customizeThreadColor') ? document.getElementById('customizeThreadColor').value : '';
                            const threadColorOther = document.getElementById('customizeThreadColorOther') ? document.getElementById('customizeThreadColorOther').value : '';
                            const finalThreadColor = threadColorSel === 'other' ? threadColorOther : threadColorSel;
                            const threadName = finalThreadColor ? `Thread ${finalThreadColor}` : 'Spun Polyester Thread';
                            threadCost = calculateThreadPrice(threadName, threadMetersProvided);
                            details.push(
                                { label: 'Thread Color', value: finalThreadColor || 'N/A' },
                                { label: 'Thread Meters', value: threadMetersProvided },
                                { label: 'Thread Cost', value: `₱${(threadCost * quantity).toFixed(2)}` }
                            );
                        }
                    }
                } else if (typeOfCustomize === 'pe') {
                    const peType = document.getElementById('peType') ? document.getElementById('peType').value : '';
                    if (peType === 'pants') {
                        baseCost = pricing.customize.pe_pants_labor || pricing.customize.pe_labor_only;
                    } else if (peType === 'short' || peType === 'shorts') {
                        baseCost = pricing.customize.pe_shorts_labor || pricing.customize.pe_labor_only;
                    } else {
                        baseCost = pricing.customize.pe_labor_only;
                    }
                    
                    // Calculate fabric and thread costs for PE orders
                    let fabric = document.getElementById('customizeFabric') ? document.getElementById('customizeFabric').value : '';
                    
                    // Get custom fabric name if "Add Another Fabric" is selected
                    if (fabric === 'add_another') {
                        const customFabricName = document.getElementById('customFabricName') ? document.getElementById('customFabricName').value : '';
                        fabric = customFabricName || '';
                    }
                    
                    const fabricYards = parseFloat(document.getElementById('customizeFabricYards') ? document.getElementById('customizeFabricYards').value : 0) || 0;
                    
                    if (fabric && fabric !== 'N/A' && fabric !== '' && fabricYards > 0) {
                        // Use selling price when Top Style provides the fabric
                        fabricCost = calculateFabricPrice(fabric, fabricYards, true);
                    }

                    const threadMetersProvided = parseFloat(document.getElementById('customizeThreadMeters') ? document.getElementById('customizeThreadMeters').value : 0) || 0;
                    if (threadMetersProvided > 0) {
                        const threadColorSel = document.getElementById('customizeThreadColor') ? document.getElementById('customizeThreadColor').value : '';
                        const threadColorOther = document.getElementById('customizeThreadColorOther') ? document.getElementById('customizeThreadColorOther').value : '';
                        const finalThreadColor = threadColorSel === 'other' ? threadColorOther : threadColorSel;
                        const threadName = finalThreadColor ? `Thread ${finalThreadColor}` : 'Spun Polyester Thread';
                        threadCost = calculateThreadPrice(threadName, threadMetersProvided);
                    }
                }
                
                // Calculate total cost: Base Cost (Labor) + Fabric Cost + Thread Cost
                // Start with base cost (labor) * quantity
                totalCost = (baseCost * quantity) + (fabricCost * quantity) + (threadCost * quantity);
                
                // Add urgent surcharge if urgent
                if (urgencyYN === 'yes') {
                    totalCost += pricing.customize.urgent_surcharge * quantity;
                }

                // Collect size details
                let sizeDetails = '';
                
            if (uniformTypes.includes(typeOfCustomize) && customizeType) {
                if (customizeType === 'pants') {
                        // Helper function to get checkbox values or custom input
                        function getMeasurement(fieldName, customId) {
                            const checkboxes = Array.from(document.querySelectorAll(`input[name="${fieldName}"]:checked`)).map(cb => cb.value);
                            const custom = document.getElementById(customId)?.value || '';
                            return { checkboxes, custom };
                        }
                        
                        const length = getMeasurement('uniform_pants_length_checkbox', 'uniformPantsLengthCustom');
                        const waist = getMeasurement('uniform_pants_waist_checkbox', 'uniformPantsWaistCustom');
                        const crotch = getMeasurement('uniform_pants_crotch_checkbox', 'uniformPantsCrotchCustom');
                        const hips = getMeasurement('uniform_pants_hips_checkbox', 'uniformPantsHipsCustom');
                        const thigh = getMeasurement('uniform_pants_thigh_checkbox', 'uniformPantsThighCustom');
                        const knee = getMeasurement('uniform_pants_knee_checkbox', 'uniformPantsKneeCustom');
                        const bottom = getMeasurement('uniform_pants_bottom_checkbox', 'uniformPantsBottomCustom');
                        
                        const parts = [];
                        if (length.checkboxes.length > 0) parts.push(`Length: ${length.checkboxes.join(', ')}`);
                        if (length.custom) parts.push(`Length (Custom): ${length.custom}`);
                        if (waist.checkboxes.length > 0) parts.push(`Waist: ${waist.checkboxes.join(', ')}`);
                        if (waist.custom) parts.push(`Waist (Custom): ${waist.custom}`);
                        if (crotch.checkboxes.length > 0) parts.push(`Crotch: ${crotch.checkboxes.join(', ')}`);
                        if (crotch.custom) parts.push(`Crotch (Custom): ${crotch.custom}`);
                        if (hips.checkboxes.length > 0) parts.push(`Hips: ${hips.checkboxes.join(', ')}`);
                        if (hips.custom) parts.push(`Hips (Custom): ${hips.custom}`);
                        if (thigh.checkboxes.length > 0) parts.push(`Thigh: ${thigh.checkboxes.join(', ')}`);
                        if (thigh.custom) parts.push(`Thigh (Custom): ${thigh.custom}`);
                        if (knee.checkboxes.length > 0) parts.push(`Knee: ${knee.checkboxes.join(', ')}`);
                        if (knee.custom) parts.push(`Knee (Custom): ${knee.custom}`);
                        if (bottom.checkboxes.length > 0) parts.push(`Bottom: ${bottom.checkboxes.join(', ')}`);
                        if (bottom.custom) parts.push(`Bottom (Custom): ${bottom.custom}`);
                        sizeDetails = parts.length > 0 ? parts.join(' | ') : 'Pants Measurements';
                } else if (customizeType === 'polo' || customizeType === 'polo_shirt') {
                    // Helper function to get checkbox values or custom input
                    function getMeasurement(fieldName, customId) {
                        const checkboxes = Array.from(document.querySelectorAll(`input[name="${fieldName}"]:checked`)).map(cb => cb.value);
                        const custom = document.getElementById(customId)?.value || '';
                        return { checkboxes, custom };
                    }
                    
                    const neckline = getMeasurement('uniform_polo_neckline_checkbox', 'uniformPoloNecklineCustom');
                    const bust = getMeasurement('uniform_polo_bust_checkbox', 'uniformPoloBustCustom');
                    const armhole = getMeasurement('uniform_polo_armhole_checkbox', 'uniformPoloArmholeCustom');
                    const shoulders = getMeasurement('uniform_polo_shoulders_checkbox', 'uniformPoloShouldersCustom');
                    const waist = getMeasurement('uniform_polo_waist_checkbox', 'uniformPoloWaistCustom');
                    const sleeve = getMeasurement('uniform_polo_sleeve_checkbox', 'uniformPoloSleeveCustom');
                    const hips = getMeasurement('uniform_polo_hips_checkbox', 'uniformPoloHipsCustom');
                    const length = getMeasurement('uniform_polo_length_checkbox', 'uniformPoloLengthCustom');
                    
                    const parts = [];
                    if (neckline.checkboxes.length > 0) parts.push(`Neckline: ${neckline.checkboxes.join(', ')}`);
                    if (neckline.custom) parts.push(`Neckline (Custom): ${neckline.custom}`);
                    if (bust.checkboxes.length > 0) parts.push(`Bust: ${bust.checkboxes.join(', ')}`);
                    if (bust.custom) parts.push(`Bust (Custom): ${bust.custom}`);
                    if (armhole.checkboxes.length > 0) parts.push(`Armhole: ${armhole.checkboxes.join(', ')}`);
                    if (armhole.custom) parts.push(`Armhole (Custom): ${armhole.custom}`);
                    if (shoulders.checkboxes.length > 0) parts.push(`Shoulders: ${shoulders.checkboxes.join(', ')}`);
                    if (shoulders.custom) parts.push(`Shoulders (Custom): ${shoulders.custom}`);
                    if (waist.checkboxes.length > 0) parts.push(`Waist: ${waist.checkboxes.join(', ')}`);
                    if (waist.custom) parts.push(`Waist (Custom): ${waist.custom}`);
                    if (sleeve.checkboxes.length > 0) parts.push(`Sleeve: ${sleeve.checkboxes.join(', ')}`);
                    if (sleeve.custom) parts.push(`Sleeve (Custom): ${sleeve.custom}`);
                    if (hips.checkboxes.length > 0) parts.push(`Hips: ${hips.checkboxes.join(', ')}`);
                    if (hips.custom) parts.push(`Hips (Custom): ${hips.custom}`);
                    if (length.checkboxes.length > 0) parts.push(`Length: ${length.checkboxes.join(', ')}`);
                    if (length.custom) parts.push(`Length (Custom): ${length.custom}`);
                    sizeDetails = parts.length > 0 ? parts.join(' | ') : 'Polo Measurements';
                } else if (customizeType === 'blouse') {
                    // Helper function to get checkbox values or custom input
                    function getMeasurement(fieldName, customId) {
                        const checkboxes = Array.from(document.querySelectorAll(`input[name="${fieldName}"]:checked`)).map(cb => cb.value);
                        const custom = document.getElementById(customId)?.value || '';
                        return { checkboxes, custom };
                    }
                    
                    const neckline = getMeasurement('uniform_blouse_neckline_checkbox', 'uniformBlouseNecklineCustom');
                    const bust = getMeasurement('uniform_blouse_bust_checkbox', 'uniformBlouseBustCustom');
                    const armhole = getMeasurement('uniform_blouse_armhole_checkbox', 'uniformBlouseArmholeCustom');
                    const shoulders = getMeasurement('uniform_blouse_shoulders_checkbox', 'uniformBlouseShouldersCustom');
                    const waist = getMeasurement('uniform_blouse_waist_checkbox', 'uniformBlouseWaistCustom');
                    const sleeve = getMeasurement('uniform_blouse_sleeve_checkbox', 'uniformBlouseSleeveCustom');
                    const hips = getMeasurement('uniform_blouse_hips_checkbox', 'uniformBlouseHipsCustom');
                    const length = getMeasurement('uniform_blouse_length_checkbox', 'uniformBlouseLengthCustom');
                    
                    const parts = [];
                    if (neckline.checkboxes.length > 0) parts.push(`Neckline: ${neckline.checkboxes.join(', ')}`);
                    if (neckline.custom) parts.push(`Neckline (Custom): ${neckline.custom}`);
                    if (bust.checkboxes.length > 0) parts.push(`Bust: ${bust.checkboxes.join(', ')}`);
                    if (bust.custom) parts.push(`Bust (Custom): ${bust.custom}`);
                    if (armhole.checkboxes.length > 0) parts.push(`Armhole: ${armhole.checkboxes.join(', ')}`);
                    if (armhole.custom) parts.push(`Armhole (Custom): ${armhole.custom}`);
                    if (shoulders.checkboxes.length > 0) parts.push(`Shoulders: ${shoulders.checkboxes.join(', ')}`);
                    if (shoulders.custom) parts.push(`Shoulders (Custom): ${shoulders.custom}`);
                    if (waist.checkboxes.length > 0) parts.push(`Waist: ${waist.checkboxes.join(', ')}`);
                    if (waist.custom) parts.push(`Waist (Custom): ${waist.custom}`);
                    if (sleeve.checkboxes.length > 0) parts.push(`Sleeve: ${sleeve.checkboxes.join(', ')}`);
                    if (sleeve.custom) parts.push(`Sleeve (Custom): ${sleeve.custom}`);
                    if (hips.checkboxes.length > 0) parts.push(`Hips: ${hips.checkboxes.join(', ')}`);
                    if (hips.custom) parts.push(`Hips (Custom): ${hips.custom}`);
                    if (length.checkboxes.length > 0) parts.push(`Length: ${length.checkboxes.join(', ')}`);
                    if (length.custom) parts.push(`Length (Custom): ${length.custom}`);
                    sizeDetails = parts.length > 0 ? parts.join(' | ') : 'Blouse Measurements';
                } else if (customizeType === 'shorts') {
                    // Helper function to get checkbox values or custom input
                    function getMeasurement(fieldName, customId) {
                        const checkboxes = Array.from(document.querySelectorAll(`input[name="${fieldName}"]:checked`)).map(cb => cb.value);
                        const custom = document.getElementById(customId)?.value || '';
                        return { checkboxes, custom };
                    }
                    
                    const length = getMeasurement('uniform_shorts_length_checkbox', 'uniformShortsLengthCustom');
                    const waist = getMeasurement('uniform_shorts_waist_checkbox', 'uniformShortsWaistCustom');
                    const crotch = getMeasurement('uniform_shorts_crotch_checkbox', 'uniformShortsCrotchCustom');
                    const hips = getMeasurement('uniform_shorts_hips_checkbox', 'uniformShortsHipsCustom');
                    const bottom = getMeasurement('uniform_shorts_bottom_checkbox', 'uniformShortsBottomCustom');
                    
                    const parts = [];
                    if (length.checkboxes.length > 0) parts.push(`Length: ${length.checkboxes.join(', ')}`);
                    if (length.custom) parts.push(`Length (Custom): ${length.custom}`);
                    if (waist.checkboxes.length > 0) parts.push(`Waist: ${waist.checkboxes.join(', ')}`);
                    if (waist.custom) parts.push(`Waist (Custom): ${waist.custom}`);
                    if (crotch.checkboxes.length > 0) parts.push(`Crotch: ${crotch.checkboxes.join(', ')}`);
                    if (crotch.custom) parts.push(`Crotch (Custom): ${crotch.custom}`);
                    if (hips.checkboxes.length > 0) parts.push(`Hips: ${hips.checkboxes.join(', ')}`);
                    if (hips.custom) parts.push(`Hips (Custom): ${hips.custom}`);
                    if (bottom.checkboxes.length > 0) parts.push(`Bottom: ${bottom.checkboxes.join(', ')}`);
                    if (bottom.custom) parts.push(`Bottom (Custom): ${bottom.custom}`);
                    sizeDetails = parts.length > 0 ? parts.join(' | ') : 'Shorts Measurements';
                } else if (customizeType === 'skirt_palda') {
                    // Helper function to get checkbox values or custom input
                    function getMeasurement(fieldName, customId) {
                        const checkboxes = Array.from(document.querySelectorAll(`input[name="${fieldName}"]:checked`)).map(cb => cb.value);
                        const custom = document.getElementById(customId)?.value || '';
                        return { checkboxes, custom };
                    }
                    
                    const length = getMeasurement('uniform_skirt_length_checkbox', 'uniformSkirtLengthCustom');
                    const waist = getMeasurement('uniform_skirt_waist_checkbox', 'uniformSkirtWaistCustom');
                    const hips = getMeasurement('uniform_skirt_hips_checkbox', 'uniformSkirtHipsCustom');
                    const hemWidth = getMeasurement('uniform_skirt_hem_width_checkbox', 'uniformSkirtHemWidthCustom');
                    
                    const parts = [];
                    if (length.checkboxes.length > 0) parts.push(`Length: ${length.checkboxes.join(', ')}`);
                    if (length.custom) parts.push(`Length (Custom): ${length.custom}`);
                    if (waist.checkboxes.length > 0) parts.push(`Waist: ${waist.checkboxes.join(', ')}`);
                    if (waist.custom) parts.push(`Waist (Custom): ${waist.custom}`);
                    if (hips.checkboxes.length > 0) parts.push(`Hips: ${hips.checkboxes.join(', ')}`);
                    if (hips.custom) parts.push(`Hips (Custom): ${hips.custom}`);
                    if (hemWidth.checkboxes.length > 0) parts.push(`Hem Width: ${hemWidth.checkboxes.join(', ')}`);
                    if (hemWidth.custom) parts.push(`Hem Width (Custom): ${hemWidth.custom}`);
                    sizeDetails = parts.length > 0 ? parts.join(' | ') : 'Skirt/Palda Measurements';
                }
            } else if (typeOfCustomize === 'pe') {
                const peType = document.getElementById('peType')?.value || '';
                const parts = ['PE Uniform'];
                if (peType === 'short') {
                    const waist = document.getElementById('peShortsWaist')?.value || '';
                    const hips = document.getElementById('peShortsHips')?.value || '';
                    const length = document.getElementById('peShortsLength')?.value || '';
                    if (waist) parts.push(`Waist: ${waist}`);
                    if (hips) parts.push(`Hips: ${hips}`);
                    if (length) parts.push(`Length: ${length}`);
                } else if (peType === 'pants') {
                    const waist = document.getElementById('pePantsWaist')?.value || '';
                    const hips = document.getElementById('pePantsHips')?.value || '';
                    const length = document.getElementById('pePantsLength')?.value || '';
                    const legOpening = document.getElementById('pePantsLegOpening')?.value || '';
                    const inseam = document.getElementById('pePantsInseam')?.value || '';
                    const outseam = document.getElementById('pePantsOutseam')?.value || '';
                    if (waist) parts.push(`Waist: ${waist}`);
                    if (hips) parts.push(`Hips: ${hips}`);
                    if (length) parts.push(`Length: ${length}`);
                    if (legOpening) parts.push(`Leg Opening: ${legOpening}`);
                    if (inseam) parts.push(`Inseam: ${inseam}`);
                    if (outseam) parts.push(`Outseam: ${outseam}`);
                }
                const peGender = document.getElementById('peGender')?.value || '';
                const tshirtSize = document.getElementById('peTshirtSize')?.value || '';
                const chestCirc = document.getElementById('peChestCircumference')?.value || '';
                const shirtLength = document.getElementById('peShirtLength')?.value || '';
                const neckCirc = document.getElementById('peNeckCircumference')?.value || '';
                const bust = document.getElementById('peBust')?.value || '';
                const armhole = document.getElementById('peArmhole')?.value || '';
                const shoulder = document.getElementById('peShoulder')?.value || '';
                const waist = document.getElementById('peTshirtWaist')?.value || '';
                if (peGender) parts.push(`Gender: ${peGender.charAt(0).toUpperCase() + peGender.slice(1)}`);
                if (tshirtSize) parts.push(`T-Shirt Size: ${tshirtSize}`);
                if (chestCirc) parts.push(`Chest: ${chestCirc}`);
                if (shirtLength) parts.push(`Shirt Length: ${shirtLength}`);
                if (neckCirc) parts.push(`Neck: ${neckCirc}`);
                if (bust) parts.push(`Bust: ${bust}`);
                if (armhole) parts.push(`Armhole: ${armhole}`);
                if (shoulder) parts.push(`Shoulder: ${shoulder}`);
                if (waist) parts.push(`Waist: ${waist}`);
                sizeDetails = parts.join(' | ');
            }
            
            if (customizeType === 'whole') {
                const gender = document.getElementById('wholeGender').value || 'N/A';
                const top = gender === 'male' ? (document.getElementById('maleTopSize').value || 'N/A') : (gender === 'female' ? (document.getElementById('femaleBlouseSize').value || 'N/A') : 'N/A');
                // Get selected radio button value or hidden input value for pants
                let pants = 'N/A';
                if (gender === 'male') {
                    const malePantsRadio = document.querySelector('input[name="male_pants_size"]:checked');
                    pants = malePantsRadio ? malePantsRadio.value : (document.getElementById('malePantsSize') ? document.getElementById('malePantsSize').value : 'N/A');
                } else if (gender === 'female') {
                    const femalePantsRadio = document.querySelector('input[name="female_pants_size"]:checked');
                    pants = femalePantsRadio ? femalePantsRadio.value : (document.getElementById('femalePantsSize') ? document.getElementById('femalePantsSize').value : 'N/A');
                }
                sizeDetails = `Gender: ${gender.toUpperCase()} • Top: ${top} • Pants: ${pants}`;
            }

                // Calculate breakdown for display
                let baseCostDisplay = baseCost * quantity;
                let urgentFee = 0;
                let finalTotal = totalCost;
                
                if (urgencyYN === 'yes') {
                    urgentFee = pricing.customize.urgent_surcharge * quantity;
                }
                
                // Display the actual selected type
                let displayType = typeOfCustomize.charAt(0).toUpperCase() + typeOfCustomize.slice(1).replace('_', '/');
                if (typeOfCustomize === 'pants') {
                    const pantsType = document.getElementById('pantsType')?.value;
                    if (pantsType) {
                        displayType += ` (${pantsType.charAt(0).toUpperCase() + pantsType.slice(1)})`;
                    }
                } else if (typeOfCustomize === 'pe') {
                    const peType = document.getElementById('peType')?.value;
                    if (peType) {
                        displayType = `PE - ${peType.charAt(0).toUpperCase() + peType.slice(1)}`;
                    } else {
                        displayType = 'PE';
                    }
                }
                
                const detailsArray = [
                    { label: 'Customer Name', value: customerName },
                    { label: 'Service Type', value: 'Customize' },
                    { label: 'Type of Customize', value: displayType },
                    { label: 'Urgent', value: urgencyYN === 'yes' ? 'Yes' : 'No' },
                    { label: 'Fabric', value: fabric },
                ];
                
                detailsArray.push({ label: 'Quantity', value: quantity });
                
                // Add pricing type
                if (uniformTypes.includes(typeOfCustomize)) {
                    if (providedMaterials) {
                        detailsArray.push({ label: 'Pricing Type', value: 'Materials Provided' });
                    } else {
                        detailsArray.push({ label: 'Pricing Type', value: 'Top Style Tela & Labor' });
                    }
                } else if (typeOfCustomize === 'pe') {
                    detailsArray.push({ label: 'Pricing Type', value: 'Labor Only' });
                }
                
                // Add cost breakdown - show labor cost and materials cost separately
                detailsArray.push(
                    { label: 'Labor Cost', value: `₱${baseCostDisplay.toFixed(2)}` }
                );
                
                // Calculate and display materials cost (fabric + thread)
                const materialsCostTotal = (fabricCost * quantity) + (threadCost * quantity);
                if (materialsCostTotal > 0) {
                    detailsArray.push({ label: 'Materials Cost', value: `₱${materialsCostTotal.toFixed(2)}` });
                    
                    // Show breakdown of materials if available
                    if (fabricCost > 0 && fabric && fabric !== 'N/A' && fabric !== '') {
                        const fabricYards = parseFloat(document.getElementById('customizeFabricYards') ? document.getElementById('customizeFabricYards').value : 0) || 0;
                        if (fabricYards > 0) {
                            detailsArray.push({ 
                                label: '  - Fabric Cost', 
                                value: `₱${(fabricCost * quantity).toFixed(2)} (${fabric.charAt(0).toUpperCase() + fabric.slice(1).replace(/_/g, ' ')}, ${fabricYards} yards)` 
                            });
                        }
                    }
                    if (threadCost > 0) {
                        const threadMetersProvided = parseFloat(document.getElementById('customizeThreadMeters') ? document.getElementById('customizeThreadMeters').value : 0) || 0;
                        if (threadMetersProvided > 0) {
                            const threadColorSel = document.getElementById('customizeThreadColor') ? document.getElementById('customizeThreadColor').value : '';
                            const threadColorOther = document.getElementById('customizeThreadColorOther') ? document.getElementById('customizeThreadColorOther').value : '';
                            const finalThreadColor = threadColorSel === 'other' ? threadColorOther : threadColorSel;
                            detailsArray.push({ 
                                label: '  - Thread Cost', 
                                value: `₱${(threadCost * quantity).toFixed(2)} (${finalThreadColor || 'N/A'}, ${threadMetersProvided}m)` 
                            });
                        }
                    }
                }
                
                if (urgentFee > 0) {
                    detailsArray.push({ label: 'Urgent Fee', value: `₱${urgentFee.toFixed(2)}` });
                }
                
                detailsArray.push(
                    { label: 'Details', value: sizeDetails || 'No measurements provided' },
                    { label: 'Total Cost', value: `₱${finalTotal.toFixed(2)}` }
                );
                
                details.push(...detailsArray);
            } else {
                // Unknown service type
                showAlert('Unknown service type', 'warning');
                return;
            }

            // Display cost details
            displayCostDetails(details);
        } catch (error) {
            console.error('Error calculating cost:', error);
            showAlert('An error occurred while calculating cost. Please check the console for details.', 'danger');
        }
    }

    function displayCostDetails(details) {
        const costDetailsDiv = document.getElementById('costDetails');
        costDetailsDiv.innerHTML = '';

        details.forEach(detail => {
            const costItem = document.createElement('div');
            costItem.className = 'cost-item';
            costItem.innerHTML = `
                <span class="cost-label">${detail.label}:</span>
                <span class="cost-value">${detail.value}</span>
            `;
            costDetailsDiv.appendChild(costItem);
        });

        // Show cost box and action buttons
        document.getElementById('costResultBox').classList.remove('hidden');
        document.getElementById('actionButtons').style.display = 'block';
    }

    // Cancel order function
    function cancelOrder() {
        if (confirm('Are you sure you want to cancel this order?')) {
            // Clear the form
            document.getElementById('estimatorForm').reset();
            selectedRentalProducts = [];
            updateSelectedItemsDisplay();
            // Hide the cost result box
            document.getElementById('costResultBox').classList.add('hidden');
            document.getElementById('actionButtons').style.display = 'none';
        }
    }

    // Create order function
    async function createOrder() {
        const formData = new FormData(document.getElementById('estimatorForm'));
        const data = Object.fromEntries(formData.entries());
        
        // Collect all customize data
        let customizeData = {};
        if (data.service_type === 'customize') {
            // Get product ID from uploaded image if available
            let uploadedProductId = '';
            const customizeProductImage = document.getElementById('customizeProductImage');
            if (customizeProductImage && customizeProductImage.dataset.productId) {
                uploadedProductId = customizeProductImage.dataset.productId;
            }
            
            // Get selected customize product ID from hidden field
            const selectedCustomizeProductId = document.getElementById('selectedCustomizeProductId')?.value || '';
            
            customizeData = {
                type_of_customize: data.type_of_customize,
                customize_urgency: data.customize_urgency,
                customize_category: data.customize_category || '',
                customize_product_id: uploadedProductId || selectedCustomizeProductId || data.customize_product_id || '',
                customize_fabric: data.customize_fabric,
                custom_fabric_name: data.custom_fabric_name || '',
                customize_thread_color: data.customize_thread_color === 'other' ? (data.customize_thread_color_other || '') : (data.customize_thread_color || ''),
                customize_thread_meters: data.customize_thread_meters || '',
                customize_fabric_yards: data.customize_fabric_yards || '',
                uniform_size: data.uniform_size || '',
                provided_materials: (document.getElementById('providedMaterialsSelect')?.value || 'no') === 'yes' ? 'yes' : 'no',
            };
            
            const uniformTypesData = ['polo', 'polo_shirt', 'blouse', 'pants', 'shorts', 'skirt_palda'];
            if (uniformTypesData.includes(data.type_of_customize)) {
                customizeData.customize_type = data.type_of_customize;
                customizeData.customize_quantity = data.customize_quantity || 1;
                customizeData.uniform_button_type = data.uniform_button_type || '';
                customizeData.uniform_buttons_needed = data.uniform_buttons_needed || 0;
                
                // Add pants type if pants is selected
                if (data.type_of_customize === 'pants') {
                    customizeData.pants_type = data.pants_type || 'slacks';
                }
                
                // Collect measurement data - Helper function
                function getMeasurementData(fieldName, customId) {
                    const checkboxes = Array.from(document.querySelectorAll(`input[name="${fieldName}"]:checked`)).map(cb => cb.value);
                    const custom = document.getElementById(customId)?.value || '';
                    return { checkboxes, custom };
                }
                
                if (data.type_of_customize === 'pants') {
                    customizeData.measurements = {
                        length_checkbox: getMeasurementData('uniform_pants_length_checkbox', 'uniformPantsLengthCustom').checkboxes,
                        length_custom: getMeasurementData('uniform_pants_length_checkbox', 'uniformPantsLengthCustom').custom,
                        waist_checkbox: getMeasurementData('uniform_pants_waist_checkbox', 'uniformPantsWaistCustom').checkboxes,
                        waist_custom: getMeasurementData('uniform_pants_waist_checkbox', 'uniformPantsWaistCustom').custom,
                        crotch_checkbox: getMeasurementData('uniform_pants_crotch_checkbox', 'uniformPantsCrotchCustom').checkboxes,
                        crotch_custom: getMeasurementData('uniform_pants_crotch_checkbox', 'uniformPantsCrotchCustom').custom,
                        hips_checkbox: getMeasurementData('uniform_pants_hips_checkbox', 'uniformPantsHipsCustom').checkboxes,
                        hips_custom: getMeasurementData('uniform_pants_hips_checkbox', 'uniformPantsHipsCustom').custom,
                        thigh_checkbox: getMeasurementData('uniform_pants_thigh_checkbox', 'uniformPantsThighCustom').checkboxes,
                        thigh_custom: getMeasurementData('uniform_pants_thigh_checkbox', 'uniformPantsThighCustom').custom,
                        knee_checkbox: getMeasurementData('uniform_pants_knee_checkbox', 'uniformPantsKneeCustom').checkboxes,
                        knee_custom: getMeasurementData('uniform_pants_knee_checkbox', 'uniformPantsKneeCustom').custom,
                        bottom_checkbox: getMeasurementData('uniform_pants_bottom_checkbox', 'uniformPantsBottomCustom').checkboxes,
                        bottom_custom: getMeasurementData('uniform_pants_bottom_checkbox', 'uniformPantsBottomCustom').custom
                    };
                } else if (data.type_of_customize === 'shorts') {
                    customizeData.measurements = {
                        length_checkbox: getMeasurementData('uniform_shorts_length_checkbox', 'uniformShortsLengthCustom').checkboxes,
                        length_custom: getMeasurementData('uniform_shorts_length_checkbox', 'uniformShortsLengthCustom').custom,
                        waist_checkbox: getMeasurementData('uniform_shorts_waist_checkbox', 'uniformShortsWaistCustom').checkboxes,
                        waist_custom: getMeasurementData('uniform_shorts_waist_checkbox', 'uniformShortsWaistCustom').custom,
                        crotch_checkbox: getMeasurementData('uniform_shorts_crotch_checkbox', 'uniformShortsCrotchCustom').checkboxes,
                        crotch_custom: getMeasurementData('uniform_shorts_crotch_checkbox', 'uniformShortsCrotchCustom').custom,
                        hips_checkbox: getMeasurementData('uniform_shorts_hips_checkbox', 'uniformShortsHipsCustom').checkboxes,
                        hips_custom: getMeasurementData('uniform_shorts_hips_checkbox', 'uniformShortsHipsCustom').custom,
                        bottom_checkbox: getMeasurementData('uniform_shorts_bottom_checkbox', 'uniformShortsBottomCustom').checkboxes,
                        bottom_custom: getMeasurementData('uniform_shorts_bottom_checkbox', 'uniformShortsBottomCustom').custom
                    };
                } else if (data.type_of_customize === 'polo' || data.type_of_customize === 'polo_shirt') {
                    customizeData.measurements = {
                        neckline_checkbox: getMeasurementData('uniform_polo_neckline_checkbox', 'uniformPoloNecklineCustom').checkboxes,
                        neckline_custom: getMeasurementData('uniform_polo_neckline_checkbox', 'uniformPoloNecklineCustom').custom,
                        bust_checkbox: getMeasurementData('uniform_polo_bust_checkbox', 'uniformPoloBustCustom').checkboxes,
                        bust_custom: getMeasurementData('uniform_polo_bust_checkbox', 'uniformPoloBustCustom').custom,
                        armhole_checkbox: getMeasurementData('uniform_polo_armhole_checkbox', 'uniformPoloArmholeCustom').checkboxes,
                        armhole_custom: getMeasurementData('uniform_polo_armhole_checkbox', 'uniformPoloArmholeCustom').custom,
                        shoulders_checkbox: getMeasurementData('uniform_polo_shoulders_checkbox', 'uniformPoloShouldersCustom').checkboxes,
                        shoulders_custom: getMeasurementData('uniform_polo_shoulders_checkbox', 'uniformPoloShouldersCustom').custom,
                        waist_checkbox: getMeasurementData('uniform_polo_waist_checkbox', 'uniformPoloWaistCustom').checkboxes,
                        waist_custom: getMeasurementData('uniform_polo_waist_checkbox', 'uniformPoloWaistCustom').custom,
                        sleeve_checkbox: getMeasurementData('uniform_polo_sleeve_checkbox', 'uniformPoloSleeveCustom').checkboxes,
                        sleeve_custom: getMeasurementData('uniform_polo_sleeve_checkbox', 'uniformPoloSleeveCustom').custom,
                        hips_checkbox: getMeasurementData('uniform_polo_hips_checkbox', 'uniformPoloHipsCustom').checkboxes,
                        hips_custom: getMeasurementData('uniform_polo_hips_checkbox', 'uniformPoloHipsCustom').custom,
                        length_checkbox: getMeasurementData('uniform_polo_length_checkbox', 'uniformPoloLengthCustom').checkboxes,
                        length_custom: getMeasurementData('uniform_polo_length_checkbox', 'uniformPoloLengthCustom').custom
                    };
                } else if (data.type_of_customize === 'blouse') {
                    customizeData.measurements = {
                        neckline_checkbox: getMeasurementData('uniform_blouse_neckline_checkbox', 'uniformBlouseNecklineCustom').checkboxes,
                        neckline_custom: getMeasurementData('uniform_blouse_neckline_checkbox', 'uniformBlouseNecklineCustom').custom,
                        bust_checkbox: getMeasurementData('uniform_blouse_bust_checkbox', 'uniformBlouseBustCustom').checkboxes,
                        bust_custom: getMeasurementData('uniform_blouse_bust_checkbox', 'uniformBlouseBustCustom').custom,
                        armhole_checkbox: getMeasurementData('uniform_blouse_armhole_checkbox', 'uniformBlouseArmholeCustom').checkboxes,
                        armhole_custom: getMeasurementData('uniform_blouse_armhole_checkbox', 'uniformBlouseArmholeCustom').custom,
                        shoulders_checkbox: getMeasurementData('uniform_blouse_shoulders_checkbox', 'uniformBlouseShouldersCustom').checkboxes,
                        shoulders_custom: getMeasurementData('uniform_blouse_shoulders_checkbox', 'uniformBlouseShouldersCustom').custom,
                        waist_checkbox: getMeasurementData('uniform_blouse_waist_checkbox', 'uniformBlouseWaistCustom').checkboxes,
                        waist_custom: getMeasurementData('uniform_blouse_waist_checkbox', 'uniformBlouseWaistCustom').custom,
                        sleeve_checkbox: getMeasurementData('uniform_blouse_sleeve_checkbox', 'uniformBlouseSleeveCustom').checkboxes,
                        sleeve_custom: getMeasurementData('uniform_blouse_sleeve_checkbox', 'uniformBlouseSleeveCustom').custom,
                        hips_checkbox: getMeasurementData('uniform_blouse_hips_checkbox', 'uniformBlouseHipsCustom').checkboxes,
                        hips_custom: getMeasurementData('uniform_blouse_hips_checkbox', 'uniformBlouseHipsCustom').custom,
                        length_checkbox: getMeasurementData('uniform_blouse_length_checkbox', 'uniformBlouseLengthCustom').checkboxes,
                        length_custom: getMeasurementData('uniform_blouse_length_checkbox', 'uniformBlouseLengthCustom').custom
                    };
                } else if (data.type_of_customize === 'skirt_palda') {
                    customizeData.measurements = {
                        length_checkbox: getMeasurementData('uniform_skirt_length_checkbox', 'uniformSkirtLengthCustom').checkboxes,
                        length_custom: getMeasurementData('uniform_skirt_length_checkbox', 'uniformSkirtLengthCustom').custom,
                        waist_checkbox: getMeasurementData('uniform_skirt_waist_checkbox', 'uniformSkirtWaistCustom').checkboxes,
                        waist_custom: getMeasurementData('uniform_skirt_waist_checkbox', 'uniformSkirtWaistCustom').custom,
                        hips_checkbox: getMeasurementData('uniform_skirt_hips_checkbox', 'uniformSkirtHipsCustom').checkboxes,
                        hips_custom: getMeasurementData('uniform_skirt_hips_checkbox', 'uniformSkirtHipsCustom').custom,
                        hem_width_checkbox: getMeasurementData('uniform_skirt_hem_width_checkbox', 'uniformSkirtHemWidthCustom').checkboxes,
                        hem_width_custom: getMeasurementData('uniform_skirt_hem_width_checkbox', 'uniformSkirtHemWidthCustom').custom
                    };
                }
            } else if (data.type_of_customize === 'pe') {
                customizeData.pe_type = data.pe_type;
                customizeData.pe_quantity = data.pe_quantity || 1;
                customizeData.pe_garter_cm = data.pe_garter_cm || 0;
                
                if (data.pe_type === 'short') {
                    customizeData.shorts_size = data.pe_shorts_size || '';
                    customizeData.measurements = {
                        waist: data.pe_shorts_waist || '',
                        hips: data.pe_shorts_hips || '',
                        shorts_length: data.pe_shorts_length || ''
                    };
                } else if (data.pe_type === 'pants') {
                    customizeData.pants_size = data.pe_pants_size || '';
                    customizeData.measurements = {
                        waist: data.pe_pants_waist || '',
                        hips: data.pe_pants_hips || '',
                        pants_length: data.pe_pants_length || '',
                        leg_opening: data.pe_pants_leg_opening || '',
                        inseam: data.pe_pants_inseam || '',
                        outseam: data.pe_pants_outseam || ''
                    };
                }
                
                // PE T-shirt measurements
                customizeData.tshirt_measurements = {
                    gender: data.pe_gender || '',
                    size: data.pe_tshirt_size || '',
                    chest_circumference: data.pe_chest_circumference || '',
                    shirt_length: data.pe_shirt_length || '',
                    neck_circumference: data.pe_neck_circumference || '',
                    bust: data.pe_bust || '',
                    armhole: data.pe_armhole || '',
                    shoulder: data.pe_shoulder || '',
                    waist: data.pe_tshirt_waist || ''
                };
            }
        }
        
        // Store order data in sessionStorage for payment page
        const orderData = {
            items: data.service_type === 'rent' ? selectedRentalProducts.map(product => ({
                name: product.name,
                quantity: product.quantity,
                cost: product.price * product.quantity,
                class: product.category
            })) : [{
                name: data.service_type === 'repair' ? data.repair_type : (data.type_of_customize === 'uniform' ? data.customize_type : (data.type_of_customize === 'pe' ? (data.pe_type ? `PE - ${data.pe_type.charAt(0).toUpperCase() + data.pe_type.slice(1)}` : 'PE') : (data.customize_type || 'Customize'))),
                quantity: data.service_type === 'customize' ? (data.type_of_customize === 'uniform' ? (data.customize_quantity || 1) : (data.pe_quantity || 1)) : 1,
                cost: calculateTotalCost(data),
                class: data.service_type === 'repair' ? data.button_class : 'standard'
            }],
            customerName: data.customer_name,
            mobileNumber: data.customer_phone,
            orderType: data.service_type,
            totalCost: calculateTotalCost(data),
            ...customizeData
        };
        
        // Add repair-specific data if it's a repair order
        if (data.service_type === 'repair') {
            orderData.repair_type = data.repair_type || '';
            orderData.repair_urgency = data.repair_urgency || '';
            orderData.sewing_style = data.sewing_style || '';
            
            // Zipper replacement data (only for zipper_replacement)
            if (data.repair_type === 'zipper_replacement') {
                orderData.zipper_provided = data.zipper_provided || 'no';
                // New zipper selection data
                orderData.selected_zipper_id = document.getElementById('selectedZipperId')?.value || '';
                orderData.selected_zipper_inches_used = document.getElementById('selectedZipperInchesUsed')?.value || '';
                // Get thread color and meters from zipper modal
                orderData.thread_color = document.getElementById('selectedThreadColor')?.value || '';
                orderData.thread_color_other = document.getElementById('selectedThreadColorOther')?.value || '';
                orderData.thread_meters = document.getElementById('zipperThreadMetersNeeded')?.value || '';
                // Legacy fields (kept for backward compatibility)
                orderData.zipper_size = data.zipper_size || '';
                orderData.zipper_color = data.zipper_color || '';
                orderData.zipper_type = data.zipper_type || 'normal';
                orderData.zipper_length = data.zipper_length || '';
            }
            
            // Button repair data
            if (data.repair_type === 'buttons') {
                orderData.button_type = data.button_type || '';
                orderData.button_class = data.button_class || '';
                orderData.buttons_provided = data.buttons_provided || 'no';
                // New button selection data
                orderData.selected_button_id = document.getElementById('selectedButtonId')?.value || '';
                orderData.selected_button_quantity_used = document.getElementById('selectedButtonQuantityUsed')?.value || '';
                // Get thread color and meters from button modal
                orderData.thread_color = document.getElementById('selectedThreadColorButtons')?.value || '';
                orderData.thread_color_other = document.getElementById('selectedThreadColorOtherButtons')?.value || '';
                orderData.thread_meters = document.getElementById('buttonThreadMetersNeeded')?.value || '';
            }
            
            // Lock repair data
            if (data.repair_type === 'lock_repair') {
                orderData.selected_lock_id = document.getElementById('selectedLockId')?.value || '';
                orderData.selected_lock_groups_used = document.getElementById('selectedLockGroupsUsed')?.value || '';
                // Get thread color and meters from lock modal
                orderData.thread_color = document.getElementById('selectedThreadColorLocks')?.value || '';
                orderData.thread_color_other = document.getElementById('selectedThreadColorOtherLocks')?.value || '';
                orderData.thread_meters = document.getElementById('locksThreadMetersNeeded')?.value || '';
            }
            
            // Patch repair data
            if (data.repair_type === 'patches') {
                orderData.patch_provided = data.patch_provided || 'no';
                // Get selected patch data
                orderData.selected_patch_id = document.getElementById('selectedPatchId')?.value || '';
                orderData.selected_patch_quantity_used = document.getElementById('selectedPatchQuantityUsed')?.value || '';
                // Get thread color and length from patch section
                orderData.thread_color = document.getElementById('selectedThreadColorPatches')?.value || '';
                orderData.thread_color_other = document.getElementById('selectedThreadColorOtherPatches')?.value || '';
                orderData.thread_length = document.getElementById('selectedPatchThreadLength')?.value || '';
            }
            
            // Bewang repair data
            if (data.repair_type === 'bewang') {
                orderData.selected_garter_id = document.getElementById('selectedGarterId')?.value || '';
                orderData.selected_garter_inches_used = document.getElementById('selectedGarterInchesUsed')?.value || '';
                // Get thread color and meters from garter modal or thread details section
                orderData.thread_color = document.getElementById('selectedThreadColorBewang')?.value || 
                                        document.getElementById('threadColor')?.value || '';
                orderData.thread_color_other = document.getElementById('selectedThreadColorOtherBewang')?.value || 
                                              document.getElementById('threadColorOther')?.value || '';
                orderData.thread_meters = document.getElementById('garterThreadMetersNeeded')?.value || 
                                         document.getElementById('threadMeters')?.value || '';
            }
            
            // Elastic repair data
            if (data.repair_type === 'elastic') {
                orderData.selected_garter_id = document.getElementById('selectedGarterIdElastic')?.value || '';
                orderData.selected_garter_inches_used = document.getElementById('selectedGarterInchesUsedElastic')?.value || '';
                // Get thread color and meters from garter modal or thread details section
                orderData.thread_color = document.getElementById('selectedThreadColorElastic')?.value || 
                                        document.getElementById('threadColor')?.value || '';
                orderData.thread_color_other = document.getElementById('selectedThreadColorOtherElastic')?.value || 
                                              document.getElementById('threadColorOther')?.value || '';
                orderData.thread_meters = document.getElementById('garterThreadMetersNeeded')?.value || 
                                         document.getElementById('threadMeters')?.value || '';
            }
            
            // Thread details for specific repair types - use global directly
            if (window.threadRequiredTypes && window.threadRequiredTypes.includes(data.repair_type)) {
                orderData.thread_color = data.thread_color || '';
                orderData.thread_meters = data.thread_meters || '';
            }
        }
        
        // Check thread availability for patches BEFORE checking materials
        if (data.service_type === 'repair' && data.repair_type === 'patches') {
            const patchThreadColor = document.getElementById('patchThreadColor')?.value || '';
            const patchThreadColorOther = document.getElementById('patchThreadColorOther')?.value || '';
            
            if (patchThreadColor) {
                const finalThreadColor = patchThreadColor === 'other' ? patchThreadColorOther.trim() : patchThreadColor;
                
                if (finalThreadColor) {
                    try {
                        const threadAvailability = await checkThreadAvailability(finalThreadColor);
                        
                        if (!threadAvailability.found) {
                            showAlert(`Thread color "${finalThreadColor}" not found in materials. Out of stock, please choose other color.`, 'danger');
                            return;
                        }
                        
                        if (!threadAvailability.available || threadAvailability.quantity <= 0) {
                            showAlert(`Thread color "${finalThreadColor}" is out of stock. Please choose other color.`, 'danger');
                            return;
                        }
                    } catch (error) {
                        console.error('Error checking thread availability for patches:', error);
                        // Continue if check fails (will be validated on backend)
                    }
                }
            }
        }
        
        // Check material availability BEFORE creating order (for repair and customize)
        if (data.service_type === 'repair' || data.service_type === 'customize') {
            // Show loading indicator
            const loadingAlert = showAlert('Checking material availability...', 'info');
            
            // Check material availability via API (works offline - queues if offline)
            fetch('/api/orders/check-materials/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(orderData)
            })
            .then(response => response.json())
            .then(result => {
                // Remove loading alert
                document.querySelector('.alert-custom')?.remove();
                
                // Handle offline queued response
                if (result.queued && result.offline) {
                    console.log('[CreateOrder] Request queued offline, proceeding with order');
                    // Store order data for offline processing
                    if (window.offlineDB) {
                        window.offlineDB.saveOrder({
                            ...orderData,
                            sync_status: 'pending',
                            created_at: new Date().toISOString(),
                            order_type: orderData.orderType,
                            status: 'pending'
                        }).then(() => {
                            console.log('[CreateOrder] Order saved offline');
                            showAlert('Order created offline. It will be synced when connection is restored.', 'info');
                            sessionStorage.setItem('currentOrder', JSON.stringify(orderData));
                            // Proceed to payment page even offline (it will queue too)
                            window.location.href = '{% url "payment_method" %}';
                        });
                    } else {
                        sessionStorage.setItem('currentOrder', JSON.stringify(orderData));
                        window.location.href = '{% url "payment_method" %}';
                    }
                    return;
                }
                
                if (result.available) {
                    // Materials are available, proceed with order
                    sessionStorage.setItem('currentOrder', JSON.stringify(orderData));
                    window.location.href = '{% url "payment_method" %}';
                } else {
                    // Materials are unavailable, show error message
                    let errorMessage = result.message || 'Materials are unavailable';
                    
                    if (result.unavailable_materials && result.unavailable_materials.length > 0) {
                        errorMessage += '\n\nUnavailable Materials:';
                        result.unavailable_materials.forEach(material => {
                            errorMessage += `\n- ${material.material}: ${material.message || `Need ${material.needed}, Available ${material.available}`}`;
                        });
                    } else if (result.error) {
                        errorMessage = result.error;
                    }
                    
                    errorMessage += '\n\nPlease use other available materials and try again.';
                    
                    alert(errorMessage);
                    showAlert('Materials are unavailable. Please check the materials page and select available materials.', 'danger');
                }
            })
            .catch(error => {
                // Remove loading alert
                document.querySelector('.alert-custom')?.remove();
                console.error('Error checking materials:', error);
                
                // If offline, queue the order and proceed
                if (!navigator.onLine) {
                    console.log('[CreateOrder] Offline detected, queueing order');
                    if (window.offlineDB) {
                        window.offlineDB.saveOrder({
                            ...orderData,
                            sync_status: 'pending',
                            created_at: new Date().toISOString(),
                            order_type: orderData.orderType,
                            status: 'pending'
                        }).then(() => {
                            showAlert('Order created offline. It will be synced when connection is restored.', 'info');
                            sessionStorage.setItem('currentOrder', JSON.stringify(orderData));
                            window.location.href = '{% url "payment_method" %}';
                        });
                    } else {
                        sessionStorage.setItem('currentOrder', JSON.stringify(orderData));
                        window.location.href = '{% url "payment_method" %}';
                    }
                } else {
                    alert('Error checking material availability. Please try again.');
                    showAlert('Error checking material availability. Please try again.', 'danger');
                }
            });
        } else {
            // For rental orders, no material check needed
            sessionStorage.setItem('currentOrder', JSON.stringify(orderData));
            window.location.href = '{% url "payment_method" %}';
        }
    }
    
    // Material Pricing Calculation Functions
    function calculateZipperPrice(zipperName, inches) {
        if (!inches || inches <= 0) return 0;
        
        const nameLower = zipperName.toLowerCase();
        let zipperType = null;
        
        // Determine zipper type from name
        if (nameLower.includes('magic')) {
            zipperType = materialPricing.zippers.magic;
        } else if (nameLower.includes('plastic')) {
            zipperType = materialPricing.zippers.plastic;
        } else if (nameLower.includes('tanso')) {
            zipperType = materialPricing.zippers.tanso;
        } else {
            // Default to plastic if type not found
            zipperType = materialPricing.zippers.plastic;
        }
        
        if (!zipperType) return 0;
        
        // Calculate price: base price for first 5 inches, then per inch for additional
        if (inches <= zipperType.baseInches) {
            return zipperType.basePrice;
        } else {
            const additionalInches = inches - zipperType.baseInches;
            return zipperType.basePrice + (additionalInches * zipperType.perInch);
        }
    }
    
    function calculateThreadPrice(threadName, meters) {
        if (!meters || meters <= 0) return 0;
        
        const nameLower = threadName.toLowerCase();
        let threadType = null;
        
        // Determine thread type from name
        if (nameLower.includes('spun') && nameLower.includes('polyester')) {
            threadType = materialPricing.thread.spun_polyester;
        } else if (nameLower.includes('apple') && nameLower.includes('rugged')) {
            threadType = materialPricing.thread.apple_rugged;
        } else if (nameLower.includes('trident') && nameLower.includes('polyester')) {
            threadType = materialPricing.thread.trident_polyester;
        } else if (nameLower.includes('apple') && !nameLower.includes('rugged')) {
            threadType = materialPricing.thread.apple;
        } else {
            // Default to spun polyester if type not found
            threadType = materialPricing.thread.spun_polyester;
        }
        
        if (!threadType) return 0;
        
        // Calculate price: base price for first 500 meters, then per 100m for additional
        if (meters <= threadType.baseMeters) {
            return threadType.basePrice;
        } else {
            const additionalMeters = meters - threadType.baseMeters;
            const additional100mUnits = Math.ceil(additionalMeters / 100);
            return threadType.basePrice + (additional100mUnits * threadType.per100m);
        }
    }
    
    function calculateButtonPrice(buttonName, quantity) {
        if (!quantity || quantity <= 0) return 0;
        
        const nameLower = buttonName.toLowerCase();
        let buttonConfig = null;
        
        // Determine button type and class from name
        if (nameLower.includes('4 holes') || nameLower.includes('four holes')) {
            if (nameLower.includes('plastic')) {
                buttonConfig = materialPricing.buttons.four_holes.plastic;
            } else if (nameLower.includes('metal')) {
                buttonConfig = materialPricing.buttons.four_holes.metal;
            } else {
                // Default to plastic
                buttonConfig = materialPricing.buttons.four_holes.plastic;
            }
        } else if (nameLower.includes('2 holes') || nameLower.includes('two holes')) {
            if (nameLower.includes('plastic')) {
                buttonConfig = materialPricing.buttons.two_holes.plastic;
            } else if (nameLower.includes('metal')) {
                buttonConfig = materialPricing.buttons.two_holes.metal;
            } else {
                // Default to plastic
                buttonConfig = materialPricing.buttons.two_holes.plastic;
            }
        } else if (nameLower.includes('levis') || nameLower.includes('wrangler') || nameLower.includes('lee') || nameLower.includes('special')) {
            buttonConfig = materialPricing.buttons.special;
        } else {
            // Default to 4 holes plastic
            buttonConfig = materialPricing.buttons.four_holes.plastic;
        }
        
        if (!buttonConfig) return 0;
        
        // Calculate price: base price for first group (8 pieces), then per piece for additional
        if (quantity <= buttonConfig.groupSize) {
            return buttonConfig.basePrice;
        } else {
            const additionalPieces = quantity - buttonConfig.groupSize;
            return buttonConfig.basePrice + (additionalPieces * buttonConfig.perPiece);
        }
    }
    
    function calculateLockPrice(groups) {
        if (!groups || groups <= 0) return 0;
        return groups * materialPricing.locks.basePrice;
    }
    
    function calculateGarterPrice(inches) {
        if (!inches || inches <= 0) return 0;
        return inches * materialPricing.garter.perInch;
    }
    
    function calculateFabricPrice(fabricType, yards, useSellingPrice = true) {
        if (!yards || yards <= 0) return 0;
        if (!fabricType) return 0;
        
        const fabricLower = fabricType.toLowerCase().replace(/\s+/g, '_');
        let fabricConfig = null;
        
        // Map fabric types to pricing config
        if (fabricLower.includes('cotton') && fabricLower.includes('spandex')) {
            fabricConfig = materialPricing.fabric.cotton_spandex;
        } else if (fabricLower === 'cotton' || fabricLower.includes('cotton')) {
            fabricConfig = materialPricing.fabric.cotton;
        } else if (fabricLower === 'linen' || fabricLower.includes('linen')) {
            fabricConfig = materialPricing.fabric.linen;
        } else if (fabricLower === 'denim' || fabricLower.includes('denim')) {
            fabricConfig = materialPricing.fabric.denim;
        } else if (fabricLower === 'corduroy' || fabricLower.includes('corduroy')) {
            fabricConfig = materialPricing.fabric.corduroy;
        } else if (fabricLower === 'wool' || fabricLower.includes('wool')) {
            fabricConfig = materialPricing.fabric.wool;
        } else {
            // Default to cotton if type not found
            fabricConfig = materialPricing.fabric.cotton;
        }
        
        if (!fabricConfig) return 0;
        
        // Use selling price (for customer) or cost price (for internal)
        const pricePerYard = useSellingPrice ? fabricConfig.sellingPrice : fabricConfig.costPrice;
        return yards * pricePerYard;
    }

    // Helper function to calculate total cost
    function calculateTotalCost(data) {
        let totalCost = 0;
        
        if (data.service_type === 'rent') {
            totalCost = selectedRentalProducts.reduce((sum, product) => sum + (product.price * product.quantity), 0);
        } else if (data.service_type === 'repair') {
            // Pricing for new repair types
            if (data.repair_type === 'putol') {
                totalCost = pricing.repair.putol || pricing.repair.general_repair || 0;
            } else if (data.repair_type === 'baston') {
                totalCost = pricing.repair.baston || pricing.repair.general_repair || 0;
            } else if (data.repair_type === 'suklot') {
                totalCost = pricing.repair.suklot || pricing.repair.general_repair || 0;
            } else if (data.repair_type === 'baston_suklot') {
                totalCost = pricing.repair.baston_suklot || pricing.repair.general_repair || 0;
            } else if (data.repair_type === 'baston_putol') {
                totalCost = pricing.repair.baston_putol || pricing.repair.general_repair || 0;
            } else if (data.repair_type === 'ambel') {
                totalCost = pricing.repair.ambel || pricing.repair.general_repair || 0;
            } else if (data.repair_type === 'pasada') {
                totalCost = pricing.repair.pasada || pricing.repair.general_repair || 0;
            } else if (data.repair_type === 'zipper_replacement') {
                // Labor cost is same whether zipper is provided or not
                let laborCost = pricing.repair.zipper_replacement || 90;
                let materialsCost = 0;
                
                const provided = data.zipper_provided || 'no';
                if (provided === 'no') {
                    // Calculate zipper price based on selected zipper and inches (materials cost)
                    const zipperId = data.selected_zipper_id;
                    const zipperInches = parseFloat(data.selected_zipper_inches_used) || 0;
                    
                    if (zipperId && zipperInches > 0) {
                        // Find zipper name from selected zipper
                        const selectedZipper = allZippers.find(z => z.id == zipperId);
                        if (selectedZipper) {
                            materialsCost = calculateZipperPrice(selectedZipper.name, zipperInches);
                        }
                    }
                }
                
                totalCost = laborCost + materialsCost;
            } else if (data.repair_type === 'bewang') {
                // Labor cost for bewang
                let laborCost = pricing.repair.bewang || 250;
                // Calculate garter price if garter is selected (materials cost)
                const garterId = data.selected_garter_id;
                const garterInches = parseFloat(data.selected_garter_inches_used) || 0;
                
                let garterCost = 0;
                if (garterId && garterInches > 0) {
                    garterCost = calculateGarterPrice(garterInches);
                }
                
                // Total = labor + materials
                totalCost = laborCost + garterCost;
            } else if (data.repair_type === 'buttons') {
                // Labor cost is same whether buttons are provided or not
                let laborCost = pricing.repair.buttons || 90;
                let materialsCost = 0;
                
                const provided = data.buttons_provided || 'no';
                if (provided === 'no') {
                    // Calculate button price based on selected button and quantity (materials cost)
                    const buttonId = data.selected_button_id;
                    const buttonQuantity = parseInt(data.selected_button_quantity_used) || 0;
                    
                    if (buttonId && buttonQuantity > 0) {
                        // Find button name from selected button
                        const selectedButton = allButtons.find(b => b.id == buttonId);
                        if (selectedButton) {
                            materialsCost = calculateButtonPrice(selectedButton.name, buttonQuantity);
                        }
                    }
                }
                
                totalCost = laborCost + materialsCost;
            } else if (data.repair_type === 'lock_repair') {
                // Labor cost for lock repair
                let laborCost = pricing.repair.lock_repair || 90;
                // Calculate lock price if lock is selected (materials cost)
                const lockId = data.selected_lock_id;
                const lockGroups = parseInt(data.selected_lock_groups_used) || 0;
                
                let lockCost = 0;
                if (lockId && lockGroups > 0) {
                    lockCost = calculateLockPrice(lockGroups);
                }
                
                // Total = labor + materials
                totalCost = laborCost + lockCost;
            } else if (data.repair_type === 'elastic') {
                // Labor cost for elastic repair
                let laborCost = pricing.repair.elastic || 150;
                // Calculate garter price if garter is selected (materials cost)
                const garterId = data.selected_garter_id;
                const garterInches = parseFloat(data.selected_garter_inches_used) || 0;
                
                let garterCost = 0;
                if (garterId && garterInches > 0) {
                    garterCost = calculateGarterPrice(garterInches);
                }
                
                // Total = labor + materials
                totalCost = laborCost + garterCost;
            } else if (data.repair_type === 'patches') {
                // Labor cost is same whether patch is provided or not
                let laborCost = pricing.repair.patches || 90;
                let materialsCost = 0;
                
                const patchProvided = data.patch_provided || 'no';
                if (patchProvided === 'no') {
                    // Calculate patch price based on selected patch and quantity (materials cost)
                    const patchId = data.selected_patch_id;
                    const patchQuantity = parseInt(data.selected_patch_quantity_used) || 0;
                    
                    if (patchId && patchQuantity > 0 && allPatches && allPatches.length > 0) {
                        const selectedPatch = allPatches.find(p => p.id == patchId);
                        if (selectedPatch) {
                            materialsCost = parseFloat(selectedPatch.price) * patchQuantity;
                        }
                    }
                }
                
                // Add thread cost if thread length is provided (materials cost)
                const patchThreadLength = parseFloat(data.thread_length || data.selected_patch_thread_length) || 0;
                if (patchThreadLength > 0) {
                    const patchThreadColor = data.thread_color || data.selected_thread_color_patches || '';
                    const patchThreadColorOther = data.thread_color_other || data.selected_thread_color_other_patches || '';
                    const finalThreadColor = patchThreadColor === 'other' ? patchThreadColorOther : patchThreadColor;
                    const threadName = finalThreadColor ? `Thread ${finalThreadColor}` : 'Spun Polyester Thread';
                    materialsCost += calculateThreadPrice(threadName, patchThreadLength);
                }
                
                totalCost = laborCost + materialsCost;
            } else if (data.repair_type === 'general_tshirt_repair') {
                totalCost = pricing.repair.general_tshirt_repair || 150;
            } else if (data.repair_type === 'general_repair') {
                totalCost = pricing.repair.general_repair || 450;
            // Note: lock_repair is already handled above, this is a duplicate - keeping for compatibility
            } else {
                // Default to general repair pricing if repair type not found
                totalCost = pricing.repair.general_repair || 450;
            }
            
            // Add thread cost if thread is used (for thread-requiring repairs) - use global directly
            if (window.threadRequiredTypes && window.threadRequiredTypes.includes(data.repair_type)) {
                const threadMeters = parseFloat(data.thread_meters || data.threadMeters) || 0;
                if (threadMeters > 0) {
                    const threadColor = data.thread_color || data.threadColor || '';
                    // Use thread color or default thread type
                    const threadName = threadColor ? `Thread ${threadColor}` : 'Spun Polyester Thread';
                    const threadCost = calculateThreadPrice(threadName, threadMeters);
                    totalCost += threadCost;
                }
            }
            
            if (data.repair_urgency === 'urgent') {
                totalCost += 20; // Add 20 pesos urgent fee
            }
        } else if (data.service_type === 'customize') {
            const typeOfCustomize = data.type_of_customize;
            const uniformTypes = ['polo', 'polo_shirt', 'blouse', 'pants', 'shorts', 'skirt_palda'];
            let baseCost = 0;
            let quantity = parseInt(data.customize_quantity || data.pe_quantity || 1);
            const providedMaterials = data.provided_materials === 'yes' || data.provided_materials === true;
            
            if (uniformTypes.includes(typeOfCustomize)) {
                const customizeType = typeOfCustomize;
                
                // Check if materials are provided
                if (providedMaterials) {
                    // Materials provided pricing
                    if (customizeType === 'polo' || customizeType === 'polo_shirt') {
                        baseCost = pricing.customize.polo_materials_provided;
                    } else if (customizeType === 'blouse') {
                        baseCost = pricing.customize.blouse_materials_provided;
                    } else if (customizeType === 'pants') {
                        const pantsType = data.pants_type || 'slacks';
                        baseCost = pricing.customize.pants_labor_only[pantsType] || pricing.customize.pants_materials_provided;
                    } else if (customizeType === 'shorts') {
                        baseCost = pricing.customize.shorts_materials_provided || pricing.customize.polo_materials_provided;
                    } else if (customizeType === 'skirt_palda') {
                        baseCost = pricing.customize.palda_materials_provided;
                    }
                } else {
                    // Top Style Tela & Labor pricing
                    if (customizeType === 'polo' || customizeType === 'polo_shirt') {
                        baseCost = pricing.customize.polo_tela_labor;
                    } else if (customizeType === 'blouse') {
                        baseCost = pricing.customize.blouse_tela_labor;
                    } else if (customizeType === 'pants') {
                        const pantsType = data.pants_type || 'slacks';
                        baseCost = pricing.customize.pants_tela_labor[pantsType] || pricing.customize.pants_materials_provided;
                    } else if (customizeType === 'shorts') {
                        baseCost = pricing.customize.shorts_tela_labor || pricing.customize.polo_tela_labor;
                    } else if (customizeType === 'skirt_palda') {
                        baseCost = pricing.customize.palda_tela_labor;
                    }
                    
                    // Add fabric cost if fabric is selected and yards are specified (only when Top Style provides materials)
                    const fabricType = data.customize_fabric || data.fabric || '';
                    let fabricTypeToUse = fabricType;
                    
                    // Handle custom fabric name if "add_another" is selected
                    if (fabricType === 'add_another') {
                        fabricTypeToUse = data.custom_fabric_name || '';
                    }
                    
                    const fabricYards = parseFloat(data.customize_fabric_yards || data.fabric_yards || 0) || 0;
                    let fabricCostTotal = 0;
                    
                    if (fabricTypeToUse && fabricTypeToUse !== 'N/A' && fabricTypeToUse !== '' && fabricYards > 0) {
                        // Use selling price when Top Style provides the fabric
                        const fabricCost = calculateFabricPrice(fabricTypeToUse, fabricYards, true);
                        fabricCostTotal = fabricCost * quantity;
                    }

                    let threadCostTotal = 0;
                    const threadMetersProvided = parseFloat(data.customize_thread_meters || 0) || 0;
                    if (threadMetersProvided > 0) {
                        const threadColorSel = data.customize_thread_color || '';
                        const threadName = threadColorSel ? `Thread ${threadColorSel}` : 'Spun Polyester Thread';
                        const threadCost = calculateThreadPrice(threadName, threadMetersProvided);
                        threadCostTotal = threadCost * quantity;
                    }
                    
                    // Add fabric and thread costs to base cost
                    totalCost = (baseCost * quantity) + fabricCostTotal + threadCostTotal;
                }
            } else if (typeOfCustomize === 'pe') {
                // PE: Labor based on type (pants/shorts)
                if (data.pe_type === 'pants') {
                    baseCost = pricing.customize.pe_pants_labor || pricing.customize.pe_labor_only;
                } else if (data.pe_type === 'short' || data.pe_type === 'shorts') {
                    baseCost = pricing.customize.pe_shorts_labor || pricing.customize.pe_labor_only;
                } else {
                    baseCost = pricing.customize.pe_labor_only;
                }
                totalCost = baseCost * quantity;
            }
            
            // Only set totalCost if it wasn't already calculated above
            if (totalCost === 0 && baseCost > 0) {
                totalCost = baseCost * quantity;
            }
            
            if (data.customize_urgency === 'yes') {
                totalCost += pricing.customize.urgent_surcharge * quantity;
            }
        }
        
        return totalCost;
    }

    // Print estimate function
    function printEstimate() {
        window.print();
    }

    // Enhanced form validation
    function validateForm() {
        const serviceType = document.getElementById('serviceType').value;
        const customerName = document.getElementById('customerName').value;
        const customerPhone = document.getElementById('customerPhone').value;
        
        let isValid = true;
        let errorMessage = '';
        
        if (!serviceType) {
            errorMessage = 'Please select a service type';
            isValid = false;
        } else if (!customerName || customerName.trim() === '') {
            errorMessage = 'Please enter customer name';
            isValid = false;
        } else if (!customerPhone || customerPhone.trim() === '') {
            errorMessage = 'Please enter customer phone number';
            isValid = false;
        }
        
        if (!isValid) {
            showAlert(errorMessage, 'warning');
        }
        
        return isValid;
    }

    // Add real-time validation - ensure DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        const customerPhone = document.getElementById('customerPhone');
        const customerEmail = document.getElementById('customerEmail');
        
        if (customerPhone) {
            customerPhone.addEventListener('input', function() {
                const phone = this.value;
                const phoneRegex = /^[0-9+\-\s()]+$/;
                
                if (phone && !phoneRegex.test(phone)) {
                    this.classList.add('is-invalid');
                    showAlert('Please enter a valid phone number format', 'warning');
                } else {
                    this.classList.remove('is-invalid');
                }
            });
        }
        
        if (customerEmail) {
            customerEmail.addEventListener('input', function() {
                const email = this.value;
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                
                if (email && !emailRegex.test(email)) {
                    this.classList.add('is-invalid');
                    showAlert('Please enter a valid email address', 'warning');
                } else {
                    this.classList.remove('is-invalid');
                }
            });
        }
    });
</script>
{% endblock %}

