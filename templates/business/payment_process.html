{% extends 'business/base.html' %}

{% block title %}Payment Process - TopStyle Business{% endblock %}
{% block page_title %}Payment Process{% endblock %}

{% block extra_css %}
<style>
    .payment-process-container {
        background-color: #f8f9fa;
        min-height: 100vh;
        padding: 5px;
    }
    
    .payment-display {
        background: white;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        max-width: 1200px;
        margin: 0 auto;
        border: 2px solid #e9ecef;
    }
    
    /* Two Column Layout */
    .payment-columns {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 10px;
    }
    
    .left-column, .right-column {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    @media (max-width: 992px) {
        .payment-columns {
            grid-template-columns: 1fr;
        }
    }
    
    .payment-header {
        text-align: center;
        margin-bottom: 8px;
        padding-bottom: 6px;
        border-bottom: 2px solid #1e3a8a;
    }
    
    .payment-header h2 {
        color: #1e3a8a;
        font-weight: bold;
        margin-bottom: 2px;
        font-size: 1.2rem;
    }
    
    .payment-header p {
        color: #666;
        font-size: 0.85rem;
        margin-bottom: 0;
    }
    
    .order-amount-container {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .order-details {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 12px;
        flex: 1;
    }
    
    .amount-display {
        background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
        color: white !important;
        border-radius: 8px;
        padding: 12px;
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(30, 58, 138, 0.3);
    }
    
    .amount-label {
        font-size: 0.75rem;
        margin-bottom: 4px;
        opacity: 0.9;
        color: white !important;
    }
    
    .amount-value {
        font-size: 1.2rem;
        font-weight: bold;
        margin-bottom: 0;
        color: white !important;
    }
    
    .payment-input-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 12px;
    }
    
    .payment-input-section h4 {
        color: #333;
        margin-bottom: 8px;
        text-align: center;
        font-size: 0.95rem;
    }
    
    .amount-input-group {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 10px;
    }
    
    .peso-symbol {
        font-size: 1.3rem;
        font-weight: bold;
        color: #1e3a8a;
        margin-right: 8px;
    }
    
    .amount-input {
        font-size: 1.3rem;
        font-weight: bold;
        text-align: center;
        border: 2px solid #1e3a8a;
        border-radius: 8px;
        padding: 8px 12px;
        width: 150px;
        color: #1e3a8a;
        background: white;
    }
    
    .amount-input:focus {
        outline: none;
        border-color: #1e40af;
        box-shadow: 0 0 0 0.2rem rgba(30, 58, 138, 0.25);
    }
    
    .quick-amount-buttons {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        margin-bottom: 10px;
    }
    
    .quick-amount-btn {
        background: white;
        border: 2px solid #1e3a8a;
        color: #1e3a8a;
        padding: 6px 8px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .quick-amount-btn:hover {
        background: #1e3a8a;
        color: white;
    }
    
    .payment-summary {
        background: white;
        border-radius: 8px;
        padding: 10px;
        border: 1px solid #e9ecef;
    }
    
    .summary-row {
        display: flex;
        justify-content: space-between;
        padding: 5px 0;
        border-bottom: 1px solid #f0f0f0;
        font-size: 0.9rem;
    }
    
    .summary-row:last-child {
        border-bottom: none;
        font-weight: bold;
        font-size: 1rem;
        color: #1e3a8a;
        margin-top: 5px;
        padding-top: 8px;
        border-top: 2px solid #1e3a8a;
    }
    
    .summary-label {
        color: #666;
        font-size: 0.9rem;
    }
    
    .summary-value {
        font-weight: 600;
        font-size: 0.9rem;
    }
    
    .change-display {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border-radius: 8px;
        padding: 10px;
        text-align: center;
        display: none;
    }
    
    .change-display.show {
        display: block;
        animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .change-label {
        font-size: 0.9rem;
        margin-bottom: 3px;
        opacity: 0.9;
    }
    
    .change-value {
        font-size: 1.3rem;
        font-weight: bold;
    }
    
    .action-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
    }
    
    .btn-clear {
        background: #dc3545;
        border: none;
        color: white;
        padding: 8px 20px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
        flex: 1;
        max-width: 120px;
    }
    
    .btn-clear:hover {
        background: #c82333;
        transform: translateY(-2px);
    }
    
    .btn-process {
        background: #28a745;
        border: none;
        color: white;
        padding: 8px 20px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
        flex: 1;
        max-width: 160px;
    }
    
    .btn-process:hover {
        background: #218838;
        transform: translateY(-2px);
    }
    
    .btn-process:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
    }
    
    .order-details h5 {
        color: #333;
        margin-bottom: 8px;
        font-size: 0.95rem;
        font-weight: 600;
    }
    
    .detail-row {
        display: flex;
        justify-content: space-between;
        padding: 3px 0;
        color: #666;
        font-size: 0.8rem;
    }
    
    .custom-amount-section {
        margin-top: 8px;
        padding: 8px;
        background: #fff3cd;
        border: 2px solid #ffc107;
        border-radius: 6px;
        text-align: center;
    }
    
    .custom-amount-note {
        color: #856404;
        font-size: 0.9rem;
        margin-bottom: 8px;
        font-weight: 500;
    }
    
    .custom-amount-btn {
        background: #ffc107;
        border: none;
        color: #856404;
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .custom-amount-btn:hover {
        background: #ffca2c;
        transform: translateY(-2px);
        box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
    }
    
    .amount-input.highlight {
        border-color: #ffc107;
        box-shadow: 0 0 0 0.3rem rgba(255, 193, 7, 0.25);
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { box-shadow: 0 0 0 0.3rem rgba(255, 193, 7, 0.25); }
        50% { box-shadow: 0 0 0 0.5rem rgba(255, 193, 7, 0.4); }
    }
    
    /* Downpayment Styles */
    .downpayment-toggle-section {
        background: #e3f2fd;
        border: 2px solid #1e88e5;
        border-radius: 8px;
        padding: 12px;
        text-align: center;
    }
    
    .downpayment-toggle-section.disabled {
        background: #f5f5f5;
        border-color: #ccc;
        opacity: 0.6;
    }
    
    .downpayment-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin-bottom: 8px;
    }
    
    .downpayment-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
    }
    
    .downpayment-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .downpayment-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 24px;
    }
    
    .downpayment-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }
    
    input:checked + .downpayment-slider {
        background-color: #1e88e5;
    }
    
    input:checked + .downpayment-slider:before {
        transform: translateX(26px);
    }
    
    .downpayment-toggle label {
        font-weight: 600;
        color: #1e3a8a;
        margin: 0;
        font-size: 0.95rem;
    }
    
    .downpayment-info {
        background: white;
        border-radius: 6px;
        padding: 8px;
        margin-top: 8px;
        display: none;
    }
    
    .downpayment-info.show {
        display: block;
    }
    
    .downpayment-detail {
        display: flex;
        justify-content: space-between;
        padding: 4px 0;
        font-size: 0.85rem;
    }
    
    .downpayment-detail.minimum {
        font-weight: bold;
        color: #d32f2f;
        border-top: 2px solid #e3f2fd;
        padding-top: 8px;
        margin-top: 4px;
    }
    
    .downpayment-note {
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 6px;
        padding: 8px;
        margin-top: 8px;
        font-size: 0.8rem;
        color: #856404;
        display: none;
    }
    
    .downpayment-note.show {
        display: block;
    }
    
    .downpayment-warning {
        background: #f8d7da;
        border: 2px solid #dc3545;
        color: #721c24;
        border-radius: 6px;
        padding: 10px;
        margin-top: 10px;
        font-size: 0.85rem;
        font-weight: 600;
        display: none;
        text-align: center;
    }
    
    .downpayment-warning.show {
        display: block;
        animation: shake 0.5s;
    }
    
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-10px); }
        75% { transform: translateX(10px); }
    }
</style>
{% endblock %}

{% block content %}
<div class="payment-process-container">
    <div class="payment-display">
        <!-- Header -->
        <div class="payment-header">
            <h2><i class="fas fa-credit-card me-2"></i>Payment Process</h2>
            <p>Enter the amount received from customer</p>
        </div>
        
        <!-- Two Column Layout -->
        <div class="payment-columns">
            <!-- Left Column -->
            <div class="left-column">
                <!-- Order Details and Amount Container -->
                <div class="order-amount-container">
                    <!-- Order Details -->
                    <div class="order-details">
                        <h5><i class="fas fa-receipt me-2"></i>Order Details</h5>
                        <div id="orderDetails">
                            <!-- Order details will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Amount to Pay Display -->
                    <div class="amount-display">
                        <div class="amount-label" id="amountLabel">Amount to Pay</div>
                        <div class="amount-value" id="amountToPay">₱0.00</div>
                    </div>
                </div>
                
                <!-- Downpayment Toggle Section (Only for Repair and Customize) -->
                <div class="downpayment-toggle-section" id="downpaymentSection" style="display: none;">
            <div class="downpayment-toggle">
                <label class="downpayment-switch">
                    <input type="checkbox" id="downpaymentToggle" onchange="toggleDownpayment()">
                    <span class="downpayment-slider"></span>
                </label>
                <label for="downpaymentToggle">Accept Downpayment (Minimum 75%)</label>
            </div>
            
            <div class="downpayment-info" id="downpaymentInfo">
                <div class="downpayment-detail">
                    <span>Total Amount:</span>
                    <span id="downpaymentTotal">₱0.00</span>
                </div>
                <div class="downpayment-detail">
                    <span>Minimum Required (75%):</span>
                    <span id="downpaymentMinimum">₱0.00</span>
                </div>
                <div class="downpayment-detail">
                    <span>Remaining Balance:</span>
                    <span id="downpaymentBalance">₱0.00</span>
                </div>
                <div class="downpayment-detail minimum">
                    <span>Minimum to Proceed:</span>
                    <span id="downpaymentMinDisplay">₱0.00</span>
                </div>
            </div>
            
            <div class="downpayment-note" id="downpaymentNote">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Note:</strong> Customer must pay at least 75% of the total amount to proceed with the order.
            </div>
        </div>
        
                <div class="downpayment-warning" id="downpaymentWarning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Insufficient downpayment! Minimum required is <span id="warningMinAmount">₱0.00</span> (75% of total)
                </div>
            </div>
            <!-- End Left Column -->
            
            <!-- Right Column -->
            <div class="right-column">
                <!-- Payment Input Section -->
        <div class="payment-input-section">
            <h4><i class="fas fa-money-bill-wave me-2"></i>Enter Amount Received</h4>
            
            <div class="amount-input-group">
                <span class="peso-symbol">₱</span>
                <input type="number" class="amount-input" id="amountReceived" placeholder="0.00" step="0.01" min="0">
            </div>
            
            <!-- Quick Amount Buttons -->
            <div class="quick-amount-buttons" id="quickAmountButtons">
                <button class="quick-amount-btn" onclick="setQuickAmount(100)">₱100</button>
                <button class="quick-amount-btn" onclick="setQuickAmount(200)">₱200</button>
                <button class="quick-amount-btn" onclick="setQuickAmount(500)">₱500</button>
                <button class="quick-amount-btn" onclick="setQuickAmount(1000)">₱1,000</button>
                <button class="quick-amount-btn" onclick="setQuickAmount(2000)">₱2,000</button>
                <button class="quick-amount-btn" onclick="setQuickAmount(5000)">₱5,000</button>
            </div>
            
            <!-- Custom Amount Section (shown when amount > 5000) -->
            <div class="custom-amount-section" id="customAmountSection" style="display: none;">
                <div class="custom-amount-note">
                    <i class="fas fa-info-circle me-2"></i>
                    <span>Amount is higher than ₱5,000. Please enter the exact amount received.</span>
                </div>
                <button class="custom-amount-btn" onclick="focusAmountInput()">
                    <i class="fas fa-keyboard me-2"></i>
                    Enter Custom Amount
                </button>
            </div>
            
            <!-- Additional Quick Buttons for High Amounts -->
            <div class="quick-amount-buttons" id="highAmountButtons" style="display: none;">
                <button class="quick-amount-btn" onclick="setQuickAmount(10000)">₱10,000</button>
                <button class="quick-amount-btn" onclick="setQuickAmount(20000)">₱20,000</button>
                <button class="quick-amount-btn" onclick="setQuickAmount(50000)">₱50,000</button>
            </div>
        </div>
        
        <!-- Payment Summary -->
        <div class="payment-summary">
            <div class="summary-row" id="totalAmountRow" style="display: none;">
                <span class="summary-label">Total Amount:</span>
                <span class="summary-value" id="summaryTotalAmount">₱0.00</span>
            </div>
            <div class="summary-row">
                <span class="summary-label" id="amountToPayLabel">Amount to Pay:</span>
                <span class="summary-value" id="summaryAmountToPay">₱0.00</span>
            </div>
            <div class="summary-row">
                <span class="summary-label">Amount Received:</span>
                <span class="summary-value" id="summaryAmountReceived">₱0.00</span>
            </div>
            <div class="summary-row" id="balanceRow" style="display: none;">
                <span class="summary-label">Remaining Balance:</span>
                <span class="summary-value" id="summaryBalance" style="color: #dc3545; font-weight: bold;">₱0.00</span>
            </div>
            <div class="summary-row" id="changeRow" style="display: none;">
                <span class="summary-label">Change:</span>
                <span class="summary-value" id="summaryChange">₱0.00</span>
            </div>
        </div>
        
        <!-- Change Display -->
        <div class="change-display" id="changeDisplay">
            <div class="change-label">Change to Give</div>
            <div class="change-value" id="changeAmount">₱0.00</div>
        </div>
        
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn-clear" onclick="clearAmount()">
                        <i class="fas fa-eraser me-2"></i>Clear
                    </button>
                    <button class="btn-process" id="processPaymentBtn" onclick="processPayment()" disabled>
                        <i class="fas fa-check me-2"></i>Process Payment
                    </button>
                </div>
            </div>
            <!-- End Right Column -->
        </div>
        <!-- End Two Column Layout -->
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let orderData = null;
    let amountToPay = 0;
    let amountReceived = 0;
    let change = 0;
    let isDownpaymentMode = false;
    let minimumDownpayment = 0;
    let totalAmount = 0;
    let isDownpaymentEligible = false;
    
    // Load order data from sessionStorage
    function loadOrderData() {
        const storedOrder = sessionStorage.getItem('currentOrder');
        if (storedOrder) {
            orderData = JSON.parse(storedOrder);
            totalAmount = orderData.totalCost;
            amountToPay = totalAmount;
            
            // Check if order is eligible for downpayment (repair or customize only)
            const orderType = orderData.orderType ? orderData.orderType.toLowerCase() : '';
            isDownpaymentEligible = (orderType === 'repair' || orderType === 'customize');
            
            // Calculate minimum downpayment (75% of total)
            minimumDownpayment = totalAmount * 0.75;
            
            displayOrderDetails();
            updateAmountDisplay();
            
            // Show downpayment section if eligible
            if (isDownpaymentEligible) {
                document.getElementById('downpaymentSection').style.display = 'block';
                updateDownpaymentInfo();
            }
        } else {
            // No order data found, redirect back to create order
            window.location.href = '/orders/create/';
        }
    }
    
    // Update downpayment information
    function updateDownpaymentInfo() {
        document.getElementById('downpaymentTotal').textContent = `₱${totalAmount.toFixed(2)}`;
        document.getElementById('downpaymentMinimum').textContent = `₱${minimumDownpayment.toFixed(2)}`;
        document.getElementById('downpaymentMinDisplay').textContent = `₱${minimumDownpayment.toFixed(2)}`;
        document.getElementById('warningMinAmount').textContent = `₱${minimumDownpayment.toFixed(2)}`;
        
        if (isDownpaymentMode) {
            const balance = totalAmount - amountReceived;
            document.getElementById('downpaymentBalance').textContent = `₱${balance > 0 ? balance.toFixed(2) : '0.00'}`;
        } else {
            document.getElementById('downpaymentBalance').textContent = `₱0.00`;
        }
    }
    
    // Toggle downpayment mode
    function toggleDownpayment() {
        const toggle = document.getElementById('downpaymentToggle');
        const info = document.getElementById('downpaymentInfo');
        const note = document.getElementById('downpaymentNote');
        const amountLabel = document.getElementById('amountLabel');
        const amountToPayLabel = document.getElementById('amountToPayLabel');
        const totalAmountRow = document.getElementById('totalAmountRow');
        const balanceRow = document.getElementById('balanceRow');
        
        isDownpaymentMode = toggle.checked;
        
        if (isDownpaymentMode) {
            info.classList.add('show');
            note.classList.add('show');
            amountLabel.textContent = 'Minimum to Pay (75%)';
            amountToPayLabel.textContent = 'Minimum Downpayment:';
            totalAmountRow.style.display = 'flex';
            balanceRow.style.display = 'flex';
            amountToPay = minimumDownpayment;
            
            // Update total amount in summary
            document.getElementById('summaryTotalAmount').textContent = `₱${totalAmount.toFixed(2)}`;
        } else {
            info.classList.remove('show');
            note.classList.remove('show');
            amountLabel.textContent = 'Amount to Pay';
            amountToPayLabel.textContent = 'Amount to Pay:';
            totalAmountRow.style.display = 'none';
            balanceRow.style.display = 'none';
            amountToPay = totalAmount;
        }
        
        updateAmountDisplay();
        updateDownpaymentInfo();
        calculateChange();
    }
    
    // Display order details
    function displayOrderDetails() {
        if (!orderData) return;
        
        const detailsDiv = document.getElementById('orderDetails');
        
        detailsDiv.innerHTML = `
            <div class="detail-row">
                <span>Customer:</span>
                <span>${orderData.customerName}</span>
            </div>
            <div class="detail-row">
                <span>Mobile:</span>
                <span>${orderData.mobileNumber}</span>
            </div>
            <div class="detail-row">
                <span>Order Type:</span>
                <span>${orderData.orderType.charAt(0).toUpperCase() + orderData.orderType.slice(1)}</span>
            </div>
            <div class="detail-row">
                <span>Payment Method:</span>
                <span>${orderData.paymentMethod ? orderData.paymentMethod.charAt(0).toUpperCase() + orderData.paymentMethod.slice(1) : 'Cash'}</span>
            </div>
        `;
    }
    
    // Update amount display
    function updateAmountDisplay() {
        document.getElementById('amountToPay').textContent = `₱${amountToPay.toFixed(2)}`;
        document.getElementById('summaryAmountToPay').textContent = `₱${amountToPay.toFixed(2)}`;
        
        // Show/hide custom amount section based on amount
        const customAmountSection = document.getElementById('customAmountSection');
        const highAmountButtons = document.getElementById('highAmountButtons');
        const amountInput = document.getElementById('amountReceived');
        
        if (amountToPay > 5000) {
            customAmountSection.style.display = 'block';
            highAmountButtons.style.display = 'grid';
            amountInput.classList.add('highlight');
            // Auto-focus the input field
            setTimeout(() => {
                amountInput.focus();
            }, 300);
        } else {
            customAmountSection.style.display = 'none';
            highAmountButtons.style.display = 'none';
            amountInput.classList.remove('highlight');
        }
    }
    
    // Focus amount input
    function focusAmountInput() {
        const amountInput = document.getElementById('amountReceived');
        amountInput.focus();
        amountInput.select();
    }
    
    // Set quick amount
    function setQuickAmount(amount) {
        document.getElementById('amountReceived').value = amount;
        calculateChange();
    }
    
    // Calculate change
    function calculateChange() {
        const receivedInput = document.getElementById('amountReceived');
        amountReceived = parseFloat(receivedInput.value) || 0;
        
        // Update summary
        document.getElementById('summaryAmountReceived').textContent = `₱${amountReceived.toFixed(2)}`;
        
        // Show/hide change row and display
        const changeRow = document.getElementById('changeRow');
        const changeDisplay = document.getElementById('changeDisplay');
        const processBtn = document.getElementById('processPaymentBtn');
        const downpaymentWarning = document.getElementById('downpaymentWarning');
        
        // Update downpayment info if in downpayment mode
        if (isDownpaymentMode) {
            updateDownpaymentInfo();
        }
        
        if (amountReceived > 0) {
            // Downpayment validation for repair and customize orders
            if (isDownpaymentMode && isDownpaymentEligible) {
                // Check if amount is at least 75% of total
                if (amountReceived < minimumDownpayment) {
                    // Insufficient downpayment
                    downpaymentWarning.classList.add('show');
                    changeRow.style.display = 'none';
                    changeDisplay.classList.remove('show');
                    processBtn.disabled = true;
                    return;
                } else {
                    downpaymentWarning.classList.remove('show');
                }
            } else {
                downpaymentWarning.classList.remove('show');
            }
            
            // Calculate change based on current amount to pay
            change = amountReceived - amountToPay;
            
            if (change >= 0) {
                // Sufficient payment
                if (isDownpaymentMode) {
                    // In downpayment mode, show remaining balance
                    const balance = totalAmount - amountReceived;
                    if (balance > 0) {
                        document.getElementById('summaryBalance').textContent = `₱${balance.toFixed(2)}`;
                    } else {
                        document.getElementById('summaryBalance').textContent = `₱0.00 (Fully Paid)`;
                    }
                    
                    // Show change if customer paid more than total
                    if (amountReceived > totalAmount) {
                        changeRow.style.display = 'flex';
                        const actualChange = amountReceived - totalAmount;
                        document.getElementById('summaryChange').textContent = `₱${actualChange.toFixed(2)}`;
                        changeDisplay.classList.add('show');
                        document.getElementById('changeAmount').textContent = `₱${actualChange.toFixed(2)}`;
                    } else {
                        changeRow.style.display = 'none';
                        changeDisplay.classList.remove('show');
                    }
                } else {
                    // Normal payment mode
                    changeRow.style.display = 'flex';
                    document.getElementById('summaryChange').textContent = `₱${change.toFixed(2)}`;
                    
                    if (change > 0) {
                        // Show change display
                        changeDisplay.classList.add('show');
                        document.getElementById('changeAmount').textContent = `₱${change.toFixed(2)}`;
                    } else {
                        // Exact payment
                        changeDisplay.classList.remove('show');
                    }
                }
                
                processBtn.disabled = false;
            } else {
                // Insufficient payment
                changeRow.style.display = 'none';
                changeDisplay.classList.remove('show');
                processBtn.disabled = true;
                
                if (isDownpaymentMode) {
                    document.getElementById('summaryBalance').textContent = `₱${totalAmount.toFixed(2)}`;
                }
            }
        } else {
            changeRow.style.display = 'none';
            changeDisplay.classList.remove('show');
            processBtn.disabled = true;
            downpaymentWarning.classList.remove('show');
        }
    }
    
    // Clear amount
    function clearAmount() {
        document.getElementById('amountReceived').value = '';
        amountReceived = 0;
        change = 0;
        calculateChange();
    }
    
    // Process payment
    function processPayment() {
        // Validate minimum downpayment for repair and customize orders
        if (isDownpaymentMode && isDownpaymentEligible) {
            if (amountReceived < minimumDownpayment) {
                alert(`Insufficient downpayment! Minimum required is ₱${minimumDownpayment.toFixed(2)} (75% of total amount)`);
                return;
            }
        } else {
            if (amountReceived < amountToPay) {
                alert('Insufficient payment amount!');
                return;
            }
        }
        
        // Calculate remaining balance
        const remainingBalance = totalAmount - amountReceived;
        const isFullPayment = remainingBalance <= 0;
        
        // Update order data with payment information
        orderData.amountReceived = amountReceived;
        orderData.change = change;
        orderData.paymentDate = new Date().toISOString();
        orderData.orderId = 'TS' + Date.now(); // Generate unique order ID
        orderData.isDownpayment = isDownpaymentMode;
        orderData.totalAmount = totalAmount;
        orderData.remainingBalance = remainingBalance > 0 ? remainingBalance : 0;
        orderData.paymentStatus = isFullPayment ? 'Fully Paid' : 'Partial Payment (Downpayment)';
        orderData.downpaymentPercentage = ((amountReceived / totalAmount) * 100).toFixed(2);
        
        // Store updated order data
        sessionStorage.setItem('currentOrder', JSON.stringify(orderData));
        
        // Show confirmation message if downpayment
        if (isDownpaymentMode && !isFullPayment) {
            const confirmMsg = `Downpayment received: ₱${amountReceived.toFixed(2)} (${orderData.downpaymentPercentage}%)\n` +
                             `Remaining balance: ₱${remainingBalance.toFixed(2)}\n\n` +
                             `Proceed to generate receipt?`;
            if (!confirm(confirmMsg)) {
                return;
            }
        }
        
        // Redirect to receipt generation page
        window.location.href = '/orders/receipt/';
    }
    
    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        loadOrderData();
        
        // Add event listener to amount input
        document.getElementById('amountReceived').addEventListener('input', calculateChange);
        
        // Add event listener for Enter key
        document.getElementById('amountReceived').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !document.getElementById('processPaymentBtn').disabled) {
                processPayment();
            }
        });
    });
</script>
{% endblock %}
