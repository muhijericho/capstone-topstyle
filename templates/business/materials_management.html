{% extends 'business/base.html' %}

{% block title %}Materials Management - TopStyle Business{% endblock %}
{% block page_title %}Materials Management{% endblock %}

{% block extra_css %}
<style>
    .materials-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding: 20px;
        background: #ffffff;
        border-radius: 15px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        flex-wrap: wrap;
        gap: 15px;
    }
    
    .materials-title {
        color: #1f2937;
        font-size: 24px;
        font-weight: 700;
        margin: 0;
    }
    
    .materials-header-actions {
        display: flex;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap;
    }
    
    .material-search-container {
        position: relative;
        display: flex;
        align-items: center;
        min-width: 300px;
        max-width: 500px;
        flex: 1;
    }
    
    .material-search-icon {
        position: absolute;
        left: 15px;
        color: #64748b;
        font-size: 16px;
        z-index: 1;
    }
    
    .material-search-input {
        width: 100%;
        padding: 12px 45px 12px 45px;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        font-size: 14px;
        color: #1f2937;
        background: #ffffff;
        transition: all 0.3s ease;
        outline: none;
    }
    
    .material-search-input:focus {
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }
    
    .material-search-input::placeholder {
        color: #94a3b8;
    }
    
    .material-search-clear {
        position: absolute;
        right: 10px;
        background: #e5e7eb;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: #64748b;
        transition: all 0.2s ease;
        z-index: 1;
    }
    
    .material-search-clear:hover {
        background: #cbd5e1;
        color: #1f2937;
    }
    
    .material-search-clear i {
        font-size: 12px;
    }
    
    .add-material-btn {
        background: linear-gradient(135deg, #10b981, #059669);
        border: none;
        color: white;
        padding: 12px 24px;
        border-radius: 10px;
        font-weight: 600;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
        text-decoration: none;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    .add-material-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        color: white;
        text-decoration: none;
    }
    
    /* Filter Buttons */
    .material-filters {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 20px;
        padding: 15px 20px;
        background: #ffffff;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .filter-btn {
        padding: 10px 20px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        background: #ffffff;
        color: #475569;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
    
    .filter-btn:hover {
        border-color: #10b981;
        background: #f0fdf4;
        color: #059669;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        text-decoration: none;
    }
    
    .filter-btn.active {
        background: linear-gradient(135deg, #10b981, #059669);
        border-color: #10b981;
        color: white;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    .filter-btn.active:hover {
        background: linear-gradient(135deg, #059669, #047857);
        color: white;
    }
    
    .materials-table-container {
        background: #ffffff;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
    }
    
    .materials-table {
        width: 100%;
        margin: 0;
        color: #1f2937;
        background: #ffffff;
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .materials-table thead th {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border: none;
        padding: 16px 20px;
        font-weight: 600;
        color: #475569;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        font-size: 11px;
        text-align: left;
        border-bottom: 2px solid #e2e8f0;
        white-space: nowrap;
    }
    
    .materials-table thead th:first-child {
        padding-left: 24px;
    }
    
    .materials-table thead th:last-child {
        padding-right: 24px;
    }
    
    .materials-table tbody td {
        border: none;
        padding: 18px 20px;
        vertical-align: middle;
        border-bottom: 1px solid #f1f5f9;
        background: #ffffff;
        font-size: 14px;
    }
    
    .materials-table tbody td:first-child {
        padding-left: 24px;
    }
    
    .materials-table tbody td:last-child {
        padding-right: 24px;
    }
    
    .materials-table tbody tr {
        background: #ffffff;
        transition: all 0.2s ease;
    }
    
    .materials-table tbody tr:last-child td {
        border-bottom: none;
    }
    
    .materials-table tbody tr:hover {
        background: #f8fafc;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
    }
    
    .materials-table tbody tr:hover td {
        border-bottom-color: #e2e8f0;
    }
    
    .material-row-clickable {
        transition: all 0.2s ease;
    }
    
    .material-row-clickable:hover {
        background: #f0f9ff !important;
        transform: translateX(2px);
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.15);
    }
    
    .material-row-clickable:hover td {
        border-bottom-color: #bae6fd;
    }
    
    .material-row-clickable:active {
        transform: translateX(1px);
        box-shadow: 0 1px 4px rgba(16, 185, 129, 0.2);
    }
    
    /* Material Detail Modal Styles */
    .material-detail-images {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .material-detail-image {
        width: 100%;
        height: 150px;
        object-fit: cover;
        border-radius: 10px;
        border: 2px solid #e5e7eb;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .material-detail-image:hover {
        transform: scale(1.05);
        border-color: #10b981;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    .material-detail-image.primary {
        border-color: #10b981;
        border-width: 3px;
    }
    
    .material-detail-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    
    .material-detail-item {
        padding: 15px;
        background: #f8fafc;
        border-radius: 8px;
        border-left: 4px solid #10b981;
    }
    
    .material-detail-item label {
        font-size: 12px;
        text-transform: uppercase;
        color: #64748b;
        font-weight: 600;
        letter-spacing: 0.5px;
        margin-bottom: 5px;
        display: block;
    }
    
    .material-detail-item .value {
        font-size: 16px;
        font-weight: 700;
        color: #1e293b;
    }
    
    .material-detail-description {
        margin-top: 20px;
        padding: 15px;
        background: #f8fafc;
        border-radius: 8px;
        border-left: 4px solid #3b82f6;
    }
    
    .material-detail-description h6 {
        color: #1e293b;
        margin-bottom: 10px;
        font-weight: 600;
    }
    
    .material-detail-description ul {
        margin: 0;
        padding-left: 20px;
    }
    
    .material-detail-description li {
        margin-bottom: 5px;
        color: #475569;
    }
    
    .material-image {
        width: 64px;
        height: 64px;
        object-fit: cover;
        border-radius: 10px;
        border: 2px solid #e5e7eb;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        transition: all 0.2s ease;
    }
    
    .materials-table tbody tr:hover .material-image {
        border-color: #cbd5e1;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .material-image-placeholder {
        width: 64px;
        height: 64px;
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid #e5e7eb;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .material-image-placeholder i {
        font-size: 24px;
        color: #94a3b8;
    }
    
    .material-name {
        font-weight: 600;
        color: #1e293b;
        font-size: 15px;
        margin-bottom: 4px;
        line-height: 1.4;
    }
    
    .material-type {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        color: #065f46;
        padding: 4px 10px;
        border-radius: 6px;
        display: inline-block;
        font-weight: 600;
        border: 1px solid #6ee7b7;
    }
    
    .stock-status {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: 1px solid;
    }
    
    .status-in-stock {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        color: #065f46;
        border-color: #6ee7b7;
    }
    
    .status-low-stock {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        color: #92400e;
        border-color: #fcd34d;
    }
    
    .status-out-of-stock {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        color: #991b1b;
        border-color: #fca5a5;
    }
    
    .material-price {
        font-size: 16px;
        font-weight: 700;
        color: #059669;
        line-height: 1.3;
    }
    
    .material-stock {
        font-size: 14px;
        font-weight: 600;
        color: #1e293b;
        line-height: 1.4;
    }
    
    .material-actions {
        display: flex;
        gap: 8px;
        align-items: center;
    }
    
    .action-btn {
        padding: 8px 12px;
        border: none;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        min-width: 40px;
        height: 40px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .material-actions form {
        display: inline;
    }
    
    .material-actions button.action-btn {
        background: inherit;
        color: inherit;
    }
    
    .btn-edit {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
    }
    
    .btn-restock {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }
    
    .btn-archive {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        color: white;
    }
    
    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        color: white;
        text-decoration: none;
    }
    
    .action-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
    }
    
    .no-materials {
        text-align: center;
        padding: 80px 20px;
        color: #6b7280;
    }
    
    .no-materials i {
        font-size: 64px;
        margin-bottom: 20px;
        color: #d1d5db;
    }
    
    .no-materials h4 {
        color: #1f2937;
        margin-bottom: 10px;
        font-weight: 600;
    }
    
    .no-materials p {
        font-size: 16px;
        line-height: 1.6;
        margin-bottom: 30px;
    }
    
    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    /* 3D Stat Cards Styling */
    .stat-card {
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        border: none !important;
        transform-style: preserve-3d;
        perspective: 1000px;
        box-shadow: 
            0 10px 25px rgba(0, 0, 0, 0.15),
            0 5px 10px rgba(0, 0, 0, 0.1),
            inset 0 -3px 0 rgba(0, 0, 0, 0.2);
        background: linear-gradient(135deg, var(--card-color-start, #667eea) 0%, var(--card-color-end, #764ba2) 100%);
        border-radius: 15px !important;
        overflow: hidden;
        padding: 25px 20px;
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 140px;
    }
    
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 100%);
        pointer-events: none;
        border-radius: 15px;
    }
    
    .stat-card::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 0 0 15px 15px;
    }
    
    .stat-card:hover {
        transform: translateY(-8px) rotateX(5deg) scale(1.02);
        box-shadow: 
            0 20px 40px rgba(0, 0, 0, 0.25),
            0 10px 20px rgba(0, 0, 0, 0.15),
            inset 0 -5px 0 rgba(0, 0, 0, 0.3);
    }
    
    .stat-card:active {
        transform: translateY(-4px) rotateX(2deg) scale(0.98);
        transition: all 0.1s ease;
    }
    
    .stat-card .stat-content {
        position: relative;
        z-index: 1;
        color: #ffffff !important;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .stat-card .stat-content * {
        color: #ffffff !important;
    }
    
    .stat-icon {
        font-size: 32px;
        margin-bottom: 10px;
        margin-top: 0;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        transition: transform 0.3s ease;
        color: #ffffff !important;
    }
    
    .stat-icon i {
        color: #ffffff !important;
    }
    
    .stat-card:hover .stat-icon {
        transform: rotate(5deg) scale(1.1);
    }
    
    .stat-number {
        font-size: clamp(1.25rem, 4vw, 1.75rem); /* Responsive stat number */
        font-weight: 700;
        margin-bottom: 6px;
        margin-top: 0;
        line-height: 1.2;
        text-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
        transition: transform 0.3s ease;
        color: #ffffff !important;
    }
    
    .stat-card:hover .stat-number {
        transform: scale(1.1);
    }
    
    /* Responsive stat cards on mobile */
    @media (max-width: 768px) {
        .stat-number {
            font-size: clamp(1.1rem, 3.5vw, 1.5rem) !important;
        }
        
        .stat-icon {
            font-size: clamp(1rem, 3vw, 1.5rem) !important;
        }
        
        .stat-label {
            font-size: clamp(0.65rem, 1.8vw, 0.85rem) !important;
        }
    }
    
    @media (max-width: 576px) {
        .stat-number {
            font-size: clamp(1rem, 3vw, 1.35rem) !important;
        }
        
        .stat-icon {
            font-size: clamp(0.9rem, 2.5vw, 1.25rem) !important;
        }
        
        .stat-label {
            font-size: clamp(0.6rem, 1.5vw, 0.8rem) !important;
        }
    }
    
    .stat-label {
        font-size: clamp(0.65rem, 1.8vw, 0.7rem); /* Responsive label */
        color: #ffffff !important;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        margin-top: 0;
        margin-bottom: 0;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        font-weight: 600;
        line-height: 1.3;
    }
    
    /* Card Color Variables */
    .stat-card-blue {
        --card-color-start: #667eea;
        --card-color-end: #764ba2;
    }
    
    .stat-card-green {
        --card-color-start: #4facfe;
        --card-color-end: #00f2fe;
    }
    
    .stat-card-orange {
        --card-color-start: #f093fb;
        --card-color-end: #f5576c;
    }
    
    .stat-card-red {
        --card-color-start: #dc2626;
        --card-color-end: #991b1b;
        background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%) !important;
    }
    
    .stat-card-purple {
        --card-color-start: #43e97b;
        --card-color-end: #38f9d7;
    }
    
    .stat-card-teal {
        --card-color-start: #fa709a;
        --card-color-end: #fee140;
    }
    
    /* Material Usage History Box */
    .material-history-box {
        background: #ffffff;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
        margin-bottom: 30px;
        padding: 20px;
        max-height: 200px;
        overflow-y: auto;
    }
    
    .material-history-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e5e7eb;
    }
    
    .material-history-title {
        font-size: 18px;
        font-weight: 700;
        color: #1f2937;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .material-history-title i {
        color: #10b981;
    }
    
    .material-history-refresh {
        background: linear-gradient(135deg, #10b981, #059669);
        border: none;
        color: white;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .material-history-refresh:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    .material-history-refresh:active {
        transform: translateY(0);
    }
    
    .material-history-refresh i {
        font-size: 12px;
    }
    
    .material-history-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .material-history-item {
        padding: 12px 15px;
        margin-bottom: 10px;
        background: #f8fafc;
        border-radius: 8px;
        border-left: 4px solid #10b981;
        transition: all 0.2s ease;
        font-size: 14px;
        line-height: 1.6;
        color: #1f2937;
    }
    
    .material-history-item:hover {
        background: #f0fdf4;
        border-left-color: #059669;
        transform: translateX(2px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .material-history-item:last-child {
        margin-bottom: 0;
    }
    
    .material-history-item strong {
        color: #059669;
        font-weight: 700;
    }
    
    .material-history-empty {
        text-align: center;
        padding: 40px 20px;
        color: #6b7280;
    }
    
    .material-history-empty i {
        font-size: 48px;
        margin-bottom: 15px;
        color: #d1d5db;
        display: block;
    }
    
    .material-history-loading {
        text-align: center;
        padding: 40px 20px;
        color: #6b7280;
    }
    
    .material-history-loading .spinner-border {
        width: 3rem;
        height: 3rem;
        border-width: 0.3em;
        color: #10b981;
    }
    
    /* Modal Styling */
    .materials-modal .modal-content {
        border-radius: 15px;
        border: none;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    .materials-modal .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px 15px 0 0;
        border: none;
    }
    
    .materials-modal .modal-header .btn-close {
        filter: brightness(0) invert(1);
    }
    
    .materials-stat-box {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 15px;
        border-left: 4px solid #667eea;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .materials-stat-box h6 {
        color: #495057;
        font-weight: 600;
        margin-bottom: 10px;
    }
    
    .materials-stat-box .stat-value {
        font-size: 1.8rem;
        font-weight: 700;
        color: #667eea;
    }
    
    @media (max-width: 768px) {
        .materials-header {
            flex-direction: column;
            gap: 20px;
            text-align: center;
        }
        
        .materials-table-container {
            overflow-x: auto;
        }
        
        .materials-table {
            min-width: 600px;
        }
        
        .stats-row {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="materials-header">
    <h1 class="materials-title">
        <i class="fas fa-cut me-2"></i>Materials Management
    </h1>
    <div class="materials-header-actions">
        <div class="material-search-container">
            <i class="fas fa-search material-search-icon"></i>
            <input type="text" id="materialSearchInput" class="material-search-input" placeholder="Search materials by name, type, or description...">
            <button type="button" id="clearSearchBtn" class="material-search-clear" style="display: none;" title="Clear search">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <a href="{% url 'add_material_product' %}" class="add-material-btn">
            <i class="fas fa-plus"></i>
            <span>Add Material</span>
        </a>
    </div>
</div>

<!-- Statistics Row -->
<div class="stats-row">
    <div class="stat-card stat-card-blue" data-stat-type="total">
        <div class="stat-content">
            <div class="stat-icon">
                <i class="fas fa-cut"></i>
            </div>
            <div class="stat-number">{{ total_materials|default:0 }}</div>
            <div class="stat-label">Total Materials</div>
        </div>
    </div>
    <div class="stat-card stat-card-green" data-stat-type="in_stock">
        <div class="stat-content">
            <div class="stat-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-number">{{ in_stock|default:0 }}</div>
            <div class="stat-label">In Stock</div>
        </div>
    </div>
    <div class="stat-card stat-card-orange" data-stat-type="low_stock">
        <div class="stat-content">
            <div class="stat-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="stat-number">{{ low_stock_materials|default:0 }}</div>
            <div class="stat-label">Low Stock</div>
        </div>
    </div>
    <div class="stat-card stat-card-red" data-stat-type="out_of_stock">
        <div class="stat-content">
            <div class="stat-icon">
                <i class="fas fa-times-circle"></i>
            </div>
            <div class="stat-number">{{ out_of_stock|default:0 }}</div>
            <div class="stat-label">Out of Stock</div>
        </div>
    </div>
    <div class="stat-card stat-card-purple" data-stat-type="total_value">
        <div class="stat-content">
            <div class="stat-icon">
                <i class="fas fa-peso-sign"></i>
            </div>
            <div class="stat-number">₱{{ total_value|floatformat:2|default:"0.00" }}</div>
            <div class="stat-label">Total Value</div>
        </div>
    </div>
</div>

<!-- Material Usage History Box -->
<div class="material-history-box">
    <div class="material-history-header">
        <h3 class="material-history-title">
            <i class="fas fa-history"></i>
            Material Usage History
        </h3>
        <button type="button" class="material-history-refresh" id="refreshHistoryBtn" title="Refresh History">
            <i class="fas fa-sync-alt"></i>
            Refresh
        </button>
    </div>
    <div id="materialHistoryContent">
        <div class="material-history-loading">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading material usage history...</p>
        </div>
    </div>
</div>

<!-- Filter Buttons -->
<div class="material-filters">
    <a href="?filter=all" 
       class="filter-btn {% if current_filter == 'all' or not current_filter %}active{% endif %}">
        <i class="fas fa-list"></i>
        <span>All Materials</span>
    </a>
    <a href="?filter=fabric" 
       class="filter-btn {% if current_filter|lower == 'fabric' %}active{% endif %}">
        <i class="fas fa-cut"></i>
        <span>Fabric</span>
    </a>
    <a href="?filter=buttons" 
       class="filter-btn {% if current_filter|lower == 'buttons' %}active{% endif %}">
        <i class="fas fa-circle"></i>
        <span>Buttons</span>
    </a>
    <a href="?filter=zippers" 
       class="filter-btn {% if current_filter|lower == 'zippers' %}active{% endif %}">
        <i class="fas fa-link"></i>
        <span>Zippers</span>
    </a>
    <a href="?filter=garter_locks" 
       class="filter-btn {% if current_filter == 'garter_locks' %}active{% endif %}">
        <i class="fas fa-ellipsis-h"></i>
        <span>Garter & Locks</span>
    </a>
    <a href="?filter=thread" 
       class="filter-btn {% if current_filter|lower == 'thread' %}active{% endif %}">
        <i class="fas fa-thread"></i>
        <span>Thread</span>
    </a>
    <a href="?filter=patches" 
       class="filter-btn {% if current_filter|lower == 'patches' %}active{% endif %}">
        <i class="fas fa-stamp"></i>
        <span>Patches</span>
    </a>
</div>

<!-- Materials Table -->
<div class="materials-table-container">
    {% if materials %}
        <table class="materials-table">
            <thead>
                <tr>
                    <th>Image</th>
                    <th>Material Details</th>
                    <th>Type</th>
                    <th>Stock</th>
                    <th>Status</th>
                    <th>Price</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="materialsTableBody">
                {% for product in materials %}
                <tr class="material-row-clickable material-table-row" data-product-id="{{ product.id }}" style="cursor: pointer;" 
                    data-material-name="{{ product.name|lower }}" 
                    data-material-type="{{ product.material_type.name|default:''|lower }}"
                    data-material-description="{{ product.description|default:''|lower }}">
                    <td>
                        {% if product.image %}
                            <img src="{{ product.image.url }}" alt="{{ product.name }}" class="material-image">
                        {% else %}
                            <div class="material-image-placeholder">
                                <i class="fas fa-cut"></i>
                            </div>
                        {% endif %}
                    </td>
                    <td>
                        <div class="material-name">{{ product.name }}</div>
                        {% if product.description %}
                            <div class="text-muted small">{{ product.description|truncatechars:50 }}</div>
                        {% endif %}
                    </td>
                    <td>
                        <span class="material-type">{{ product.material_type.name|default:"No Type" }}</span>
                    </td>
                    <td>
                        <div class="material-stock">
                            {{ product.quantity }} 
                            {% if product.material_type.name|lower == 'garter' %}
                                inch
                            {% else %}
                                {{ product.unit_of_measurement|default:"piece" }}
                            {% endif %}
                        </div>
                        {% if product.min_quantity > 0 %}
                            <div class="text-muted small">Min: {{ product.min_quantity }} 
                            {% if product.material_type.name|lower == 'garter' %}
                                inch
                            {% else %}
                                {{ product.unit_of_measurement|default:"piece" }}
                            {% endif %}
                            </div>
                        {% endif %}
                    </td>
                    <td>
                        <span class="stock-status status-{% if product.quantity == 0 %}out-of-stock{% elif product.min_quantity > 0 and product.quantity <= product.min_quantity %}low-stock{% else %}in-stock{% endif %}">
                            {% if product.quantity == 0 %}
                                Out of Stock
                            {% elif product.min_quantity > 0 and product.quantity <= product.min_quantity %}
                                Low Stock
                            {% else %}
                                In Stock
                            {% endif %}
                        </span>
                    </td>
                    <td>
                        <div class="material-price">₱{{ product.price|floatformat:2 }}</div>
                        {% if product.cost > 0 %}
                            <div class="text-muted small">Cost: ₱{{ product.cost|floatformat:2 }}</div>
                        {% endif %}
                    </td>
                    <td>
                        <div class="material-actions" onclick="event.stopPropagation();">
                            <a href="{% url 'restock_material' product.id %}" class="action-btn btn-restock" title="Restock">
                                <i class="fas fa-plus"></i>
                            </a>
                            <a href="{% url 'edit_material' product.id %}" class="action-btn btn-edit" title="Edit">
                                <i class="fas fa-edit"></i>
                            </a>
                            <form method="post" action="{% url 'archive_product' product.id %}" style="display: inline-block;" onsubmit="return confirm('Are you sure you want to archive this material?');">
                                {% csrf_token %}
                                <button type="submit" class="action-btn btn-archive" title="Archive" style="background: #6b7280; color: white; border: none;">
                                    <i class="fas fa-archive"></i>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <!-- Pagination -->
        {% if materials.has_other_pages %}
        <div class="d-flex justify-content-center mt-4">
            <nav aria-label="Materials pagination">
                <ul class="pagination">
                    {% if materials.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1{% if current_filter and current_filter != 'all' %}&filter={{ current_filter }}{% endif %}">First</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ materials.previous_page_number }}{% if current_filter and current_filter != 'all' %}&filter={{ current_filter }}{% endif %}">Previous</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">First</span>
                        </li>
                        <li class="page-item disabled">
                            <span class="page-link">Previous</span>
                        </li>
                    {% endif %}
                    
                    <li class="page-item active">
                        <span class="page-link">
                            Page {{ materials.number }} of {{ materials.paginator.num_pages }}
                        </span>
                    </li>
                    
                    {% if materials.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ materials.next_page_number }}{% if current_filter and current_filter != 'all' %}&filter={{ current_filter }}{% endif %}">Next</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ materials.paginator.num_pages }}{% if current_filter and current_filter != 'all' %}&filter={{ current_filter }}{% endif %}">Last</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">Next</span>
                        </li>
                        <li class="page-item disabled">
                            <span class="page-link">Last</span>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    {% else %}
        <div class="no-materials">
            <i class="fas fa-cut"></i>
            <h4>No Materials Found</h4>
            <p>You haven't added any materials yet. Start by adding your first material to the system.</p>
            <a href="{% url 'add_material_product' %}" class="add-material-btn">
                <i class="fas fa-plus"></i>
                <span>Add Your First Material</span>
            </a>
        </div>
    {% endif %}
</div>

<!-- Materials Details Modal -->
<div class="modal fade materials-modal" id="materialsDetailsModal" tabindex="-1" aria-labelledby="materialsDetailsModalLabel" aria-hidden="true" data-bs-backdrop="false">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="materialsDetailsModalLabel">
                    <i class="fas fa-cut me-2"></i>
                    <span id="modalStatLabel">Materials Details</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="event.stopPropagation();"></button>
            </div>
            <div class="modal-body">
                <div id="materialsModalContent">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">Loading materials details...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="updateMaterialBtn" class="btn btn-primary" style="display: none; background: linear-gradient(135deg, #10b981, #059669); border: none; padding: 10px 20px; font-weight: 600; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);" onclick="event.stopPropagation();">
                    <i class="fas fa-edit me-2"></i>Update Material
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="event.stopPropagation();">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // 3D Stat Cards Interactive Functionality
    document.addEventListener('DOMContentLoaded', function() {
        const statCards = document.querySelectorAll('.stat-card');
        const modalElement = document.getElementById('materialsDetailsModal');
        if (!modalElement || statCards.length === 0) return;
        
        const modal = new bootstrap.Modal(modalElement, {
            backdrop: false,
            keyboard: true
        });
        const modalLabel = document.getElementById('modalStatLabel');
        const modalContent = document.getElementById('materialsModalContent');
        const updateMaterialBtn = document.getElementById('updateMaterialBtn');
        if (!modalLabel || !modalContent) return;
        
        function displayMaterialsDetails(data, contentElement) {
            let html = `
                <div class="materials-stat-box">
                    <h6><i class="fas fa-cut me-2"></i>${data.title}</h6>
                    <div class="stat-value">${data.value}</div>
                    <small class="text-muted">${data.count} material(s)</small>
                </div>
            `;
            
            // Materials List
            if (data.materials && data.materials.length > 0) {
                html += `
                    <div class="mb-4">
                        <h6 class="mb-3"><i class="fas fa-list me-2"></i>Materials</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Type</th>
                                        <th>Stock</th>
                                        <th>Status</th>
                                        <th>Price</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                data.materials.forEach(material => {
                    html += `
                        <tr>
                            <td>${material.name}</td>
                            <td><span class="badge bg-info">${material.type || 'N/A'}</span></td>
                            <td>${material.stock} ${material.unit || 'piece'}</td>
                            <td><span class="badge ${material.status_class}">${material.status}</span></td>
                            <td>₱${parseFloat(material.price || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        No materials found in this category.
                    </div>
                `;
            }
            
            contentElement.innerHTML = html;
        }
        
        statCards.forEach(card => {
            card.addEventListener('click', function(e) {
                // Prevent clicks on child elements from triggering modal
                const target = e.target;
                if (target.closest('button') || 
                    target.closest('a') || 
                    target.closest('.btn') ||
                    target.tagName === 'BUTTON' ||
                    target.tagName === 'A') {
                    e.stopPropagation();
                    return false;
                }
                
                e.stopPropagation();
                const statType = this.getAttribute('data-stat-type');
                
                // Update modal title
                const statLabels = {
                    'total': 'Total Materials',
                    'in_stock': 'In Stock Materials',
                    'low_stock': 'Low Stock Materials',
                    'out_of_stock': 'Out of Stock Materials',
                    'total_value': 'Total Value Summary'
                };
                if (modalLabel) {
                    modalLabel.textContent = statLabels[statType] || 'Materials Details';
                }
                
                // Hide update button for stat card views
                if (updateMaterialBtn) {
                    updateMaterialBtn.style.display = 'none';
                }
                
                // Show loading state
                if (modalContent) {
                    modalContent.innerHTML = `
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3">Loading materials details...</p>
                        </div>
                    `;
                }
                
                // Ensure any existing modals are closed first
                const existingBackdrops = document.querySelectorAll('.modal-backdrop');
                existingBackdrops.forEach(backdrop => backdrop.remove());
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
                
                // Show modal
                modal.show();
                
                // Immediately remove any backdrop that might have been created
                setTimeout(() => {
                    const backdrops = document.querySelectorAll('.modal-backdrop');
                    backdrops.forEach(backdrop => backdrop.remove());
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                }, 10);
                
                // Fetch materials details
                fetch(`/api/materials-details/?type=${statType}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && modalContent) {
                            displayMaterialsDetails(data, modalContent);
                        } else if (modalContent) {
                            modalContent.innerHTML = `
                                <div class="alert alert-danger">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Error loading materials details. Please try again.
                                </div>
                            `;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        if (modalContent) {
                            modalContent.innerHTML = `
                                <div class="alert alert-danger">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Error loading materials details. Please try again.
                                </div>
                            `;
                        }
                    });
            });
        });
        
        // Clean up modals
        modalElement.addEventListener('hidden.bs.modal', function() {
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            // Hide update button when modal closes
            if (updateMaterialBtn) {
                updateMaterialBtn.style.display = 'none';
            }
        });
        
        // Material Row Click Functionality
        const materialRows = document.querySelectorAll('.material-row-clickable');
        materialRows.forEach(row => {
            row.addEventListener('click', function(e) {
                // Prevent clicks on action buttons from triggering row click
                if (e.target.closest('.material-actions') || 
                    e.target.closest('a') || 
                    e.target.closest('button') ||
                    e.target.closest('form')) {
                    return;
                }
                
                const productId = this.getAttribute('data-product-id');
                if (!productId) return;
                
                // Update modal title
                if (modalLabel) {
                    modalLabel.textContent = 'Material Details';
                }
                
                // Show update button and set its href
                if (updateMaterialBtn) {
                    updateMaterialBtn.style.display = 'inline-block';
                    updateMaterialBtn.onclick = function(e) {
                        e.stopPropagation();
                        window.location.href = `/materials/${productId}/edit/`;
                    };
                }
                
                // Show loading state
                if (modalContent) {
                    modalContent.innerHTML = `
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3">Loading material details...</p>
                        </div>
                    `;
                }
                
                // Clean up any existing modals
                const existingBackdrops = document.querySelectorAll('.modal-backdrop');
                existingBackdrops.forEach(backdrop => backdrop.remove());
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
                
                // Show modal
                modal.show();
                
                // Remove backdrop after a short delay
                setTimeout(() => {
                    const backdrops = document.querySelectorAll('.modal-backdrop');
                    backdrops.forEach(backdrop => backdrop.remove());
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                }, 10);
                
                // Fetch material details
                fetch(`/api/material/${productId}/detail/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.material && modalContent) {
                            displayMaterialDetail(data.material, modalContent);
                        } else if (modalContent) {
                            modalContent.innerHTML = `
                                <div class="alert alert-danger">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    ${data.error || 'Error loading material details. Please try again.'}
                                </div>
                            `;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        if (modalContent) {
                            modalContent.innerHTML = `
                                <div class="alert alert-danger">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Error loading material details. Please try again.
                                </div>
                            `;
                        }
                    });
            });
        });
        
        // Function to display material detail in modal
        function displayMaterialDetail(material, contentElement) {
            let html = `
                <div class="material-detail-content">
                    <h4 class="mb-4" style="color: #1e293b; font-weight: 700;">
                        <i class="fas fa-cut me-2" style="color: #10b981;"></i>${material.name}
                    </h4>
            `;
            
            // Images Gallery
            // Check for images array first, then fallback to image_url for backward compatibility
            let materialImages = material.images || [];
            if (materialImages.length === 0 && material.image_url) {
                // Fallback: create images array from single image_url
                materialImages = [{
                    'url': material.image_url,
                    'alt': material.name,
                    'is_primary': true
                }];
            }
            
            if (materialImages && materialImages.length > 0) {
                html += `
                    <div class="material-detail-images">
                `;
                materialImages.forEach((img, index) => {
                    html += `
                        <img src="${img.url}" 
                             alt="${img.alt || material.name + ' - Image ' + (index + 1)}" 
                             class="material-detail-image ${img.is_primary ? 'primary' : ''}"
                             onclick="window.open('${img.url}', '_blank')"
                             title="${img.is_primary ? 'Primary Image' : 'Image ' + (index + 1)}"
                             onerror="this.src='/static/images/placeholder.png'; this.onerror=null;">
                    `;
                });
                html += `</div>`;
            } else {
                html += `
                    <div class="text-center py-4 mb-4" style="background: #f8fafc; border-radius: 10px;">
                        <i class="fas fa-image" style="font-size: 48px; color: #cbd5e1;"></i>
                        <p class="mt-2 text-muted">No images available</p>
                    </div>
                `;
            }
            
            // Material Information Grid
            html += `
                <div class="material-detail-info">
                    <div class="material-detail-item">
                        <label><i class="fas fa-tag me-1"></i>Material Type</label>
                        <div class="value">${material.material_type}</div>
                    </div>
                    <div class="material-detail-item">
                        <label><i class="fas fa-boxes me-1"></i>Stock Quantity</label>
                        <div class="value">${material.quantity} ${material.unit_of_measurement}</div>
                    </div>
                    <div class="material-detail-item">
                        <label><i class="fas fa-exclamation-triangle me-1"></i>Status</label>
                        <div class="value">
                            <span class="stock-status ${material.status_class || 'status-in-stock'}">${material.status || 'IN STOCK'}</span>
                        </div>
                    </div>
                    <div class="material-detail-item">
                        <label><i class="fas fa-peso-sign me-1"></i>Selling Price</label>
                        <div class="value" style="color: #059669;">₱${parseFloat(material.price).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    </div>
                    <div class="material-detail-item">
                        <label><i class="fas fa-coins me-1"></i>Cost Price</label>
                        <div class="value" style="color: #dc2626;">₱${parseFloat(material.cost).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    </div>
                    ${material.min_quantity > 0 ? `
                    <div class="material-detail-item">
                        <label><i class="fas fa-arrow-down me-1"></i>Minimum Quantity</label>
                        <div class="value">${material.min_quantity} ${material.unit_of_measurement}</div>
                    </div>
                    ` : ''}
                    <div class="material-detail-item">
                        <label><i class="fas fa-calendar me-1"></i>Date Added</label>
                        <div class="value">${material.created_at}</div>
                    </div>
                </div>
            `;
            
            // Description
            if (material.description && material.description.trim() !== '') {
                html += `
                    <div class="material-detail-description">
                        <h6><i class="fas fa-info-circle me-2"></i>Description</h6>
                        ${material.description_parts && material.description_parts.length > 0 ? `
                            <ul>
                                ${material.description_parts.map(part => `<li>${part}</li>`).join('')}
                            </ul>
                        ` : `
                            <p style="margin: 0; color: #475569;">${material.description}</p>
                        `}
                    </div>
                `;
            }
            
            html += `</div>`;
            
            contentElement.innerHTML = html;
        }
        
        // Material Search Functionality
        const searchInput = document.getElementById('materialSearchInput');
        const clearSearchBtn = document.getElementById('clearSearchBtn');
        const materialsTableBody = document.getElementById('materialsTableBody');
        
        if (searchInput && materialsTableBody) {
            // Show/hide clear button based on input
            searchInput.addEventListener('input', function() {
                if (this.value.trim().length > 0) {
                    clearSearchBtn.style.display = 'flex';
                } else {
                    clearSearchBtn.style.display = 'none';
                }
                filterMaterials();
            });
            
            // Clear search functionality
            if (clearSearchBtn) {
                clearSearchBtn.addEventListener('click', function() {
                    searchInput.value = '';
                    this.style.display = 'none';
                    filterMaterials();
                    searchInput.focus();
                });
            }
            
            // Filter materials function
            function filterMaterials() {
                const searchTerm = searchInput.value.toLowerCase().trim();
                const rows = materialsTableBody.querySelectorAll('.material-table-row');
                let visibleCount = 0;
                
                rows.forEach(row => {
                    const name = row.getAttribute('data-material-name') || '';
                    const type = row.getAttribute('data-material-type') || '';
                    const description = row.getAttribute('data-material-description') || '';
                    
                    const matches = name.includes(searchTerm) || 
                                   type.includes(searchTerm) || 
                                   description.includes(searchTerm);
                    
                    if (matches || searchTerm === '') {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                });
                
                // Show "No results" message if no matches
                let noResultsMsg = document.getElementById('noSearchResults');
                if (visibleCount === 0 && searchTerm !== '') {
                    if (!noResultsMsg) {
                        noResultsMsg = document.createElement('tr');
                        noResultsMsg.id = 'noSearchResults';
                        noResultsMsg.innerHTML = `
                            <td colspan="7" style="text-align: center; padding: 40px; color: #64748b;">
                                <i class="fas fa-search" style="font-size: 48px; margin-bottom: 15px; display: block; opacity: 0.3;"></i>
                                <h5 style="color: #475569; margin-bottom: 10px;">No materials found</h5>
                                <p style="margin: 0;">Try adjusting your search terms</p>
                            </td>
                        `;
                        materialsTableBody.appendChild(noResultsMsg);
                    }
                } else {
                    if (noResultsMsg) {
                        noResultsMsg.remove();
                    }
                }
            }
            
            // Allow Ctrl/Cmd + K to focus search
            document.addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    searchInput.focus();
                }
            });
        }
        
        // Material Usage History Functionality
        const historyContent = document.getElementById('materialHistoryContent');
        const refreshHistoryBtn = document.getElementById('refreshHistoryBtn');
        
        function loadMaterialHistory() {
            if (!historyContent) return;
            
            // Show loading state
            historyContent.innerHTML = `
                <div class="material-history-loading">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading material usage history...</p>
                </div>
            `;
            
            // Fetch history from API
                fetch('/api/material-usage-history/?limit=50', { credentials: 'same-origin' })
                    .then(response => {
                        const ct = response.headers.get('content-type') || '';
                        if (!response.ok) throw new Error('Network response was not ok: ' + response.status);
                        if (ct.includes('application/json')) return response.json();
                        throw new Error('Unexpected content-type: ' + ct);
                    })
                    .then(data => {
                    if (data.success && data.history && data.history.length > 0) {
                        let html = '<ul class="material-history-list">';
                        
                        data.history.forEach((item, index) => {
                            html += `
                                <li class="material-history-item">
                                    <strong>Order ${index + 1}</strong> "${item.order_identifier}", "${item.order_type_display}" ${item.used_text || 'used'} ${item.materials_display}. was deducted to the total number of the ${item.materials_summary}
                                </li>
                            `;
                        });
                        
                        html += '</ul>';
                        historyContent.innerHTML = html;
                    } else {
                        historyContent.innerHTML = `
                            <div class="material-history-empty">
                                <i class="fas fa-inbox"></i>
                                <h5>No Material Usage History</h5>
                                <p>Material usage history will appear here when orders are created.</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error loading material history:', error);
                    historyContent.innerHTML = `
                        <div class="material-history-empty">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h5>Error Loading History</h5>
                            <p>Unable to load material usage history. Please try again.</p>
                        </div>
                    `;
                });
        }
        
        // Load history on page load
        loadMaterialHistory();
        
        // Refresh button functionality
        if (refreshHistoryBtn) {
            refreshHistoryBtn.addEventListener('click', function() {
                const icon = this.querySelector('i');
                if (icon) {
                    icon.classList.add('fa-spin');
                }
                loadMaterialHistory();
                setTimeout(() => {
                    if (icon) {
                        icon.classList.remove('fa-spin');
                    }
                }, 1000);
            });
        }
    });
</script>
{% endblock %}